<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能轮椅辅助应用</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>♿</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Leaflet 地图库 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- 演示对话数据 -->
    <script src="demo-conversations.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        /* 地图自定义标记样式 */
        .custom-div-icon {
            background: transparent;
            border: none;
        }
        
        /* 确保地图容器正确显示 */
        #route-map-container {
            z-index: 1;
        }
        .joystick-container {
            position: relative;
            width: 200px;
            height: 200px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 50%;
            margin: 0 auto;
        }
        .joystick {
            position: absolute;
            width: 80px;
            height: 80px;
            background: #3b82f6;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .directions {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        .direction {
            position: absolute;
            width: 20px;
            height: 20px;
            color: #64748b;
        }
        .direction.up { top: 10px; left: 50%; transform: translateX(-50%); }
        .direction.right { top: 50%; right: 10px; transform: translateY(-50%); }
        .direction.down { bottom: 10px; left: 50%; transform: translateX(-50%); }
        .direction.left { top: 50%; left: 10px; transform: translateY(-50%); }
        
        .battery-level {
            width: 100%;
            height: 10px;
            background-color: #e5e7eb;
            border-radius: 5px;
            overflow: hidden;
        }
        .battery-fill {
            height: 100%;
            background-color: #10b981;
            border-radius: 5px;
        }
        
        /* 激光雷达扫描动画 */
        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
        
        /* 雷达扫描线样式 */
        #radar-line {
            pointer-events: none;
            opacity: 0.8;
            transition: transform 0.05s linear;
        }
        
        /* 轮椅位置动画 */
        #wheelchair-position {
            transition: all 0.1s ease-in-out;
        }
        
        /* Canvas样式 */
        #mapping-canvas {
            cursor: crosshair;
        }
        
        #mapping-canvas:not(.waypoint-mode) {
            cursor: default;
        }
        
        /* 设点模式提示动画 */
        #waypoint-mode-tip {
            animation: tipFadeIn 0.3s ease-in-out;
        }
        
        @keyframes tipFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* 标记点类型按钮hover效果 */
        .waypoint-type-btn {
            transition: all 0.2s ease-in-out;
        }
        
        /* 实时标记点列表动画 */
        #realtime-waypoints-list > div {
            animation: slideInUp 0.3s ease-out;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* 设备选择器样式 */
        .device-card {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .device-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        

        
        .device-card .device-icon {
            transition: transform 0.3s ease;
        }
        
        .device-card:hover .device-icon {
            transform: scale(1.1);
        }
        

        
        .device-card .device-name {
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }
        
        .device-card .device-status {
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .device-card .device-status.online {
            color: #10b981;
        }
        
        .device-card .device-status.offline {
            color: #6b7280;
        }
        
        .device-selector-btn {
            padding: 8px;
            border-radius: 8px;
            border: none;
            background-color: transparent;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .device-selector-btn:hover {
            background-color: #f3f4f6;
            color: #374151;
        }
        
        .device-selector-btn.primary {
            color: #3b82f6;
        }
        
                    .device-selector-btn.primary:hover {
                background-color: #eff6ff;
                color: #2563eb;
            }
            
            /* 弹窗动画增强 */
            .modal-content {
                animation: modalSlideIn 0.3s ease-out;
            }
            
            @keyframes modalSlideIn {
                from {
                    transform: translateY(-30px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
        </style>
</head>
<body class="bg-gradient-to-b from-purple-50 to-blue-50 min-h-screen text-gray-800">
    <!-- 页面导航栏 -->
    <nav id="bottom-nav" class="fixed bottom-0 w-full bg-white shadow-lg z-40">
        <div class="flex justify-around items-center p-2">
            <a href="#home" class="flex flex-col items-center p-2 text-blue-500">
                <i class="fas fa-home text-xl"></i>
                <span class="text-xs mt-1">首页</span>
            </a>
            <a href="#voice" class="flex flex-col items-center p-2 text-gray-400">
                <i class="fas fa-microphone text-xl"></i>
                <span class="text-xs mt-1">语音</span>
            </a>
            <a href="#device" class="flex flex-col items-center p-2 text-gray-400">
                <i class="fas fa-wheelchair text-xl"></i>
                <span class="text-xs mt-1">设备</span>
            </a>
            <a href="#profile" class="flex flex-col items-center p-2 text-gray-400">
                <i class="fas fa-user text-xl"></i>
                <span class="text-xs mt-1">我的</span>
            </a>
        </div>
    </nav>

    <!-- 主要内容区域 -->
    <div class="pb-28 pt-4">
        <!-- 登录注册页面 -->
        <div id="login" class="p-4 max-w-md mx-auto">
            <div class="text-center mb-8">
                <svg class="w-20 h-20 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                    <line x1="9" y1="9" x2="9.01" y2="9"></line>
                    <line x1="15" y1="9" x2="15.01" y2="9"></line>
                </svg>
                <h1 class="text-2xl font-bold text-blue-600">智能轮椅助手</h1>
                <p class="text-gray-500">让出行更加便捷自由</p>
            </div>
            
            <div id="register-form" class="bg-white rounded-xl shadow-md p-6 mb-4">
                <h2 class="text-xl font-semibold mb-4">账号注册</h2>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">邮箱地址</label>
                    <div class="flex">
                        <input type="email" class="flex-1 rounded-l-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="请输入邮箱">
                        <button class="bg-blue-500 text-white px-3 py-2 rounded-r-lg">获取验证码</button>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">验证码</label>
                    <input type="text" class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="请输入验证码">
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                    <input type="password" class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="请设置密码">
                </div>
                
                <button class="w-full bg-blue-600 text-white py-2 rounded-lg font-medium shadow-md hover:bg-blue-700 transition">注册并创建家庭圈</button>
                
                <p class="text-center text-sm text-gray-500 mt-4">
                    已有账号？<a href="#" class="text-blue-600" id="show-login-btn">立即登录</a>
                </p>
            </div>
            
            <div id="login-form" class="hidden bg-white rounded-xl shadow-md p-6 mb-4">
                <h2 class="text-xl font-semibold mb-4">账号登录</h2>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">邮箱地址</label>
                    <input type="email" class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="请输入邮箱">
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                    <div class="relative">
                        <input type="password" class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="请输入密码">
                        <a href="#" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-sm text-gray-500">忘记密码？</a>
                    </div>
                </div>
                
                <button class="w-full bg-blue-600 text-white py-2 rounded-lg font-medium shadow-md hover:bg-blue-700 transition">登录</button>
                
                <p class="text-center text-sm text-gray-500 mt-4">
                    没有账号？<a href="#" class="text-blue-600" id="show-register-btn">立即注册</a>
                </p>
            </div>
        </div>

        <!-- 添加设备页面 -->
        <div id="add-device" class="hidden p-4 max-w-md mx-auto">
            <div class="bg-white rounded-xl shadow-md p-6 mb-4">
                <h2 class="text-xl font-semibold mb-4">添加智能轮椅</h2>
                
                <div class="text-center py-8">
                    <div class="w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-bluetooth text-blue-600 text-3xl"></i>
                    </div>
                    <p class="text-gray-700 mb-6">正在搜索附近的智能轮椅设备...</p>
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                </div>
                
                <div class="border border-gray-200 rounded-lg p-4 mb-4">
                    <div class="flex items-center">
                        <div class="bg-blue-100 rounded-full p-3 mr-3">
                            <i class="fas fa-wheelchair text-blue-600"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-medium">Orion-Wheelchair-A002</h3>
                            <p class="text-sm text-gray-500">智能轮椅设备</p>
                        </div>
                        <button class="bg-blue-600 text-white px-4 py-1 rounded-full text-sm" id="connect-device-btn">连接</button>
                    </div>
                </div>
                
                <p class="text-sm text-gray-500 mb-4">
                    请确保智能轮椅设备已开启并处于蓝牙配对模式
                </p>
                
                <button class="w-full border border-gray-300 text-gray-700 py-2 rounded-lg font-medium mt-4" id="refresh-devices-btn">
                    手动刷新设备列表
                </button>
            </div>
        </div>

        <!-- 配置Wi-Fi页面 -->
        <div id="wifi-setup" class="hidden p-4 max-w-md mx-auto">
            <div class="bg-white rounded-xl shadow-md p-6 mb-4">
                <h2 class="text-xl font-semibold mb-4">配置Wi-Fi</h2>
                
                <p class="text-gray-700 mb-4">
                    请为您的智能轮椅设备配置Wi-Fi连接
                </p>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Wi-Fi名称</label>
                    <input type="text" class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="请输入Wi-Fi名称">
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Wi-Fi密码</label>
                    <input type="password" class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="请输入Wi-Fi密码">
                </div>
                
                <button class="w-full bg-blue-600 text-white py-2 rounded-lg font-medium shadow-md hover:bg-blue-700 transition" id="confirm-wifi-btn">确认配置</button>
            </div>
        </div>

        <!-- 添加成功页面 -->
        <div id="device-success" class="hidden p-4 max-w-md mx-auto">
            <div class="bg-white rounded-xl shadow-md p-6 mb-4 text-center">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-check text-green-600 text-3xl"></i>
                </div>
                <h2 class="text-xl font-semibold mb-2">设备添加成功</h2>
                <p class="text-gray-700 mb-6">
                    您的智能轮椅设备已成功连接到家庭网络
                </p>
                
                <div class="border border-gray-200 rounded-lg p-4 mb-6">
                    <div class="flex items-center">
                        <div class="bg-blue-100 rounded-full p-3 mr-3">
                            <i class="fas fa-wheelchair text-blue-600"></i>
                        </div>
                        <div class="flex-1 text-left">
                            <h3 class="font-medium">Orion-Wheelchair-A002</h3>
                            <p class="text-sm text-green-600">已连接</p>
                        </div>
                    </div>
                </div>
                
                <button class="w-full bg-blue-600 text-white py-2 rounded-lg font-medium shadow-md hover:bg-blue-700 transition" id="go-to-device-status-btn">前往设备状态</button>
            </div>
        </div>

        <!-- 远程控制页面 -->
        <div id="control" class="hidden p-4 max-w-md mx-auto">
            <div class="bg-white rounded-xl shadow-md p-6 mb-4">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center">
                        <button id="control-back-btn" class="text-gray-500 hover:text-gray-700 mr-3">
                            <i class="fas fa-arrow-left text-lg"></i>
                        </button>
                        <h2 class="text-xl font-semibold">远程控制</h2>
                    </div>
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                        <span class="text-sm text-gray-700">已连接</span>
                    </div>
                </div>
                
                <div class="mb-8 joystick-container">
                    <div class="directions">
                        <div class="direction up"><i class="fas fa-chevron-up"></i></div>
                        <div class="direction right"><i class="fas fa-chevron-right"></i></div>
                        <div class="direction down"><i class="fas fa-chevron-down"></i></div>
                        <div class="direction left"><i class="fas fa-chevron-left"></i></div>
                    </div>
                    <div class="joystick">
                        <div class="w-full h-full rounded-full flex items-center justify-center">
                            <div class="w-4 h-4 bg-white rounded-full"></div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <button class="w-full bg-yellow-500 text-white py-3 rounded-lg font-medium">
                        <i class="fas fa-lock mr-2"></i> 远程锁车
                    </button>
                </div>
                
                <div class="border-t border-gray-200 pt-4">
                    <h3 class="font-medium text-gray-700 mb-2">档位调节</h3>
                    <div class="relative mb-2">
                        <div class="flex justify-between mb-1">
                            <span class="text-xs text-gray-500">低速</span>
                            <span class="text-xs text-gray-500">高速</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <button class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 focus:outline-none hover:bg-gray-300" id="decrease-level">
                                <i class="fas fa-minus"></i>
                            </button>
                            <div class="flex-1 px-4">
                                <div class="w-full h-2 bg-gray-200 rounded-full">
                                    <div class="h-full bg-blue-600 rounded-full" style="width: 60%" id="level-indicator"></div>
                                </div>
                                <div class="flex justify-between mt-1">
                                    <span class="text-xs">LV1</span>
                                    <span class="text-xs">LV2</span>
                                    <span class="text-xs font-bold text-blue-600">LV3</span>
                                    <span class="text-xs">LV4</span>
                                    <span class="text-xs">LV5</span>
                                </div>
                            </div>
                            <button class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 focus:outline-none hover:bg-gray-300" id="increase-level">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-gray-100 rounded-lg p-3 mt-2 flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-tachometer-alt text-gray-500 mr-2"></i>
                            <span class="text-sm text-gray-700">当前车速</span>
                        </div>
                        <div class="text-lg font-bold text-blue-600" id="current-speed">2.5 km/h</div>
                    </div>
                </div>
                
                <!-- 实时视频窗口 -->
                <div class="mt-4 border-t border-gray-200 pt-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-medium text-gray-700">实时画面</h3>
                        <div class="flex items-center">
                            <div class="w-2 h-2 bg-red-500 rounded-full mr-1 pulse-animation"></div>
                            <span class="text-xs text-red-500">实时</span>
                        </div>
                    </div>
                    <div class="rounded-lg overflow-hidden relative bg-gray-900 aspect-video">
                        <div id="video-placeholder" class="flex items-center justify-center h-full">
                            <p class="text-gray-400 text-sm">正在加载视频...</p>
                        </div>
                        <video id="remote-video" class="w-full h-full object-cover" autoplay playsinline muted></video>
                        <div class="absolute bottom-2 right-2 flex">
                            <button id="toggle-fullscreen" class="bg-black bg-opacity-50 text-white rounded-full p-2 mr-2">
                                <i class="fas fa-expand"></i>
                            </button>
                            <button id="toggle-mic" class="bg-black bg-opacity-50 text-white rounded-full p-2">
                                <i class="fas fa-microphone-slash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <div class="text-xs text-gray-500">720p | 25fps</div>
                        <div class="flex items-center">
                            <span class="text-xs text-gray-500 mr-2">画质：</span>
                            <select class="text-xs border rounded px-1 py-0.5">
                                <option>高清</option>
                                <option selected>标清</option>
                                <option>流畅</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 状态查询页面 -->
        <div id="device-status" class="hidden p-4 max-w-md mx-auto bg-gradient-to-b from-purple-50 to-blue-50 min-h-screen">
            <div class="flex justify-between items-center mb-4 px-2">
                <button class="text-left" id="device-selector-btn">
                    <div class="flex items-center">
                        <h2 class="text-xl font-semibold mr-2">智能轮椅</h2>
                        <i class="fas fa-chevron-down text-gray-400 text-sm"></i>
                    </div>
                    <p class="text-sm text-gray-500 mt-1" id="current-device-name">CM-6001</p>
                </button>
                <!-- 设备详情按钮 -->
                <button id="show-device-details-btn" class="text-gray-400 text-sm p-1">
                    <i class="fas fa-info-circle"></i>
                </button>
            </div>
            
            <!-- 快捷控制按钮 -->
            <div class="mb-4">
                <!-- 功能按钮横向滚动：按钮加大，超出一屏可水平滑动 -->
                <div class="flex gap-3 overflow-x-auto -mx-1 px-1" style="-webkit-overflow-scrolling: touch;">
                    <button id="route-navigation-btn" class="shrink-0 bg-orange-500 text-white px-4 py-3 rounded-lg font-medium flex flex-col items-center justify-center shadow-sm text-sm min-w-[104px]">
                        <i class="fas fa-route mb-1 text-base"></i>
                        <span>路线导航</span>
                    </button>
                    <button id="go-charging-btn" class="shrink-0 bg-green-600 text-white px-4 py-3 rounded-lg font-medium flex flex-col items-center justify-center shadow-sm text-sm min-w-[104px]">
                        <i class="fas fa-charging-station mb-1 text-base"></i>
                        <span>去充电</span>
                    </button>
                    <button id="summon-wheelchair-btn" class="shrink-0 bg-purple-600 text-white px-4 py-3 rounded-lg font-medium flex flex-col items-center justify-center shadow-sm text-sm min-w-[104px]">
                        <i class="fas fa-hand-paper mb-1 text-base"></i>
                        <span>召唤</span>
                    </button>
                    <button id="remote-control-btn" class="shrink-0 bg-blue-600 text-white px-4 py-3 rounded-lg font-medium flex flex-col items-center justify-center shadow-sm text-sm min-w-[104px]">
                        <i class="fas fa-gamepad mb-1 text-base"></i>
                        <span>远程控制</span>
                    </button>
                    <button id="lock-vehicle-btn" class="shrink-0 bg-gray-700 text-white px-4 py-3 rounded-lg font-medium flex flex-col items-center justify-center shadow-sm text-sm min-w-[104px]">
                        <i class="fas fa-lock mb-1 text-base"></i>
                        <span>锁车</span>
                    </button>
                </div>
            </div>
            
            <!-- 核心状态信息展示区域 -->
            <div class="bg-white rounded-xl shadow-sm p-5 mb-4 text-gray-900 relative overflow-hidden">                
                <!-- 电量和运行状态大卡片 -->
                <div class="mb-4">
                    <!-- 顶部综合状态卡：左侧信息 + 右侧放大轮椅图标 -->
                    <div class="flex items-center justify-between mb-4">
                        <!-- 左侧：电量放大 + 三种状态 -->
                        <div class="flex-1 mr-3">
                            <p class="text-xs text-gray-500 mb-1">电量</p>
                            <div class="flex items-end mb-3">
                                <p id="battery-percentage" class="text-5xl font-extrabold leading-none mr-2">85%</p>
                                <i id="battery-icon" class="fas fa-battery-three-quarters text-green-400 text-2xl"></i>
                            </div>
                            <div class="grid grid-cols-3 gap-2 text-xs">
                                <div class="flex items-center bg-gray-100 rounded-md px-2 py-1">
                                    <i class="fas fa-wifi text-green-600 mr-1"></i>
                                    <span class="text-green-700">在线</span>
                                </div>
                                <div class="flex items-center bg-gray-100 rounded-md px-2 py-1">
                                    <i class="fab fa-bluetooth-b text-blue-600 mr-1"></i>
                                    <span class="text-blue-700">已配对</span>
                                </div>
                                <div class="flex items-center bg-gray-100 rounded-md px-2 py-1">
                                    <i class="fas fa-lock text-gray-500 mr-1"></i>
                                    <span class="text-gray-700">未锁定</span>
                                </div>
                            </div>
                        </div>
                        <!-- 右侧：放大轮椅图标 -->
                        <div class="w-28 h-28 bg-blue-50 rounded-2xl flex items-center justify-center">
                            <i class="fas fa-wheelchair text-blue-400 text-5xl"></i>
                        </div>
                    </div>
                    
                    <!-- 主要指标 -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="text-center bg-gray-50 rounded-lg p-3">
                            <p class="text-sm text-gray-500 mb-2">当前速度</p>
                            <div class="flex items-center justify-center">
                                <i class="fas fa-tachometer-alt text-blue-500 mr-2"></i>
                                <p class="text-xl font-bold text-gray-900" id="current-speed-status">2.5 km/h</p>
                            </div>
                        </div>
                        <div class="text-center bg-gray-50 rounded-lg p-3">
                            <p class="text-sm text-gray-500 mb-2">今日里程</p>
                            <div class="flex items-center justify-center">
                                <i class="fas fa-road text-blue-500 mr-2"></i>
                                <p class="text-xl font-bold text-gray-900" id="today-distance">25 km</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 预计信息 -->
                    <div class="grid grid-cols-2 gap-4 pt-4 border-t border-gray-200">
                        <div class="text-center">
                            <p class="text-xs text-gray-500 mb-1">Estimated Range</p>
                            <div class="flex items-center justify-center">
                                <i class="fas fa-route text-blue-500 mr-2 text-sm"></i>
                                <p class="text-lg font-bold text-blue-600" id="estimated-distance">125 km</p>
                            </div>
                        </div>
                        <div class="text-center">
                            <p class="text-xs text-gray-500 mb-1">Estimated Usage</p>
                            <div class="flex items-center justify-center">
                                <i class="fas fa-clock text-blue-500 mr-2 text-sm"></i>
                                <p class="text-lg font-bold text-blue-600" id="estimated-usage-time">6 hours and 30 minutes</p>
                            </div>
                        </div>
                    </div>
                </div>
                

                
                <!-- 智能地图卡片（室内/室外切换） -->
                <div class="border border-gray-200 rounded-lg p-3 bg-white mb-3">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center">
                            <!-- 地图类型切换按钮 -->
                            <div class="bg-gray-100 rounded-lg p-1 mr-3">
                                <button id="indoor-map-btn" class="px-3 py-1 rounded-md text-xs font-medium transition-all duration-200 bg-blue-600 text-white">
                                    <i class="fas fa-map mr-1"></i>室内
                                </button>
                                <button id="outdoor-map-btn" class="px-3 py-1 rounded-md text-xs font-medium transition-all duration-200 text-gray-400 hover:text-white">
                                    <i class="fas fa-map-marker-alt mr-1"></i>室外
                                </button>
                            </div>
                            <span class="text-sm text-gray-900 hidden" id="map-title">智能地图</span>
                        </div>
                        <div class="flex items-center">
                            <!-- 定位状态 -->
                            <div class="flex items-center mr-3" id="position-status">
                                <div class="w-2 h-2 bg-green-500 rounded-full mr-2 pulse-animation"></div>
                                <span class="text-xs text-green-700" id="position-status-text">定位正常</span>
                            </div>
                            <!-- 导航按钮（仅室外地图显示） -->
                            <button class="navigate-btn hidden" id="navigate-btn">
                                <span>导航前往</span>
                                <i class="fas fa-chevron-right ml-1 text-xs"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 地图容器 -->
                    <div class="relative rounded-lg overflow-hidden" style="height: 200px;" id="unified-map-container">
                        <!-- 室内地图 -->
                        <div id="indoor-map-view" class="absolute inset-0 bg-gray-100">
                            <canvas id="indoor-map-canvas" class="w-full h-full rounded-lg"></canvas>
                            
                            <!-- 轮椅位置标记 -->
                            <div id="indoor-wheelchair-position" class="absolute" style="left: 40%; top: 60%; transform: translate(-50%, -50%);">
                                <div class="w-4 h-4 bg-blue-500 rounded-full relative">
                                    <div class="absolute inset-0 bg-blue-400 rounded-full animate-ping"></div>
                                    <!-- 轮椅方向指示 -->
                                    <div class="absolute top-0 left-1/2 w-0.5 h-3 bg-blue-300 transform -translate-x-1/2 -translate-y-full"></div>
                                </div>
                            </div>
                            
                            <!-- 充电桩位置 -->
                            <div id="charging-home-marker" class="absolute" style="left: 20%; top: 20%; transform: translate(-50%, -50%);">
                                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                <div class="absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full"></div>
                            </div>
                            
                            <!-- 导航路径 -->
                            <svg class="absolute inset-0 w-full h-full" id="indoor-path-svg">
                                <!-- 导航路径将通过JS动态绘制 -->
                            </svg>
                            
                            <!-- 室内定位信息 -->
                            <div class="absolute bottom-2 left-2 bg-white bg-opacity-90 rounded-lg p-2">
                                <div class="text-xs text-gray-800">
                                    <div class="mb-1">
                                        <span class="text-gray-400">当前位置:</span>
                                        <span class="text-gray-900" id="indoor-current-location">客厅区域</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">精度:</span>
                                        <span class="text-green-700" id="indoor-accuracy">±0.5米</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 室外地图 -->
                        <div id="outdoor-map-view" class="absolute inset-0 bg-gray-100 hidden">
                            <!-- 地图背景（模拟） -->
                            <div class="absolute inset-0 opacity-80" id="outdoor-map-background" style="background-image: url('https://api.mapbox.com/styles/v1/mapbox/dark-v10/static/121.4737,31.2304,15,0/350x200?access_token=pk.eyJ1IjoiZXhhbXBsZXVzZXIiLCJhIjoiY2syMDVtbDZ1MG9hdjNvcGJ2YWUzcHNmcyJ9.f1Y4y9cTZxL-tsjNk3hUbA'); background-size: cover;"></div>
                            
                            <!-- 位置标记和精度圆圈 -->
                            <div class="location-marker">
                                <!-- 精度圆圈 -->
                                <div class="accuracy-circle"></div>
                                <!-- 位置标记点 -->
                                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-3 h-3 bg-blue-500 rounded-full"></div>
                            </div>
                            
                            <!-- 室外位置信息 -->
                            <div class="absolute bottom-2 left-2 bg-white bg-opacity-90 rounded-lg p-2" id="outdoor-location-details">
                                <div class="text-xs text-gray-800">
                                    <div class="mb-1">
                                        <span class="text-gray-500">地址:</span>
                                        <span class="text-gray-900" id="device-address">上海市浦东新区张江高科技园区</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <div class="mr-4">
                                            <span class="text-gray-400">更新:</span>
                                            <span class="text-green-700" id="location-update-time">10:23</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-400">GPS精度:</span>
                                            <span class="text-green-700" id="gps-accuracy">5米</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 统一的地图控制按钮 -->
                        <div class="absolute bottom-2 right-2 flex flex-col space-y-1">
                            <button class="w-6 h-6 bg-black bg-opacity-60 text-white rounded flex items-center justify-center text-xs hover:bg-opacity-80" id="map-zoom-in">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="w-6 h-6 bg-black bg-opacity-60 text-white rounded flex items-center justify-center text-xs hover:bg-opacity-80" id="map-zoom-out">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
            </div>

            <!-- 设备详情模态框 -->
            <div id="device-details-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                <div class="bg-white rounded-xl shadow-lg p-5 m-4 max-w-md w-full">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">设备详情</h3>
                        <button id="close-device-details-btn" class="text-gray-500">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <p class="text-xs text-gray-500 mb-1">设备ID</p>
                            <p class="font-medium" data-device-display>A001-28FC9D</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-1">电池健康度</p>
                            <p class="font-medium">96%</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-1">固件版本</p>
                            <p class="font-medium">V2.5.3</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-1">上次连接</p>
                            <p class="font-medium">刚刚</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 设备选择弹窗 -->
            <div id="device-selector-modal" class="hidden fixed inset-0 bg-gradient-to-br from-slate-900 via-purple-950 to-indigo-950 z-50">
                <div class="p-6">
                    <!-- 头部 -->
                    <div class="flex justify-between items-center mb-8">
                        <div class="flex items-center">
                            <i class="fas fa-th text-white text-lg mr-3"></i>
                            <h3 class="text-xl font-medium text-white">全部设备(4)</h3>
                        </div>
                        <div class="flex items-center space-x-4">
                            <button id="add-new-device-btn" class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center text-white hover:bg-opacity-30 transition">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 设备列表 -->
                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <!-- 当前选中设备 -->
                        <div class="device-card bg-white bg-opacity-10 backdrop-blur rounded-2xl p-4 cursor-pointer relative border border-white border-opacity-20 hover:bg-opacity-20 transition" data-device-id="CM-6001">
                            <!-- 选中标记 -->
                            <div class="absolute top-3 right-3 w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-check text-white text-xs"></i>
                            </div>
                            
                            <!-- 设备名称和状态 -->
                            <div class="mb-4">
                                <h4 class="font-medium text-white text-base mb-1">CM-6001</h4>
                                <div class="flex items-center">
                                    <div class="w-2 h-2 bg-green-400 rounded-full mr-2"></div>
                                    <span class="text-sm text-green-300">在线</span>
                                </div>
                            </div>
                            
                            <!-- 设备图标 -->
                            <div class="flex justify-center mb-3">
                                <div class="w-16 h-16 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                                    <svg width="32" height="32" viewBox="0 0 60 60" class="text-white">
                                        <circle cx="20" cy="35" r="8" fill="none" stroke="currentColor" stroke-width="2"/>
                                        <circle cx="40" cy="35" r="8" fill="none" stroke="currentColor" stroke-width="2"/>
                                        <rect x="25" y="20" width="10" height="15" rx="2" fill="currentColor"/>
                                        <rect x="28" y="15" width="4" height="10" rx="1" fill="currentColor"/>
                                        <circle cx="30" cy="25" r="2" fill="currentColor"/>
                                    </svg>
                                </div>
                            </div>
                            
                            <!-- 设置按钮 -->
                            <div class="absolute bottom-3 right-3">
                                <button class="w-6 h-6 text-white text-opacity-60 hover:text-opacity-100 transition">
                                    <i class="fas fa-cog text-sm"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- 其他设备 -->
                        <div class="device-card bg-white bg-opacity-10 backdrop-blur rounded-2xl p-4 cursor-pointer relative border border-white border-opacity-20 hover:bg-opacity-20 transition" data-device-id="CM-6001-Pro-123456">
                            <!-- 设备名称和状态 -->
                            <div class="mb-4">
                                <h4 class="font-medium text-white text-base mb-1">CM-6001 Pro</h4>
                                <div class="flex items-center">
                                    <div class="w-2 h-2 bg-green-400 rounded-full mr-2"></div>
                                    <span class="text-sm text-green-300">在线</span>
                                </div>
                            </div>
                            
                            <!-- 设备图标 -->
                            <div class="flex justify-center mb-3">
                                <div class="w-16 h-16 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                                    <svg width="32" height="32" viewBox="0 0 60 60" class="text-white">
                                        <circle cx="20" cy="40" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
                                        <circle cx="40" cy="40" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
                                        <rect x="22" y="20" width="16" height="20" rx="3" fill="currentColor"/>
                                        <rect x="26" y="12" width="8" height="15" rx="2" fill="currentColor"/>
                                        <circle cx="30" cy="25" r="2" fill="currentColor"/>
                                        <rect x="35" y="30" width="6" height="8" rx="1" fill="currentColor"/>
                                    </svg>
                                </div>
                            </div>
                            
                            <!-- 设置按钮 -->
                            <div class="absolute bottom-3 right-3">
                                <button class="w-6 h-6 text-white text-opacity-60 hover:text-opacity-100 transition">
                                    <i class="fas fa-cog text-sm"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="device-card bg-white bg-opacity-10 backdrop-blur rounded-2xl p-4 cursor-pointer relative border border-white border-opacity-20 hover:bg-opacity-20 transition" data-device-id="CM-6001-Pro-12-2">
                            <!-- 设备名称和状态 -->
                            <div class="mb-4">
                                <h4 class="font-medium text-white text-base mb-1">CM-6001 Pro 2</h4>
                                <div class="flex items-center">
                                    <div class="w-2 h-2 bg-green-400 rounded-full mr-2"></div>
                                    <span class="text-sm text-green-300">在线</span>
                                </div>
                            </div>
                            
                            <!-- 设备图标 -->
                            <div class="flex justify-center mb-3">
                                <div class="w-16 h-16 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                                    <svg width="32" height="32" viewBox="0 0 60 60" class="text-white">
                                        <circle cx="20" cy="40" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
                                        <circle cx="40" cy="40" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
                                        <rect x="22" y="20" width="16" height="20" rx="3" fill="currentColor"/>
                                        <rect x="26" y="12" width="8" height="15" rx="2" fill="currentColor"/>
                                        <circle cx="30" cy="25" r="2" fill="currentColor"/>
                                        <rect x="35" y="30" width="6" height="8" rx="1" fill="currentColor"/>
                                    </svg>
                                </div>
                            </div>
                            
                            <!-- 设置按钮 -->
                            <div class="absolute bottom-3 right-3">
                                <button class="w-6 h-6 text-white text-opacity-60 hover:text-opacity-100 transition">
                                    <i class="fas fa-cog text-sm"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="device-card bg-white bg-opacity-10 backdrop-blur rounded-2xl p-4 cursor-pointer relative border border-white border-opacity-20 opacity-60" data-device-id="CM-6001-Pro-12-3">
                            <!-- 设备名称和状态 -->
                            <div class="mb-4">
                                <h4 class="font-medium text-white text-base mb-1">CM-6001 Pro 3</h4>
                                <div class="flex items-center">
                                    <div class="w-2 h-2 bg-gray-400 rounded-full mr-2"></div>
                                    <span class="text-sm text-gray-300">离线</span>
                                </div>
                            </div>
                            
                            <!-- 设备图标 -->
                            <div class="flex justify-center mb-3">
                                <div class="w-16 h-16 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                                    <svg width="32" height="32" viewBox="0 0 60 60" class="text-white text-opacity-60">
                                        <circle cx="20" cy="40" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
                                        <circle cx="40" cy="40" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
                                        <rect x="22" y="20" width="16" height="20" rx="3" fill="currentColor"/>
                                        <rect x="26" y="12" width="8" height="15" rx="2" fill="currentColor"/>
                                        <circle cx="30" cy="25" r="2" fill="currentColor"/>
                                    </svg>
                                </div>
                            </div>
                            
                            <!-- 设置按钮 -->
                            <div class="absolute bottom-3 right-3">
                                <button class="w-6 h-6 text-white text-opacity-40 hover:text-opacity-60 transition">
                                    <i class="fas fa-cog text-sm"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 底部关闭按钮 -->
                    <div class="flex justify-center">
                        <button id="close-modal-bottom-btn" class="w-12 h-12 bg-black bg-opacity-30 rounded-full flex items-center justify-center text-white hover:bg-opacity-50 transition">
                            <i class="fas fa-times text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 去充电弹窗 -->
            <div id="charging-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                <div class="bg-white rounded-xl shadow-lg p-6 m-4 max-w-sm w-full">
                    <div class="text-center">
                        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-charging-station text-green-600 text-3xl" id="charging-icon"></i>
                        </div>
                        <h3 class="text-lg font-semibold mb-2" id="charging-title">正在前往充电桩</h3>
                        <p class="text-gray-600 mb-4" id="charging-message">轮椅正在自动导航至充电桩位置...</p>
                        
                        <!-- 进度条 -->
                        <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                            <div id="charging-progress" class="bg-green-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        
                        <!-- 状态信息 -->
                        <div class="text-sm text-gray-500 mb-4">
                            <div class="flex justify-between">
                                <span>距离充电桩:</span>
                                <span id="charging-distance">15米</span>
                            </div>
                            <div class="flex justify-between">
                                <span>预计时间:</span>
                                <span id="charging-eta">30秒</span>
                            </div>
                        </div>
                        
                        <button id="cancel-charging-btn" class="w-full bg-red-500 text-white py-2 rounded-lg font-medium">
                            取消充电
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 召唤弹窗 -->
            <div id="summon-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                <div class="bg-white rounded-xl shadow-lg p-6 m-4 max-w-sm w-full">
                    <div class="text-center">
                        <div class="w-20 h-20 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-hand-paper text-purple-600 text-3xl" id="summon-icon"></i>
                        </div>
                        <h3 class="text-lg font-semibold mb-2" id="summon-title">选择目的地</h3>
                        <p class="text-gray-600 mb-4" id="summon-message">请选择您希望轮椅前往的位置</p>
                        
                        <!-- 目的地选择 -->
                        <div id="destination-selection" class="space-y-2 mb-4">
                            <button class="destination-btn w-full bg-gray-100 hover:bg-gray-200 p-3 rounded-lg text-left transition" data-destination="客厅">
                                <div class="flex items-center">
                                    <i class="fas fa-couch text-blue-600 mr-3"></i>
                                    <div>
                                        <div class="font-medium">客厅</div>
                                        <div class="text-sm text-gray-500">距离约8米</div>
                                    </div>
                                </div>
                            </button>
                            <button class="destination-btn w-full bg-gray-100 hover:bg-gray-200 p-3 rounded-lg text-left transition" data-destination="卧室">
                                <div class="flex items-center">
                                    <i class="fas fa-bed text-green-600 mr-3"></i>
                                    <div>
                                        <div class="font-medium">卧室</div>
                                        <div class="text-sm text-gray-500">距离约12米</div>
                                    </div>
                                </div>
                            </button>
                            <button class="destination-btn w-full bg-gray-100 hover:bg-gray-200 p-3 rounded-lg text-left transition" data-destination="书房">
                                <div class="flex items-center">
                                    <i class="fas fa-book text-purple-600 mr-3"></i>
                                    <div>
                                        <div class="font-medium">书房</div>
                                        <div class="text-sm text-gray-500">距离约15米</div>
                                    </div>
                                </div>
                            </button>
                            <button class="destination-btn w-full bg-gray-100 hover:bg-gray-200 p-3 rounded-lg text-left transition" data-destination="厨房">
                                <div class="flex items-center">
                                    <i class="fas fa-utensils text-orange-600 mr-3"></i>
                                    <div>
                                        <div class="font-medium">厨房</div>
                                        <div class="text-sm text-gray-500">距离约10米</div>
                                    </div>
                                </div>
                            </button>
                        </div>
                        
                        <!-- 导航进度 (隐藏) -->
                        <div id="navigation-progress" class="hidden">
                            <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                                <div id="navigation-progress-bar" class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            
                            <div class="text-sm text-gray-500 mb-4">
                                <div class="flex justify-between">
                                    <span>距离目的地:</span>
                                    <span id="navigation-distance">8米</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>预计时间:</span>
                                    <span id="navigation-eta">20秒</span>
                                </div>
                            </div>
                        </div>
                        
                        <button id="cancel-summon-btn" class="w-full bg-gray-500 text-white py-2 rounded-lg font-medium">
                            取消召唤
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 定位异常警告弹窗 -->
            <div id="positioning-error-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                <div class="bg-white rounded-xl shadow-lg p-6 m-4 max-w-sm w-full">
                    <div class="text-center">
                        <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-exclamation-triangle text-red-600 text-3xl"></i>
                        </div>
                        <h3 class="text-lg font-semibold mb-2 text-red-700" id="positioning-error-title">定位异常</h3>
                        <p class="text-gray-600 mb-4" id="positioning-error-message">轮椅当前定位不准确或不在已知路径上，无法执行该操作。</p>
                        
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-yellow-600 mt-1 mr-2"></i>
                                <div class="text-sm text-yellow-700">
                                    <p class="font-medium mb-1">建议操作:</p>
                                    <ul class="text-left space-y-1" id="positioning-error-suggestions">
                                        <li>• 确保轮椅在室内地图覆盖范围内</li>
                                        <li>• 将轮椅移动到充电桩上</li>
                                        <li>• 然后重新校准轮椅位置</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button id="recalibrate-btn" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-medium">
                                重新校准
                            </button>
                            <button id="close-positioning-error-btn" class="flex-1 bg-gray-500 text-white py-2 rounded-lg font-medium">
                                关闭
                            </button>
                        </div>
                    </div>
                </div>
                        </div>
        </div>
        
        <!-- 通用APP风格弹窗 -->
        <div id="app-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white rounded-2xl shadow-xl m-4 max-w-sm w-full modal-content">
                <!-- 弹窗头部 -->
                <div class="p-6 pb-2">
                    <h3 class="text-lg font-semibold text-gray-900 text-center" id="modal-title">提示</h3>
                </div>
                
                <!-- 弹窗内容 -->
                <div class="px-6 pb-4">
                                            <p class="text-gray-600 text-left leading-relaxed" id="modal-message"></p>
                    
                    <!-- 输入框 (prompt类型时显示) -->
                    <div id="modal-input-container" class="hidden mt-4">
                        <input type="text" id="modal-input" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="请输入内容">
                        
                        <!-- 推荐选项 -->
                        <div id="modal-suggestions" class="hidden mt-3">
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                                    <span class="text-sm font-medium text-yellow-800" id="suggestions-title">推荐位置</span>
                                </div>
                                <div class="space-y-2" id="suggestions-content">
                                    <div class="suggestion-item cursor-pointer text-sm text-gray-700 hover:text-blue-600 transition" data-value="房门口">• 房门口、走廊入口等开阔地点</div>
                                    <div class="suggestion-item cursor-pointer text-sm text-gray-700 hover:text-blue-600 transition" data-value="客厅中央">• 客厅中央、餐厅中央等空旷区域</div>
                                    <div class="suggestion-item cursor-pointer text-sm text-gray-700 hover:text-blue-600 transition" data-value="各房间的连接通道处">• 各房间的连接通道处</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 弹窗按钮 -->
                <div class="flex border-t border-gray-200">
                    <button id="modal-cancel" class="flex-1 py-4 text-gray-600 font-medium hover:bg-gray-50 transition">取消</button>
                    <div class="w-px bg-gray-200"></div>
                    <button id="modal-confirm" class="flex-1 py-4 text-blue-600 font-medium hover:bg-blue-50 transition">确定</button>
                </div>
            </div>
        </div>
        
        <!-- 我的页面 -->
        <div id="profile" class="hidden p-4 max-w-md mx-auto">
            <div class="bg-white rounded-xl shadow-md p-6 mb-4">
                <div class="flex items-center mb-6">
                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mr-4">
                        <i class="fas fa-user text-blue-600 text-2xl"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-semibold">张先生</h2>
                        <p class="text-gray-500">家庭管理员</p>
                    </div>
                </div>
                
                <div class="border-t border-gray-200 pt-4">
                    <a href="family-members.html" class="flex items-center justify-between py-3 border-b border-gray-100">
                        <div class="flex items-center">
                            <i class="fas fa-users text-gray-500 w-6"></i>
                            <span class="ml-2">家庭成员管理</span>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                    </a>
                    <a href="emergency-contacts.html" class="flex items-center justify-between py-3 border-b border-gray-100">
                        <div class="flex items-center">
                            <i class="fas fa-phone-alt text-gray-500 w-6"></i>
                            <span class="ml-2">紧急联系人</span>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                    </a>
                    <a href="#" id="map-management-btn" class="flex items-center justify-between py-3 border-b border-gray-100">
                        <div class="flex items-center">
                            <i class="fas fa-map text-gray-500 w-6"></i>
                            <span class="ml-2">地图管理</span>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                    </a>
                    <a href="#" class="flex items-center justify-between py-3 border-b border-gray-100">
                        <div class="flex items-center">
                            <i class="fas fa-cog text-gray-500 w-6"></i>
                            <span class="ml-2">设置</span>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                    </a>
                    <a href="#" class="flex items-center justify-between py-3 border-b border-gray-100">
                        <div class="flex items-center">
                            <i class="fas fa-bell text-gray-500 w-6"></i>
                            <span class="ml-2">通知设置</span>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                    </a>
                    <a href="#" class="flex items-center justify-between py-3 border-b border-gray-100">
                        <div class="flex items-center">
                            <i class="fas fa-shield-alt text-gray-500 w-6"></i>
                            <span class="ml-2">隐私设置</span>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                    </a>
                    <a href="#" id="app-update-btn" class="flex items-center justify-between py-3 border-b border-gray-100">
                        <div class="flex items-center">
                            <i class="fas fa-mobile-alt text-gray-500 w-6"></i>
                            <span class="ml-2">APP版本更新</span>
                        </div>
                        <span class="text-xs text-green-500" id="app-version-status">v2.1.3</span>
                    </a>
                    <a href="#" id="firmware-update-btn" class="flex items-center justify-between py-3 border-b border-gray-100">
                        <div class="flex items-center">
                            <i class="fas fa-microchip text-gray-500 w-6"></i>
                            <span class="ml-2">轮椅固件更新</span>
                        </div>
                        <span class="text-xs text-red-500" id="firmware-version-status">有新版本</span>
                    </a>
                    <a href="#" class="flex items-center justify-between py-3">
                        <div class="flex items-center">
                            <i class="fas fa-info-circle text-gray-500 w-6"></i>
                            <span class="ml-2">关于我们</span>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                    </a>
                </div>
                
                <button class="w-full border border-gray-300 text-gray-700 py-2 rounded-lg font-medium mt-6">
                    退出登录
                </button>
            </div>
        </div>

        <!-- APP版本更新页面 -->
        <div id="app-update" class="hidden p-4 max-w-md mx-auto">
            <div class="flex items-center mb-4">
                <button id="app-update-back-btn" class="mr-3 text-gray-600">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <h2 class="text-xl font-semibold">APP版本更新</h2>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-6 mb-4">
                <div class="text-center mb-6">
                    <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-mobile-alt text-blue-600 text-3xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800">检查APP更新</h3>
                    <p class="text-sm text-gray-600 mt-2">检测当前APP版本和最新版本信息</p>
                </div>
                
                <!-- 版本信息 -->
                <div class="space-y-4 mb-6">
                    <div class="flex justify-between items-center p-3 border border-gray-200 rounded-lg">
                        <span class="text-sm text-gray-700">当前版本</span>
                        <span class="text-sm font-semibold text-blue-600" id="current-app-version">v2.1.3</span>
                    </div>
                    
                    <div class="flex justify-between items-center p-3 border border-gray-200 rounded-lg">
                        <span class="text-sm text-gray-700">最新版本</span>
                        <span class="text-sm font-semibold text-green-600" id="latest-app-version">检测中...</span>
                    </div>
                    
                    <div id="app-update-status" class="p-3 bg-gray-50 rounded-lg text-center">
                        <p class="text-sm text-gray-600">正在检查更新...</p>
                    </div>
                </div>
                
                <!-- 更新内容（如果有新版本时显示） -->
                <div id="app-update-content" class="hidden">
                    <h4 class="font-medium text-gray-800 mb-3">更新内容</h4>
                    <div class="bg-blue-50 rounded-lg p-4 mb-4">
                        <ul class="text-sm text-blue-800 space-y-2" id="app-update-features">
                            <!-- 动态添加更新内容 -->
                        </ul>
                    </div>
                </div>
            </div>
            
            <button id="app-update-action-btn" class="w-full bg-gray-400 text-white py-3 rounded-xl font-medium cursor-not-allowed" disabled>
                检查中...
            </button>
        </div>

        <!-- 轮椅固件更新页面 -->
        <div id="firmware-update" class="hidden p-4 max-w-md mx-auto">
            <div class="flex items-center mb-4">
                <button id="firmware-update-back-btn" class="mr-3 text-gray-600">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <h2 class="text-xl font-semibold">轮椅固件更新</h2>
            </div>
            
            <!-- 设备概览 -->
            <div class="bg-white rounded-xl shadow-md p-4 mb-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">设备概览</h3>
                    <button id="refresh-devices-btn" class="text-purple-600 hover:text-purple-700">
                        <i class="fas fa-sync text-sm"></i>
                    </button>
                </div>
                
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div class="bg-green-50 rounded-lg p-3">
                        <div class="text-lg font-semibold text-green-700" id="connected-devices-count">3</div>
                        <div class="text-xs text-green-600">在线数</div>
                    </div>
                    <div class="bg-orange-50 rounded-lg p-3">
                        <div class="text-lg font-semibold text-orange-700" id="pending-updates-count">2</div>
                        <div class="text-xs text-orange-600">待更新</div>
                    </div>
                    <div class="bg-blue-50 rounded-lg p-3">
                        <div class="text-lg font-semibold text-blue-700" id="total-devices-count">3</div>
                        <div class="text-xs text-blue-600">总设备</div>
                    </div>
                </div>
            </div>
            
            <!-- 设备列表 -->
            <div class="space-y-3" id="wheelchair-devices-list">
                <!-- 设备项将通过JavaScript动态生成 -->
            </div>
            

        </div>
        
        <!-- 固件更新进度弹窗 -->
        <div id="firmware-update-progress-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white rounded-xl shadow-lg p-6 m-4 max-w-sm w-full">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-microchip text-purple-600 text-2xl" id="firmware-progress-icon"></i>
                    </div>
                    <h3 class="text-lg font-semibold">固件更新中</h3>
                    <p class="text-sm text-gray-600 mt-1">请勿断开电源或移动轮椅</p>
                </div>
                
                <!-- 进度条 -->
                <div class="mb-4">
                    <div class="w-full bg-gray-200 rounded-full h-3 mb-2">
                        <div id="firmware-progress-bar" class="bg-purple-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span id="firmware-progress-text" class="text-gray-600">准备中...</span>
                        <span id="firmware-progress-percentage" class="text-purple-600 font-medium">0%</span>
                    </div>
                </div>
                
                <!-- 当前步骤 -->
                <div class="bg-purple-50 rounded-lg p-4 mb-4">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-info-circle text-purple-600 mr-2"></i>
                        <span class="text-sm font-medium text-purple-800">当前状态</span>
                    </div>
                    <p class="text-sm text-purple-700" id="firmware-current-step">正在准备固件更新...</p>
                </div>
                
                <!-- 预计时间 -->
                <div class="text-center">
                    <p class="text-xs text-gray-500">预计剩余时间：<span id="firmware-remaining-time" class="font-medium">5-10分钟</span></p>
                </div>
            </div>
        </div>

        <!-- 导航页面 -->
        <div id="navigation" class="hidden p-4 max-w-md mx-auto pb-20 min-h-screen bg-gray-50">
            <!-- 倒计时页面 -->
            <div id="navigation-countdown" class="text-center">
                <div class="bg-white rounded-xl shadow-md p-6 mt-8">
                    <div class="mb-6">
                        <i class="fas fa-route text-purple-600 text-4xl mb-4"></i>
                        <h2 class="text-xl font-semibold mb-2" id="countdown-title">准备导航</h2>
                        <p class="text-gray-600" id="countdown-message">即将开始前往目的地...</p>
                    </div>
                    
                    <!-- 倒计时数字 -->
                    <div class="mb-8">
                        <div class="w-32 h-32 mx-auto bg-purple-100 rounded-full flex items-center justify-center mb-4">
                            <span id="countdown-number" class="text-6xl font-bold text-purple-600">5</span>
                        </div>
                        <p class="text-gray-500">秒后开始</p>
                    </div>
                </div>
            </div>

            <!-- 导航进度页面和完成页面现在通过JavaScript动态创建 -->
        </div>

                <!-- 发现广场页面 -->
        <div id="voice" class="hidden bg-gradient-to-b from-purple-50 to-blue-50 min-h-screen p-4 pb-20">
            <!-- 页面标题 -->
            <div class="text-center mb-6 mt-4">
                <h1 class="text-2xl font-bold text-gray-800">发现广场</h1>
                <p class="text-sm text-gray-600 mt-1">探索更多智能功能</p>
            </div>
            
            <!-- AI助手人设卡片 -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 text-center">
                <!-- AI头像 -->
                <div class="w-24 h-24 mx-auto mb-4 relative">
                    <div class="w-full h-full bg-gradient-to-br from-pink-400 via-purple-400 to-blue-400 rounded-full flex items-center justify-center">
                        <i class="fas fa-robot text-white text-3xl"></i>
                    </div>
                    <div class="absolute -bottom-1 -right-1 w-8 h-8 bg-green-500 rounded-full border-4 border-white flex items-center justify-center">
                        <i class="fas fa-check text-white text-xs"></i>
                    </div>
                </div>
                
                <!-- AI介绍 -->
                <h3 class="text-xl font-bold text-gray-800 mb-2">智能语音助手小智</h3>
                <p class="text-gray-600 text-sm mb-4 leading-relaxed">您好，我是您的智能轮椅语音助手。我可以回答您的问题，帮助您控制轮椅功能，还能陪您聊天。</p>
                
                <!-- 开始对话按钮 -->
                <button id="start-chat-btn" class="w-full bg-gradient-to-r from-yellow-400 to-orange-400 hover:from-yellow-500 hover:to-orange-500 text-white font-semibold py-3 px-6 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105">
                    开始对话
                </button>
            </div>
            
            <!-- 功能入口网格 -->
            <div class="grid grid-cols-2 gap-4">
                <!-- 电台播放 -->
                <div class="bg-white rounded-xl shadow-md p-4 text-center hover:shadow-lg transition-shadow cursor-pointer">
                    <div class="w-12 h-12 mx-auto mb-3 bg-gradient-to-br from-red-400 to-pink-500 rounded-xl flex items-center justify-center">
                        <i class="fas fa-radio text-white text-xl"></i>
                    </div>
                    <h4 class="font-semibold text-gray-800 text-sm mb-1">音乐电台</h4>
                    <p class="text-xs text-gray-500">放松身心</p>
                </div>
                
                <!-- 天气查询 -->
                <div class="bg-white rounded-xl shadow-md p-4 text-center hover:shadow-lg transition-shadow cursor-pointer">
                    <div class="w-12 h-12 mx-auto mb-3 bg-gradient-to-br from-blue-400 to-cyan-500 rounded-xl flex items-center justify-center">
                        <i class="fas fa-cloud-sun text-white text-xl"></i>
                    </div>
                    <h4 class="font-semibold text-gray-800 text-sm mb-1">天气查询</h4>
                    <p class="text-xs text-gray-500">实时天气</p>
                </div>
                
                <!-- 路线导航 -->
                <div class="bg-white rounded-xl shadow-md p-4 text-center hover:shadow-lg transition-shadow cursor-pointer" id="route-navigation-btn">
                    <div class="w-12 h-12 mx-auto mb-3 bg-gradient-to-br from-green-400 to-emerald-500 rounded-xl flex items-center justify-center">
                        <i class="fas fa-route text-white text-xl"></i>
                    </div>
                    <h4 class="font-semibold text-gray-800 text-sm mb-1">路线导航</h4>
                    <p class="text-xs text-gray-500">智能路径</p>
                </div>
                
                <!-- 生活助手 -->
                <div class="bg-white rounded-xl shadow-md p-4 text-center hover:shadow-lg transition-shadow cursor-pointer">
                    <div class="w-12 h-12 mx-auto mb-3 bg-gradient-to-br from-purple-400 to-indigo-500 rounded-xl flex items-center justify-center">
                        <i class="fas fa-life-ring text-white text-xl"></i>
                    </div>
                    <h4 class="font-semibold text-gray-800 text-sm mb-1">生活助手</h4>
                    <p class="text-xs text-gray-500">贴心服务</p>
                </div>
            </div>
        </div>

        <!-- 语音对话页面 -->
        <div id="voice-chat" class="hidden fixed inset-0 bg-gray-50 z-50">
            <!-- 顶部导航栏 - 固定在最顶部 -->
            <div class="fixed top-0 left-0 right-0 flex items-center p-4 bg-white border-b border-gray-100 z-10">
                <button id="voice-chat-back-btn" class="mr-3 text-gray-600 hover:text-gray-800 active:text-gray-900">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <div class="flex-1">
                    <h2 class="text-lg font-semibold text-center">AI Assistant</h2>
                </div>
                <button id="history-btn" class="text-gray-600 hover:text-gray-800 active:text-gray-900">
                    <i class="fas fa-history text-lg"></i>
                </button>
            </div>
            
            <!-- 连接状态 - 固定在顶部导航下方 -->
            <div class="fixed top-16 left-0 right-0 flex items-center justify-center py-3 bg-white border-b border-gray-50 z-10">
                <div class="flex items-center bg-green-50 px-3 py-1 rounded-full">
                    <div class="w-2 h-2 bg-green-500 rounded-full mr-2 pulse-animation"></div>
                    <span class="text-xs text-green-700">Today 14:30</span>
                </div>
            </div>

            <!-- 对话历史区域 - 可滚动，但不影响顶部固定元素 -->
            <div id="conversation-container" class="absolute top-28 bottom-32 left-0 right-0 overflow-y-auto px-4 py-4">
                <div class="space-y-4 max-w-md mx-auto" id="demo-conversation-list">
                    <!-- 初始助手消息 - 人设话术 -->
                    <div class="flex items-start">
                        <div class="w-8 h-8 bg-gradient-to-br from-pink-400 to-purple-500 rounded-full flex items-center justify-center mr-2 flex-shrink-0">
                            <i class="fas fa-robot text-white text-sm"></i>
                        </div>
                        <div class="bg-white rounded-2xl rounded-tl-none p-3 max-w-[80%] shadow-sm">
                            <p class="text-sm">Hello,  I'm Your Intelligent Voice Assistant Xiaobao. You can chat with me or ask me any questions.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 底部语音控制区域 - 固定在最底部 -->
            <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 z-40">
                <div class="flex flex-col items-center py-4" style="padding-bottom: env(safe-area-inset-bottom, 16px);">
                    <!-- 大圆形语音按钮 -->
                    <button id="voice-btn" class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white shadow-2xl hover:from-blue-600 hover:to-purple-700 active:scale-95 transition-all duration-300 group mb-2">
                        <i class="fas fa-microphone text-2xl group-active:scale-110 transition-transform"></i>
                    </button>
                    <!-- 提示文字 -->
                    <p class="text-xs text-gray-500">Hold to speak</p>
                </div>
            </div>
            
            <!-- 语音识别指示器 (默认隐藏) -->
            <div id="voice-indicator" class="hidden fixed inset-0 bg-black bg-opacity-30 z-[60] flex items-center justify-center">
                <div class="bg-white rounded-2xl p-6 shadow-2xl text-center max-w-xs mx-4">
                    <div class="flex justify-center mb-4">
                        <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center relative">
                            <i class="fas fa-microphone text-blue-500 text-3xl"></i>
                            <div class="absolute inset-0 border-4 border-blue-300 rounded-full animate-pulse"></div>
                            <div class="absolute inset-0 flex justify-center items-center">
                                <div class="voice-wave">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p class="text-lg text-gray-800 font-medium mb-2">正在聆听...</p>
                    <p id="voice-text" class="text-sm text-gray-500 italic">请开始说话</p>
                </div>
            </div>
        </div>

        <!-- 户外导航 - 目的地输入页面 -->
        <div id="outdoor-navigation-destination" class="hidden fixed inset-0 bg-gray-50 z-50">
            <!-- 顶部导航栏 -->
            <div class="fixed top-0 left-0 right-0 flex items-center p-4 bg-white border-b border-gray-100 z-10">
                <button id="destination-back-btn" class="mr-3 text-gray-600 hover:text-gray-800 active:text-gray-900">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <div class="flex-1">
                    <h2 class="text-lg font-semibold text-center">户外导航</h2>
                </div>
                <div class="w-8"></div>
            </div>
            
            <!-- 内容区域 -->
            <div class="pt-16 pb-8 px-4 h-full overflow-y-auto">
                <div class="max-w-md mx-auto">
                    <!-- 导航图标和说明 -->
                    <div class="text-center mb-8">
                        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-route text-green-500 text-3xl"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">请输入目的地</h3>
                        <p class="text-gray-600 text-sm">支持语音输入或手动输入您想去的地方</p>
                    </div>
                    
                    <!-- 输入方式选择 -->
                    <div class="bg-white rounded-xl shadow-md p-4 mb-6">
                        <div class="flex space-x-4 mb-4">
                            <button id="voice-input-tab" class="flex-1 py-2 px-4 rounded-lg bg-blue-500 text-white text-sm font-medium">
                                <i class="fas fa-microphone mr-2"></i>语音输入
                            </button>
                            <button id="text-input-tab" class="flex-1 py-2 px-4 rounded-lg bg-gray-100 text-gray-700 text-sm font-medium">
                                <i class="fas fa-keyboard mr-2"></i>手动输入
                            </button>
                        </div>
                        
                        <!-- 语音输入区域 -->
                        <div id="voice-input-area" class="text-center">
                            <button id="start-voice-input-btn" class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white shadow-lg hover:shadow-xl active:scale-95 transition-all duration-300 mx-auto mb-4">
                                <i class="fas fa-microphone text-2xl"></i>
                            </button>
                            <p class="text-sm text-gray-600 mb-4">点击开始语音输入</p>
                            <div id="voice-input-result" class="hidden">
                                <div class="bg-gray-50 rounded-lg p-3 mb-4">
                                    <p class="text-sm text-gray-700" id="voice-input-text"></p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 文本输入区域 -->
                        <div id="text-input-area" class="hidden">
                            <div class="relative">
                                <input type="text" id="destination-input" placeholder="例如：朝阳公园、北京站、三里屯..." 
                                       class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <button id="clear-input-btn" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 常用目的地 -->
                    <div class="bg-white rounded-xl shadow-md p-4 mb-6">
                        <h4 class="font-semibold text-gray-800 mb-3">常用目的地</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <button class="common-destination-btn flex items-center p-3 bg-gray-50 rounded-lg hover:bg-blue-50 transition-colors" data-destination="朝阳公园">
                                <i class="fas fa-tree text-green-500 mr-3"></i>
                                <span class="text-sm">朝阳公园</span>
                            </button>
                            <button class="common-destination-btn flex items-center p-3 bg-gray-50 rounded-lg hover:bg-blue-50 transition-colors" data-destination="北京站">
                                <i class="fas fa-train text-blue-500 mr-3"></i>
                                <span class="text-sm">北京站</span>
                            </button>
                            <button class="common-destination-btn flex items-center p-3 bg-gray-50 rounded-lg hover:bg-blue-50 transition-colors" data-destination="协和医院">
                                <i class="fas fa-hospital text-red-500 mr-3"></i>
                                <span class="text-sm">协和医院</span>
                            </button>
                            <button class="common-destination-btn flex items-center p-3 bg-gray-50 rounded-lg hover:bg-blue-50 transition-colors" data-destination="三里屯">
                                <i class="fas fa-shopping-bag text-purple-500 mr-3"></i>
                                <span class="text-sm">三里屯</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 确认按钮 -->
                    <button id="confirm-destination-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 px-6 rounded-lg font-medium disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors" disabled>
                        确认目的地
                    </button>
                </div>
            </div>
        </div>

        <!-- 户外导航 - 导航前确认页面 -->
        <div id="outdoor-navigation-confirm" class="hidden fixed inset-0 bg-gray-50 z-50">
            <!-- 顶部导航栏 -->
            <div class="fixed top-0 left-0 right-0 flex items-center p-4 bg-white border-b border-gray-100 z-10">
                <button id="confirm-back-btn" class="mr-3 text-gray-600 hover:text-gray-800 active:text-gray-900">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <div class="flex-1">
                    <h2 class="text-lg font-semibold text-center">导航确认</h2>
                </div>
                <div class="w-8"></div>
            </div>
            
            <!-- 内容区域 -->
            <div class="pt-16 pb-8 px-4 h-full overflow-y-auto">
                <div class="max-w-md mx-auto">
                    <!-- 目的地信息 -->
                    <div class="bg-white rounded-xl shadow-md p-4 mb-4">
                        <div class="flex items-center mb-3">
                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-map-marker-alt text-green-500"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-800">目的地</h3>
                                <p class="text-sm text-gray-600" id="destination-name">朝阳公园</p>
                            </div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-gray-600">预计距离</span>
                                <span class="font-medium" id="estimated-distance">5.2 km</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">预计时间</span>
                                <span class="font-medium" id="estimated-time">25 分钟</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 电量评估 -->
                    <div class="bg-white rounded-xl shadow-md p-4 mb-4">
                        <div class="flex items-center mb-3">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-battery-three-quarters text-blue-500"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-800">电量评估</h3>
                                <p class="text-sm text-green-600" id="battery-assessment">电量充足，支持往返</p>
                            </div>
                            <div class="text-right">
                                <span class="text-lg font-bold text-blue-500" id="current-battery">65%</span>
                            </div>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-3">
                            <p class="text-sm text-blue-700" id="battery-details">
                                当前电量预计可支持 43 公里行程
                            </p>
                        </div>
                    </div>
                    
                    <!-- 天气信息 -->
                    <div class="bg-white rounded-xl shadow-md p-4 mb-4">
                        <div class="flex items-center mb-3">
                            <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-sun text-yellow-500" id="weather-icon"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-800">天气状况</h3>
                                <p class="text-sm text-gray-600" id="weather-description">晴朗，适宜出行</p>
                            </div>
                            <div class="text-right">
                                <span class="text-lg font-bold text-gray-700" id="current-temperature">22°C</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-2 text-xs">
                            <div class="bg-gray-50 rounded p-2 text-center">
                                <i class="fas fa-thermometer-half text-orange-500 mb-1"></i>
                                <p class="text-gray-600">体感温度</p>
                                <p class="font-medium" id="feels-like">24°C</p>
                            </div>
                            <div class="bg-gray-50 rounded p-2 text-center">
                                <i class="fas fa-wind text-blue-500 mb-1"></i>
                                <p class="text-gray-600">风速</p>
                                <p class="font-medium" id="wind-speed">3级</p>
                            </div>
                            <div class="bg-gray-50 rounded p-2 text-center">
                                <i class="fas fa-cloud-rain text-blue-600 mb-1"></i>
                                <p class="text-gray-600">降水</p>
                                <p class="font-medium" id="precipitation">0%</p>
                            </div>
                        </div>
                        <div class="mt-3 p-2 bg-green-50 rounded-lg" id="weather-advice">
                            <p class="text-xs text-green-700">
                                <i class="fas fa-check-circle mr-1"></i>
                                天气条件良好，适合外出
                            </p>
                        </div>
                    </div>
                    
                    <!-- 日程冲突检查 -->
                    <div class="bg-white rounded-xl shadow-md p-4 mb-6">
                        <div class="flex items-center mb-3">
                            <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-calendar-alt text-purple-500"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-800">日程提醒</h3>
                                <p class="text-sm text-green-600" id="schedule-status">无冲突</p>
                            </div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-3" id="schedule-details">
                            <p class="text-xs text-green-700">
                                <i class="fas fa-check-circle mr-1"></i>
                                未发现与现有安排冲突，可以开始导航
                            </p>
                        </div>
                    </div>
                    
                    <!-- 开始导航按钮 -->
                    <button id="start-outdoor-navigation-btn" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 px-6 rounded-lg font-medium transition-colors">
                        <i class="fas fa-navigation mr-2"></i>开始导航
                    </button>
                </div>
            </div>
        </div>

        <!-- 户外导航 - 导航页面 (Google Maps风格) -->
        <div id="outdoor-navigation-route" class="hidden fixed inset-0 bg-black z-50">
            <!-- 顶部蓝色指令卡片 -->
            <div class="absolute top-0 left-0 right-0 z-20 pt-6">
                <!-- 主要指令卡片 -->
                <div class="bg-white mx-3 mt-3 rounded-xl shadow-lg overflow-hidden">
                    <!-- 指令头部 -->
                    <div class="flex items-center px-4 py-3 bg-gradient-to-r from-blue-500 to-blue-600">
                        <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-arrow-right text-white text-xl" id="direction-icon"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-white text-base font-medium mb-0.5" id="next-instruction">前方右转</p>
                            <p class="text-blue-100 text-xs" id="next-road">朝阳北路</p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-white" id="distance-to-turn">50</p>
                            <p class="text-blue-100 text-xs">米</p>
                        </div>
                    </div>
                    
                    <!-- 次要信息栏 -->
                    <div class="px-4 py-2 bg-gray-50 border-t">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3 text-xs text-gray-600">
                                <div class="flex items-center">
                                    <i class="fas fa-clock mr-1"></i>
                                    <span id="remaining-time">18分钟</span>
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-route mr-1"></i>
                                    <span id="remaining-distance">4.7公里</span>
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-battery-three-quarters mr-1"></i>
                                    <span id="route-battery">60%</span>
                                </div>
                            </div>
                            <button id="show-route-options" class="text-blue-600 text-xs font-medium">
                                路线选项
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 全屏地图区域 -->
            <div class="absolute inset-0">
                <!-- Leaflet 地图容器 -->
                <div id="route-map-container" class="absolute inset-0 w-full h-full"></div>
                
                <!-- 地图控制按钮 -->
                <div class="absolute right-4 bottom-48 flex flex-col space-y-2 z-10">
                    <button id="map-center-btn" class="w-12 h-12 bg-white rounded-full shadow-lg flex items-center justify-center hover:bg-gray-50 transition-colors">
                        <i class="fas fa-crosshairs text-gray-600"></i>
                    </button>
                </div>
            </div>
            
            <!-- 底部操作栏 (参考高德地图优化版本) -->
            <div class="absolute bottom-0 left-0 right-0 z-20">
                <div class="bg-white border-t border-gray-200 px-5 py-4" style="padding-bottom: env(safe-area-inset-bottom, 20px);">
                    <div class="flex items-center justify-between">
                        <!-- 左侧：语音播报开关 -->
                        <button id="voice-guidance-btn" class="flex items-center justify-center w-12 h-12 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
                            <i class="fas fa-volume-up text-gray-700 text-lg"></i>
                        </button>
                        
                        <!-- 中间：距离和时间信息 -->
                        <div class="flex flex-col items-center">
                            <div class="flex items-center space-x-4 mb-1">
                                <span class="text-xl font-bold text-gray-800" id="bottom-distance">4.7公里</span>
                                <span class="text-xl font-bold text-gray-800" id="bottom-time">18分钟</span>
                            </div>
                            <div class="text-xs text-gray-500" id="bottom-eta">21:09到达</div>
                        </div>
                        
                        <!-- 右侧：结束导航按钮 -->
                        <button id="end-navigation-btn" class="flex items-center justify-center px-4 py-2.5 rounded-lg bg-red-500 hover:bg-red-600 text-white transition-colors">
                            <i class="fas fa-stop text-sm mr-1"></i>
                            <span class="text-sm font-medium">结束导航</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 路线菜单弹窗 -->
            <div id="route-menu-modal" class="hidden absolute inset-0 bg-black bg-opacity-50 z-30 flex items-end">
                <div class="bg-white w-full rounded-t-3xl p-6 transform translate-y-full transition-transform duration-300" id="route-menu-content">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">导航设置</h3>
                        <button id="close-route-menu" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">
                            <i class="fas fa-times text-gray-600"></i>
                        </button>
                    </div>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between py-3 border-b border-gray-100">
                            <div class="flex items-center">
                                <i class="fas fa-volume-up w-6 text-blue-600 mr-3"></i>
                                <span>语音提示</span>
                            </div>
                            <div class="w-12 h-6 bg-blue-600 rounded-full relative">
                                <div class="w-5 h-5 bg-white rounded-full absolute right-0.5 top-0.5"></div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between py-3 border-b border-gray-100">
                            <div class="flex items-center">
                                <i class="fas fa-satellite w-6 text-blue-600 mr-3"></i>
                                <span>卫星视图</span>
                            </div>
                            <div class="w-12 h-6 bg-gray-300 rounded-full relative">
                                <div class="w-5 h-5 bg-white rounded-full absolute left-0.5 top-0.5"></div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between py-3">
                            <div class="flex items-center">
                                <i class="fas fa-moon w-6 text-blue-600 mr-3"></i>
                                <span>夜间模式</span>
                            </div>
                            <div class="w-12 h-6 bg-gray-300 rounded-full relative">
                                <div class="w-5 h-5 bg-white rounded-full absolute left-0.5 top-0.5"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 户外导航 - 到达目的地页面 -->
        <div id="outdoor-navigation-arrived" class="hidden fixed inset-0 bg-gray-50 z-50">
            <div class="flex flex-col items-center justify-center h-full p-4">
                <div class="text-center max-w-md mx-auto">
                    <!-- 成功图标 -->
                    <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-check text-green-500 text-4xl"></i>
                    </div>
                    
                    <!-- 到达信息 -->
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">已到达目的地</h2>
                    <p class="text-lg text-gray-600 mb-1" id="arrived-destination">朝阳公园</p>
                    <p class="text-sm text-gray-500 mb-8" id="arrival-time">14:25 到达</p>
                    
                    <!-- 行程统计 -->
                    <div class="bg-white rounded-xl shadow-md p-6 mb-8 w-full">
                        <h3 class="font-semibold text-gray-800 mb-4 text-center">本次行程</h3>
                        <div class="flex justify-center items-center space-x-12">
                            <div class="text-center">
                                <p class="text-3xl font-bold text-blue-500 mb-1" id="trip-distance">8.1</p>
                                <p class="text-sm text-gray-600">公里</p>
                            </div>
                            <div class="text-center">
                                <p class="text-3xl font-bold text-green-500 mb-1" id="trip-time">37</p>
                                <p class="text-sm text-gray-600">分钟</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 返回按钮 -->
                    <button id="back-to-discovery-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 px-6 rounded-lg font-medium transition-colors">
                        <i class="fas fa-home mr-2"></i>返回发现广场
                    </button>
                </div>
            </div>
        </div>

        <!-- 历史对话查询弹窗 -->
        <div id="history-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white rounded-xl shadow-lg p-4 m-4 max-w-md w-full">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">历史对话记录</h3>
                    <button id="close-history-btn" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="relative flex-grow">
                            <input type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2 pr-10" placeholder="搜索历史对话...">
                            <button class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <button class="ml-2 text-blue-500 text-sm">
                            筛选
                        </button>
                    </div>
                    
                    <!-- 日期分组 -->
                    <div class="border-b border-gray-200 pb-2 mb-3">
                        <p class="text-xs text-gray-500 mb-2">今天</p>
                        
                        <!-- 对话项目 -->
                        <div class="bg-gray-50 hover:bg-gray-100 rounded-lg p-2 mb-2 cursor-pointer">
                            <div class="flex justify-between items-start mb-1">
                                <p class="text-sm font-medium truncate">轮椅电量查询</p>
                                <span class="text-xs text-gray-500">14:30</span>
                            </div>
                            <p class="text-xs text-gray-500 truncate" id="battery-history-text">Your wheelchair's current battery is at 85%, estimated to last 6 hours and 30 minutes, with a driving range of about 25 km.</p>
                        </div>
                        
                        <div class="bg-gray-50 hover:bg-gray-100 rounded-lg p-2 mb-2 cursor-pointer">
                            <div class="flex justify-between items-start mb-1">
                                <p class="text-sm font-medium truncate">速度调整</p>
                                <span class="text-xs text-gray-500">11:15</span>
                            </div>
                            <p class="text-xs text-gray-500 truncate">已将速度调整为3档，当前速度2.5km/h。您可以通过语音指令或控制面板随时调整速度。</p>
                        </div>
                    </div>
                    
                    <!-- 更多日期分组 -->
                    <div class="border-b border-gray-200 pb-2 mb-3">
                        <p class="text-xs text-gray-500 mb-2">昨天</p>
                        
                        <div class="bg-gray-50 hover:bg-gray-100 rounded-lg p-2 mb-2 cursor-pointer">
                            <div class="flex justify-between items-start mb-1">
                                <p class="text-sm font-medium truncate">寻找轮椅</p>
                                <span class="text-xs text-gray-500">18:42</span>
                            </div>
                            <p class="text-xs text-gray-500 truncate">您的轮椅当前位置位于家中客厅区域。已在地图上标记位置并可导航前往。</p>
                        </div>
                        
                        <div class="bg-gray-50 hover:bg-gray-100 rounded-lg p-2 cursor-pointer">
                            <div class="flex justify-between items-start mb-1">
                                <p class="text-sm font-medium truncate">温度调节</p>
                                <span class="text-xs text-gray-500">09:20</span>
                            </div>
                            <p class="text-xs text-gray-500 truncate">座椅温度已设置为26℃，已切换到舒适模式。您可以随时调整温度或更改加热模式。</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between">
                    <button class="text-sm text-gray-500">导出对话</button>
                    <button class="text-sm text-gray-500">清除历史</button>
                </div>
            </div>
        </div>

        <!-- 地图管理页面 -->
        <div id="map-management" class="hidden p-4 max-w-md mx-auto">
            <div class="flex items-center mb-4">
                <button id="map-management-back-btn" class="mr-3 text-gray-600">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <h2 class="text-xl font-semibold">地图管理</h2>
            </div>
            
            <!-- 当前使用的地图 -->
            <div class="mb-4">
                <h3 class="text-sm font-medium text-gray-700 mb-3">当前使用</h3>
                <div class="bg-white rounded-xl shadow-md border-2 border-blue-200 p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                <i class="fas fa-home text-blue-600"></i>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800">家庭地图</h4>
                                <p class="text-sm text-gray-500">最后编辑: 2024-01-15 14:30</p>
                            </div>
                        </div>
                        <div class="relative">
                            <button class="map-menu-btn text-gray-400 hover:text-gray-600" data-map-id="home-map">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div class="map-menu hidden absolute right-0 top-8 bg-white border border-gray-200 rounded-lg shadow-lg z-10 w-32">
                                <button class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-t-lg" onclick="editMap('home-map')">
                                    <i class="fas fa-edit mr-2"></i>编辑
                                </button>
                                <button class="w-full text-left px-3 py-2 text-sm text-red-600 hover:bg-gray-100 rounded-b-lg" onclick="deleteMap('home-map')">
                                    <i class="fas fa-trash mr-2"></i>删除
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-medium">正在使用</span>
                        </div>
                        <div class="flex items-center" id="current-map-status">
                            <div class="w-2 h-2 bg-red-500 rounded-full mr-2 pulse-animation"></div>
                            <span class="text-xs text-red-600">定位异常</span>
                        </div>
                    </div>
                    
                    <!-- 定位异常时显示重新定位按钮 -->
                    <div id="relocate-btn-container" class="mt-3">
                        <button id="relocate-map-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white py-2 rounded-lg text-sm font-medium flex items-center justify-center">
                            <i class="fas fa-crosshairs mr-2"></i>重新定位
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 其他地图 -->
            <div class="mb-4">
                <h3 class="text-sm font-medium text-gray-700 mb-3">其他地图</h3>
                <div class="space-y-3">
                    <div class="bg-white rounded-xl shadow-md border border-gray-200 p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-building text-gray-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-medium text-gray-800">家庭地图2</h4>
                                    <p class="text-sm text-gray-500">最后编辑: 2024-01-10 09:15</p>
                                </div>
                            </div>
                            <div class="relative">
                                <button class="map-menu-btn text-gray-400 hover:text-gray-600" data-map-id="office-map">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <div class="map-menu hidden absolute right-0 top-8 bg-white border border-gray-200 rounded-lg shadow-lg z-10 w-32">
                                    <button class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-t-lg" onclick="editMap('office-map')">
                                        <i class="fas fa-edit mr-2"></i>编辑
                                    </button>
                                    <button class="w-full text-left px-3 py-2 text-sm text-blue-600 hover:bg-gray-100" onclick="switchToMap('office-map')">
                                        <i class="fas fa-toggle-on mr-2"></i>切换使用
                                    </button>
                                    <button class="w-full text-left px-3 py-2 text-sm text-red-600 hover:bg-gray-100 rounded-b-lg" onclick="deleteMap('office-map')">
                                        <i class="fas fa-trash mr-2"></i>删除
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center">
                            <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full">未使用</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 新建地图按钮 -->
            <button id="create-new-map-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-medium flex items-center justify-center mb-4">
                <i class="fas fa-plus mr-2"></i>
                新建地图
            </button>
            
            <!-- 帮助说明 -->
            <div class="bg-blue-50 rounded-xl p-4">
                <div class="flex items-start">
                    <i class="fas fa-info-circle text-blue-600 mt-1 mr-3"></i>
                    <div>
                        <h4 class="font-medium text-blue-800 mb-1">建图小贴士</h4>
                        <p class="text-sm text-blue-700">
                            建图需在室内环境进行，避免阳光直射和反光镜面。建议建图时间控制在30分钟内完成，确保传感器能够准确扫描环境。
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- 地图编辑弹窗 -->
            <div id="edit-map-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                <div class="bg-white rounded-xl shadow-lg p-6 m-4 max-w-sm w-full">
                    <div class="text-center mb-4">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-edit text-blue-600 text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-semibold">编辑地图</h3>
                        <p class="text-sm text-gray-600 mt-1" id="edit-map-name">家庭地图</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">地图名称</label>
                            <input type="text" id="edit-map-name-input" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="输入地图名称">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <button id="cancel-edit-map" class="bg-gray-500 text-white py-2 rounded-lg font-medium">
                                取消
                            </button>
                            <button id="save-edit-map" class="bg-blue-600 text-white py-2 rounded-lg font-medium">
                                保存
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 删除地图确认弹窗 -->
            <div id="delete-map-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                <div class="bg-white rounded-xl shadow-lg p-6 m-4 max-w-sm w-full">
                    <div class="text-center mb-4">
                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-trash text-red-600 text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-red-700">删除地图</h3>
                        <p class="text-sm text-gray-600 mt-2">确定要删除 "<span id="delete-map-name">家庭地图</span>" 吗？</p>
                        <p class="text-xs text-red-500 mt-1">此操作不可撤销</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button id="cancel-delete-map" class="bg-gray-500 text-white py-2 rounded-lg font-medium">
                            取消
                        </button>
                        <button id="confirm-delete-map" class="bg-red-600 text-white py-2 rounded-lg font-medium">
                            删除
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 切换地图确认弹窗 -->
            <div id="switch-map-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                <div class="bg-white rounded-xl shadow-lg p-6 m-4 max-w-sm w-full">
                    <div class="text-center mb-4">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-toggle-on text-green-600 text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-semibold">切换地图</h3>
                        <p class="text-sm text-gray-600 mt-2">切换到 "<span id="switch-map-name">家庭地图2</span>" 作为当前使用的地图？</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button id="cancel-switch-map" class="bg-gray-500 text-white py-2 rounded-lg font-medium">
                            取消
                        </button>
                        <button id="confirm-switch-map" class="bg-green-600 text-white py-2 rounded-lg font-medium">
                            切换
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 重新定位弹窗 -->
            <div id="relocate-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                <div class="bg-white rounded-xl shadow-lg p-6 m-4 max-w-sm w-full">
                    <div class="text-center mb-4">
                        <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-crosshairs text-yellow-600 text-2xl" id="relocate-icon"></i>
                        </div>
                        <h3 class="text-lg font-semibold" id="relocate-title">重新定位</h3>
                        <p class="text-sm text-gray-600 mt-2" id="relocate-message">请将轮椅移动到定位点或充电桩位置</p>
                    </div>
                    
                    <!-- 操作指导动画区域 -->
                    <div id="relocate-guide" class="mb-4">
                        <div class="bg-blue-50 rounded-lg p-4 mb-4">
                            <div class="flex items-center justify-center mb-3">
                                <!-- 轮椅动画 -->
                                <div class="relative">
                                    <div class="w-12 h-12 bg-blue-500 rounded-lg flex items-center justify-center mr-4" id="wheelchair-icon">
                                        <i class="fas fa-wheelchair text-white text-xl"></i>
                                    </div>
                                    <!-- 移动箭头动画 -->
                                    <div class="absolute top-1/2 -right-2 transform -translate-y-1/2">
                                        <div class="flex items-center" id="move-arrow">
                                            <div class="w-8 h-0.5 bg-blue-400 mr-1"></div>
                                            <div class="w-0 h-0 border-l-4 border-l-blue-400 border-t-2 border-t-transparent border-b-2 border-b-transparent"></div>
                                        </div>
                                    </div>
                                </div>
                                <!-- 目标位置 -->
                                <div class="w-12 h-12 bg-green-500 rounded-lg flex items-center justify-center ml-8" id="target-icon">
                                    <i class="fas fa-charging-station text-white text-xl"></i>
                                </div>
                            </div>
                            <div class="text-center">
                                <p class="text-sm font-medium text-blue-800 mb-1">操作步骤</p>
                                <div class="text-xs text-blue-700 space-y-1">
                                    <p id="step-1" class="font-medium">• 1. 手动控制轮椅移动</p>
                                    <p id="step-2" class="text-gray-500">• 2. 移动到充电桩前方1米处</p>
                                    <p id="step-3" class="text-gray-500">• 3. 确保轮椅正对充电桩</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 进度条（校验阶段显示） -->
                    <div id="relocate-progress-section" class="hidden mb-4">
                        <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                            <div id="relocate-progress" class="bg-yellow-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <div class="text-sm text-gray-500 text-center">
                            <span id="relocate-status">正在检测环境...</span>
                        </div>
                    </div>
                    
                    <!-- 按钮区域 -->
                    <div id="relocate-buttons">
                        <button id="confirm-position" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium mb-2">
                            <i class="fas fa-check mr-2"></i>确认已在定位点
                        </button>
                        <button id="cancel-relocate" class="w-full bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg font-medium">
                            取消定位
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 新建地图 - 连接检查页面 -->
        <div id="create-map-check" class="hidden p-4 max-w-md mx-auto">
            <div class="flex items-center mb-4">
                <button id="create-map-check-back-btn" class="mr-3 text-gray-600">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <h2 class="text-xl font-semibold">新建地图</h2>
            </div>
            
            <!-- 进度指示器 -->
            <div class="mb-6">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-medium">1</div>
                    <div class="flex-1 h-0.5 bg-gray-300 mx-2"></div>
                    <div class="w-8 h-8 bg-gray-300 text-gray-500 rounded-full flex items-center justify-center text-sm">2</div>
                    <div class="flex-1 h-0.5 bg-gray-300 mx-2"></div>
                    <div class="w-8 h-8 bg-gray-300 text-gray-500 rounded-full flex items-center justify-center text-sm">3</div>
                </div>
                <div class="flex justify-between mt-2 text-xs text-gray-500">
                    <span>连接检查</span>
                    <span>配置信息</span>
                    <span>开始建图</span>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-6 mb-4">
                <h3 class="text-lg font-semibold mb-4 text-center">连接状态检查</h3>
                
                <!-- 蓝牙连接检查 -->
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                <i class="fab fa-bluetooth-b text-blue-600"></i>
                            </div>
                            <div>
                                <h4 class="font-medium">蓝牙连接</h4>
                                <p class="text-sm text-gray-500">检查与轮椅的蓝牙连接状态</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <div id="bluetooth-status" class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-check text-white text-sm"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- WiFi连接检查 -->
                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-wifi text-green-600"></i>
                            </div>
                            <div>
                                <h4 class="font-medium">网络连接</h4>
                                <p class="text-sm text-gray-500">检查轮椅的网络连接状态</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <div id="wifi-status" class="w-6 h-6 bg-yellow-500 rounded-full flex items-center justify-center">
                                <div class="w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 传感器检查 -->
                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-satellite-dish text-purple-600"></i>
                            </div>
                            <div>
                                <h4 class="font-medium">传感器检查</h4>
                                <p class="text-sm text-gray-500">检查雷达和传感器工作状态</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <div id="sensor-status" class="w-6 h-6 bg-gray-300 rounded-full flex items-center justify-center">
                                <div class="w-2 h-2 bg-gray-500 rounded-full"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 连接状态说明 -->
                <!-- <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-start">
                        <i class="fas fa-info-circle text-gray-500 mt-1 mr-2"></i>
                        <div class="text-sm text-gray-600">
                            <p class="mb-1">正在检查各项连接状态...</p>
                            <p class="text-xs">• 蓝牙连接用于基础控制和状态同步</p>
                            <p class="text-xs">• 网络连接用于实时数据传输和云端同步</p>
                            <p class="text-xs">• 传感器用于环境感知和地图构建</p>
                        </div>
                    </div>
                </div> -->
            </div>
            
            <button id="connection-next-btn" class="w-full bg-gray-400 text-white py-3 rounded-xl font-medium cursor-not-allowed" disabled>
                检查中...
            </button>
        </div>

        <!-- 地图命名页面 -->
        <div id="map-naming" class="hidden p-4 max-w-md mx-auto">
            <div class="flex items-center mb-4">
                <button id="map-naming-back-btn" class="mr-3 text-gray-600">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <h2 class="text-xl font-semibold">新建地图</h2>
            </div>
            
            <!-- 进度指示器 -->
            <div class="mb-6">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-medium">✓</div>
                    <div class="flex-1 h-0.5 bg-blue-600 mx-2"></div>
                    <div class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-medium">2</div>
                    <div class="flex-1 h-0.5 bg-gray-300 mx-2"></div>
                    <div class="w-8 h-8 bg-gray-300 text-gray-500 rounded-full flex items-center justify-center text-sm">3</div>
                </div>
                <div class="flex justify-between mt-2 text-xs text-gray-500">
                    <span>连接检查</span>
                    <span>配置信息</span>
                    <span>开始建图</span>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-6 mb-4">
                <h3 class="text-lg font-semibold mb-6 text-center">配置地图信息</h3>
                
                <!-- 地图命名 -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">地图名称</label>
                    <input type="text" id="map-name-input" class="w-full rounded-lg border border-gray-300 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="请输入地图名称，如：家庭地图">
                    <p class="text-xs text-gray-500 mt-1">建议使用具有标识性的名称，方便后续管理</p>
                </div>
                

                
                <!-- 预估面积 -->
                <!-- <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">预估面积</label>
                    <div class="flex items-center space-x-3">
                        <input type="range" id="area-slider" class="flex-1" min="20" max="500" value="100">
                        <span id="area-value" class="text-lg font-semibold text-blue-600 w-16">100㎡</span>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>20㎡</span>
                        <span>500㎡</span>
                    </div>
                </div> -->
                
                <!-- 建图说明 -->
                <div class="bg-yellow-50 rounded-lg p-4">
                    <div class="flex items-start">
                        <i class="fas fa-lightbulb text-yellow-600 mt-1 mr-2"></i>
                        <div class="text-sm text-yellow-700">
                            <p class="font-medium mb-1">建图小提示</p>
                            <p class="text-xs">建图过程中请缓慢移动轮椅，确保传感器能够准确扫描环境。建议建图时间控制在30分钟内完成。</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <button id="naming-next-btn" class="w-full bg-gray-400 text-white py-3 rounded-xl font-medium cursor-not-allowed" disabled>
                下一步
            </button>
        </div>

        <!-- 环境检测页面 -->
        <div id="environment-check" class="hidden p-4 max-w-md mx-auto">
            <div class="flex items-center mb-4">
                <button id="environment-check-back-btn" class="mr-3 text-gray-600">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <h2 class="text-xl font-semibold">环境检测</h2>
            </div>
            
            <!-- 进度指示器 -->
            <div class="mb-6">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-medium">✓</div>
                    <div class="flex-1 h-0.5 bg-blue-600 mx-2"></div>
                    <div class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-medium">✓</div>
                    <div class="flex-1 h-0.5 bg-blue-600 mx-2"></div>
                    <div class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-medium">3</div>
                </div>
                <div class="flex justify-between mt-2 text-xs text-gray-500">
                    <span>连接检查</span>
                    <span>配置信息</span>
                    <span>开始建图</span>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-6 mb-4">
                <h3 class="text-lg font-semibold mb-6 text-center">请确认建图环境条件</h3>
                
                <!-- 手动确认（主要部分） -->
                <div class="border border-blue-200 rounded-lg p-5 mb-6 bg-blue-50">
                    <h4 class="font-semibold text-blue-800 mb-4 flex items-center">
                        <i class="fas fa-check-circle mr-2"></i>
                        环境确认清单
                    </h4>
                    <div class="space-y-4">
                        <label class="flex items-center">
                            <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-600 rounded" id="indoor-confirm">
                            <span class="ml-3 text-sm font-medium">我确认当前处于室内环境</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-600 rounded" id="space-confirm">
                            <span class="ml-3 text-sm font-medium">确认轮椅有足够的活动空间</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-600 rounded" id="obstacle-confirm">
                            <span class="ml-3 text-sm font-medium">已清理主要通道上的障碍物</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-600 rounded" id="safety-confirm">
                            <span class="ml-3 text-sm font-medium">环境安全，无危险区域</span>
                        </label>
                    </div>
                </div>
                
                <!-- 环境检测结果（仅在检测到室外环境时显示） -->
                <div id="environment-detection-section" class="mb-4 hidden">
                    <h4 class="font-medium text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-robot mr-2"></i>
                        系统自动检测（参考）
                    </h4>
                    
                    <!-- 非室内环境警告 -->
                    <div id="outdoor-warning" class="p-4 bg-red-50 border-2 border-red-200 rounded-lg">
                        <div class="flex items-start">
                            <i class="fas fa-exclamation-triangle text-red-600 text-xl mr-3 mt-1"></i>
                            <div>
                                <h5 class="font-semibold text-red-800 mb-2">⚠️ 检测到可能的非室内环境</h5>
                                <p class="text-sm text-red-700 mb-2">
                                    系统检测到当前环境可能不适合建图，请确认您是否在室内环境中。
                                </p>
                                <div class="text-xs text-red-600 space-y-1">
                                    <p>• 建图功能设计用于室内环境</p>
                                    <p>• 室外环境可能影响传感器精度</p>
                                    <p>• 强烈建议在室内进行建图操作</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 重要提醒 -->
                <!-- <div class="bg-red-50 rounded-lg p-4">
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-triangle text-red-600 mt-1 mr-2"></i>
                        <div class="text-sm text-red-700">
                            <p class="font-medium mb-1">重要提醒</p>
                            <p class="text-xs">建图过程中轮椅将自主移动，请确保：</p>
                            <ul class="text-xs mt-2 space-y-1 ml-4">
                                <li>• 周围没有人员或宠物</li>
                                <li>• 地面平整，无积水或杂物</li>
                                <li>• 您能够随时通过遥控器停止轮椅</li>
                            </ul>
                        </div>
                    </div>
                </div> -->
            </div>
            
            <button id="environment-next-btn" class="w-full bg-gray-400 text-white py-3 rounded-xl font-medium cursor-not-allowed" disabled>
                环境检测通过，继续
            </button>
        </div>

        <!-- 建图注意事项页面 -->
        <div id="mapping-precautions" class="hidden p-4 max-w-md mx-auto">
            <div class="flex items-center mb-4">
                <button id="precautions-back-btn" class="mr-3 text-gray-600">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <h2 class="text-xl font-semibold">建图须知</h2>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-6 mb-4">
                <div class="text-center mb-6">
                    <div class="w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-exclamation-triangle text-orange-600 text-3xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800">建图前请仔细阅读以下内容</h3>
                    <p class="text-sm text-gray-600 mt-2">请您仔细阅读，并在最后勾选确认。</p>
                </div>
                
                <!-- 核心风险提示 -->
                <div class="space-y-6 mb-6">
                    <!-- 1. 清理路径障碍物 -->
                    <div class="border border-orange-200 rounded-xl bg-orange-50 shadow-sm overflow-hidden">
                        <div class="p-5">
                            <h4 class="font-bold text-orange-800 text-lg mb-4 text-center">1. 清理路径上的障碍物</h4>
                            <div class="flex items-center justify-between">
                                <div class="flex-1 pr-4">
                                    <p class="text-sm text-orange-700 leading-relaxed">请把轮椅行驶路径上的杂物（比如小凳子、地垫、玩具等）清理干净。建图过程中，也请保持路径畅通，避免轮椅刮擦或碰撞家具。</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <svg width="120" height="90" viewBox="0 0 120 90" xmlns="http://www.w3.org/2000/svg">
                                        <!-- 地面 -->
                                        <rect x="0" y="75" width="120" height="15" fill="#fed7aa"/>
                                        
                                        <!-- 障碍物：小凳子 -->
                                        <rect x="60" y="65" width="12" height="10" fill="#8b4513"/>
                                        <rect x="62" y="55" width="8" height="10" fill="#a0522d"/>
                                        
                                        <!-- 障碍物：玩具车 -->
                                        <rect x="80" y="68" width="15" height="7" rx="2" fill="#ef4444"/>
                                        <circle cx="83" cy="73" r="2" fill="#374151"/>
                                        <circle cx="92" cy="73" r="2" fill="#374151"/>
                                        
                                        <!-- 障碍物：地垫 -->
                                        <ellipse cx="45" cy="73" rx="8" ry="3" fill="#7c3aed"/>
                                        
                                        <!-- 轮椅 -->
                                        <circle cx="15" cy="70" r="8" fill="#4b5563" stroke="#374151" stroke-width="2"/>
                                        <circle cx="15" cy="70" r="4" fill="#9ca3af"/>
                                        <circle cx="35" cy="72" r="6" fill="#4b5563" stroke="#374151" stroke-width="2"/>
                                        <rect x="10" y="45" width="25" height="25" rx="3" fill="#3b82f6"/>
                                        <rect x="30" y="35" width="8" height="35" rx="2" fill="#2563eb"/>
                                        
                                        <!-- 人物 -->
                                        <ellipse cx="22" cy="35" rx="6" ry="10" fill="#f59e0b"/>
                                        <circle cx="22" cy="20" r="6" fill="#fbbf24"/>
                                        
                                        <!-- 警告标志 -->
                                        <polygon points="50,25 55,35 45,35" fill="#ef4444"/>
                                        <text x="50" y="32" font-family="Arial" font-size="8" fill="#ffffff" text-anchor="middle">!</text>
                                        
                                        <!-- 清理动作箭头 -->
                                        <path d="M35 45 Q45 40 55 50" stroke="#f59e0b" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
                                        <defs>
                                            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                                                <polygon points="0 0, 10 3.5, 0 7" fill="#f59e0b"/>
                                            </marker>
                                        </defs>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 2. 充电桩摆放指引 -->
                    <div class="border border-blue-200 rounded-xl bg-blue-50 shadow-sm overflow-hidden">
                        <div class="p-5">
                            <h4 class="font-bold text-blue-800 text-lg mb-4 text-center">2. 充电桩摆放指引</h4>
                            <div class="flex items-center justify-between">
                                <div class="flex-1 pr-4">
                                    <p class="text-sm text-blue-700 leading-relaxed">充电桩应当靠墙固定摆放，前方宽敞，确保充电桩周围有足够的空间让轮椅转弯和对准。</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <svg width="120" height="90" viewBox="0 0 120 90" xmlns="http://www.w3.org/2000/svg">
                                        <!-- 地面 -->
                                        <rect x="0" y="75" width="120" height="15" fill="#dbeafe"/>
                                        
                                        <!-- 墙壁 -->
                                        <rect x="0" y="0" width="8" height="75" fill="#6b7280"/>
                                        <rect x="0" y="0" width="120" height="5" fill="#6b7280"/>
                                        
                                        <!-- 充电桩 -->
                                        <rect x="15" y="45" width="12" height="30" fill="#374151"/>
                                        <rect x="12" y="42" width="18" height="8" rx="2" fill="#10b981"/>
                                        <circle cx="21" cy="38" r="3" fill="#ef4444"/>
                                        <text x="21" y="40" font-family="Arial" font-size="6" fill="#ffffff" text-anchor="middle">⚡</text>
                                        
                                        <!-- 宽敞区域标识 -->
                                        <circle cx="60" cy="55" r="25" fill="none" stroke="#3b82f6" stroke-width="2" stroke-dasharray="4,2"/>
                                        <text x="60" y="60" font-family="Arial" font-size="8" fill="#3b82f6" text-anchor="middle">宽敞区域</text>
                                        
                                        <!-- 轮椅 -->
                                        <g transform="translate(80,50)">
                                            <!-- 轮椅车身 -->
                                            <rect x="-6" y="-4" width="12" height="8" rx="2" fill="#3b82f6"/>
                                            <!-- 轮子 -->
                                            <circle cx="-4" cy="-6" r="3" fill="#4b5563"/>
                                            <circle cx="4" cy="-6" r="3" fill="#4b5563"/>
                                            <!-- 人物 -->
                                            <circle cx="0" cy="-10" r="3" fill="#fbbf24"/>
                                            <ellipse cx="0" cy="-2" rx="4" ry="6" fill="#f59e0b"/>
                                        </g>
                                        
                                        <!-- 充电桩到轮椅的箭头 -->
                                        <path d="M35 55 Q55 45 70 55" stroke="#10b981" stroke-width="2" fill="none" marker-end="url(#arrowhead2)"/>
                                        
                                        <!-- 空间标识线 -->
                                        <line x1="30" y1="30" x2="65" y2="30" stroke="#3b82f6" stroke-width="1"/>
                                        <line x1="30" y1="28" x2="30" y2="32" stroke="#3b82f6" stroke-width="1"/>
                                        <line x1="65" y1="28" x2="65" y2="32" stroke="#3b82f6" stroke-width="1"/>
                                        <text x="47" y="26" font-family="Arial" font-size="6" fill="#3b82f6" text-anchor="middle">足够空间</text>
                                        
                                        <defs>
                                            <marker id="arrowhead2" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
                                                <polygon points="0 0, 8 3, 0 6" fill="#10b981"/>
                                            </marker>
                                        </defs>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 3. 路线需要走成一圈 -->
                    <div class="border border-purple-200 rounded-xl bg-purple-50 shadow-sm overflow-hidden">
                        <div class="p-5">
                            <h4 class="font-bold text-purple-800 text-lg mb-4 text-center">3. 路线需要走成一圈</h4>
                            <div class="flex items-center justify-between">
                                <div class="flex-1 pr-4">
                                    <p class="text-sm text-purple-700 leading-relaxed">建图开始请从充电桩前出发，走过所有区域最后回到同一个充电桩前位置，将路线闭合才能完成建图。</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <svg width="120" height="90" viewBox="0 0 120 90" xmlns="http://www.w3.org/2000/svg">
                                        <!-- 地面 -->
                                        <rect x="0" y="75" width="120" height="15" fill="#ede9fe"/>
                                        
                                        <!-- 充电桩 -->
                                        <rect x="85" y="45" width="6" height="30" fill="#374151"/>
                                        <rect x="82" y="42" width="12" height="6" rx="2" fill="#10b981"/>
                                        <circle cx="88" cy="39" r="2" fill="#ef4444"/>
                                        
                                        <!-- 圆形路径 -->
                                        <circle cx="60" cy="55" r="25" fill="none" stroke="#7c3aed" stroke-width="3" stroke-dasharray="5,3"/>
                                        
                                        <!-- 起点/终点标记 -->
                                        <circle cx="85" cy="55" r="3" fill="#10b981"/>
                                        <text x="90" y="58" font-family="Arial" font-size="8" fill="#10b981">起点/终点</text>
                                        
                                        <!-- 轮椅位置1 -->
                                        <g transform="translate(45,40)">
                                            <circle cx="0" cy="15" r="4" fill="#4b5563"/>
                                            <circle cx="10" cy="17" r="3" fill="#4b5563"/>
                                            <rect x="-3" y="5" width="12" height="10" rx="2" fill="#7c3aed"/>
                                            <circle cx="3" cy="0" r="3" fill="#fbbf24"/>
                                        </g>
                                        
                                        <!-- 轮椅位置2 -->
                                        <g transform="translate(35,70)">
                                            <circle cx="0" cy="0" r="4" fill="#4b5563"/>
                                            <circle cx="10" cy="2" r="3" fill="#4b5563"/>
                                            <rect x="-3" y="-10" width="12" height="10" rx="2" fill="#7c3aed"/>
                                            <circle cx="3" cy="-15" r="3" fill="#fbbf24"/>
                                        </g>
                                        
                                        <!-- 方向箭头 -->
                                        <path d="M80 45 Q75 35 65 40" stroke="#7c3aed" stroke-width="2" fill="none" marker-end="url(#arrowhead2)"/>
                                        <defs>
                                            <marker id="arrowhead2" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
                                                <polygon points="0 0, 8 3, 0 6" fill="#7c3aed"/>
                                            </marker>
                                        </defs>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 4. 只需走常用路线 -->
                    <div class="border border-blue-200 rounded-xl bg-blue-50 shadow-sm overflow-hidden">
                        <div class="p-5">
                            <h4 class="font-bold text-blue-800 text-lg mb-4 text-center">4. 只需走常用路线</h4>
                            <div class="flex items-center justify-between">
                                <div class="flex-1 pr-4">
                                    <p class="text-sm text-blue-700 leading-relaxed">您只需要让轮椅走一遍平时经常走的路线（比如卧室到客厅、客厅到卫生间）。这些路线会变成轮椅自动导航的基准路线。</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <svg width="120" height="90" viewBox="0 0 120 90" xmlns="http://www.w3.org/2000/svg">
                                        <!-- 地面 -->
                                        <rect x="0" y="75" width="120" height="15" fill="#dbeafe"/>
                                        
                                        <!-- 房间区域 -->
                                        <rect x="5" y="20" width="30" height="25" fill="#f3f4f6" stroke="#9ca3af" stroke-width="1"/>
                                        <text x="20" y="35" font-family="Arial" font-size="8" fill="#6b7280" text-anchor="middle">卧室</text>
                                        
                                        <rect x="45" y="15" width="35" height="30" fill="#f3f4f6" stroke="#9ca3af" stroke-width="1"/>
                                        <text x="62" y="32" font-family="Arial" font-size="8" fill="#6b7280" text-anchor="middle">客厅</text>
                                        
                                        <rect x="85" y="25" width="25" height="20" fill="#f3f4f6" stroke="#9ca3af" stroke-width="1"/>
                                        <text x="97" y="37" font-family="Arial" font-size="8" fill="#6b7280" text-anchor="middle">卫生间</text>
                                        
                                        <!-- 常用路线 -->
                                        <path d="M35 35 L45 30" stroke="#3b82f6" stroke-width="3" marker-end="url(#arrowhead3)"/>
                                        <path d="M80 30 L85 35" stroke="#3b82f6" stroke-width="3" marker-end="url(#arrowhead3)"/>
                                        
                                        <!-- 轮椅 -->
                                        <g transform="translate(60,50)">
                                            <circle cx="-5" cy="10" r="5" fill="#4b5563"/>
                                            <circle cx="8" cy="12" r="4" fill="#4b5563"/>
                                            <rect x="-8" y="0" width="15" height="12" rx="2" fill="#3b82f6"/>
                                            <circle cx="0" cy="-6" r="4" fill="#fbbf24"/>
                                            <ellipse cx="0" cy="2" rx="4" ry="6" fill="#f59e0b"/>
                                        </g>
                                        
                                        <defs>
                                            <marker id="arrowhead3" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
                                                <polygon points="0 0, 8 3, 0 6" fill="#3b82f6"/>
                                            </marker>
                                        </defs>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 5. 避免长时间倒车 -->
                    <div class="border border-red-200 rounded-xl bg-red-50 shadow-sm overflow-hidden">
                        <div class="p-5">
                            <h4 class="font-bold text-red-800 text-lg mb-4 text-center">5. 避免长时间倒车</h4>
                            <div class="flex items-center justify-between">
                                <div class="flex-1 pr-4">
                                    <p class="text-sm text-red-700 leading-relaxed">建图过程中请尽量保持向前行驶，不要长时间倒着走。这样可以提高轮椅导航的准确性。</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <svg width="120" height="90" viewBox="0 0 120 90" xmlns="http://www.w3.org/2000/svg">
                                        <!-- 地面 -->
                                        <rect x="0" y="75" width="120" height="15" fill="#fee2e2"/>
                                        
                                        <!-- 正确的前进轮椅 -->
                                        <g transform="translate(20,45)">
                                            <circle cx="0" cy="15" r="5" fill="#4b5563"/>
                                            <circle cx="15" cy="17" r="4" fill="#4b5563"/>
                                            <rect x="-3" y="5" width="18" height="12" rx="2" fill="#10b981"/>
                                            <circle cx="7" cy="0" r="4" fill="#fbbf24"/>
                                            <ellipse cx="7" cy="7" rx="5" ry="7" fill="#f59e0b"/>
                                            <!-- 前进箭头 -->
                                            <path d="M25 12 L35 12" stroke="#10b981" stroke-width="3" marker-end="url(#arrowhead4)"/>
                                        </g>
                                        
                                        <!-- 错误的倒车轮椅 -->
                                        <g transform="translate(75,45)">
                                            <circle cx="15" cy="15" r="5" fill="#4b5563"/>
                                            <circle cx="0" cy="17" r="4" fill="#4b5563"/>
                                            <rect x="0" y="5" width="18" height="12" rx="2" fill="#ef4444"/>
                                            <circle cx="10" cy="0" r="4" fill="#fbbf24"/>
                                            <ellipse cx="10" cy="7" rx="5" ry="7" fill="#f59e0b"/>
                                            <!-- 倒车箭头 -->
                                            <path d="M-5 12 L-15 12" stroke="#ef4444" stroke-width="3" marker-end="url(#arrowhead5)"/>
                                        </g>
                                        
                                        <!-- 检查和叉号 -->
                                        <circle cx="40" cy="30" r="8" fill="#10b981"/>
                                        <path d="M36 30 L39 33 L44 28" stroke="#ffffff" stroke-width="2" fill="none"/>
                                        
                                        <circle cx="85" cy="30" r="8" fill="#ef4444"/>
                                        <path d="M81 26 L89 34 M89 26 L81 34" stroke="#ffffff" stroke-width="2"/>
                                        
                                        <defs>
                                            <marker id="arrowhead4" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
                                                <polygon points="0 0, 8 3, 0 6" fill="#10b981"/>
                                            </marker>
                                            <marker id="arrowhead5" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
                                                <polygon points="0 0, 8 3, 0 6" fill="#ef4444"/>
                                            </marker>
                                        </defs>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 风险确认 -->
                <div class="border border-gray-200 rounded-lg p-4 mb-4">
                    <h4 class="font-medium text-gray-800 mb-3">风险确认</h4>
                    <div class="space-y-3">
                        <label class="flex items-start">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 rounded mt-0.5" id="safety-risk-confirm">
                            <span class="ml-2 text-sm">我已阅读建图须知，并确认建图环境安全，没有易碎物品或危险区域</span>
                        </label>
                       
                        <label class="flex items-start">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 rounded mt-0.5" id="responsibility-confirm">
                            <span class="ml-2 text-sm">我已了解建图过程中的安全风险，并接受因违反操作指南可能造成的风险和责任</span>
                        </label>
                    </div>
                </div>
                
                <!-- 紧急停止提醒 -->
                <!-- <div class="bg-red-100 rounded-lg p-4">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-hand-paper text-red-600 mr-2"></i>
                        <h4 class="font-medium text-red-800">紧急停止</h4>
                    </div>
                    <p class="text-sm text-red-700">
                        如遇紧急情况，可通过以下方式立即停止轮椅：
                    </p>
                    <ul class="text-sm text-red-700 mt-2 ml-4">
                        <li>• 点击APP上的"紧急停止"按钮</li>
                        <li>• 按住轮椅遥控器的停止键</li>
                        <li>• 语音指令："停止轮椅"</li>
                    </ul>
                </div> -->
            </div>
            
            <button id="precautions-next-btn" class="w-full bg-gray-400 text-white py-3 rounded-xl font-medium cursor-not-allowed" disabled>
                我已确认，开始建图
            </button>
        </div>

        <!-- 设置回充点页面 -->
        <div id="set-charging-home" class="hidden p-4 max-w-md mx-auto">
            <div class="flex items-center mb-4">
                <button id="charging-home-back-btn" class="mr-3 text-gray-600">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <h2 class="text-xl font-semibold">设置充电桩</h2>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-6 mb-4">
                <div class="text-center mb-6">
                    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-charging-station text-green-600 text-3xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800">设置充电桩位置</h3>
                    <p class="text-sm text-gray-600 mt-2">按照以下步骤完成充电桩的设置和定位</p>
                </div>
                
                <!-- 操作指导 -->
                <div class="space-y-4 mb-6">
                    <div class="flex items-start p-4 border border-blue-200 rounded-lg bg-blue-50">
                        <i class="fas fa-home text-blue-600 text-lg mt-1 mr-3"></i>
                        <div>
                            <h4 class="font-medium text-blue-800 mb-1">1. 充电桩摆放</h4>
                            <p class="text-sm text-blue-700">充电桩贴墙固定摆放，前方2m范围内保持宽敞空旷</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start p-4 border border-green-200 rounded-lg bg-green-50">
                        <i class="fas fa-wheelchair text-green-600 text-lg mt-1 mr-3"></i>
                        <div>
                            <h4 class="font-medium text-green-800 mb-1">2. 轮椅定位</h4>
                            <p class="text-sm text-green-700">将轮椅尾部正对充电桩中心，移动到充电桩上</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start p-4 border border-purple-200 rounded-lg bg-purple-50">
                        <i class="fas fa-mouse-pointer text-purple-600 text-lg mt-1 mr-3"></i>
                        <div>
                            <h4 class="font-medium text-purple-800 mb-1">3. 确认设置</h4>
                            <p class="text-sm text-purple-700">点击下方按钮，设置充电桩位置</p>
                        </div>
                    </div>
                </div>
                
                <!-- 当前状态 -->
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-700">位置检测状态</span>
                        <span class="text-sm text-gray-500" id="position-status">等待检测</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="position-progress" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- 检测结果 -->
                <div id="detection-result" class="hidden mb-4">
                    <!-- 动态显示检测结果 -->
                </div>
            </div>
            
            <button id="detect-charging-position-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-medium">
                设置充电桩
            </button>
        </div>



        <!-- 实时建图页面 -->
        <div id="real-time-mapping" class="hidden p-4 max-w-md mx-auto">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <h2 class="text-xl font-semibold">实时建图</h2>
                </div>
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-red-500 rounded-full mr-2 pulse-animation"></div>
                    <span class="text-sm text-red-600 font-medium">建图中</span>
                </div>
            </div>
            
            <!-- 新手引导弹窗 -->
            <div id="guide-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
                <div class="flex items-center justify-center h-full p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full relative">
                        <!-- 左箭头按钮 -->
                        <button id="guide-prev-btn" class="absolute left-4 top-1/2 transform -translate-y-1/2 w-8 h-8 bg-white rounded-full shadow-md flex items-center justify-center text-gray-400 hover:text-gray-600 transition-colors z-10">
                            <i class="fas fa-chevron-left text-sm"></i>
                        </button>
                        
                        <!-- 右箭头按钮 -->
                        <button id="guide-next-arrow-btn" class="absolute right-4 top-1/2 transform -translate-y-1/2 w-8 h-8 bg-white rounded-full shadow-md flex items-center justify-center text-gray-400 hover:text-gray-600 transition-colors z-10">
                            <i class="fas fa-chevron-right text-sm"></i>
                        </button>
                        
                        <div id="guide-content" class="p-6 px-12">
                            <!-- 引导内容动态插入 -->
                        </div>
                        <div class="px-6 pb-6 flex space-x-3">
                            <button id="guide-skip-btn" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg font-medium">
                                跳过引导
                            </button>
                            <button id="guide-next-btn" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-medium">
                                我知道了
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 建图进度 -->
            <!-- <div class="bg-white rounded-xl shadow-md p-4 mb-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-semibold">建图进度</h3>
                    <span id="mapping-progress-text" class="text-sm text-blue-600">15%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                    <div id="mapping-progress-bar" class="bg-blue-600 h-2 rounded-full" style="width: 15%"></div>
                </div>
                <div class="flex justify-between text-xs text-gray-500">
                    <span>已用时间: <span id="elapsed-time">02:35</span></span>
                    <span>预计剩余: <span id="remaining-time">12:25</span></span>
                </div>
            </div> -->
            
            <!-- 实时地图显示 -->
            <div class="bg-white rounded-xl shadow-md p-4 mb-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-semibold">实时地图</h3>
                    <div class="flex items-center space-x-2">
                        <div class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">
                            <i class="fas fa-satellite-dish mr-1"></i>建图中
                        </div>
                        <button id="map-zoom-in" class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center">
                            <i class="fas fa-plus text-sm"></i>
                        </button>
                        <button id="map-zoom-out" class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center">
                            <i class="fas fa-minus text-sm"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 地图画布 -->
                <div class="relative bg-gray-900 rounded-lg overflow-hidden" style="height: 450px;">
                    <canvas id="mapping-canvas" class="w-full h-full"></canvas>
                    
                    <!-- 激光雷达扫描线 -->
                    <div id="radar-line" class="absolute top-1/2 left-1/2 w-0.5 h-32 bg-gradient-to-t from-red-500 to-transparent transform-gpu origin-bottom" style="transform: translate(-50%, -100%) rotate(0deg);"></div>
                    
                    <!-- 轮椅位置指示器 -->
                    <div id="wheelchair-position" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
                        <div class="w-4 h-4 bg-blue-500 rounded-full relative">
                            <div class="absolute inset-0 bg-blue-400 rounded-full animate-ping"></div>
                            <!-- 轮椅方向指示 -->
                            <div class="absolute top-0 left-1/2 w-0.5 h-2 bg-blue-300 transform -translate-x-1/2 -translate-y-full"></div>
                        </div>
                    </div>
                    
                    <!-- 图例 -->
                    <div class="absolute bottom-2 left-2 bg-black bg-opacity-80 rounded-lg p-2">
                        <div class="grid grid-cols-2 gap-2 text-xs text-white">
                            <div class="flex items-center"><div class="w-2 h-2 bg-gray-300 mr-1"></div>墙壁</div>
                            <div class="flex items-center"><div class="w-2 h-2 bg-blue-500 mr-1"></div>轮椅</div>
                            <div class="flex items-center"><div class="w-2 h-2 bg-green-400 mr-1"></div>可通行</div>
                            <div class="flex items-center"><div class="w-2 h-2 bg-yellow-400 mr-1"></div>路径</div>
                            <div class="flex items-center"><div class="w-2 h-2 bg-red-400 mr-1"></div>扫描</div>
                            <div class="flex items-center"><div class="w-2 h-2 bg-purple-400 mr-1"></div>标记点</div>
                        </div>
                    </div>
                    
                    <!-- 建图状态提示 -->
                    <div id="mapping-status-tip" class="absolute top-2 left-2 bg-green-500 bg-opacity-90 text-white text-xs rounded-lg p-2">
                        <i class="fas fa-route mr-1"></i>正在扫描建图...
                    </div>
                </div>
                
                <!-- 地图信息 -->
                <!-- <div class="mt-3 grid grid-cols-3 gap-4 text-center">
                    <div>
                        <p class="text-xs text-gray-500">已扫描面积</p>
                        <p class="font-semibold text-blue-600" id="scanned-area">18㎡</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500">检测到房间</p>
                        <p class="font-semibold text-green-600" id="detected-rooms">3</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500">障碍物</p>
                        <p class="font-semibold text-orange-600" id="obstacles-count">7</p>
                    </div>
                </div> -->
            </div>
            

            
            <!-- 地点管理 -->
            <div class="bg-white rounded-xl shadow-md p-4 mb-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-semibold">地点管理</h3>
                    <span class="text-sm text-gray-500" id="locations-count">0个地点</span>
                </div>
                
                <!-- 地点类型选择 -->
                <div class="flex space-x-2 mb-4">
                    <button id="location-type-waypoint" class="flex-1 py-2 px-3 text-xs rounded-lg bg-blue-100 text-blue-600 border border-blue-200 font-medium">
                        <i class="fas fa-map-marker-alt mr-1"></i>定位点
                    </button>
                    <button id="location-type-parking" class="flex-1 py-2 px-3 text-xs rounded-lg bg-gray-100 text-gray-600 border border-gray-200 font-medium">
                        <i class="fas fa-parking mr-1"></i>停靠点
                    </button>
                </div>
                
                <div id="locations-list" class="space-y-2 max-h-32 overflow-y-auto mb-4">
                    <div class="text-center text-gray-400 text-sm py-4" id="no-locations-tip">
                        移动轮椅到合适位置，选择地点类型后点击添加
                    </div>
                </div>
                
                <button id="add-location-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium">
                    <i class="fas fa-plus mr-2"></i>添加定位点
                </button>
            </div>
            
            <!-- 建图控制 -->
            <button id="finish-mapping-btn" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-medium">
                <i class="fas fa-check mr-2"></i>
                建图完成
            </button>
        </div>

        <!-- 设置充电桩页面 -->
        <div id="set-charging-station" class="hidden p-4 max-w-md mx-auto">
            <div class="flex items-center mb-4">
                <button id="charging-station-back-btn" class="mr-3 text-gray-600">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <h2 class="text-xl font-semibold">设置充电桩</h2>
            </div>
            
            <!-- 步骤指示器 -->
            <div class="mb-6">
                <div class="flex items-center">
                    <div class="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs">1</div>
                    <div class="flex-1 h-0.5 bg-gray-300 mx-2"></div>
                    <div class="w-6 h-6 bg-gray-300 text-gray-500 rounded-full flex items-center justify-center text-xs">2</div>
                    <div class="flex-1 h-0.5 bg-gray-300 mx-2"></div>
                    <div class="w-6 h-6 bg-gray-300 text-gray-500 rounded-full flex items-center justify-center text-xs">3</div>
                    <div class="flex-1 h-0.5 bg-gray-300 mx-2"></div>
                    <div class="w-6 h-6 bg-gray-300 text-gray-500 rounded-full flex items-center justify-center text-xs">4</div>
                </div>
                <div class="flex justify-between mt-2 text-xs text-gray-500">
                    <span>充电桩</span>
                    <span>定位点</span>
                    <span>停靠点</span>
                    <span>完成</span>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-6 mb-4">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-charging-station text-green-600 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold">设置充电桩位置</h3>
                    <p class="text-sm text-gray-600 mt-2">请在地图上标记轮椅充电桩的位置</p>
                </div>
                
                <!-- 地图区域 -->
                <div class="relative bg-gray-100 rounded-lg mb-4" style="height: 250px;">
                    <canvas id="charging-map-canvas" class="w-full h-full rounded-lg"></canvas>
                    
                    <!-- 充电桩标记 -->
                    <div id="charging-station-marker" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 hidden">
                        <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center shadow-lg">
                            <i class="fas fa-plug text-white text-xs"></i>
                        </div>
                    </div>
                    
                    <!-- 操作提示 -->
                    <div class="absolute top-2 left-2 bg-black bg-opacity-70 text-white text-xs rounded-lg p-2">
                        点击地图设置充电桩位置
                    </div>
                </div>
                
                <!-- 充电桩信息 -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">充电桩名称</label>
                        <input type="text" id="charging-station-name" class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="如：客厅充电桩" value="主充电桩">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">充电桩类型</label>
                        <select id="charging-station-type" class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="standard">标准充电桩</option>
                            <option value="fast">快速充电桩</option>
                            <option value="wireless">无线充电桩</option>
                        </select>
                    </div>
                    
                    <!-- 自动充电设置 -->
                    <div class="border border-gray-200 rounded-lg p-3">
                        <h4 class="font-medium text-gray-800 mb-3">自动充电设置</h4>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 rounded" id="auto-charge-low-battery" checked>
                                <span class="ml-2 text-sm">电量低于20%时自动返回充电</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 rounded" id="auto-charge-schedule">
                                <span class="ml-2 text-sm">定时自动充电</span>
                            </label>
                            <div id="schedule-time" class="ml-6 hidden">
                                <input type="time" class="text-sm border rounded px-2 py-1" value="02:00">
                                <span class="text-xs text-gray-500 ml-2">每天凌晨充电</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 充电桩状态预览 -->
                <div id="charging-station-preview" class="hidden mt-4 p-3 bg-green-50 rounded-lg border border-green-200">
                    <div class="flex items-center">
                        <i class="fas fa-charging-station text-green-600 mr-3"></i>
                        <div>
                            <h4 class="font-medium text-green-800">充电桩已设置</h4>
                            <p class="text-sm text-green-600" id="charging-position-info">位置: (125, 89)</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <button id="charging-station-next-btn" class="w-full bg-gray-400 text-white py-3 rounded-xl font-medium cursor-not-allowed" disabled>
                设置定位点
            </button>
        </div>

        <!-- 设置定位点页面 -->
        <div id="set-waypoints" class="hidden p-4 max-w-md mx-auto">
            <div class="flex items-center mb-4">
                <button id="waypoints-back-btn" class="mr-3 text-gray-600">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <h2 class="text-xl font-semibold">设置定位点</h2>
            </div>
            
            <!-- 步骤指示器 -->
            <div class="mb-6">
                <div class="flex items-center">
                    <div class="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs">✓</div>
                    <div class="flex-1 h-0.5 bg-blue-600 mx-2"></div>
                    <div class="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs">2</div>
                    <div class="flex-1 h-0.5 bg-gray-300 mx-2"></div>
                    <div class="w-6 h-6 bg-gray-300 text-gray-500 rounded-full flex items-center justify-center text-xs">3</div>
                    <div class="flex-1 h-0.5 bg-gray-300 mx-2"></div>
                    <div class="w-6 h-6 bg-gray-300 text-gray-500 rounded-full flex items-center justify-center text-xs">4</div>
                </div>
                <div class="flex justify-between mt-2 text-xs text-gray-500">
                    <span>充电桩</span>
                    <span>定位点</span>
                    <span>停靠点</span>
                    <span>完成</span>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-6 mb-4">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-map-marker-alt text-blue-600 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold">设置导航定位点</h3>
                    <p class="text-sm text-gray-600 mt-2">添加重要位置，方便快速导航</p>
                </div>
                
                <!-- 地图区域 -->
                <div class="relative bg-gray-100 rounded-lg mb-4" style="height: 250px;">
                    <canvas id="waypoints-map-canvas" class="w-full h-full rounded-lg"></canvas>
                    
                    <!-- 已设置的定位点 -->
                    <div id="waypoint-markers" class="absolute inset-0">
                        <!-- 动态添加的定位点标记 -->
                    </div>
                    
                    <!-- 操作提示 -->
                    <div class="absolute top-2 left-2 bg-black bg-opacity-70 text-white text-xs rounded-lg p-2">
                        点击地图添加定位点
                    </div>
                </div>
                
                <!-- 定位点列表 -->
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-medium">已设置定位点</h4>
                        <span class="text-sm text-gray-500" id="waypoints-count">0/8</span>
                    </div>
                    
                    <div id="waypoints-list" class="space-y-2 max-h-32 overflow-y-auto">
                        <!-- 动态生成的定位点列表 -->
                    </div>
                </div>
                
                <!-- 快速添加常用定位点 -->
                <div class="border border-gray-200 rounded-lg p-3">
                    <h4 class="font-medium text-gray-800 mb-3">快速添加</h4>
                    <div class="grid grid-cols-2 gap-2">
                        <button class="quick-waypoint-btn border border-gray-300 rounded-lg p-2 text-sm hover:border-blue-500" data-name="客厅">
                            <i class="fas fa-couch text-blue-600 mb-1"></i>
                            <p>客厅</p>
                        </button>
                        <button class="quick-waypoint-btn border border-gray-300 rounded-lg p-2 text-sm hover:border-blue-500" data-name="卧室">
                            <i class="fas fa-bed text-green-600 mb-1"></i>
                            <p>卧室</p>
                        </button>
                        <button class="quick-waypoint-btn border border-gray-300 rounded-lg p-2 text-sm hover:border-blue-500" data-name="厨房">
                            <i class="fas fa-utensils text-orange-600 mb-1"></i>
                            <p>厨房</p>
                        </button>
                        <button class="quick-waypoint-btn border border-gray-300 rounded-lg p-2 text-sm hover:border-blue-500" data-name="书房">
                            <i class="fas fa-book text-purple-600 mb-1"></i>
                            <p>书房</p>
                        </button>
                    </div>
                </div>
            </div>
            
            <button id="waypoints-next-btn" class="w-full bg-blue-600 text-white py-3 rounded-xl font-medium">
                添加停靠点
            </button>
        </div>

        <!-- 添加停靠点页面 -->
        <div id="set-parking-spots" class="hidden p-4 max-w-md mx-auto">
            <div class="flex items-center mb-4">
                <button id="parking-spots-back-btn" class="mr-3 text-gray-600">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <h2 class="text-xl font-semibold">添加停靠点</h2>
            </div>
            
            <!-- 步骤指示器 -->
            <div class="mb-6">
                <div class="flex items-center">
                    <div class="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs">✓</div>
                    <div class="flex-1 h-0.5 bg-blue-600 mx-2"></div>
                    <div class="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs">✓</div>
                    <div class="flex-1 h-0.5 bg-blue-600 mx-2"></div>
                    <div class="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs">3</div>
                    <div class="flex-1 h-0.5 bg-gray-300 mx-2"></div>
                    <div class="w-6 h-6 bg-gray-300 text-gray-500 rounded-full flex items-center justify-center text-xs">4</div>
                </div>
                <div class="flex justify-between mt-2 text-xs text-gray-500">
                    <span>充电桩</span>
                    <span>定位点</span>
                    <span>停靠点</span>
                    <span>完成</span>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-6 mb-4">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-parking text-purple-600 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold">设置停靠点</h3>
                    <p class="text-sm text-gray-600 mt-2">设置轮椅的常用停靠位置</p>
                </div>
                
                <!-- 地图区域 -->
                <div class="relative bg-gray-100 rounded-lg mb-4" style="height: 250px;">
                    <canvas id="parking-spots-map-canvas" class="w-full h-full rounded-lg"></canvas>
                    
                    <!-- 停靠点标记 -->
                    <div id="parking-spots-markers" class="absolute inset-0">
                        <!-- 动态添加的停靠点标记 -->
                    </div>
                    
                    <!-- 操作提示 -->
                    <div class="absolute top-2 left-2 bg-black bg-opacity-70 text-white text-xs rounded-lg p-2">
                        点击地图添加停靠点
                    </div>
                </div>
                
                <!-- 停靠点列表 -->
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-medium">已设置停靠点</h4>
                        <span class="text-sm text-gray-500" id="parking-spots-count">0/6</span>
                    </div>
                    
                    <div id="parking-spots-list" class="space-y-2 max-h-32 overflow-y-auto">
                        <!-- 动态生成的停靠点列表 -->
                    </div>
                </div>
                
                <!-- 停靠点类型选择 -->
                <div class="border border-gray-200 rounded-lg p-3">
                    <h4 class="font-medium text-gray-800 mb-3">停靠点类型</h4>
                    <div class="grid grid-cols-3 gap-2">
                        <button class="parking-type-btn border border-gray-300 rounded-lg p-2 text-sm hover:border-purple-500" data-type="rest">
                            <i class="fas fa-chair text-purple-600 mb-1"></i>
                            <p>休息点</p>
                        </button>
                        <button class="parking-type-btn border border-gray-300 rounded-lg p-2 text-sm hover:border-purple-500" data-type="temp">
                            <i class="fas fa-clock text-orange-600 mb-1"></i>
                            <p>临时停车</p>
                        </button>
                        <button class="parking-type-btn border border-gray-300 rounded-lg p-2 text-sm hover:border-purple-500" data-type="night">
                            <i class="fas fa-moon text-blue-600 mb-1"></i>
                            <p>夜间停车</p>
                        </button>
                    </div>
                </div>
                
                <!-- 停靠设置 -->
                <div class="mt-4 space-y-3">
                    <label class="flex items-center">
                        <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 rounded" id="auto-parking">
                        <span class="ml-2 text-sm">自动停靠（轮椅将自动对齐停靠点）</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 rounded" id="parking-notification">
                        <span class="ml-2 text-sm">到达停靠点时发送通知</span>
                    </label>
                </div>
            </div>
            
            <button id="parking-spots-next-btn" class="w-full bg-blue-600 text-white py-3 rounded-xl font-medium">
                设置安全区域
            </button>
        </div>

        <!-- 设置安全区域页面 -->
        <div id="set-safety-zones" class="hidden p-4 max-w-md mx-auto">
            <div class="flex items-center mb-4">
                <button id="safety-zones-back-btn" class="mr-3 text-gray-600">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <h2 class="text-xl font-semibold">设置安全区域</h2>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-6 mb-4">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-shield-alt text-green-600 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold">划定安全区域</h3>
                    <p class="text-sm text-gray-600 mt-2">为轮椅划定可以自由移动和掉头的区域</p>
                </div>
                
                <!-- 地图区域 -->
                <div class="relative bg-gray-100 rounded-lg mb-4" style="height: 300px;">
                    <canvas id="safety-zones-map-canvas" class="w-full h-full rounded-lg"></canvas>
                    
                    <!-- 绘制工具提示 -->
                    <div class="absolute top-2 left-2 bg-black bg-opacity-70 text-white text-xs rounded-lg p-2">
                        <div id="drawing-mode">点击并拖拽绘制安全区域</div>
                    </div>
                    
                    <!-- 绘制工具 -->
                    <div class="absolute bottom-2 right-2 flex space-x-1">
                        <button id="draw-rectangle" class="w-8 h-8 bg-green-500 text-white rounded text-xs" title="矩形">
                            <i class="fas fa-square"></i>
                        </button>
                        <button id="draw-circle" class="w-8 h-8 bg-gray-500 text-white rounded text-xs" title="圆形">
                            <i class="fas fa-circle"></i>
                        </button>
                        <button id="clear-zones" class="w-8 h-8 bg-red-500 text-white rounded text-xs" title="清除">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 安全区域列表 -->
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-medium">已设置安全区域</h4>
                        <span class="text-sm text-gray-500" id="safety-zones-count">0个</span>
                    </div>
                    
                    <div id="safety-zones-list" class="space-y-2">
                        <!-- 动态生成的安全区域列表 -->
                    </div>
                </div>
                

            </div>
            
            <button id="safety-zones-next-btn" class="w-full bg-blue-600 text-white py-3 rounded-xl font-medium">
                完成建图
            </button>
        </div>

        <!-- 设置禁行区页面 -->
        <div id="set-restricted-zones" class="hidden p-4 max-w-md mx-auto">
            <div class="flex items-center mb-4">
                <button id="restricted-zones-back-btn" class="mr-3 text-gray-600">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <h2 class="text-xl font-semibold">设置禁行区</h2>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-6 mb-4">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-ban text-red-600 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold">设置禁行区域</h3>
                    <p class="text-sm text-gray-600 mt-2">标记轮椅禁止进入的区域</p>
                </div>
                
                <!-- 地图区域 -->
                <div class="relative bg-gray-100 rounded-lg mb-4" style="height: 300px;">
                    <canvas id="restricted-zones-map-canvas" class="w-full h-full rounded-lg"></canvas>
                    
                    <!-- 绘制工具提示 -->
                    <div class="absolute top-2 left-2 bg-black bg-opacity-70 text-white text-xs rounded-lg p-2">
                        <div>点击并拖拽绘制禁行区域</div>
                    </div>
                    
                    <!-- 绘制工具 -->
                    <div class="absolute bottom-2 right-2 flex space-x-1">
                        <button id="draw-restricted-rectangle" class="w-8 h-8 bg-red-500 text-white rounded text-xs" title="矩形">
                            <i class="fas fa-square"></i>
                        </button>
                        <button id="draw-restricted-circle" class="w-8 h-8 bg-gray-500 text-white rounded text-xs" title="圆形">
                            <i class="fas fa-circle"></i>
                        </button>
                        <button id="clear-restricted-zones" class="w-8 h-8 bg-orange-500 text-white rounded text-xs" title="清除">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 禁行区域列表 -->
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-medium">已设置禁行区域</h4>
                        <span class="text-sm text-gray-500" id="restricted-zones-count">0个</span>
                    </div>
                    
                    <div id="restricted-zones-list" class="space-y-2">
                        <!-- 动态生成的禁行区域列表 -->
                    </div>
                </div>
                
                <!-- 快速添加常见禁行区 -->
                <div class="border border-gray-200 rounded-lg p-3 mb-4">
                    <h4 class="font-medium text-gray-800 mb-3">常见禁行区域</h4>
                    <div class="grid grid-cols-2 gap-2">
                        <button class="restricted-zone-btn border border-gray-300 rounded-lg p-2 text-sm hover:border-red-500" data-type="stairs">
                            <i class="fas fa-walking text-red-600 mb-1"></i>
                            <p>楼梯区域</p>
                        </button>
                        <button class="restricted-zone-btn border border-gray-300 rounded-lg p-2 text-sm hover:border-red-500" data-type="kitchen">
                            <i class="fas fa-utensils text-orange-600 mb-1"></i>
                            <p>厨房操作台</p>
                        </button>
                        <button class="restricted-zone-btn border border-gray-300 rounded-lg p-2 text-sm hover:border-red-500" data-type="balcony">
                            <i class="fas fa-building text-blue-600 mb-1"></i>
                            <p>阳台边缘</p>
                        </button>
                        <button class="restricted-zone-btn border border-gray-300 rounded-lg p-2 text-sm hover:border-red-500" data-type="bathroom">
                            <i class="fas fa-bath text-cyan-600 mb-1"></i>
                            <p>浴室淋浴区</p>
                        </button>
                    </div>
                </div>
                
                <!-- 禁行设置 -->
                <div class="border border-gray-200 rounded-lg p-3">
                    <h4 class="font-medium text-gray-800 mb-3">禁行设置</h4>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 rounded" id="strict-boundary" checked>
                            <span class="ml-2 text-sm">严格边界检测（禁止任何部分进入）</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 rounded" id="approach-warning">
                            <span class="ml-2 text-sm">接近禁行区时警告</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 rounded" id="force-stop">
                            <span class="ml-2 text-sm">进入禁行区时强制停止</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <button id="restricted-zones-next-btn" class="w-full bg-blue-600 text-white py-3 rounded-xl font-medium">
                完成建图
            </button>
        </div>

        <!-- 完成建图页面 -->
        <div id="mapping-complete" class="hidden p-4 max-w-md mx-auto">
            <div class="bg-white rounded-xl shadow-md p-6 mb-4 text-center">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-check text-green-600 text-3xl"></i>
                </div>
                <h2 class="text-xl font-semibold mb-2">建图完成！</h2>
                <p class="text-gray-700 mb-6">
                    恭喜您成功完成地图建立，轮椅现在可以在设定的环境中自主导航
                </p>
                
                <!-- 建图总结 -->
                <div class="text-left bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="font-medium text-gray-800 mb-3">建图总结</h3>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <p class="text-gray-500">地图名称</p>
                            <p class="font-semibold" id="final-map-name">家庭地图</p>
                        </div>
                        <div>
                            <p class="text-gray-500">建图用时</p>
                            <p class="font-semibold" id="final-mapping-time">18分35秒</p>
                        </div>
                        <div>
                            <p class="text-gray-500">扫描面积</p>
                            <p class="font-semibold" id="final-scanned-area">125㎡</p>
                        </div>
                        <div>
                            <p class="text-gray-500">检测房间</p>
                            <p class="font-semibold" id="final-rooms-count">5个</p>
                        </div>
                        <div>
                            <p class="text-gray-500">充电桩</p>
                            <p class="font-semibold" id="final-charging-stations">1个</p>
                        </div>
                        <div>
                            <p class="text-gray-500">定位点</p>
                            <p class="font-semibold" id="final-waypoints">4个</p>
                        </div>
                        <div>
                            <p class="text-gray-500">停靠点</p>
                            <p class="font-semibold" id="final-parking-spots">3个</p>
                        </div>
                        <div>
                            <p class="text-gray-500">安全设置</p>
                            <p class="font-semibold text-green-600">已完成</p>
                        </div>
                    </div>
                </div>
                
                <!-- 地图预览 -->
                <div class="mb-6">
                    <h3 class="font-medium text-gray-800 mb-3">地图预览</h3>
                    <div class="bg-gray-100 rounded-lg" style="height: 200px;">
                        <canvas id="final-map-preview" class="w-full h-full rounded-lg"></canvas>
                    </div>
                </div>
                
                <!-- 同步状态 -->
                <div class="flex items-center justify-center mb-6 p-3 bg-blue-50 rounded-lg">
                    <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-cloud-upload-alt text-white text-sm"></i>
                    </div>
                    <div class="text-left">
                        <p class="font-medium text-blue-800">云端同步中...</p>
                        <p class="text-sm text-blue-600">正在将地图数据同步到云端</p>
                    </div>
                </div>
                
                <!-- 操作按钮 -->
                <div class="space-y-3">
                    <button id="start-navigation-btn" class="w-full bg-blue-600 text-white py-3 rounded-xl font-medium">
                        <i class="fas fa-route mr-2"></i>
                        开始导航
                    </button>
                    <button id="view-map-details-btn" class="w-full border border-gray-300 text-gray-700 py-3 rounded-xl font-medium">
                        查看地图详情
                    </button>
                    <button id="back-to-management-btn" class="w-full bg-gray-100 text-gray-600 py-3 rounded-xl font-medium">
                        返回地图管理
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 全局悬浮音频播放器 -->
    <div id="floating-audio-player" class="fixed left-4 bottom-28 z-50 transition-all duration-300 ease-in-out">
        <!-- 折叠状态：圆形悬浮球 -->
        <div id="player-collapsed" class="floating-player-ball w-14 h-14 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full shadow-2xl flex items-center justify-center cursor-pointer">
            <div class="relative">
                <i id="floating-player-icon" class="fas fa-music text-white text-lg"></i>
                <!-- 播放状态指示器 -->
                <div id="playing-indicator" class="absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
            </div>
        </div>
        
        <!-- 展开状态：完整播放器 -->
        <div id="player-expanded" class="hidden floating-player-expanded bg-white rounded-2xl shadow-2xl" style="width: 320px;">
            <!-- 播放器头部 -->
            <div class="flex items-center justify-between p-4 border-b border-gray-100">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-music text-white text-sm"></i>
                    </div>
                    <div>
                        <h3 class="font-medium text-gray-700 text-sm">音频播放器</h3>
                        <div class="flex items-center">
                            <div class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></div>
                            <span class="text-xs text-gray-500">在线</span>
                        </div>
                    </div>
                </div>
                <button id="player-minimize-btn" class="text-gray-400 hover:text-gray-600 transition p-1 rounded-full hover:bg-gray-100">
                    <i class="fas fa-minus text-sm"></i>
                </button>
            </div>
            
            <!-- 当前播放内容 -->
            <div class="p-4">
                <div class="flex items-center mb-3">
                    <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-500 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-music text-white text-lg"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-800 truncate" id="floating-track-title">轻松音乐频道</p>
                        <p class="text-xs text-gray-500 truncate" id="floating-track-artist">正在播放：舒缓钢琴曲</p>
                    </div>
                    <button id="floating-favorite-btn" class="text-gray-400 hover:text-red-500 transition">
                        <i class="far fa-heart text-sm"></i>
                    </button>
                </div>
                
                <!-- 进度条 -->
                <div class="flex items-center text-xs text-gray-500 mb-3">
                    <span id="floating-current-time">02:34</span>
                    <div class="flex-1 mx-3">
                        <div class="w-full bg-gray-200 rounded-full h-1 relative cursor-pointer">
                            <div id="floating-progress-bar" class="bg-blue-500 h-1 rounded-full" style="width: 45%"></div>
                        </div>
                    </div>
                    <span id="floating-total-time">05:42</span>
                </div>
                
                <!-- 播放控制按钮 -->
                <div class="flex items-center justify-center space-x-4 mb-3">
                    <button id="floating-shuffle-btn" class="text-gray-400 hover:text-blue-500 transition">
                        <i class="fas fa-random text-sm"></i>
                    </button>
                    <button id="floating-prev-btn" class="text-gray-600 hover:text-blue-500 transition">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button id="floating-play-pause-btn" class="w-10 h-10 bg-blue-500 hover:bg-blue-600 text-white rounded-full flex items-center justify-center transition">
                        <i class="fas fa-pause"></i>
                    </button>
                    <button id="floating-next-btn" class="text-gray-600 hover:text-blue-500 transition">
                        <i class="fas fa-step-forward"></i>
                    </button>
                    <button id="floating-repeat-btn" class="text-gray-400 hover:text-blue-500 transition">
                        <i class="fas fa-redo text-sm"></i>
                    </button>
                </div>
                
                <!-- 音量控制 -->
                <div class="flex items-center space-x-2">
                    <i class="fas fa-volume-up text-gray-400 text-sm"></i>
                    <div class="flex-1 bg-gray-200 rounded-full h-1 relative cursor-pointer">
                        <div id="floating-volume-bar" class="bg-blue-500 h-1 rounded-full" style="width: 70%"></div>
                    </div>
                    <span class="text-xs text-gray-500 w-8 text-right">70%</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 显示电量不足警告模态框
        function showBatteryWarningModal(currentBattery) {
            // 创建模态框HTML
            const modalHTML = `
                <div id="battery-warning-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                    <div class="bg-white rounded-xl shadow-lg p-6 m-4 max-w-sm w-full">
                        <div class="text-center mb-4">
                            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-battery-quarter text-red-600 text-2xl"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">⚠️ 轮椅电量不足</h3>
                        </div>
                        
                        <div class="space-y-3 mb-6">
                            <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                                <span class="text-sm text-gray-700">当前电量</span>
                                <span class="text-sm font-bold text-red-600">${currentBattery}%</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <span class="text-sm text-gray-700">建图所需电量</span>
                                <span class="text-sm font-bold text-green-600">≥50%</span>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                            <div class="flex items-start">
                                <i class="fas fa-exclamation-triangle text-yellow-600 mt-0.5 mr-2"></i>
                                <div class="text-sm text-yellow-800">
                                    <p class="font-medium mb-1">温馨提示</p>
                                    <p>建图过程耗电较大，电量不足可能导致建图失败。请为轮椅充电至50%以上再进行建图操作。</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="closeBatteryWarningModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-lg font-medium transition">
                                取消
                            </button>
                            <button onclick="closeBatteryWarningModal()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-medium transition">
                                我知道了
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加到页面
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // 添加点击外部关闭功能
            const modal = document.getElementById('battery-warning-modal');
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeBatteryWarningModal();
                }
            });
        }
        
        // 关闭电量警告模态框
        function closeBatteryWarningModal() {
            const modal = document.getElementById('battery-warning-modal');
            if (modal) {
                modal.remove();
            }
        }

        // 全局弹窗函数 - 必须在页面加载前定义
        let currentModalResolve = null;
        
        function showModal(config) {
            const modal = document.getElementById('app-modal');
            const title = document.getElementById('modal-title');
            const message = document.getElementById('modal-message');
            const inputContainer = document.getElementById('modal-input-container');
            const input = document.getElementById('modal-input');
            const suggestions = document.getElementById('modal-suggestions');
            const cancelBtn = document.getElementById('modal-cancel');
            const confirmBtn = document.getElementById('modal-confirm');
            
            // 设置内容
            title.textContent = config.title || '提示';
            // 将换行符转换为HTML换行标签，以支持多行显示
            const messageContent = (config.message || '').replace(/\n/g, '<br>');
            message.innerHTML = messageContent;
            
            // 根据类型显示不同UI
            if (config.type === 'prompt') {
                inputContainer.classList.remove('hidden');
                input.value = config.defaultValue || '';
                input.placeholder = config.placeholder || '请输入内容';
                
                // 如果是定位点名称输入或停靠点名称输入，显示推荐选项
                if (config.message.includes('定位点名称') || config.message.includes('停靠点名称')) {
                    suggestions.classList.remove('hidden');
                    
                    // 根据类型显示不同的建议选项
                    const suggestionsTitle = document.getElementById('suggestions-title');
                    const suggestionsContent = document.getElementById('suggestions-content');
                    
                    if (config.message.includes('停靠点名称')) {
                        suggestionsTitle.textContent = '常用停靠点';
                        suggestionsContent.innerHTML = `
                            <div class="grid grid-cols-3 gap-2">
                                <div class="suggestion-item cursor-pointer text-sm bg-blue-50 hover:bg-blue-100 text-blue-700 text-center py-2 rounded-lg font-medium transition" data-value="沙发">沙发</div>
                                <div class="suggestion-item cursor-pointer text-sm bg-green-50 hover:bg-green-100 text-green-700 text-center py-2 rounded-lg font-medium transition" data-value="床边">床边</div>
                                <div class="suggestion-item cursor-pointer text-sm bg-purple-50 hover:bg-purple-100 text-purple-700 text-center py-2 rounded-lg font-medium transition" data-value="卫生间">卫生间</div>
                                <div class="suggestion-item cursor-pointer text-sm bg-orange-50 hover:bg-orange-100 text-orange-700 text-center py-2 rounded-lg font-medium transition" data-value="书房">书房</div>
                                <div class="suggestion-item cursor-pointer text-sm bg-blue-50 hover:bg-blue-100 text-blue-700 text-center py-2 rounded-lg font-medium transition" data-value="客厅">客厅</div>
                                <div class="suggestion-item cursor-pointer text-sm bg-green-50 hover:bg-green-100 text-green-700 text-center py-2 rounded-lg font-medium transition" data-value="卧室">卧室</div>
                                <div class="suggestion-item cursor-pointer text-sm bg-purple-50 hover:bg-purple-100 text-purple-700 text-center py-2 rounded-lg font-medium transition" data-value="厨房">厨房</div>
                                <div class="suggestion-item cursor-pointer text-sm bg-orange-50 hover:bg-orange-100 text-orange-700 text-center py-2 rounded-lg font-medium transition" data-value="餐厅">餐厅</div>
                                <div class="suggestion-item cursor-pointer text-sm bg-red-50 hover:bg-red-100 text-red-700 text-center py-2 rounded-lg font-medium transition" data-value="阳台">阳台</div>
                            </div>
                        `;
                    } else {
                        suggestionsTitle.textContent = '推荐位置';
                        suggestionsContent.innerHTML = `
                            <div class="suggestion-item cursor-pointer text-sm text-gray-700 hover:text-blue-600 transition" data-value="房门口">• 房门口、走廊入口等开阔地点</div>
                            <div class="suggestion-item cursor-pointer text-sm text-gray-700 hover:text-blue-600 transition" data-value="客厅中央">• 客厅中央、餐厅中央等空旷区域</div>
                            <div class="suggestion-item cursor-pointer text-sm text-gray-700 hover:text-blue-600 transition" data-value="各房间的连接通道处">• 各房间的连接通道处</div>
                        `;
                    }
                    
                    // 添加点击事件
                    const suggestionItems = suggestionsContent.querySelectorAll('.suggestion-item');
                    suggestionItems.forEach(item => {
                        item.addEventListener('click', function() {
                            const value = this.getAttribute('data-value');
                            input.value = value;
                            input.focus();
                        });
                    });
                } else {
                    suggestions.classList.add('hidden');
                }
                
                // 聚焦输入框
                setTimeout(() => input.focus(), 100);
            } else {
                inputContainer.classList.add('hidden');
                suggestions.classList.add('hidden');
            }
            
            // 设置按钮文本
            if (config.type === 'alert') {
                cancelBtn.classList.add('hidden');
                confirmBtn.textContent = config.confirmText || '确定';
                confirmBtn.classList.remove('flex-1');
                confirmBtn.classList.add('w-full');
            } else {
                cancelBtn.classList.remove('hidden');
                confirmBtn.classList.add('flex-1');
                confirmBtn.classList.remove('w-full');
                cancelBtn.textContent = config.cancelText || '取消';
                confirmBtn.textContent = config.confirmText || '确定';
            }
            
            // 显示弹窗
            modal.classList.remove('hidden');
            
            return new Promise((resolve) => {
                currentModalResolve = resolve;
            });
        }
        
        function hideModal() {
            const modal = document.getElementById('app-modal');
            modal.classList.add('hidden');
        }
        
        // 替换原生弹窗的函数
        function appAlert(message, title = '提示') {
            return showModal({
                type: 'alert',
                title: title,
                message: message,
                confirmText: '确定'
            });
        }
        
        function appConfirm(message, title = '确认') {
            return showModal({
                type: 'confirm',
                title: title,
                message: message,
                cancelText: '取消',
                confirmText: '确定'
            });
        }
        
        function appPrompt(message, defaultValue = '', placeholder = '请输入内容', title = '输入') {
            return showModal({
                type: 'prompt',
                title: title,
                message: message,
                defaultValue: defaultValue,
                placeholder: placeholder,
                cancelText: '取消',
                confirmText: '确定'
            });
        }
        
        // Toast提示功能
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg z-50 text-white font-medium`;
            
            switch (type) {
                case 'success':
                    toast.classList.add('bg-green-500');
                    break;
                case 'error':
                    toast.classList.add('bg-red-500');
                    break;
                case 'warning':
                    toast.classList.add('bg-yellow-500');
                    break;
                default:
                    toast.classList.add('bg-blue-500');
            }
            
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // 自动移除
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }

        // 切换页面的简单实现
        document.addEventListener('DOMContentLoaded', function() {
            
            // 电量随机更新系统
            let currentBatteryLevel = 85; // 当前电量百分比
            
            // 生成30%-85%之间的随机电量
            function generateRandomBattery() {
                return Math.floor(Math.random() * (85 - 30 + 1)) + 30;
            }
            
            // 根据电量级别获取电池图标和颜色
            function getBatteryIcon(level) {
                if (level >= 75) return { icon: 'fas fa-battery-full', color: 'text-green-500' };
                if (level >= 50) return { icon: 'fas fa-battery-three-quarters', color: 'text-green-500' };
                if (level >= 25) return { icon: 'fas fa-battery-half', color: 'text-yellow-500' };
                return { icon: 'fas fa-battery-quarter', color: 'text-red-500' };
            }
            
            // 根据电量计算预计时间和里程
            function calculateBatteryInfo(level) {
                const baseHours = 8; // 100%电量的基准使用时间
                const baseKm = 35; // 100%电量的基准里程
                
                const hours = Math.floor((level / 100) * baseHours);
                const minutes = Math.floor(((level / 100) * baseHours - hours) * 60);
                const km = Math.floor((level / 100) * baseKm);
                
                return {
                    timeText: `${hours} hours and ${minutes} minutes`,
                    distance: km
                };
            }
            
            // 更新所有电量显示
            function updateBatteryDisplay() {
                currentBatteryLevel = generateRandomBattery();
                const batteryInfo = calculateBatteryInfo(currentBatteryLevel);
                const batteryIcon = getBatteryIcon(currentBatteryLevel);
                
                // 更新主界面电量显示
                const batteryPercentage = document.getElementById('battery-percentage');
                if (batteryPercentage) {
                    batteryPercentage.textContent = `${currentBatteryLevel}%`;
                }
                
                // 更新电池图标
                const batteryIconElement = document.getElementById('battery-icon');
                if (batteryIconElement) {
                    batteryIconElement.className = `${batteryIcon.icon} ${batteryIcon.color} text-xl`;
                }
                
                // 更新语音助手对话中的电量信息
                const batteryStatusText = document.getElementById('battery-status-text');
                if (batteryStatusText) {
                    batteryStatusText.textContent = `Your wheelchair's current battery is at ${currentBatteryLevel}%, estimated to last ${batteryInfo.timeText}, with a driving range of about ${batteryInfo.distance} km.`;
                }
                
                // 更新历史对话中的电量信息
                const batteryHistoryText = document.getElementById('battery-history-text');
                if (batteryHistoryText) {
                    batteryHistoryText.textContent = `Your wheelchair's current battery is at ${currentBatteryLevel}%, estimated to last ${batteryInfo.timeText}, with a driving range of about ${batteryInfo.distance} km.`;
                }
                
                // Update estimated range and usage time on device status page
                const estimatedDistance = document.getElementById('estimated-distance');
                const estimatedUsageTime = document.getElementById('estimated-usage-time');
                const todayDistance = document.getElementById('today-distance');
                const currentSpeedStatus = document.getElementById('current-speed-status');
                if (estimatedDistance) {
                    estimatedDistance.textContent = `${batteryInfo.distance} km`;
                }
                if (estimatedUsageTime) {
                    estimatedUsageTime.textContent = batteryInfo.timeText;
                }
                // 今日里程和当前速度基于当前设备的基础数据，不随电量变化
                if (todayDistance || currentSpeedStatus) {
                    const currentDeviceData = generateDeviceData({name: 'CM-6001'}); // 获取当前设备数据
                    if (todayDistance) {
                        todayDistance.textContent = `${currentDeviceData.distance} km`;
                    }
                    if (currentSpeedStatus) {
                        currentSpeedStatus.textContent = currentDeviceData.speed;
                    }
                }
                
                // 建图小贴士保持静态内容，电量状态由按钮显示
                
                // 更新新建地图按钮状态
                const createNewMapBtn = document.getElementById('create-new-map-btn');
                if (createNewMapBtn) {
                    if (currentBatteryLevel < 50) {
                        // 电量不足时禁用按钮
                        createNewMapBtn.disabled = true;
                        createNewMapBtn.className = 'w-full bg-gray-400 text-gray-600 py-3 rounded-xl font-medium flex items-center justify-center mb-4 cursor-not-allowed';
                        createNewMapBtn.innerHTML = `
                            <i class="fas fa-battery-quarter mr-2"></i>
                            电量不足，无法建图 (${currentBatteryLevel}%)
                        `;
                    } else {
                        // 电量充足时恢复按钮
                        createNewMapBtn.disabled = false;
                        createNewMapBtn.className = 'w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-medium flex items-center justify-center mb-4';
                        createNewMapBtn.innerHTML = `
                            <i class="fas fa-plus mr-2"></i>
                            新建地图
                        `;
                    }
                }
                
                // 更新全局电量状态（用于动态生成的内容）
                window.currentBatteryStatus = {
                    level: currentBatteryLevel,
                    timeText: batteryInfo.timeText,
                    distance: batteryInfo.distance,
                                            fullText: `Your wheelchair's current battery is at ${currentBatteryLevel}%, estimated to last ${batteryInfo.timeText}, with a driving range of about ${batteryInfo.distance} km. The wheelchair is in good overall condition with no abnormal faults.`
                };
                
                console.log(`🔋 电量已更新: ${currentBatteryLevel}% (${batteryInfo.timeText}, ${batteryInfo.distance}km)`);
            }
            
            // 启动电量随机更新定时器
            function startBatteryUpdater() {
                // 立即执行一次
                updateBatteryDisplay();
                
                // 每10秒更新一次
                setInterval(updateBatteryDisplay, 10000);
            }
            
            // 启动电量更新系统
            startBatteryUpdater();
            
            // 登录注册表单切换
            const showLoginBtn = document.getElementById('show-login-btn');
            const showRegisterBtn = document.getElementById('show-register-btn');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            
            if (showLoginBtn && showRegisterBtn && loginForm && registerForm) {
                showLoginBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    registerForm.classList.add('hidden');
                    loginForm.classList.remove('hidden');
                });
                
                showRegisterBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    loginForm.classList.add('hidden');
                    registerForm.classList.remove('hidden');
                });
            }
            
            // 导航栏切换
            const navLinks = document.querySelectorAll('nav a');
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // 移除所有页面的active状态
                    navLinks.forEach(l => l.classList.remove('text-blue-500'));
                    navLinks.forEach(l => l.classList.add('text-gray-400'));
                    
                    // 设置当前页面为active
                    this.classList.remove('text-gray-400');
                    this.classList.add('text-blue-500');
                    
                    // 隐藏所有页面
                    const allPages = [
                        'login', 'add-device', 'wifi-setup', 'device-success', 'control', 
                        'device-status', 'profile', 'voice', 'map-management', 'create-map-check',
                        'map-naming', 'environment-check', 'mapping-precautions', 'real-time-mapping',
                        'set-charging-station', 'set-waypoints', 'set-parking-spots', 'set-safety-zones',
                        'set-restricted-zones', 'mapping-complete'
                    ];
                    
                    allPages.forEach(pageId => {
                        const page = document.getElementById(pageId);
                        if (page) {
                            page.classList.add('hidden');
                        }
                    });
                    
                    // 显示对应页面
                    const target = this.getAttribute('href').substring(1);
                    if (target === 'home') {
                        document.getElementById('login').classList.remove('hidden');
                    } else if (target === 'control') {
                        document.getElementById('control').classList.remove('hidden');
                    } else if (target === 'device') {
                        document.getElementById('device-status').classList.remove('hidden');
                    } else if (target === 'profile') {
                        document.getElementById('profile').classList.remove('hidden');
                    } else if (target === 'voice') {
                        document.getElementById('voice').classList.remove('hidden');
                    }
                });
            });
            


            // 添加设备页面返回按钮
            const deviceBackBtn = document.createElement('button');
            deviceBackBtn.className = 'absolute top-4 left-4 text-gray-600';
            deviceBackBtn.innerHTML = '<i class="fas fa-arrow-left"></i>';
            deviceBackBtn.addEventListener('click', function() {
                // 隐藏添加设备页面
                document.getElementById('add-device').classList.add('hidden');
                // 显示设备状态页面
                document.getElementById('device-status').classList.remove('hidden');
            });
            
            // 添加返回按钮到添加设备页面
            const addDevicePage = document.getElementById('add-device');
            if (addDevicePage && !addDevicePage.querySelector('.back-btn')) {
                addDevicePage.style.position = 'relative';
                addDevicePage.appendChild(deviceBackBtn);
            }
            
            // 连接设备按钮事件
            const connectDeviceBtn = document.getElementById('connect-device-btn');
            if (connectDeviceBtn) {
                connectDeviceBtn.addEventListener('click', function() {
                    // 隐藏添加设备页面
                    document.getElementById('add-device').classList.add('hidden');
                    // 显示WiFi设置页面
                    document.getElementById('wifi-setup').classList.remove('hidden');
                    
                    // 添加返回按钮到WiFi设置页面
                    const wifiSetupPage = document.getElementById('wifi-setup');
                    if (wifiSetupPage && !wifiSetupPage.querySelector('.back-btn')) {
                        const wifiBackBtn = document.createElement('button');
                        wifiBackBtn.className = 'absolute top-4 left-4 text-gray-600 back-btn';
                        wifiBackBtn.innerHTML = '<i class="fas fa-arrow-left"></i>';
                        wifiBackBtn.addEventListener('click', function() {
                            // 隐藏WiFi设置页面
                            document.getElementById('wifi-setup').classList.add('hidden');
                            // 显示添加设备页面
                            document.getElementById('add-device').classList.remove('hidden');
                        });
                        wifiSetupPage.style.position = 'relative';
                        wifiSetupPage.appendChild(wifiBackBtn);
                    }
                });
            }
            
            // 刷新设备列表按钮事件
            const refreshDevicesBtn = document.getElementById('refresh-devices-btn');
            if (refreshDevicesBtn) {
                refreshDevicesBtn.addEventListener('click', function() {
                    // 模拟刷新过程
                    const spinner = document.querySelector('#add-device .animate-spin');
                    if (spinner) {
                        spinner.style.display = 'block';
                        setTimeout(async function() {
                            spinner.style.display = 'none';
                            await appAlert('已刷新设备列表', '设备刷新');
                        }, 1500);
                    }
                });
            }

            // WiFi配置确认按钮事件
            const confirmWifiBtn = document.getElementById('confirm-wifi-btn');
            if (confirmWifiBtn) {
                confirmWifiBtn.addEventListener('click', function() {
                    // 显示加载动画
                    const loadingEl = document.createElement('div');
                    loadingEl.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                    loadingEl.innerHTML = '<div class="bg-white p-5 rounded-lg"><div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mx-auto mb-3"></div><p class="text-center">正在配置Wi-Fi，请稍候...</p></div>';
                    document.body.appendChild(loadingEl);
                    
                    // 模拟配置过程
                    setTimeout(function() {
                        // 移除加载动画
                        document.body.removeChild(loadingEl);
                        
                        // 隐藏WiFi设置页面
                        document.getElementById('wifi-setup').classList.add('hidden');
                        // 显示设备添加成功页面
                        document.getElementById('device-success').classList.remove('hidden');
                    }, 2000);
                });
            }
            
            // 前往设备状态按钮事件
            const goToDeviceStatusBtn = document.getElementById('go-to-device-status-btn');
            if (goToDeviceStatusBtn) {
                goToDeviceStatusBtn.addEventListener('click', function() {
                    // 隐藏设备添加成功页面
                    document.getElementById('device-success').classList.add('hidden');
                    // 显示设备状态页面
                    document.getElementById('device-status').classList.remove('hidden');
                    
                    // 激活导航栏"设备"选项
                    navLinks.forEach(l => l.classList.remove('text-blue-500'));
                    navLinks.forEach(l => l.classList.add('text-gray-400'));
                    
                    const deviceNavLink = document.querySelector('nav a[href="#device"]');
                    if (deviceNavLink) {
                        deviceNavLink.classList.remove('text-gray-400');
                        deviceNavLink.classList.add('text-blue-500');
                    }
                });
            }

            // 虚拟摇杆简单交互
            const joystick = document.querySelector('.joystick');
            const container = document.querySelector('.joystick-container');
            
            if (joystick && container) {
                let isDragging = false;
                
                joystick.addEventListener('mousedown', function(e) {
                    isDragging = true;
                });
                
                document.addEventListener('mousemove', function(e) {
                    if (!isDragging) return;
                    
                    const containerRect = container.getBoundingClientRect();
                    const centerX = containerRect.left + containerRect.width / 2;
                    const centerY = containerRect.top + containerRect.height / 2;
                    
                    let x = e.clientX - centerX;
                    let y = e.clientY - centerY;
                    
                    // 限制在圆形范围内
                    const radius = containerRect.width / 2 - joystick.offsetWidth / 2;
                    const distance = Math.sqrt(x * x + y * y);
                    
                    if (distance > radius) {
                        x = (x / distance) * radius;
                        y = (y / distance) * radius;
                    }
                    
                    joystick.style.transform = `translate(${x}px, ${y}px)`;
                });
                
                document.addEventListener('mouseup', function() {
                    if (!isDragging) return;
                    isDragging = false;
                    
                    // 回到中心位置
                    joystick.style.transform = 'translate(-50%, -50%)';
                });
            }
            
            // 设备详情模态框控制
            const showDeviceDetailsBtn = document.getElementById('show-device-details-btn');
            const closeDeviceDetailsBtn = document.getElementById('close-device-details-btn');
            const deviceDetailsModal = document.getElementById('device-details-modal');
            
            if (showDeviceDetailsBtn && closeDeviceDetailsBtn && deviceDetailsModal) {
                showDeviceDetailsBtn.addEventListener('click', function() {
                    deviceDetailsModal.classList.remove('hidden');
                });
                
                closeDeviceDetailsBtn.addEventListener('click', function() {
                    deviceDetailsModal.classList.add('hidden');
                });
                
                // 设备详情模态框点击外部关闭
                deviceDetailsModal.addEventListener('click', function(e) {
                    if (e.target === deviceDetailsModal) {
                        deviceDetailsModal.classList.add('hidden');
                    }
                });
            }
            
            // 远程控制按钮事件
            const remoteControlBtn = document.getElementById('remote-control-btn');
            if (remoteControlBtn) {
                remoteControlBtn.addEventListener('click', function() {
                    // 隐藏设备状态页面
                    document.getElementById('device-status').classList.add('hidden');
                    // 显示控制页面
                    document.getElementById('control').classList.remove('hidden');
                });
            }
            
            // 控制页面返回按钮事件
            const controlBackBtn = document.getElementById('control-back-btn');
            if (controlBackBtn) {
                controlBackBtn.addEventListener('click', function() {
                    // 隐藏控制页面
                    document.getElementById('control').classList.add('hidden');
                    // 显示设备状态页面
                    document.getElementById('device-status').classList.remove('hidden');
                });
            }
            
            // 实时视频相关功能
            const videoElement = document.getElementById('remote-video');
            const videoPlaceholder = document.getElementById('video-placeholder');
            const toggleFullscreen = document.getElementById('toggle-fullscreen');
            const toggleMic = document.getElementById('toggle-mic');
            
            if (videoElement && videoPlaceholder) {
                // 模拟视频加载
                setTimeout(() => {
                    // 通常这里会是真实的视频流，这里用模拟数据
                    const simulatedVideoSource = 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerJoyrides.mp4';
                    
                    videoElement.src = simulatedVideoSource;
                    videoElement.onloadeddata = () => {
                        videoPlaceholder.style.display = 'none';
                    };
                    
                    // 错误处理
                    videoElement.onerror = () => {
                        videoPlaceholder.innerHTML = '<p class="text-gray-400 text-sm">视频加载失败，请检查网络连接</p>';
                    };
                }, 2000);
            }
            
            // 全屏切换
            if (toggleFullscreen) {
                toggleFullscreen.addEventListener('click', () => {
                    if (!document.fullscreenElement) {
                        if (videoElement.requestFullscreen) {
                            videoElement.requestFullscreen();
                        } else if (videoElement.webkitRequestFullscreen) {
                            videoElement.webkitRequestFullscreen();
                        } else if (videoElement.msRequestFullscreen) {
                            videoElement.msRequestFullscreen();
                        }
                        toggleFullscreen.innerHTML = '<i class="fas fa-compress"></i>';
                    } else {
                        if (document.exitFullscreen) {
                            document.exitFullscreen();
                        } else if (document.webkitExitFullscreen) {
                            document.webkitExitFullscreen();
                        } else if (document.msExitFullscreen) {
                            document.msExitFullscreen();
                        }
                        toggleFullscreen.innerHTML = '<i class="fas fa-expand"></i>';
                    }
                });
                
                // 监听全屏变化
                document.addEventListener('fullscreenchange', () => {
                    if (!document.fullscreenElement) {
                        toggleFullscreen.innerHTML = '<i class="fas fa-expand"></i>';
                    }
                });
            }
            
            // 麦克风切换（模拟功能）
            let micEnabled = false;
            if (toggleMic) {
                toggleMic.addEventListener('click', () => {
                    micEnabled = !micEnabled;
                    if (micEnabled) {
                        toggleMic.innerHTML = '<i class="fas fa-microphone"></i>';
                        // 这里应该启用麦克风
                    } else {
                        toggleMic.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                        // 这里应该禁用麦克风
                    }
                });
            }

            // 档位调节功能
            const decreaseLevelBtn = document.getElementById('decrease-level');
            const increaseLevelBtn = document.getElementById('increase-level');
            const levelIndicator = document.getElementById('level-indicator');
            const currentSpeedDisplay = document.getElementById('current-speed');
            
            // 档位与速度对应表
            const speedLevels = {
                1: {width: '20%', speed: '1.0 km/h'},
                2: {width: '40%', speed: '1.8 km/h'},
                3: {width: '60%', speed: '2.5 km/h'}, // 默认值
                4: {width: '80%', speed: '3.2 km/h'},
                5: {width: '100%', speed: '4.0 km/h'}
            };
            
            // 当前档位
            let currentLevel = 3;
            
            // 更新档位显示和车速
            function updateSpeedLevel() {
                if (levelIndicator && currentSpeedDisplay) {
                    const levelData = speedLevels[currentLevel];
                    levelIndicator.style.width = levelData.width;
                    currentSpeedDisplay.textContent = levelData.speed;
                    
                    // 更新档位数字显示
                    const levelTexts = document.querySelectorAll('.flex.justify-between.mt-1 .text-xs');
                    levelTexts.forEach((text, index) => {
                        const level = index + 1;
                        if (level === currentLevel) {
                            text.classList.add('font-bold', 'text-blue-600');
                        } else {
                            text.classList.remove('font-bold', 'text-blue-600');
                        }
                    });
                }
            }
            
            // 绑定按钮事件
            if (decreaseLevelBtn && increaseLevelBtn) {
                decreaseLevelBtn.addEventListener('click', () => {
                    if (currentLevel > 1) {
                        currentLevel--;
                        updateSpeedLevel();
                    }
                });
                
                increaseLevelBtn.addEventListener('click', () => {
                    if (currentLevel < 5) {
                        currentLevel++;
                        updateSpeedLevel();
                    }
                });
                
                // 初始化显示
                updateSpeedLevel();
            }

            // 语音交互相关代码
            const voiceBtn = document.getElementById('voice-btn');
            const voiceIndicator = document.getElementById('voice-indicator');
            const voiceText = document.getElementById('voice-text');
            const conversationContainer = document.getElementById('conversation-container');
            
            // 室内地图和定位功能
            let indoorMapCanvas = null;
            let indoorMapCtx = null;
            let wheelchairPosition = { x: 40, y: 60 }; // 轮椅位置百分比
            let chargingPosition = { x: 20, y: 20 }; // 充电桩位置百分比
            let isPositioningNormal = true; // 定位是否正常
            let isOnPath = true; // 是否在已知路径上
            
            // 显示定位异常错误 - 全局函数
            window.showPositioningError = function(action, errorType = 'positioning') {
                const errorModal = document.getElementById('positioning-error-modal');
                const errorTitle = document.getElementById('positioning-error-title');
                const errorMessage = document.getElementById('positioning-error-message');
                const errorSuggestions = document.getElementById('positioning-error-suggestions');
                const closeErrorBtn = document.getElementById('close-positioning-error-btn');
                const recalibrateBtn = document.getElementById('recalibrate-btn');
                
                console.log('🚨 显示定位错误弹窗:', action, errorType);
                
                // 根据异常类型设置不同的内容
                if (errorType === 'out_of_path') {
                    if (errorTitle) {
                        errorTitle.textContent = '超出规定路径';
                    }
                    if (errorMessage) {
                        errorMessage.textContent = `无法执行${action}操作：轮椅当前不在允许的行驶路径上。`;
                    }
                    if (errorSuggestions) {
                        errorSuggestions.innerHTML = `
                            <li>• 确保轮椅在室内地图覆盖范围内</li>
                            <li>• 将轮椅移动到充电桩上</li>
                            <li>• 然后重新校准轮椅位置</li>
                        `;
                    }
                } else {
                    // 默认的定位异常
                    if (errorTitle) {
                        errorTitle.textContent = '定位异常';
                    }
                    if (errorMessage) {
                        errorMessage.textContent = `无法执行${action}操作：轮椅当前定位不准确或不在已知路径上。`;
                    }
                    if (errorSuggestions) {
                        errorSuggestions.innerHTML = `
                            <li>• 确保轮椅在室内地图覆盖范围内</li>
                            <li>• 将轮椅移动到充电桩上</li>
                            <li>• 然后重新校准轮椅位置</li>
                        `;
                    }
                }
                
                if (errorModal) {
                    errorModal.classList.remove('hidden');
                    console.log('✅ 定位错误弹窗已显示');
                } else {
                    console.error('❌ 未找到定位错误弹窗元素');
                }
                
                if (closeErrorBtn) {
                    closeErrorBtn.onclick = function() {
                        errorModal.classList.add('hidden');
                        console.log('❌ 定位错误弹窗已关闭');
                    };
                }
                
                if (recalibrateBtn) {
                    recalibrateBtn.onclick = function() {
                        errorModal.classList.add('hidden');
                        window.startRecalibration();
                        console.log('🔄 开始重新校准');
                    };
                }
            };
            
            // 开始重新校准 - 全局函数
            window.startRecalibration = function() {
                console.log('🔄 开始校准过程');
                
                // 模拟校准过程
                const toast = document.createElement('div');
                toast.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                toast.textContent = '正在重新校准定位...';
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.textContent = '校准完成，定位已恢复正常';
                    toast.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                    
                    // 恢复定位状态
                    isPositioningNormal = true;
                    isOnPath = true;
                    if (typeof checkPositioningStatus === 'function') {
                        checkPositioningStatus();
                    }
                    
                    setTimeout(() => {
                        if (document.body.contains(toast)) {
                            document.body.removeChild(toast);
                        }
                    }, 2000);
                }, 3000);
            };
            
            // 确保函数在全局作用域可用
            window.showPositioningError = window.showPositioningError;
            window.startRecalibration = window.startRecalibration;
            
            // 确保导航函数全局可用
            window.startNavigation = function(type, destination) {
                console.log('🚀 全局导航函数被调用:', type, destination);
                
                // 记录当前页面作为来源页面
                const currentPage = document.querySelector('div[id]:not(.hidden)');
                navigationSourcePage = currentPage ? currentPage.id : 'device-status';
                console.log('📍 导航来源页面:', navigationSourcePage);
                
                currentNavigationType = type;
                currentDestination = destination;
                
                // 显示导航页面
                showPage('navigation');
                
                // 显示倒计时页面
                window.showNavigationCountdown(destination);
                
                // 开始倒计时
                window.startCountdown();
            };
            
            // 确保其他导航相关函数全局可用
            window.showNavigationCountdown = function(destination) {
                console.log('⏱️ 显示导航倒计时页面, 目的地:', destination);
                console.log('📊 当前导航类型:', currentNavigationType);
                
                const countdownDiv = document.getElementById('navigation-countdown');
                const progressDiv = document.getElementById('navigation-progress');
                const completeDiv = document.getElementById('navigation-complete');
                
                console.log('🔍 查找页面元素:', {
                    countdownDiv: !!countdownDiv,
                    progressDiv: !!progressDiv,
                    completeDiv: !!completeDiv
                });
                
                // 确保在navigation页面内查找
                const navigationPage = document.getElementById('navigation');
                console.log('📄 导航页面:', !!navigationPage, navigationPage?.classList.contains('hidden'));
                
                // 隐藏其他状态，显示倒计时
                if (progressDiv) {
                    progressDiv.classList.add('hidden');
                    console.log('❌ 进度页面已隐藏');
                }
                if (completeDiv) {
                    completeDiv.classList.add('hidden');
                    console.log('❌ 完成页面已隐藏');
                }
                
                if (countdownDiv) {
                    // 移除hidden类并重置display样式
                    countdownDiv.classList.remove('hidden');
                    countdownDiv.style.display = '';  // 重置display样式
                    console.log('✅ 倒计时页面已显示');
                    console.log('🎯 倒计时页面样式:', countdownDiv.style.display, countdownDiv.classList.toString());
                } else {
                    console.error('❌ 倒计时页面元素未找到');
                }
                
                // 更新倒计时内容
                const countdownTitle = document.getElementById('countdown-title');
                const countdownMessage = document.getElementById('countdown-message');
                
                if (countdownTitle) {
                    countdownTitle.textContent = currentNavigationType === 'charging' ? '准备去充电' : '准备召唤';
                }
                if (countdownMessage) {
                    countdownMessage.textContent = `即将开始前往${destination}...`;
                }
            };
            
            window.startCountdown = function() {
                let countdown = 5;
                const countdownNumber = document.getElementById('countdown-number');
                
                console.log('⏰ 开始5秒倒计时');
                
                if (countdownNumber) countdownNumber.textContent = countdown;
                
                countdownTimer = setInterval(() => {
                    countdown--;
                    if (countdownNumber) countdownNumber.textContent = countdown;
                    
                    if (countdown <= 0) {
                        clearInterval(countdownTimer);
                        console.log('⏰ 倒计时结束，开始导航进度');
                        window.startNavigationProgress();
                                         }
                 }, 1000);
             };
             
             window.startNavigationProgress = function() {
                 console.log('🚀 开始导航进度页面');
                 
                 // 隐藏倒计时页面
                 const countdownDiv = document.getElementById('navigation-countdown');
                 if (countdownDiv) {
                     countdownDiv.style.display = 'none';
                     console.log('❌ 倒计时页面已隐藏');
                 }
                 
                 // 隐藏完成页面
                 const completeDiv = document.getElementById('navigation-complete');
                 if (completeDiv) {
                     completeDiv.style.display = 'none';
                 }
                 
                 // 直接创建导航进度界面
                 window.createNavigationProgressUI();
             };
             
             // 全局导航进度UI创建函数
             window.createNavigationProgressUI = function() {
                 console.log('📱 创建导航进度界面');
                 
                 // 移除现有的进度页面
                 const existingProgress = document.getElementById('navigation-progress');
                 if (existingProgress) {
                     existingProgress.remove();
                 }
                 
                 // 创建新的导航进度界面
                 const progressContainer = document.createElement('div');
                 progressContainer.id = 'navigation-progress';
                 progressContainer.style.cssText = `
                     position: fixed !important;
                     top: 0 !important;
                     left: 0 !important;
                     right: 0 !important;
                     bottom: 0 !important;
                     background: #f9fafb !important;
                     z-index: 10000 !important;
                     overflow-y: auto !important;
                     padding: 20px !important;
                 `;
                 
                 progressContainer.innerHTML = `
                     <!-- 导航状态栏 -->
                     <div style="background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 16px; margin-bottom: 16px;">
                         <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                             <h2 style="font-size: 18px; font-weight: 600; margin: 0;" id="dynamic-navigation-title">
                                 ${currentNavigationType === 'charging' ? '正在前往充电桩' : `正在前往${currentDestination}`}
                             </h2>
                             <div style="display: flex; align-items: center; color: #10b981;">
                                 <div style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; margin-right: 8px; animation: pulse 2s infinite;"></div>
                                 <span style="font-size: 14px;">导航中</span>
                             </div>
                         </div>
                         
                         <!-- 导航信息 -->
                         <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; text-align: center;">
                             <div>
                                 <p style="font-size: 12px; color: #6b7280; margin: 0 0 4px 0;">剩余距离</p>
                                 <p style="font-size: 18px; font-weight: 600; color: #8b5cf6; margin: 0;" id="dynamic-remaining-distance">8.5m</p>
                             </div>
                             <div>
                                 <p style="font-size: 12px; color: #6b7280; margin: 0 0 4px 0;">预计时间</p>
                                 <p style="font-size: 18px; font-weight: 600; color: #3b82f6; margin: 0;" id="dynamic-estimated-time">2分30秒</p>
                             </div>
                             <div>
                                 <p style="font-size: 12px; color: #6b7280; margin: 0 0 4px 0;">当前速度</p>
                                 <p style="font-size: 18px; font-weight: 600; color: #10b981; margin: 0;" id="dynamic-current-speed">0.8m/s</p>
                             </div>
                         </div>
                     </div>

                     <!-- 地图区域 -->
                     <div style="background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 16px; margin-bottom: 16px;">
                         <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                             <h3 style="font-weight: 500; margin: 0;">实时位置</h3>
                             <button id="dynamic-refresh-location-btn" style="color: #3b82f6; font-size: 14px; background: none; border: none; cursor: pointer;">
                                 <i class="fas fa-sync" style="margin-right: 4px;"></i>刷新
                             </button>
                         </div>
                         
                         <!-- 简化地图视图 -->
                         <div style="position: relative; background: #f3f4f6; border-radius: 8px; height: 192px; overflow: hidden;">
                             <!-- 轮椅位置 -->
                             <div id="dynamic-wheelchair-position" style="position: absolute; left: 80px; top: 80px; transition: all 1s ease;">
                                 <div style="width: 24px; height: 24px; background: #8b5cf6; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                     <i class="fas fa-wheelchair" style="color: white; font-size: 12px;"></i>
                                 </div>
                                 <div style="position: absolute; top: -32px; left: 50%; transform: translateX(-50%); background: #8b5cf6; color: white; font-size: 12px; padding: 4px 8px; border-radius: 4px;">
                                     轮椅
                                 </div>
                             </div>
                             
                             <!-- 目标位置 -->
                             <div style="position: absolute; left: 250px; top: 75px;">
                                 <div style="width: 24px; height: 24px; background: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; animation: pulse 2s infinite;">
                                     <i class="fas fa-flag" style="color: white; font-size: 12px;"></i>
                                 </div>
                             </div>
                             
                             <!-- 路径指示 -->
                             <div style="position: absolute; left: 100px; top: 85px; right: 50px; height: 4px; background: linear-gradient(90deg, #8b5cf6, #10b981); border-radius: 2px; opacity: 0.8;">
                             </div>
                         </div>
                     </div>

                     <!-- 导航进度 -->
                     <div style="background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 16px; margin-bottom: 100px;">
                         <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                             <span style="font-size: 14px; font-weight: 500;">导航进度</span>
                             <span style="font-size: 14px; color: #8b5cf6;" id="dynamic-navigation-percentage">15%</span>
                         </div>
                         <div style="width: 100%; background: #e5e7eb; border-radius: 9999px; height: 8px;">
                             <div id="dynamic-navigation-progress-bar" style="background: #8b5cf6; height: 8px; border-radius: 9999px; transition: width 0.5s ease; width: 15%;"></div>
                         </div>
                     </div>

                     <!-- 圆形取消按钮 -->
                     <div style="position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%);">
                         <button id="dynamic-cancel-navigation-btn" style="
                             width: 120px; 
                             height: 120px; 
                             background: linear-gradient(135deg, #ef4444, #dc2626); 
                             color: white; 
                             border-radius: 50%; 
                             border: 4px solid white;
                             box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4), 0 4px 12px rgba(0, 0, 0, 0.1); 
                             cursor: pointer;
                             display: flex;
                             flex-direction: column;
                             align-items: center;
                             justify-content: center;
                             font-size: 16px;
                             font-weight: 700;
                             transition: all 0.2s ease;
                             outline: none;
                             -webkit-tap-highlight-color: transparent;
                         " 
                         onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 12px 32px rgba(239, 68, 68, 0.5), 0 6px 16px rgba(0, 0, 0, 0.15)'" 
                         onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 8px 24px rgba(239, 68, 68, 0.4), 0 4px 12px rgba(0, 0, 0, 0.1)'" 
                         onmousedown="this.style.transform='scale(0.95)'"
                         onmouseup="this.style.transform='scale(1.05)'">
                             <i class="fas fa-stop" style="font-size: 24px; margin-bottom: 8px;"></i>
                             <span>取消导航</span>
                         </button>
                     </div>
                 `;
                 
                 // 添加到导航页面
                 const navigationPage = document.getElementById('navigation');
                 if (navigationPage) {
                     navigationPage.appendChild(progressContainer);
                     console.log('✅ 导航进度界面已添加到页面');
                     
                     // 绑定取消按钮事件
                     setTimeout(() => {
                         const cancelBtn = document.getElementById('dynamic-cancel-navigation-btn');
                         if (cancelBtn) {
                             cancelBtn.onclick = async function(e) {
                                 e.preventDefault();
                                 e.stopPropagation();
                                 console.log('🛑 取消按钮被点击！');
                                 
                                 const confirmed = await window.showMobileConfirm(
                                     '导航将会停止，轮椅会停在当前位置',
                                     '取消导航',
                                     '确认取消',
                                     '继续导航'
                                 );
                                 
                                 if (confirmed) {
                                     console.log('✅ 用户确认取消导航');
                                     window.stopNavigation();
                                     const targetPage = navigationSourcePage || 'device-status';
                                     showPage(targetPage);
                                     console.log('🏠 返回来源页面:', targetPage);
                                 } else {
                                     console.log('❌ 用户取消了取消操作');
                                 }
                             };
                         }
                     }, 200);
                     
                     // 绑定刷新按钮事件
                     const refreshBtn = document.getElementById('dynamic-refresh-location-btn');
                     if (refreshBtn) {
                         refreshBtn.addEventListener('click', function() {
                             this.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 4px;"></i>刷新中';
                             setTimeout(() => {
                                 this.innerHTML = '<i class="fas fa-sync" style="margin-right: 4px;"></i>刷新';
                                 // showToast('位置已更新', 'success');
                             }, 1000);
                         });
                     }
                     
                                           // 开始模拟导航进度
                      window.simulateNavigationProgress();
                  } else {
                      console.error('❌ 导航页面未找到！');
                  }
              };
              
              // 全局模拟导航进度函数
              window.simulateNavigationProgress = function() {
                  console.log('🚀 开始模拟导航进度');
                  let progress = 0;
                  let distance = 8.5; // 初始距离
                  let timeRemaining = 150; // 2分30秒
                  
                  progressTimer = setInterval(() => {
                      progress += Math.random() * 3 + 1; // 随机增加1-4%
                      distance = Math.max(0, distance - (Math.random() * 0.3 + 0.1)); // 减少距离
                      timeRemaining = Math.max(0, timeRemaining - Math.random() * 4 - 2); // 减少时间
                      
                      // 限制进度最大值
                      progress = Math.min(progress, 100);
                      
                      // 更新UI - 使用动态创建的元素ID
                      const progressBar = document.getElementById('dynamic-navigation-progress-bar');
                      const progressPercentage = document.getElementById('dynamic-navigation-percentage');
                      const remainingDistance = document.getElementById('dynamic-remaining-distance');
                      const estimatedTime = document.getElementById('dynamic-estimated-time');
                      const currentSpeed = document.getElementById('dynamic-current-speed');
                      const wheelchairPosition = document.getElementById('dynamic-wheelchair-position');
                      
                      if (progressBar) progressBar.style.width = progress + '%';
                      if (progressPercentage) progressPercentage.textContent = Math.round(progress) + '%';
                      if (remainingDistance) remainingDistance.textContent = distance.toFixed(1) + 'm';
                      if (estimatedTime) {
                          const minutes = Math.floor(timeRemaining / 60);
                          const seconds = Math.round(timeRemaining % 60);
                          estimatedTime.textContent = `${minutes}分${seconds}秒`;
                      }
                      if (currentSpeed) {
                          const speed = (Math.random() * 0.4 + 0.6).toFixed(1); // 0.6-1.0 m/s
                          currentSpeed.textContent = speed + 'm/s';
                      }
                      
                      // 更新轮椅位置（模拟移动）
                      if (wheelchairPosition) {
                          const currentLeft = parseInt(wheelchairPosition.style.left) || 80;
                          const targetLeft = 250; // 目标位置
                          const newLeft = currentLeft + (targetLeft - currentLeft) * (progress / 100) * 0.05;
                          wheelchairPosition.style.left = Math.min(newLeft, targetLeft - 10) + 'px';
                      }
                      
                      // 导航完成
                      if (progress >= 100) {
                          clearInterval(progressTimer);
                          setTimeout(() => {
                              window.showNavigationComplete();
                          }, 1000);
                      }
                  }, 1000);
              };
              
              // 全局显示导航完成函数
              window.showNavigationComplete = function() {
                  console.log('🎯 显示导航完成页面');
                  
                  // 移除进度界面
                  const progressDiv = document.getElementById('navigation-progress');
                  if (progressDiv) {
                      progressDiv.remove();
                  }
                  
                  // 创建完成页面
                  const completeContainer = document.createElement('div');
                  completeContainer.id = 'navigation-complete';
                  completeContainer.style.cssText = `
                      position: fixed !important;
                      top: 0 !important;
                      left: 0 !important;
                      right: 0 !important;
                      bottom: 0 !important;
                      background: #f9fafb !important;
                      z-index: 10000 !important;
                      display: flex !important;
                      align-items: center !important;
                      justify-content: center !important;
                      padding: 20px !important;
                  `;
                  
                  const message = currentNavigationType === 'charging' ? 
                      '轮椅已成功到达充电桩' : 
                      `轮椅已成功到达${currentDestination}`;
                  
                  completeContainer.innerHTML = `
                      <div style="background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 40px; text-align: center; max-width: 320px; width: 100%;">
                          <div style="width: 64px; height: 64px; background: #dcfce7; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px;">
                              <i class="fas fa-check" style="color: #16a34a; font-size: 32px;"></i>
                          </div>
                          <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 8px; color: #111827;">导航完成</h2>
                          <p style="color: #6b7280; margin-bottom: 32px; line-height: 1.5;">${message}</p>
                          <button id="dynamic-return-home-btn" style="width: 100%; background: #8b5cf6; color: white; padding: 12px; border-radius: 8px; font-weight: 500; border: none; cursor: pointer;">
                              返回主页
                          </button>
                      </div>
                  `;
                  
                  const navigationPage = document.getElementById('navigation');
                  if (navigationPage) {
                      navigationPage.appendChild(completeContainer);
                      
                      // 绑定返回按钮事件
                      const returnBtn = document.getElementById('dynamic-return-home-btn');
                      if (returnBtn) {
                          returnBtn.addEventListener('click', () => {
                              window.stopNavigation();
                              const targetPage = navigationSourcePage || 'device-status';
                              showPage(targetPage);
                              console.log('🏠 返回来源页面:', targetPage);
                          });
                      }
                  }
              };
              
                          // 全局停止导航函数
            window.stopNavigation = function() {
                console.log('🛑 停止导航');
                
                if (countdownTimer) {
                    clearInterval(countdownTimer);
                    countdownTimer = null;
                }
                if (progressTimer) {
                    clearInterval(progressTimer);
                    progressTimer = null;
                }
                
                // 重置状态
                currentNavigationType = null;
                currentDestination = null;
                navigationSourcePage = null;
                
                // 移除动态创建的进度界面
                const dynamicProgress = document.getElementById('navigation-progress');
                if (dynamicProgress) {
                    dynamicProgress.remove();
                }
                
                const dynamicComplete = document.getElementById('navigation-complete');
                if (dynamicComplete) {
                    dynamicComplete.remove();
                }
            };
            
            // 移动端样式确认对话框
            window.showMobileConfirm = function(message, title = '确认', confirmText = '确认', cancelText = '取消') {
                return new Promise((resolve) => {
                    // 移除可能存在的旧弹窗
                    const existingModal = document.getElementById('mobile-confirm-modal');
                    if (existingModal) {
                        existingModal.remove();
                    }
                    
                    // 创建弹窗容器
                    const modal = document.createElement('div');
                    modal.id = 'mobile-confirm-modal';
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0, 0, 0, 0.5);
                        z-index: 99999;
                        display: flex;
                        align-items: flex-end;
                        justify-content: center;
                        padding: 0;
                        backdrop-filter: blur(4px);
                        animation: fadeIn 0.3s ease-out;
                    `;
                    
                                         // 创建弹窗内容
                     modal.innerHTML = `
                         <style>
                             @keyframes fadeIn {
                                 from { opacity: 0; }
                                 to { opacity: 1; }
                             }
                             @keyframes slideUp {
                                 from { transform: translateY(100%); }
                                 to { transform: translateY(0); }
                             }
                             @keyframes slideDown {
                                 from { transform: translateY(0); }
                                 to { transform: translateY(100%); }
                             }
                             
                             /* 移动端优化 */
                             @media (max-width: 768px) {
                                 #mobile-confirm-modal .mobile-confirm-content {
                                     padding-bottom: env(safe-area-inset-bottom);
                                 }
                             }
                             
                             /* 触摸反馈动画 */
                             .mobile-confirm-btn {
                                 transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
                             }
                             
                             .mobile-confirm-btn:active {
                                 transform: scale(0.98);
                             }
                         </style>
                                                 <div class="mobile-confirm-content" style="
                             background: white;
                             border-radius: 20px 20px 0 0;
                             width: 100%;
                             max-width: 400px;
                             padding: 24px;
                             animation: slideUp 0.3s ease-out;
                             box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.1);
                         ">
                            <!-- 顶部指示条 -->
                            <div style="
                                width: 40px;
                                height: 4px;
                                background: #e5e7eb;
                                border-radius: 2px;
                                margin: 0 auto 20px;
                            "></div>
                            
                            <!-- 标题 -->
                            <h3 style="
                                font-size: 18px;
                                font-weight: 600;
                                text-align: center;
                                margin: 0 0 8px 0;
                                color: #111827;
                            ">${title}</h3>
                            
                            <!-- 消息内容 -->
                            <p style="
                                font-size: 16px;
                                color: #6b7280;
                                text-align: center;
                                margin: 0 0 32px 0;
                                line-height: 1.5;
                            ">${message}</p>
                            
                            <!-- 按钮组 -->
                            <div style="display: flex; gap: 12px;">
                                                                 <!-- 取消按钮 -->
                                 <button id="mobile-confirm-cancel" class="mobile-confirm-btn" style="
                                     flex: 1;
                                     padding: 16px;
                                     background: #f3f4f6;
                                     color: #374151;
                                     border: none;
                                     border-radius: 12px;
                                     font-size: 16px;
                                     font-weight: 500;
                                     cursor: pointer;
                                     transition: all 0.2s ease;
                                     outline: none;
                                     -webkit-tap-highlight-color: transparent;
                                     user-select: none;
                                 " 
                                 onmousedown="this.style.transform='scale(0.98)'; this.style.background='#e5e7eb'"
                                 onmouseup="this.style.transform='scale(1)'; this.style.background='#f3f4f6'"
                                 onmouseleave="this.style.transform='scale(1)'; this.style.background='#f3f4f6'"
                                 ontouchstart="this.style.transform='scale(0.98)'; this.style.background='#e5e7eb'"
                                 ontouchend="this.style.transform='scale(1)'; this.style.background='#f3f4f6'">
                                     ${cancelText}
                                 </button>
                                 
                                 <!-- 确认按钮 -->
                                 <button id="mobile-confirm-ok" class="mobile-confirm-btn" style="
                                     flex: 1;
                                     padding: 16px;
                                     background: #ef4444;
                                     color: white;
                                     border: none;
                                     border-radius: 12px;
                                     font-size: 16px;
                                     font-weight: 500;
                                     cursor: pointer;
                                     transition: all 0.2s ease;
                                     outline: none;
                                     -webkit-tap-highlight-color: transparent;
                                     user-select: none;
                                     box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
                                 " 
                                 onmousedown="this.style.transform='scale(0.98)'; this.style.background='#dc2626'; this.style.boxShadow='0 1px 4px rgba(239, 68, 68, 0.4)'"
                                 onmouseup="this.style.transform='scale(1)'; this.style.background='#ef4444'; this.style.boxShadow='0 2px 8px rgba(239, 68, 68, 0.3)'"
                                 onmouseleave="this.style.transform='scale(1)'; this.style.background='#ef4444'; this.style.boxShadow='0 2px 8px rgba(239, 68, 68, 0.3)'"
                                 ontouchstart="this.style.transform='scale(0.98)'; this.style.background='#dc2626'; this.style.boxShadow='0 1px 4px rgba(239, 68, 68, 0.4)'"
                                 ontouchend="this.style.transform='scale(1)'; this.style.background='#ef4444'; this.style.boxShadow='0 2px 8px rgba(239, 68, 68, 0.3)'">
                                     ${confirmText}
                                 </button>
                            </div>
                        </div>
                    `;
                    
                    // 添加到页面
                    document.body.appendChild(modal);
                    
                    // 关闭弹窗的函数
                    const closeModal = (result) => {
                        const content = modal.querySelector('div');
                        if (content) {
                            content.style.animation = 'slideDown 0.3s ease-out';
                        }
                        modal.style.animation = 'fadeIn 0.3s ease-out reverse';
                        
                        setTimeout(() => {
                            if (modal.parentNode) {
                                modal.remove();
                            }
                            resolve(result);
                        }, 300);
                    };
                    
                    // 绑定事件
                    const cancelBtn = modal.querySelector('#mobile-confirm-cancel');
                    const okBtn = modal.querySelector('#mobile-confirm-ok');
                    
                    cancelBtn.onclick = () => closeModal(false);
                    okBtn.onclick = () => closeModal(true);
                    
                    // 点击背景关闭
                    modal.onclick = (e) => {
                        if (e.target === modal) {
                            closeModal(false);
                        }
                    };
                    
                    // 阻止内容区域点击事件冒泡
                    modal.querySelector('div').onclick = (e) => {
                        e.stopPropagation();
                    };
                });
            };
            
            // 测试函数 - 可以在控制台调用
            window.testPositioningError = function() {
                console.log('🧪 测试定位异常弹窗');
                window.showPositioningError('测试', 'positioning');
            };
            
            window.testOutOfPathError = function() {
                console.log('🧪 测试超出规定路径弹窗');
                window.showPositioningError('测试', 'out_of_path');
            };
            
            // 测试召唤功能
            window.testSummonFunction = function() {
                console.log('🧪 测试召唤功能');
                const summonBtn = document.getElementById('summon-wheelchair-btn');
                if (summonBtn) {
                    console.log('✅ 召唤按钮存在，模拟点击');
                    summonBtn.click();
                } else {
                    console.error('❌ 召唤按钮不存在');
                }
            };
            
            // 测试召唤导航流程
            window.testSummonNavigation = function() {
                console.log('🧪 测试召唤导航流程');
                console.log('📍 当前页面:', document.querySelector('div[id]:not(.hidden)')?.id);
                window.startNavigation('summon', '客厅');
            };
            
            // 完整测试召唤流程
            window.testFullSummonFlow = function() {
                console.log('🧪 完整测试召唤流程');
                
                // 1. 显示设备状态页面
                showPage('device-status');
                
                // 2. 模拟点击召唤按钮
                setTimeout(() => {
                    console.log('🎯 模拟点击召唤按钮');
                    const summonBtn = document.getElementById('summon-wheelchair-btn');
                    if (summonBtn) {
                        summonBtn.click();
                        
                        // 3. 等待弹窗显示后点击目的地
                        setTimeout(() => {
                            console.log('🎯 模拟点击客厅目的地');
                            const firstDestBtn = document.querySelector('.destination-btn[data-destination="客厅"]');
                            if (firstDestBtn) {
                                firstDestBtn.click();
                            } else {
                                console.error('❌ 未找到客厅目的地按钮');
                            }
                        }, 500);
                    } else {
                        console.error('❌ 未找到召唤按钮');
                    }
                                 }, 500);
             };
             
             // 直接测试目的地选择 
                         window.testDestinationClick = function() {
                console.log('🧪 直接测试目的地点击');
                const firstDestBtn = document.querySelector('.destination-btn[data-destination="客厅"]');
                if (firstDestBtn) {
                    console.log('✅ 找到客厅目的地按钮，模拟点击');
                    firstDestBtn.click();
                } else {
                    console.error('❌ 未找到客厅目的地按钮');
                    console.log('🔍 所有目的地按钮:', document.querySelectorAll('.destination-btn'));
                }
            };
            
            // 简化测试 - 直接调用导航
            window.testSimpleNavigation = function() {
                console.log('🧪 简化测试 - 直接调用导航');
                showPage('device-status'); // 确保在正确页面
                setTimeout(() => {
                    console.log('🚀 直接调用 window.startNavigation');
                    window.startNavigation('summon', '客厅');
                }, 100);
            };
            
            // 专门测试召唤倒计时
            window.testSummonCountdown = function() {
                console.log('🧪 专门测试召唤倒计时');
                
                // 1. 切换到导航页面
                showPage('navigation');
                
                // 2. 设置导航状态
                currentNavigationType = 'summon';
                currentDestination = '客厅';
                
                // 3. 直接调用倒计时函数
                setTimeout(() => {
                    console.log('⏰ 直接调用倒计时函数');
                    window.showNavigationCountdown('客厅');
                    
                    // 4. 检查倒计时页面状态
                    setTimeout(() => {
                        const countdownDiv = document.getElementById('navigation-countdown');
                        console.log('🔍 倒计时页面检查:', {
                            存在: !!countdownDiv,
                            隐藏类: countdownDiv?.classList.contains('hidden'),
                            显示样式: countdownDiv?.style.display,
                            可见性: countdownDiv?.offsetHeight > 0
                        });
                                         }, 100);
                }, 200);
            };
            
            // 快速测试召唤完整流程（推荐使用）
            window.testSummonQuick = function() {
                console.log('🚀 快速测试召唤完整流程');
                console.log('1️⃣ 切换到设备状态页面');
                showPage('device-status');
                
                setTimeout(() => {
                    console.log('2️⃣ 直接启动召唤导航');
                    window.startNavigation('summon', '客厅');
                }, 300);
            };
            
                         // 测试移动端确认对话框
             window.testMobileConfirm = function() {
                 console.log('🧪 测试移动端确认对话框');
                 
                 window.showMobileConfirm(
                     '导航将会停止，轮椅会停在当前位置',
                     '取消导航',
                     '确认取消',
                     '继续导航'
                 ).then(result => {
                     console.log('用户选择:', result ? '确认取消' : '继续导航');
                 });
             };
             
             // 专门测试取消导航确认框
             window.testCancelNavigation = function() {
                 console.log('🧪 测试取消导航确认框');
                 
                 // 先启动一个模拟导航
                 window.startNavigation('summon', '客厅');
                 
                 // 1秒后弹出取消确认框
                 setTimeout(() => {
                     window.showMobileConfirm(
                         '导航将会停止，轮椅会停在当前位置',
                         '取消导航',
                         '确认取消',
                         '继续导航'
                     ).then(result => {
                         if (result) {
                             console.log('✅ 用户确认取消导航');
                             window.stopNavigation();
                             showPage('device-status');
                         } else {
                             console.log('❌ 用户选择继续导航');
                         }
                     });
                 }, 1000);
             };
            
            // 测试各种类型的移动端确认对话框
            window.testMobileConfirmVariants = function() {
                console.log('🧪 测试各种移动端对话框样式');
                
                // 测试1: 取消导航
                setTimeout(() => {
                    window.showMobileConfirm(
                        '导航将会停止，轮椅会停在当前位置',
                        '取消导航',
                        '确认取消',
                        '继续导航'
                    );
                }, 500);
                
                // 测试2: 删除确认
                setTimeout(() => {
                    window.showMobileConfirm(
                        '此操作无法撤销，确定要删除吗？',
                        '删除确认',
                        '删除',
                        '取消'
                    );
                }, 3000);
                
                // 测试3: 简单确认
                setTimeout(() => {
                    window.showMobileConfirm(
                        '是否保存当前设置？',
                        '保存设置'
                    );
                }, 5500);
            };
             
             // 简化测试 - 直接调用导航
             window.testSimpleNavigation = function() {
                 console.log('🧪 简化测试 - 直接调用导航');
                 showPage('device-status'); // 确保在正确页面
                 setTimeout(() => {
                     console.log('🚀 直接调用 window.startNavigation');
                     window.startNavigation('summon', '客厅');
                 }, 100);
             };
             
             // 初始化室内地图
            function initIndoorMap() {
                indoorMapCanvas = document.getElementById('indoor-map-canvas');
                if (!indoorMapCanvas) return;
                
                const rect = indoorMapCanvas.getBoundingClientRect();
                indoorMapCanvas.width = rect.width;
                indoorMapCanvas.height = rect.height;
                indoorMapCtx = indoorMapCanvas.getContext('2d');
                
                // 开始绘制地图
                drawIndoorMap();
                
                // 定期更新轮椅位置
                setInterval(updateWheelchairPosition, 2000);
                
                            // 定期检查定位状态和模式状态
            setInterval(checkPositioningStatus, 5000);
            // 已移除模式状态逻辑
            }
            
            // 绘制室内地图
            function drawIndoorMap() {
                if (!indoorMapCtx) return;
                
                const width = indoorMapCanvas.width;
                const height = indoorMapCanvas.height;
                
                // 清除画布
                indoorMapCtx.clearRect(0, 0, width, height);
                
                // 绘制房间墙壁
                indoorMapCtx.strokeStyle = '#6B7280';
                indoorMapCtx.lineWidth = 2;
                indoorMapCtx.strokeRect(20, 20, width - 40, height - 40);
                
                // 绘制房间分隔线
                indoorMapCtx.strokeStyle = '#9CA3AF';
                indoorMapCtx.lineWidth = 1;
                indoorMapCtx.beginPath();
                indoorMapCtx.moveTo(width * 0.6, 20);
                indoorMapCtx.lineTo(width * 0.6, height - 20);
                indoorMapCtx.stroke();
                
                // 绘制门
                indoorMapCtx.strokeStyle = '#10B981';
                indoorMapCtx.lineWidth = 3;
                indoorMapCtx.beginPath();
                indoorMapCtx.moveTo(width * 0.3, 20);
                indoorMapCtx.lineTo(width * 0.4, 20);
                indoorMapCtx.stroke();
                
                // 绘制导航路径
                drawNavigationPath();
                
                // 请求下一帧
                requestAnimationFrame(drawIndoorMap);
            }
            
            // 绘制导航路径
            function drawNavigationPath() {
                if (!indoorMapCtx) return;
                
                const width = indoorMapCanvas.width;
                const height = indoorMapCanvas.height;
                
                // 绘制路径线
                indoorMapCtx.strokeStyle = '#3B82F6';
                indoorMapCtx.lineWidth = 2;
                indoorMapCtx.setLineDash([5, 5]);
                indoorMapCtx.beginPath();
                
                // 从充电桩到轮椅的路径
                const chargingX = (chargingPosition.x / 100) * width;
                const chargingY = (chargingPosition.y / 100) * height;
                const wheelchairX = (wheelchairPosition.x / 100) * width;
                const wheelchairY = (wheelchairPosition.y / 100) * height;
                
                indoorMapCtx.moveTo(chargingX, chargingY);
                indoorMapCtx.lineTo(wheelchairX, wheelchairY);
                indoorMapCtx.stroke();
                
                // 重置线条样式
                indoorMapCtx.setLineDash([]);
            }
            
            // 更新轮椅位置
            function updateWheelchairPosition() {
                if (!isPositioningNormal) return;
                
                // 模拟轮椅移动
                wheelchairPosition.x += (Math.random() - 0.5) * 5;
                wheelchairPosition.y += (Math.random() - 0.5) * 5;
                
                // 确保位置在地图范围内
                wheelchairPosition.x = Math.max(15, Math.min(85, wheelchairPosition.x));
                wheelchairPosition.y = Math.max(15, Math.min(85, wheelchairPosition.y));
                
                // 更新DOM位置
                const wheelchairElement = document.getElementById('indoor-wheelchair-position');
                if (wheelchairElement) {
                    wheelchairElement.style.left = wheelchairPosition.x + '%';
                    wheelchairElement.style.top = wheelchairPosition.y + '%';
                }
                
                // 更新位置描述
                updateLocationDescription();
            }
            
            // 更新位置描述
            function updateLocationDescription() {
                const locationElement = document.getElementById('indoor-current-location');
                if (!locationElement) return;
                
                const locations = ['客厅区域', '卧室区域', '书房区域', '厨房区域', '走廊'];
                const randomLocation = locations[Math.floor(Math.random() * locations.length)];
                locationElement.textContent = randomLocation;
            }
            
            // 检查定位状态
            function checkPositioningStatus() {
                // 重新设计三种状态的随机生成逻辑
                const randomValue = Math.random();
                
                if (randomValue < 0.6) {
                    // 60% 概率定位正常
                    isPositioningNormal = true;
                    isOnPath = true;
                } else if (randomValue < 0.8) {
                    // 20% 概率定位异常
                    isPositioningNormal = false;
                    isOnPath = true;
                } else {
                    // 20% 概率超出规定路径
                    isPositioningNormal = true;
                    isOnPath = false;
                }
                
                const statusElement = document.getElementById('indoor-position-status');
                if (statusElement) {
                    if (isPositioningNormal && isOnPath) {
                        // 状态1：定位正常
                        statusElement.innerHTML = `
                            <div class="w-2 h-2 bg-green-500 rounded-full mr-2 pulse-animation"></div>
                            <span class="text-xs text-green-400">定位正常</span>
                        `;
                    } else if (!isPositioningNormal && isOnPath) {
                        // 状态2：定位异常
                        statusElement.innerHTML = `
                            <div class="w-2 h-2 bg-red-500 rounded-full mr-2 pulse-animation"></div>
                            <span class="text-xs text-red-400">定位异常</span>
                        `;
                    } else if (isPositioningNormal && !isOnPath) {
                        // 状态3：超出规定路径
                        statusElement.innerHTML = `
                            <div class="w-2 h-2 bg-orange-500 rounded-full mr-2 pulse-animation"></div>
                            <span class="text-xs text-orange-400">超出规定路径</span>
                        `;
                    } else {
                        // 状态4：两者都异常，优先显示定位异常
                        statusElement.innerHTML = `
                            <div class="w-2 h-2 bg-red-500 rounded-full mr-2 pulse-animation"></div>
                            <span class="text-xs text-red-400">定位异常</span>
                        `;
                    }
                }
            }
            
            // 已移除 DM/AIM 模式展示与切换逻辑
            
            // 去充电功能
            function initChargingFunction() {
                const goChargingBtn = document.getElementById('go-charging-btn');
                const chargingModal = document.getElementById('charging-modal');
                const cancelChargingBtn = document.getElementById('cancel-charging-btn');
                
                if (goChargingBtn) {
                    goChargingBtn.addEventListener('click', function() {
                        if (!isPositioningNormal || !isOnPath) {
                            // 根据具体状态显示对应的异常类型，确保与地图显示一致
                            let errorType;
                            if (!isPositioningNormal && isOnPath) {
                                errorType = 'positioning'; // 定位异常
                            } else if (isPositioningNormal && !isOnPath) {
                                errorType = 'out_of_path'; // 超出规定路径
                            } else {
                                errorType = 'positioning'; // 两者都异常，优先显示定位异常
                            }
                            try {
                                console.log('⚡ 尝试显示去充电错误:', errorType);
                                window.showPositioningError('去充电', errorType);
                            } catch (error) {
                                console.error('❌ 显示去充电错误失败:', error);
                            }
                            return;
                        }
                        
                        // 显示充电弹窗
                        chargingModal.classList.remove('hidden');
                        startChargingAnimation();
                    });
                }
                
                if (cancelChargingBtn) {
                    cancelChargingBtn.addEventListener('click', function() {
                        chargingModal.classList.add('hidden');
                        resetChargingAnimation();
                    });
                }
            }
            
            // 开始充电动画
            function startChargingAnimation() {
                const chargingProgress = document.getElementById('charging-progress');
                const chargingDistance = document.getElementById('charging-distance');
                const chargingEta = document.getElementById('charging-eta');
                const chargingTitle = document.getElementById('charging-title');
                const chargingMessage = document.getElementById('charging-message');
                const chargingIcon = document.getElementById('charging-icon');
                
                let progress = 0;
                let distance = 15;
                let eta = 30;
                
                const chargingInterval = setInterval(() => {
                    progress += 5;
                    distance = Math.max(0, distance - 0.8);
                    eta = Math.max(0, eta - 1.5);
                    
                    if (chargingProgress) chargingProgress.style.width = progress + '%';
                    if (chargingDistance) chargingDistance.textContent = distance.toFixed(1) + '米';
                    if (chargingEta) chargingEta.textContent = Math.ceil(eta) + '秒';
                    
                    if (progress >= 100) {
                        clearInterval(chargingInterval);
                        
                        // 显示充电成功
                        if (chargingTitle) chargingTitle.textContent = '充电成功';
                        if (chargingMessage) chargingMessage.textContent = '轮椅已到达充电桩，正在充电中...';
                        if (chargingIcon) chargingIcon.className = 'fas fa-battery-full text-green-600 text-3xl';
                        
                        setTimeout(() => {
                            document.getElementById('charging-modal').classList.add('hidden');
                            resetChargingAnimation();
                            
                            // 更新轮椅状态为充电中
                            updateWheelchairStatus('充电中');
                        }, 2000);
                    }
                }, 200);
            }
            
            // 重置充电动画
            function resetChargingAnimation() {
                const chargingProgress = document.getElementById('charging-progress');
                const chargingDistance = document.getElementById('charging-distance');
                const chargingEta = document.getElementById('charging-eta');
                const chargingTitle = document.getElementById('charging-title');
                const chargingMessage = document.getElementById('charging-message');
                const chargingIcon = document.getElementById('charging-icon');
                
                if (chargingProgress) chargingProgress.style.width = '0%';
                if (chargingDistance) chargingDistance.textContent = '15米';
                if (chargingEta) chargingEta.textContent = '30秒';
                if (chargingTitle) chargingTitle.textContent = '正在前往充电桩';
                if (chargingMessage) chargingMessage.textContent = '轮椅正在自动导航至充电桩位置...';
                if (chargingIcon) chargingIcon.className = 'fas fa-charging-station text-green-600 text-3xl';
            }
            
            // 召唤功能
            function initSummonFunction() {
                const summonBtn = document.getElementById('summon-wheelchair-btn');
                const summonModal = document.getElementById('summon-modal');
                const cancelSummonBtn = document.getElementById('cancel-summon-btn');
                const destinationBtns = document.querySelectorAll('.destination-btn');
                
                console.log('🔍 召唤功能初始化:', {
                    summonBtn: !!summonBtn,
                    summonModal: !!summonModal,
                    cancelSummonBtn: !!cancelSummonBtn,
                    destinationBtns: destinationBtns.length
                });
                
                if (summonBtn) {
                    console.log('✅ 召唤按钮找到，绑定事件');
                    summonBtn.addEventListener('click', function() {
                        console.log('📞 召唤按钮被点击！');
                        console.log('当前状态:', { isPositioningNormal, isOnPath });
                        if (!isPositioningNormal || !isOnPath) {
                            // 根据具体状态显示对应的异常类型，确保与地图显示一致
                            let errorType;
                            if (!isPositioningNormal && isOnPath) {
                                errorType = 'positioning'; // 定位异常
                            } else if (isPositioningNormal && !isOnPath) {
                                errorType = 'out_of_path'; // 超出规定路径
                            } else {
                                errorType = 'positioning'; // 两者都异常，优先显示定位异常
                            }
                            try {
                                console.log('📞 尝试显示召唤错误:', errorType);
                                window.showPositioningError('召唤', errorType);
                            } catch (error) {
                                console.error('❌ 显示召唤错误失败:', error);
                            }
                            return;
                        }
                        
                        // 显示召唤弹窗
                        console.log('📞 显示召唤弹窗');
                        if (summonModal) {
                            summonModal.classList.remove('hidden');
                            console.log('✅ 召唤弹窗已显示');
                        } else {
                            console.error('❌ 召唤弹窗元素未找到');
                        }
                        resetSummonModal();
                    });
                } else {
                    console.error('❌ 召唤按钮未找到');
                }
                
                if (cancelSummonBtn) {
                    cancelSummonBtn.addEventListener('click', function() {
                        summonModal.classList.add('hidden');
                        resetSummonModal();
                    });
                }
                
                // 目的地选择 - 使用新的导航系统
                destinationBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        const destination = this.dataset.destination;
                        console.log('📍 目的地按钮被点击:', destination);
                        
                        // 关闭召唤弹窗
                        if (summonModal) {
                            summonModal.classList.add('hidden');
                            console.log('❌ 召唤弹窗已关闭');
                        }
                        
                        // 使用新的导航系统
                        try {
                            console.log('🚀 启动新导航系统到:', destination);
                            console.log('📍 当前页面:', document.querySelector('div[id]:not(.hidden)')?.id);
                            window.startNavigation('summon', destination);
                        } catch (error) {
                            console.error('❌ 新导航系统启动失败:', error);
                            console.log('🔄 使用旧导航系统');
                            startNavigationToDestination(destination);
                        }
                    });
                });
            }
            
            // 开始导航到目的地
            function startNavigationToDestination(destination) {
                const destinationSelection = document.getElementById('destination-selection');
                const navigationProgress = document.getElementById('navigation-progress');
                const summonTitle = document.getElementById('summon-title');
                const summonMessage = document.getElementById('summon-message');
                const summonIcon = document.getElementById('summon-icon');
                
                // 隐藏目的地选择，显示导航进度
                destinationSelection.classList.add('hidden');
                navigationProgress.classList.remove('hidden');
                
                if (summonTitle) summonTitle.textContent = `正在前往${destination}`;
                if (summonMessage) summonMessage.textContent = `轮椅正在自动导航至${destination}...`;
                if (summonIcon) summonIcon.className = 'fas fa-route text-purple-600 text-3xl';
                
                // 开始导航动画
                startNavigationAnimation(destination);
            }
            
            // 开始导航动画
            function startNavigationAnimation(destination) {
                const navigationProgressBar = document.getElementById('navigation-progress-bar');
                const navigationDistance = document.getElementById('navigation-distance');
                const navigationEta = document.getElementById('navigation-eta');
                
                let progress = 0;
                let distance = parseInt(navigationDistance.textContent);
                let eta = parseInt(navigationEta.textContent);
                
                const navigationInterval = setInterval(() => {
                    progress += 5;
                    distance = Math.max(0, distance - 0.6);
                    eta = Math.max(0, eta - 1);
                    
                    if (navigationProgressBar) navigationProgressBar.style.width = progress + '%';
                    if (navigationDistance) navigationDistance.textContent = distance.toFixed(1) + '米';
                    if (navigationEta) navigationEta.textContent = Math.ceil(eta) + '秒';
                    
                    if (progress >= 100) {
                        clearInterval(navigationInterval);
                        
                        // 显示到达成功
                        const summonTitle = document.getElementById('summon-title');
                        const summonMessage = document.getElementById('summon-message');
                        const summonIcon = document.getElementById('summon-icon');
                        
                        if (summonTitle) summonTitle.textContent = '到达目的地';
                        if (summonMessage) summonMessage.textContent = `轮椅已到达${destination}，召唤完成！`;
                        if (summonIcon) summonIcon.className = 'fas fa-check-circle text-green-600 text-3xl';
                        
                        setTimeout(() => {
                            document.getElementById('summon-modal').classList.add('hidden');
                            resetSummonModal();
                        }, 2000);
                    }
                }, 200);
            }
            
            // 重置召唤弹窗
            function resetSummonModal() {
                const destinationSelection = document.getElementById('destination-selection');
                const navigationProgress = document.getElementById('navigation-progress');
                const summonTitle = document.getElementById('summon-title');
                const summonMessage = document.getElementById('summon-message');
                const summonIcon = document.getElementById('summon-icon');
                const navigationProgressBar = document.getElementById('navigation-progress-bar');
                
                // 重置状态
                destinationSelection.classList.remove('hidden');
                navigationProgress.classList.add('hidden');
                
                if (summonTitle) summonTitle.textContent = '选择目的地';
                if (summonMessage) summonMessage.textContent = '请选择您希望轮椅前往的位置';
                if (summonIcon) summonIcon.className = 'fas fa-hand-paper text-purple-600 text-3xl';
                if (navigationProgressBar) navigationProgressBar.style.width = '0%';
            }
            
            // 旧的重复函数定义已移除，使用上面的全局函数
            
            // 更新轮椅状态
            function updateWheelchairStatus(status) {
                // 这里可以更新轮椅状态显示
                console.log('轮椅状态更新:', status);
            }
            
            // 初始化所有新功能
            function initDeviceStatusFeatures() {
                initIndoorMap();
                // initChargingFunction(); // 已被新的导航功能替代
                initSummonFunction(); // 恢复召唤功能，新导航功能需要它
                console.log('✅ 召唤功能已初始化');
            }
            
            // 在页面加载完成后初始化
            setTimeout(initDeviceStatusFeatures, 1000);
            
            // 地图管理功能
            let currentMapId = 'home-map';
            let currentEditingMapId = null;
            let currentDeletingMapId = null;
            let currentSwitchingMapId = null;
            let mapPositioningStatus = { 'home-map': false, 'office-map': true }; // 模拟定位状态
            
            // 初始化地图管理功能
            function initMapManagement() {
                // 绑定菜单按钮事件
                const mapMenuBtns = document.querySelectorAll('.map-menu-btn');
                mapMenuBtns.forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        // 关闭其他菜单
                        document.querySelectorAll('.map-menu').forEach(menu => menu.classList.add('hidden'));
                        // 显示当前菜单
                        const menu = this.nextElementSibling;
                        menu.classList.toggle('hidden');
                    });
                });
                
                // 点击外部关闭菜单
                document.addEventListener('click', function() {
                    document.querySelectorAll('.map-menu').forEach(menu => menu.classList.add('hidden'));
                });
                
                // 初始化地图状态
                updateMapPositioningStatus();
                
                // 定期更新定位状态
                setInterval(updateMapPositioningStatus, 10000);
                
                // 重新定位按钮
                const relocateBtn = document.getElementById('relocate-map-btn');
                if (relocateBtn) {
                    relocateBtn.addEventListener('click', function() {
                        startMapRelocate();
                    });
                }
                
                // 编辑地图弹窗
                initEditMapModal();
                
                // 删除地图弹窗
                initDeleteMapModal();
                
                // 切换地图弹窗
                initSwitchMapModal();
                
                // 重新定位弹窗
                initRelocateModal();
            }
            
            // 更新地图定位状态
            function updateMapPositioningStatus() {
                const currentMapStatusElement = document.getElementById('current-map-status');
                const relocateBtnContainer = document.getElementById('relocate-btn-container');
                
                if (currentMapStatusElement && relocateBtnContainer) {
                    const isPositioningNormal = mapPositioningStatus[currentMapId];
                    
                    if (isPositioningNormal) {
                        currentMapStatusElement.innerHTML = `
                            <div class="w-2 h-2 bg-green-500 rounded-full mr-2 pulse-animation"></div>
                            <span class="text-xs text-green-600">定位正常</span>
                        `;
                        relocateBtnContainer.style.display = 'none';
                    } else {
                        currentMapStatusElement.innerHTML = `
                            <div class="w-2 h-2 bg-red-500 rounded-full mr-2 pulse-animation"></div>
                            <span class="text-xs text-red-600">定位异常</span>
                        `;
                        relocateBtnContainer.style.display = 'block';
                    }
                }
                
                // 模拟定位状态变化（80%概率正常）
                if (Math.random() > 0.8) {
                    mapPositioningStatus[currentMapId] = !mapPositioningStatus[currentMapId];
                }
            }
            
            // 编辑地图功能
            function editMap(mapId) {
                currentEditingMapId = mapId;
                const modal = document.getElementById('edit-map-modal');
                const mapName = getMapName(mapId);
                
                document.getElementById('edit-map-name').textContent = mapName;
                document.getElementById('edit-map-name-input').value = mapName;
                
                modal.classList.remove('hidden');
                
                // 关闭菜单
                document.querySelectorAll('.map-menu').forEach(menu => menu.classList.add('hidden'));
            }
            
            // 删除地图功能
            function deleteMap(mapId) {
                if (mapId === currentMapId) {
                    showToast('当前使用的地图无法删除', 'error');
                    return;
                }
                
                currentDeletingMapId = mapId;
                const modal = document.getElementById('delete-map-modal');
                const mapName = getMapName(mapId);
                
                document.getElementById('delete-map-name').textContent = mapName;
                modal.classList.remove('hidden');
                
                // 关闭菜单
                document.querySelectorAll('.map-menu').forEach(menu => menu.classList.add('hidden'));
            }
            
            // 切换地图功能
            function switchToMap(mapId) {
                currentSwitchingMapId = mapId;
                const modal = document.getElementById('switch-map-modal');
                const mapName = getMapName(mapId);
                
                document.getElementById('switch-map-name').textContent = mapName;
                modal.classList.remove('hidden');
                
                // 关闭菜单
                document.querySelectorAll('.map-menu').forEach(menu => menu.classList.add('hidden'));
            }
            
            // 获取地图名称
            function getMapName(mapId) {
                const mapNames = {
                    'home-map': '家庭地图',
                    'home-map': '家庭地图2'
                };
                return mapNames[mapId] || '未知地图';
            }
            
            // 初始化编辑地图弹窗
            function initEditMapModal() {
                const modal = document.getElementById('edit-map-modal');
                const cancelBtn = document.getElementById('cancel-edit-map');
                const saveBtn = document.getElementById('save-edit-map');
                const nameInput = document.getElementById('edit-map-name-input');
                
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', function() {
                        modal.classList.add('hidden');
                        currentEditingMapId = null;
                    });
                }
                
                if (saveBtn) {
                    saveBtn.addEventListener('click', function() {
                        const newName = nameInput.value.trim();
                        if (!newName) {
                            showToast('请输入地图名称', 'error');
                            return;
                        }
                        
                        // 模拟保存
                        showToast(`地图名称已更新为"${newName}"`, 'success');
                        modal.classList.add('hidden');
                        currentEditingMapId = null;
                        
                        // 这里可以添加更新UI的逻辑
                    });
                }
            }
            
            // 初始化删除地图弹窗
            function initDeleteMapModal() {
                const modal = document.getElementById('delete-map-modal');
                const cancelBtn = document.getElementById('cancel-delete-map');
                const confirmBtn = document.getElementById('confirm-delete-map');
                
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', function() {
                        modal.classList.add('hidden');
                        currentDeletingMapId = null;
                    });
                }
                
                if (confirmBtn) {
                    confirmBtn.addEventListener('click', function() {
                        const mapName = getMapName(currentDeletingMapId);
                        
                        // 模拟删除
                        showToast(`"${mapName}"已删除`, 'success');
                        modal.classList.add('hidden');
                        currentDeletingMapId = null;
                        
                        // 这里可以添加移除UI元素的逻辑
                    });
                }
            }
            
            // 初始化切换地图弹窗
            function initSwitchMapModal() {
                const modal = document.getElementById('switch-map-modal');
                const cancelBtn = document.getElementById('cancel-switch-map');
                const confirmBtn = document.getElementById('confirm-switch-map');
                
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', function() {
                        modal.classList.add('hidden');
                        currentSwitchingMapId = null;
                    });
                }
                
                if (confirmBtn) {
                    confirmBtn.addEventListener('click', function() {
                        const mapName = getMapName(currentSwitchingMapId);
                        
                        // 更新当前地图
                        currentMapId = currentSwitchingMapId;
                        
                        showToast(`已切换到"${mapName}"`, 'success');
                        modal.classList.add('hidden');
                        currentSwitchingMapId = null;
                        
                        // 这里可以添加更新UI的逻辑，比如重新渲染地图列表
                    });
                }
            }
            
            // 开始重新定位
            function startMapRelocate() {
                const modal = document.getElementById('relocate-modal');
                modal.classList.remove('hidden');
                
                // 重置到初始状态
                resetRelocateAnimation();
                
                // 开始指导动画
                startGuideAnimation();
            }
            
            // 初始化重新定位弹窗
            function initRelocateModal() {
                const modal = document.getElementById('relocate-modal');
                const cancelBtn = document.getElementById('cancel-relocate');
                const confirmBtn = document.getElementById('confirm-position');
                
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', function() {
                        modal.classList.add('hidden');
                        resetRelocateAnimation();
                    });
                }
                
                if (confirmBtn) {
                    confirmBtn.addEventListener('click', function() {
                        // 用户确认已在定位点，开始校验过程
                        startValidationProcess();
                    });
                }
            }
            
            // 开始指导动画
            function startGuideAnimation() {
                const wheelchairIcon = document.getElementById('wheelchair-icon');
                const moveArrow = document.getElementById('move-arrow');
                const steps = ['step-1', 'step-2', 'step-3'];
                let currentStep = 0;
                
                // 轮椅图标脉冲动画
                if (wheelchairIcon) {
                    wheelchairIcon.style.animation = 'pulse 2s infinite';
                }
                
                // 箭头闪烁动画
                if (moveArrow) {
                    moveArrow.style.animation = 'pulse 1.5s infinite';
                }
                
                // 步骤高亮循环
                const stepInterval = setInterval(() => {
                    // 重置所有步骤样式
                    steps.forEach(stepId => {
                        const stepElement = document.getElementById(stepId);
                        if (stepElement) {
                            stepElement.className = 'text-gray-500';
                        }
                    });
                    
                    // 高亮当前步骤
                    const currentStepElement = document.getElementById(steps[currentStep]);
                    if (currentStepElement) {
                        currentStepElement.className = 'font-medium text-blue-700 bg-blue-100 px-2 py-1 rounded transition-all duration-300';
                    }
                    
                    currentStep = (currentStep + 1) % steps.length;
                }, 2000);
                
                // 保存定时器引用以便清理
                window.relocateStepInterval = stepInterval;
            }
            
            // 开始校验过程
            function startValidationProcess() {
                // 清理指导动画
                if (window.relocateStepInterval) {
                    clearInterval(window.relocateStepInterval);
                    window.relocateStepInterval = null;
                }
                
                // 隐藏指导区域，显示进度区域
                const guideSection = document.getElementById('relocate-guide');
                const progressSection = document.getElementById('relocate-progress-section');
                const buttonsSection = document.getElementById('relocate-buttons');
                const titleElement = document.getElementById('relocate-title');
                const messageElement = document.getElementById('relocate-message');
                const iconElement = document.getElementById('relocate-icon');
                
                if (guideSection) guideSection.style.display = 'none';
                if (progressSection) progressSection.classList.remove('hidden');
                if (buttonsSection) buttonsSection.style.display = 'none';
                
                // 更新标题和消息
                if (titleElement) titleElement.textContent = '正在校验定位';
                if (messageElement) messageElement.textContent = '系统正在验证轮椅位置和地图匹配度';
                if (iconElement) iconElement.className = 'fas fa-cog fa-spin text-yellow-600 text-2xl';
                
                // 开始校验动画
                startValidationAnimation();
            }
            
            // 开始校验动画
            function startValidationAnimation() {
                const progressBar = document.getElementById('relocate-progress');
                const statusText = document.getElementById('relocate-status');
                const titleElement = document.getElementById('relocate-title');
                const messageElement = document.getElementById('relocate-message');
                const iconElement = document.getElementById('relocate-icon');
                
                let progress = 0;
                const statusMessages = [
                    '正在检测环境...',
                    '校准传感器...',
                    '分析地图数据...',
                    '匹配定位点...',
                    '验证定位精度...'
                ];
                let currentStatusIndex = 0;
                
                const relocateInterval = setInterval(() => {
                    progress += 20;
                    
                    if (progressBar) {
                        progressBar.style.width = progress + '%';
                    }
                    
                    if (statusText && currentStatusIndex < statusMessages.length) {
                        statusText.textContent = statusMessages[currentStatusIndex];
                        currentStatusIndex++;
                    }
                    
                    if (progress >= 100) {
                        clearInterval(relocateInterval);
                        
                        // 显示成功
                        if (titleElement) titleElement.textContent = '定位成功';
                        if (messageElement) messageElement.textContent = '地图定位系统已重新校准完成';
                        if (iconElement) iconElement.className = 'fas fa-check-circle text-green-600 text-2xl';
                        if (statusText) statusText.textContent = '定位校准完成';
                        
                        // 更新定位状态
                        mapPositioningStatus[currentMapId] = true;
                        updateMapPositioningStatus();
                        
                        setTimeout(() => {
                            document.getElementById('relocate-modal').classList.add('hidden');
                            resetRelocateAnimation();
                            showToast('地图定位已恢复正常', 'success');
                        }, 2000);
                    }
                }, 500);
            }
            
            // 重置重新定位动画
            function resetRelocateAnimation() {
                // 清理定时器
                if (window.relocateStepInterval) {
                    clearInterval(window.relocateStepInterval);
                    window.relocateStepInterval = null;
                }
                
                // 重置UI元素
                const progressBar = document.getElementById('relocate-progress');
                const statusText = document.getElementById('relocate-status');
                const titleElement = document.getElementById('relocate-title');
                const messageElement = document.getElementById('relocate-message');
                const iconElement = document.getElementById('relocate-icon');
                const guideSection = document.getElementById('relocate-guide');
                const progressSection = document.getElementById('relocate-progress-section');
                const buttonsSection = document.getElementById('relocate-buttons');
                const wheelchairIcon = document.getElementById('wheelchair-icon');
                const moveArrow = document.getElementById('move-arrow');
                
                // 重置进度条
                if (progressBar) progressBar.style.width = '0%';
                if (statusText) statusText.textContent = '正在检测环境...';
                
                // 重置标题和消息
                if (titleElement) titleElement.textContent = '重新定位';
                if (messageElement) messageElement.textContent = '请将轮椅移动到定位点或充电桩位置';
                if (iconElement) iconElement.className = 'fas fa-crosshairs text-yellow-600 text-2xl';
                
                // 重置显示状态
                if (guideSection) guideSection.style.display = 'block';
                if (progressSection) progressSection.classList.add('hidden');
                if (buttonsSection) buttonsSection.style.display = 'block';
                
                // 清除动画
                if (wheelchairIcon) wheelchairIcon.style.animation = '';
                if (moveArrow) moveArrow.style.animation = '';
                
                // 重置步骤样式
                const steps = ['step-1', 'step-2', 'step-3'];
                steps.forEach((stepId, index) => {
                    const stepElement = document.getElementById(stepId);
                    if (stepElement) {
                        if (index === 0) {
                            stepElement.className = 'font-medium';
                        } else {
                            stepElement.className = 'text-gray-500';
                        }
                    }
                });
            }
            
            // 显示提示消息
            function showToast(message, type = 'info') {
                const toast = document.createElement('div');
                const bgColor = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500';
                toast.className = `fixed top-4 left-1/2 transform -translate-x-1/2 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50`;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 3000);
            }
            
            // 全局函数，供HTML调用
            window.editMap = editMap;
            window.deleteMap = deleteMap;
            window.switchToMap = switchToMap;
            
            // 初始化地图管理
            setTimeout(initMapManagement, 1000);
            
            // 设备管理功能
            let currentSelectedDevice = 'CM-6001';
            let availableDevices = {
                'CM-6001': {
                    name: 'CM-6001',
                    displayName: 'A001',
                    online: true,
                    type: 'basic',
                    color: 'pink'
                },
                'CM-6001-Pro-123456': {
                    name: 'CM-6001 Pro 123456',
                    displayName: 'A002',
                    online: true,
                    type: 'pro',
                    color: 'gray'
                },
                'CM-6001-Pro-12-2': {
                    name: 'CM-6001 Pro 12...(2)',
                    displayName: 'A003',
                    online: true,
                    type: 'pro',
                    color: 'gray'
                },
                'CM-6001-Pro-12-3': {
                    name: 'CM-6001 Pro 12...(3)',
                    displayName: 'A004',
                    online: false,
                    type: 'pro',
                    color: 'gray'
                }
            };
            
            // 初始化设备选择功能
            function initDeviceSelector() {
                const deviceSelectorBtn = document.getElementById('device-selector-btn');
                const deviceSelectorModal = document.getElementById('device-selector-modal');
                const closeModalBottomBtn = document.getElementById('close-modal-bottom-btn');
                const addNewDeviceBtn = document.getElementById('add-new-device-btn');
                const deviceCards = document.querySelectorAll('.device-card');
                
                // 设备选择按钮点击事件
                if (deviceSelectorBtn) {
                    deviceSelectorBtn.addEventListener('click', function() {
                        deviceSelectorModal.classList.remove('hidden');
                        updateDeviceList();
                    });
                }
                
                // 关闭弹窗（底部按钮）
                if (closeModalBottomBtn) {
                    closeModalBottomBtn.addEventListener('click', function() {
                        deviceSelectorModal.classList.add('hidden');
                    });
                }
                
                // 添加新设备
                if (addNewDeviceBtn) {
                    addNewDeviceBtn.addEventListener('click', function() {
                        deviceSelectorModal.classList.add('hidden');
                        // 跳转到添加设备页面
                        showPage('add-device');
                    });
                }
                
                // 设备卡片点击事件
                deviceCards.forEach(card => {
                    card.addEventListener('click', function() {
                        const deviceId = this.dataset.deviceId;
                        const device = availableDevices[deviceId];
                        
                        if (device && device.online) {
                            switchToDevice(deviceId);
                            deviceSelectorModal.classList.add('hidden');
                        } else {
                            showToast('设备离线，无法切换', 'error');
                        }
                    });
                });
                
                // 点击外部关闭弹窗
                deviceSelectorModal.addEventListener('click', function(e) {
                    if (e.target === deviceSelectorModal) {
                        deviceSelectorModal.classList.add('hidden');
                    }
                });
            }
            
            // 切换到指定设备
            function switchToDevice(deviceId) {
                if (!availableDevices[deviceId] || !availableDevices[deviceId].online) {
                    showToast('设备不可用', 'error');
                    return;
                }
                
                const oldDevice = availableDevices[currentSelectedDevice];
                const newDevice = availableDevices[deviceId];
                
                // 更新当前选中设备
                currentSelectedDevice = deviceId;
                
                // 更新标题显示
                updateDeviceTitle(newDevice);
                
                // 更新设备信息卡片
                updateDeviceInfo(newDevice);
                
                // 更新设备列表选中状态
                updateDeviceListSelection();
                
                showToast(`已切换到 ${newDevice.name}`, 'success');
                
                // 模拟加载新设备数据
                simulateDeviceDataLoading(newDevice);
            }
            
            // 更新设备标题
            function updateDeviceTitle(device) {
                const currentDeviceName = document.getElementById('current-device-name');
                if (currentDeviceName) {
                    currentDeviceName.textContent = device.name;
                }
            }
            
            // 更新设备信息
            function updateDeviceInfo(device) {
                // 更新设备ID显示
                const deviceIdElements = document.querySelectorAll('[data-device-display]');
                deviceIdElements.forEach(element => {
                    element.textContent = device.displayName;
                });
                
                // 模拟不同设备的数据
                const deviceData = generateDeviceData(device);
                
                // 更新电量信息
                const batteryPercentage = document.getElementById('battery-percentage');
                const batteryIcon = document.getElementById('battery-icon');
                if (batteryPercentage && batteryIcon) {
                    batteryPercentage.textContent = deviceData.battery + '%';
                    const batteryIconInfo = getBatteryIcon(deviceData.battery);
                    batteryIcon.className = `${batteryIconInfo.icon} ${batteryIconInfo.color} text-xl`;
                }
                
                // Update estimated range and usage time
                const batteryInfo = calculateBatteryInfo(deviceData.battery);
                const estimatedDistance = document.getElementById('estimated-distance');
                const estimatedUsageTime = document.getElementById('estimated-usage-time');
                const todayDistance = document.getElementById('today-distance');
                const currentSpeedStatus = document.getElementById('current-speed-status');
                if (estimatedDistance) {
                    estimatedDistance.textContent = `${batteryInfo.distance} km`;
                }
                if (estimatedUsageTime) {
                    estimatedUsageTime.textContent = batteryInfo.timeText;
                }
                if (todayDistance) {
                    todayDistance.textContent = `${deviceData.distance} km`;
                }
                if (currentSpeedStatus) {
                    currentSpeedStatus.textContent = deviceData.speed;
                }
                
                // 更新其他设备状态
                // 这里可以添加更多设备特定的信息更新
            }
            
            // 生成设备数据
            function generateDeviceData(device) {
                // 为不同设备生成不同的模拟数据
                const baseData = {
                    'CM-6001': { battery: 78, speed: '2.5 km/h', distance: 25 },
                    'CM-6001-Pro-123456': { battery: 92, speed: '3.2 km/h', distance: 18 },
                    'CM-6001-Pro-12-2': { battery: 65, speed: '1.8 km/h', distance: 32 },
                    'CM-6001-Pro-12-3': { battery: 45, speed: '0 km/h', distance: 0 }
                };
                
                return baseData[device.name] || baseData['CM-6001'];
            }
            
            // 更新设备列表
            function updateDeviceList() {
                const deviceCards = document.querySelectorAll('.device-card');
                
                deviceCards.forEach(card => {
                    const deviceId = card.dataset.deviceId;
                    const device = availableDevices[deviceId];
                    
                    if (device) {
                        // 查找选中标记
                        const checkIcon = card.querySelector('.absolute.top-3.right-3');
                        
                        // 更新选中状态
                        if (deviceId === currentSelectedDevice) {
                            // 显示蓝色勾选图标
                            if (!checkIcon) {
                                const newCheckIcon = document.createElement('div');
                                newCheckIcon.className = 'absolute top-3 right-3 w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center';
                                newCheckIcon.innerHTML = '<i class="fas fa-check text-white text-xs"></i>';
                                card.appendChild(newCheckIcon);
                            } else {
                                checkIcon.style.display = 'flex';
                            }
                        } else {
                            // 隐藏勾选图标
                            if (checkIcon) {
                                checkIcon.style.display = 'none';
                            }
                        }
                        
                        // 更新在线状态
                        const statusDot = card.querySelector('.w-2.h-2');
                        const statusTextSpan = card.querySelector('.flex.items-center span');
                        
                        if (device.online) {
                            card.classList.remove('opacity-60');
                            if (statusDot) {
                                statusDot.className = 'w-2 h-2 bg-green-400 rounded-full mr-2';
                            }
                            if (statusTextSpan) {
                                statusTextSpan.textContent = '在线';
                                statusTextSpan.className = 'text-sm text-green-300';
                            }
                        } else {
                            card.classList.add('opacity-60');
                            if (statusDot) {
                                statusDot.className = 'w-2 h-2 bg-gray-400 rounded-full mr-2';
                            }
                            if (statusTextSpan) {
                                statusTextSpan.textContent = '离线';
                                statusTextSpan.className = 'text-sm text-gray-300';
                            }
                        }
                    }
                });
            }
            
            // 更新设备列表选中状态
            function updateDeviceListSelection() {
                updateDeviceList();
            }
            
            // 模拟设备数据加载
            function simulateDeviceDataLoading(device) {
                // 显示加载状态
                const loadingToast = document.createElement('div');
                loadingToast.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                loadingToast.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></div>
                        <span>正在连接 ${device.name}...</span>
                    </div>
                `;
                document.body.appendChild(loadingToast);
                
                // 模拟加载延迟
                setTimeout(() => {
                    document.body.removeChild(loadingToast);
                    
                    // 更新全局电量状态
                    const deviceData = generateDeviceData(device);
                    const batteryInfo = calculateBatteryInfo(deviceData.battery);
                    window.currentBatteryStatus = {
                        level: deviceData.battery,
                        timeText: batteryInfo.timeText,
                        distance: batteryInfo.distance,
                        fullText: `Your wheelchair's current battery is at ${deviceData.battery}%, estimated to last ${batteryInfo.timeText}, with a driving range of about ${batteryInfo.distance} km.`
                    };
                    
                    // 触发电量显示更新
                    currentBatteryLevel = deviceData.battery;
                    updateBatteryDisplay();
                }, 1500);
            }
            
            // 初始化设备选择器
            setTimeout(initDeviceSelector, 1000);
            
            // 初始化设备名称显示
            function initDeviceNameDisplay() {
                const currentDevice = availableDevices[currentSelectedDevice];
                if (currentDevice) {
                    updateDeviceTitle(currentDevice);
                }
            }
            
            // 页面加载时初始化设备名称
            setTimeout(initDeviceNameDisplay, 100);
            

            
            // 初始化APP弹窗系统
            function initAppModal() {
                const modal = document.getElementById('app-modal');
                const cancelBtn = document.getElementById('modal-cancel');
                const confirmBtn = document.getElementById('modal-confirm');
                const input = document.getElementById('modal-input');
                const suggestions = document.querySelectorAll('.suggestion-item');
                
                // 取消按钮
                cancelBtn.addEventListener('click', () => {
                    hideModal();
                    if (currentModalResolve) {
                        currentModalResolve(null);
                        currentModalResolve = null;
                    }
                });
                
                // 确定按钮
                confirmBtn.addEventListener('click', () => {
                    const inputContainer = document.getElementById('modal-input-container');
                    const result = inputContainer.classList.contains('hidden') ? true : input.value.trim();
                    
                    hideModal();
                    if (currentModalResolve) {
                        currentModalResolve(result);
                        currentModalResolve = null;
                    }
                });
                
                // 推荐选项点击
                suggestions.forEach(item => {
                    item.addEventListener('click', () => {
                        const value = item.getAttribute('data-value');
                        input.value = value;
                        input.focus();
                    });
                });
                
                // 点击背景关闭
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        hideModal();
                        if (currentModalResolve) {
                            currentModalResolve(null);
                            currentModalResolve = null;
                        }
                    }
                });
                
                // 输入框回车确认
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        confirmBtn.click();
                    }
                });
            }
            
            // 立即初始化APP弹窗
            initAppModal();
            
            let isListening = false;
            
            // 语音交互功能 - 新版本只使用语音按钮
            
            // 语音按钮交互
            if (voiceBtn && voiceIndicator) {
                voiceBtn.addEventListener('mousedown', function() {
                    // 添加录音状态样式
                    this.classList.add('voice-recording');
                    // 演示模式：开始语音识别流程
                    startDemoVoiceRecognition();
                });
                
                voiceBtn.addEventListener('mouseup', function() {
                    // 移除录音状态样式
                    this.classList.remove('voice-recording');
                    // 演示模式：停止语音识别，开始AI回复
                    stopDemoVoiceRecognition();
                });
                
                // 移动设备触摸支持
                voiceBtn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    // 添加录音状态样式
                    this.classList.add('voice-recording');
                    // 演示模式：开始语音识别流程
                    startDemoVoiceRecognition();
                });
                
                voiceBtn.addEventListener('touchend', function() {
                    // 移除录音状态样式
                    this.classList.remove('voice-recording');
                    // 演示模式：停止语音识别，开始AI回复
                    stopDemoVoiceRecognition();
                });
            }
            
            // 语音按钮功能 - 新版本
            
            // 开始语音识别
            function startVoiceRecognition() {
                if (isListening) return;
                
                isListening = true;
                
                // 显示语音指示器，隐藏输入框
                if (voiceIndicator) {
                    voiceIndicator.classList.remove('hidden');
                    
                    // 模拟音量变化的动画效果
                    const animateVoiceWave = () => {
                        if (!isListening) return;
                        
                        const waveSpans = document.querySelectorAll('.voice-wave span');
                        if (waveSpans.length > 0) {
                            // 随机生成高度变化
                            waveSpans.forEach(span => {
                                const randomHeight = 6 + Math.random() * 20;
                                span.style.height = `${randomHeight}px`;
                            });
                        }
                        
                        // 继续动画循环
                        if (isListening) {
                            requestAnimationFrame(animateVoiceWave);
                        }
                    };
                    
                    // 启动动画
                    requestAnimationFrame(animateVoiceWave);
                }
                
                // 模拟语音识别过程
                if (voiceText) {
                    voiceText.textContent = "正在听取您的指令...";
                    
                    // 随机模拟不同的语音指令
                    const possibleCommands = [
                        "调整到3档速度",
                        "轮椅状态如何",
                        "设置座椅温度为26度",
                        "锁定轮椅",
                        "帮我寻找轮椅位置"
                    ];
                    
                    // 随机选择一条命令
                    const randomCommand = possibleCommands[Math.floor(Math.random() * possibleCommands.length)];
                    
                    // 模拟识别过程 - 逐字显示
                    const showTextGradually = (text) => {
                        let currentText = "";
                        let index = 0;
                        
                        const textInterval = setInterval(() => {
                            if (index >= text.length || !isListening) {
                                clearInterval(textInterval);
                                return;
                            }
                            
                            currentText += text[index++];
                            voiceText.textContent = currentText;
                        }, 100);
                    };
                    
                    // 延迟后开始逐字显示
                    setTimeout(() => {
                        if (isListening) {
                            showTextGradually(randomCommand);
                        }
                    }, 1000);
                }
            }
            
            // 停止语音识别
            function stopVoiceRecognition() {
                if (!isListening) return;
                
                isListening = false;
                
                // 隐藏语音指示器
                if (voiceIndicator) {
                    voiceIndicator.classList.add('hidden');
                }
                
                // 获取识别的文本并直接发送
                if (voiceText && conversationContainer) {
                    const recognizedText = voiceText.textContent;
                    if (recognizedText && recognizedText !== "正在听取您的指令..." && recognizedText !== "请开始说话") {
                        // 直接使用语音识别结果作为消息
                        sendMessage(recognizedText);
                    }
                    
                    // 重置语音文本
                    voiceText.textContent = "请开始说话";
                }
            }
            
            // 演示模式发送消息函数
            function sendDemoMessage() {
                const conversation = getNextDemoConversation();
                
                if (!conversation) {
                    // 演示结束，显示提示
                    addMessageToConversation("Demo completed. All conversation examples have been shown.", 'assistant');
                    return;
                }
                
                // 添加用户消息到对话区
                if (conversation.query.type === 'text') {
                    addMessageToConversation(conversation.query.content, 'user');
                } else if (conversation.query.type === 'image_text') {
                    // 支持真实图片或SVG
                    const imageContent = conversation.query.image.url 
                        ? `<img src="${conversation.query.image.url}" alt="${conversation.query.image.description}" class="w-full h-auto rounded-lg" style="max-height: 150px; object-fit: cover;">` 
                        : conversation.query.image.svg;
                    addMessageWithImage(imageContent, conversation.query.content, 'user');
                }
                
                // 显示正在输入指示
                const typingIndicator = document.createElement('div');
                typingIndicator.className = 'flex items-start my-4 typing-indicator';
                typingIndicator.innerHTML = `
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-2 flex-shrink-0">
                        <i class="fas fa-robot text-blue-600"></i>
                    </div>
                    <div class="bg-gray-100 rounded-2xl rounded-tl-none p-3 max-w-[80%]">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                `;
                const conversationList = document.getElementById('demo-conversation-list');
                conversationList.appendChild(typingIndicator);
                scrollToBottom();
                
                // 模拟AI回复延迟
                setTimeout(() => {
                    // 移除正在输入指示
                    const indicators = document.querySelectorAll('.typing-indicator');
                    indicators.forEach(indicator => indicator.remove());
                    
                    // 添加AI回复
                    if (conversation.response.type === 'text') {
                        addMessageToConversation(conversation.response.content, 'assistant');
                    } else if (conversation.response.type === 'music_card') {
                        addMusicCard(conversation.response.content);
                    }
                    
                    // 滚动到底部
                    scrollToBottom();
                }, 1500);
                
                // 滚动到底部
                scrollToBottom();
            }
            
            // 演示模式变量
            let currentDemoConversation = null;
            let voiceRecognitionStartTime = null;
            let recognitionTextInterval = null;
            let currentUserMessageDiv = null;
            
            // 开始语音识别演示
            function startDemoVoiceRecognition() {
                const conversation = getNextDemoConversation();
                
                if (!conversation) {
                    // 演示结束，显示提示
                    addMessageToConversation("Demo completed. All conversation examples have been shown.", 'assistant');
                    return;
                }
                
                currentDemoConversation = conversation;
                
                // 如果是AI主动发起的对话（如提醒），直接显示AI回复
                if (conversation.query.type === 'ai_initiated') {
                    showAIThinking();
                    return;
                }
                
                voiceRecognitionStartTime = Date.now();
                
                // 创建唯一ID避免冲突
                const uniqueId = 'recognition-text-' + Date.now();
                
                // 创建用户消息气泡（初始为空）
                const conversationList = document.getElementById('demo-conversation-list');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex items-start justify-end my-4';
                
                if (conversation.query.type === 'text') {
                    messageDiv.innerHTML = `
                        <div class="bg-blue-500 text-white rounded-2xl rounded-tr-none p-3 max-w-[80%]">
                            <p class="text-sm" id="${uniqueId}"></p>
                        </div>
                        <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center ml-2 flex-shrink-0">
                            <i class="fas fa-user text-gray-500"></i>
                        </div>
                    `;
                } else if (conversation.query.type === 'image_text') {
                    // 支持真实图片或SVG
                    const imageContent = conversation.query.image.url 
                        ? `<img src="${conversation.query.image.url}" alt="${conversation.query.image.description}" class="w-full h-auto rounded-lg" style="max-height: 150px; object-fit: cover;">` 
                        : conversation.query.image.svg;
                    messageDiv.innerHTML = `
                        <div class="bg-blue-500 text-white rounded-2xl rounded-tr-none p-3 max-w-[80%]">
                            <div class="mb-2 rounded-lg overflow-hidden bg-white p-2" style="display: none;">
                                ${imageContent}
                            </div>
                            <p class="text-sm" id="${uniqueId}"></p>
                        </div>
                        <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center ml-2 flex-shrink-0">
                            <i class="fas fa-user text-gray-500"></i>
                        </div>
                    `;
                }
                
                conversationList.appendChild(messageDiv);
                currentUserMessageDiv = messageDiv;
                scrollToBottom();
                
                // 开始流式显示识别文字
                startStreamingRecognition(uniqueId);
            }
            
            // 流式显示识别文字
            function startStreamingRecognition(textElementId) {
                const recognitionTextEl = document.getElementById(textElementId);
                if (!recognitionTextEl || !currentDemoConversation) return;
                
                const fullText = currentDemoConversation.query.content;
                let currentIndex = 0;
                
                recognitionTextInterval = setInterval(() => {
                    if (currentIndex < fullText.length) {
                        recognitionTextEl.textContent = fullText.substring(0, currentIndex + 1);
                        currentIndex++;
                        scrollToBottom();
                    } else {
                        clearInterval(recognitionTextInterval);
                    }
                }, 100); // 每100ms显示一个字符
            }
            
            // 停止语音识别演示
            function stopDemoVoiceRecognition() {
                if (!currentDemoConversation) return;
                
                // 如果是AI主动发起的对话，不需要处理用户消息
                if (currentDemoConversation.query.type === 'ai_initiated') {
                    return;
                }
                
                // 清除识别文字流式效果
                if (recognitionTextInterval) {
                    clearInterval(recognitionTextInterval);
                    recognitionTextInterval = null;
                }
                
                // 确保文字完全显示
                if (!currentUserMessageDiv) return; // 防止null访问
                const recognitionTextEl = currentUserMessageDiv.querySelector('p.text-sm');
                if (recognitionTextEl) {
                    recognitionTextEl.textContent = currentDemoConversation.query.content;
                    
                    // 如果是图片+文字类型，显示图片
                    if (currentDemoConversation.query.type === 'image_text') {
                        const imageDiv = currentUserMessageDiv.querySelector('.bg-white');
                        if (imageDiv) {
                            imageDiv.style.display = 'block';
                        }
                    }
                }
                
                scrollToBottom();
                
                // 延迟一下再显示AI思考
                setTimeout(() => {
                    showAIThinking();
                }, 300);
            }
            
            // 显示AI思考状态
            function showAIThinking() {
                // 显示正在输入指示
                const typingIndicator = document.createElement('div');
                typingIndicator.className = 'flex items-start my-4 typing-indicator';
                typingIndicator.innerHTML = `
                    <div class="w-8 h-8 bg-gradient-to-br from-pink-400 to-purple-500 rounded-full flex items-center justify-center mr-2 flex-shrink-0">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="bg-white rounded-2xl rounded-tl-none p-3 max-w-[80%] shadow-sm">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                `;
                const conversationList = document.getElementById('demo-conversation-list');
                conversationList.appendChild(typingIndicator);
                scrollToBottom();
                
                // 模拟AI回复延迟
                setTimeout(() => {
                    // 移除正在输入指示
                    const indicators = document.querySelectorAll('.typing-indicator');
                    indicators.forEach(indicator => indicator.remove());
                    
                    // 添加AI回复
                    if (currentDemoConversation.response.type === 'text') {
                        addMessageToConversation(currentDemoConversation.response.content, 'assistant');
                    } else if (currentDemoConversation.response.type === 'music_card') {
                        addMusicCard(currentDemoConversation.response.content);
                    } else if (currentDemoConversation.response.type === 'text_schedule_card') {
                        addScheduleCards(currentDemoConversation.response.content);
                    } else if (currentDemoConversation.response.type === 'reminder_card') {
                        addReminderCard(currentDemoConversation.response.content);
                    } else if (currentDemoConversation.response.type === 'text_reminder_preview') {
                        addReminderPreview(currentDemoConversation.response.content);
                    } else if (currentDemoConversation.response.type === 'text_navigation_card') {
                        addNavigationCard(currentDemoConversation.response.content);
                    } else if (currentDemoConversation.response.type === 'text_dual_card') {
                        addDualCard(currentDemoConversation.response.content);
                    }
                    
                    // 滚动到底部
                    scrollToBottom();
                    
                    // 重置状态
                    currentDemoConversation = null;
                    currentUserMessageDiv = null;
                }, 1500);
            }
            
            // 添加消息到对话区
            function addMessageToConversation(text, sender) {
                const conversationList = document.getElementById('demo-conversation-list');
                if (!conversationList) return;
                
                const messageDiv = document.createElement('div');
                
                if (sender === 'user') {
                    messageDiv.className = 'flex items-start justify-end my-4';
                    messageDiv.innerHTML = `
                        <div class="bg-blue-500 text-white rounded-2xl rounded-tr-none p-3 max-w-[80%]">
                            <p class="text-sm">${text}</p>
                        </div>
                        <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center ml-2 flex-shrink-0">
                            <i class="fas fa-user text-gray-500"></i>
                        </div>
                    `;
                } else {
                    messageDiv.className = 'flex items-start my-4';
                    messageDiv.innerHTML = `
                        <div class="w-8 h-8 bg-gradient-to-br from-pink-400 to-purple-500 rounded-full flex items-center justify-center mr-2 flex-shrink-0">
                            <i class="fas fa-robot text-white text-sm"></i>
                        </div>
                        <div class="bg-white rounded-2xl rounded-tl-none p-3 max-w-[80%] shadow-sm">
                            <p class="text-sm">${text}</p>
                        </div>
                    `;
                }
                
                conversationList.appendChild(messageDiv);
            }
            
            // 添加带图片的消息
            function addMessageWithImage(imageSvg, text, sender) {
                const conversationList = document.getElementById('demo-conversation-list');
                if (!conversationList) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex items-start justify-end my-4';
                
                messageDiv.innerHTML = `
                    <div class="bg-blue-500 text-white rounded-2xl rounded-tr-none p-3 max-w-[80%]">
                        <div class="mb-2 rounded-lg overflow-hidden bg-white p-2">
                            ${imageSvg}
                        </div>
                        <p class="text-sm">${text}</p>
                    </div>
                    <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center ml-2 flex-shrink-0">
                        <i class="fas fa-user text-gray-500"></i>
                    </div>
                `;
                
                conversationList.appendChild(messageDiv);
            }
            
            // 添加音乐卡片
            function addMusicCard(musicData) {
                const conversationList = document.getElementById('demo-conversation-list');
                if (!conversationList) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex items-start my-4';
                
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-gradient-to-br from-pink-400 to-purple-500 rounded-full flex items-center justify-center mr-2 flex-shrink-0">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="bg-white rounded-2xl rounded-tl-none p-4 w-full shadow-sm">
                        <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg p-6 text-white">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center">
                                    <i class="fas fa-music text-lg mr-2"></i>
                                    <span class="font-semibold">${musicData.station}</span>
                                </div>
                                <div class="flex items-center space-x-1">
                                    <div class="w-1 h-3 bg-white rounded-full animate-pulse"></div>
                                    <div class="w-1 h-2 bg-white rounded-full animate-pulse" style="animation-delay: 0.1s"></div>
                                    <div class="w-1 h-4 bg-white rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                                </div>
                            </div>
                            <p class="text-xs text-blue-100 mb-2">${musicData.description}</p>
                            <div class="flex items-center text-sm">
                                <div class="w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse"></div>
                                ${musicData.status}
                            </div>
                        </div>
                    </div>
                `;
                
                conversationList.appendChild(messageDiv);
            }
            
            // 添加日程卡片到对话区
            function addScheduleCards(responseData) {
                const conversationList = document.getElementById('demo-conversation-list');
                if (!conversationList) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex items-start my-4';
                
                let cardsHtml = '';
                responseData.schedule_cards.forEach(card => {
                    cardsHtml += `
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-5 mb-4 last:mb-0">
                            <!-- 标题和图标 -->
                            <div class="flex items-center mb-3">
                                <span class="text-4xl mr-4">${card.icon}</span>
                                <div class="flex-1">
                                    <h3 class="text-xl font-bold text-gray-800">${card.title}</h3>
                                </div>
                            </div>
                            
                            <!-- 时间 -->
                            <div class="mb-3">
                                <p class="text-lg text-blue-600 font-bold">${card.time}</p>
                            </div>
                            
                            <!-- 设备信息 -->
                            ${card.device ? `<div class="mb-3"><p class="text-base text-purple-600 font-semibold"><i class="fas fa-mobile-alt mr-2"></i> ${card.device}</p></div>` : ''}
                            
                            <!-- 地点 -->
                            ${card.location ? `<div class="mb-3"><p class="text-base text-gray-600 font-medium"><i class="fas fa-map-marker-alt mr-2"></i> ${card.location}</p></div>` : ''}
                            
                            <!-- 描述 -->
                            ${card.description ? `<div><p class="text-base text-gray-700">${card.description}</p></div>` : ''}
                        </div>
                    `;
                });
                
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-gradient-to-br from-pink-400 to-purple-500 rounded-full flex items-center justify-center mr-2 flex-shrink-0">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="bg-white rounded-2xl rounded-tl-none p-4 max-w-[80%] shadow-sm">
                        <p class="text-sm mb-3">${responseData.text}</p>
                        ${cardsHtml}
                    </div>
                `;
                conversationList.appendChild(messageDiv);
                scrollToBottom();
            }
            
            // 添加提醒卡片到对话区
            function addReminderCard(reminderData) {
                const conversationList = document.getElementById('demo-conversation-list');
                if (!conversationList) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex items-start my-4';
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-gradient-to-br from-pink-400 to-purple-500 rounded-full flex items-center justify-center mr-2 flex-shrink-0">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="bg-white rounded-2xl rounded-tl-none p-4 max-w-[80%] shadow-sm">
                        <div class="bg-gradient-to-r from-red-50 to-orange-50 border-2 border-red-200 rounded-xl p-4 ${reminderData.urgent ? 'animate-pulse' : ''}">
                            <div class="flex items-center mb-3">
                                <span class="text-3xl mr-3">${reminderData.icon}</span>
                                <div class="flex-1">
                                    <h4 class="font-bold text-red-700">${reminderData.title}</h4>
                                    <p class="text-red-600 font-medium">${reminderData.time}</p>
                                </div>
                                ${reminderData.urgent ? '<i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>' : ''}
                            </div>
                            <p class="text-gray-700 mb-2">${reminderData.description}</p>
                            ${reminderData.medication ? `<p class="text-sm text-gray-600 bg-white rounded-lg p-2"><strong>Medication:</strong> ${reminderData.medication}</p>` : ''}
                        </div>
                    </div>
                `;
                conversationList.appendChild(messageDiv);
                scrollToBottom();
            }
            
            // 添加提醒预览到对话区
            function addReminderPreview(previewData) {
                const conversationList = document.getElementById('demo-conversation-list');
                if (!conversationList) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex items-start my-4';
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-gradient-to-br from-pink-400 to-purple-500 rounded-full flex items-center justify-center mr-2 flex-shrink-0">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="bg-white rounded-2xl rounded-tl-none p-4 max-w-[80%] shadow-sm">
                        <p class="text-sm mb-3">${previewData.text}</p>
                        <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl p-4">
                            <div class="flex items-center mb-2">
                                <span class="text-2xl mr-3">${previewData.next_reminder.icon}</span>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-800">${previewData.next_reminder.title}</h4>
                                    <p class="text-sm text-green-600 font-medium">${previewData.next_reminder.time}</p>
                                </div>
                            </div>
                            ${previewData.next_reminder.location ? `<p class="text-sm text-gray-600"><i class="fas fa-map-marker-alt mr-1"></i> ${previewData.next_reminder.location}</p>` : ''}
                        </div>
                    </div>
                `;
                conversationList.appendChild(messageDiv);
                scrollToBottom();
            }
            
            // 添加导航卡片到对话区
            function addNavigationCard(responseData) {
                const conversationList = document.getElementById('demo-conversation-list');
                if (!conversationList) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex items-start my-4';
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-gradient-to-br from-pink-400 to-purple-500 rounded-full flex items-center justify-center mr-2 flex-shrink-0">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="bg-white rounded-2xl rounded-tl-none p-4 max-w-[80%] shadow-sm">
                        <p class="text-base mb-4 text-gray-700 leading-relaxed">${responseData.text}</p>
                        
                        <!-- 导航卡片主体 -->
                        <div class="bg-gradient-to-br from-blue-50 via-cyan-50 to-blue-100 border border-blue-200 rounded-xl overflow-hidden shadow-sm">
                            <!-- 目的地头部区域 -->
                            <div class="bg-gradient-to-r from-blue-500 to-cyan-500 text-white p-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <span class="text-3xl mr-3 filter drop-shadow-sm flex-shrink-0">${responseData.navigation_card.icon}</span>
                                        <div class="flex-1">
                                            <h3 class="text-xl font-bold mb-1 text-white">${responseData.navigation_card.destination}</h3>
                                            <p class="text-sm text-blue-100 opacity-90">${responseData.navigation_card.address}</p>
                                        </div>
                                    </div>
                                    ${responseData.navigation_card.start_available ? `
                                        <button class="bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white px-4 py-3 rounded-lg flex items-center text-sm font-medium transition-all duration-200 border border-white/30 flex-shrink-0">
                                            <i class="fas fa-play mr-2"></i>
                                            Start
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- 详细信息区域 - 单列大字体布局 -->
                            <div class="p-4 space-y-4">
                                <!-- Distance -->
                                <div class="bg-white rounded-xl p-4 border border-blue-100 shadow-sm">
                                    <div class="flex items-center">
                                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mr-4 flex-shrink-0">
                                            <i class="fas fa-route text-blue-600 text-lg"></i>
                                        </div>
                                        <div class="flex-1">
                                            <p class="text-base text-gray-500 font-medium mb-1">Distance</p>
                                            <p class="text-2xl font-bold text-gray-800">${responseData.navigation_card.distance}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Duration -->
                                <div class="bg-white rounded-xl p-4 border border-green-100 shadow-sm">
                                    <div class="flex items-center">
                                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mr-4 flex-shrink-0">
                                            <i class="fas fa-clock text-green-600 text-lg"></i>
                                        </div>
                                        <div class="flex-1">
                                            <p class="text-base text-gray-500 font-medium mb-1">Duration</p>
                                            <p class="text-2xl font-bold text-gray-800">${responseData.navigation_card.duration}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Route Type -->
                                <div class="bg-white rounded-xl p-4 border border-purple-100 shadow-sm">
                                    <div class="flex items-center">
                                        <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mr-4 flex-shrink-0">
                                            <i class="fas fa-wheelchair text-purple-600 text-lg"></i>
                                        </div>
                                        <div class="flex-1">
                                            <p class="text-base text-gray-500 font-medium mb-1">Route Type</p>
                                            <p class="text-xl font-semibold text-gray-800">${responseData.navigation_card.route_type}</p>
                                        </div>
                                    </div>
                                </div>
                                

                            </div>
                        </div>
                    </div>
                `;
                conversationList.appendChild(messageDiv);
                scrollToBottom();
            }
            
            // 添加双段文字卡片到对话区
            function addDualCard(dualCardData) {
                const conversationList = document.getElementById('demo-conversation-list');
                if (!conversationList) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex items-start my-4';
                
                // 获取卡片颜色配置
                const getCardStyle = (color) => {
                    const styles = {
                        blue: 'from-blue-50 to-indigo-50 border-blue-200',
                        green: 'from-green-50 to-emerald-50 border-green-200',
                        purple: 'from-purple-50 to-pink-50 border-purple-200',
                        orange: 'from-orange-50 to-yellow-50 border-orange-200'
                    };
                    return styles[color] || styles.blue;
                };
                
                // 获取卡片样式
                const card1Style = getCardStyle(dualCardData.card1.color);
                const card2Style = getCardStyle(dualCardData.card2.color);
                
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-gradient-to-br from-pink-400 to-purple-500 rounded-full flex items-center justify-center mr-2 flex-shrink-0">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="bg-white rounded-2xl rounded-tl-none p-4 max-w-[80%] shadow-sm">
                        <!-- 第一个卡片 -->
                        <div class="bg-gradient-to-r ${card1Style} border rounded-xl p-4 mb-3">
                            <div class="flex items-center mb-3">
                                <span class="text-3xl mr-3 flex-shrink-0">${dualCardData.card1.icon}</span>
                                <h4 class="text-xl font-bold text-gray-800 flex-1">${dualCardData.card1.title}</h4>
                            </div>
                            <div class="text-left">
                                <p class="text-base text-gray-700 leading-relaxed">${dualCardData.card1.text.replace(/\n/g, '<br>')}</p>
                            </div>
                        </div>
                        
                        <!-- 第二个卡片 -->
                        <div class="bg-gradient-to-r ${card2Style} border rounded-xl p-4">
                            <div class="flex items-center mb-3">
                                <span class="text-3xl mr-3 flex-shrink-0">${dualCardData.card2.icon}</span>
                                <h4 class="text-xl font-bold text-gray-800 flex-1">${dualCardData.card2.title}</h4>
                            </div>
                            <div class="text-left">
                                <p class="text-base text-gray-700 leading-relaxed">${dualCardData.card2.text.replace(/\n/g, '<br>')}</p>
                            </div>
                        </div>
                    </div>
                `;
                conversationList.appendChild(messageDiv);
                scrollToBottom();
            }
            
            // 滚动到对话底部
            function scrollToBottom() {
                if (conversationContainer) {
                    conversationContainer.scrollTop = conversationContainer.scrollHeight;
                }
            }

            // 历史对话查询功能
            const historyBtn = document.getElementById('history-btn');
            const historyModal = document.getElementById('history-modal');
            const closeHistoryBtn = document.getElementById('close-history-btn');
            
            if (historyBtn && historyModal && closeHistoryBtn) {
                historyBtn.addEventListener('click', function() {
                    historyModal.classList.remove('hidden');
                });
                
                closeHistoryBtn.addEventListener('click', function() {
                    historyModal.classList.add('hidden');
                });
                
                // 点击弹窗外部关闭
                historyModal.addEventListener('click', function(e) {
                    if (e.target === historyModal) {
                        historyModal.classList.add('hidden');
                    }
                });
                
                // 阻止弹窗内部点击事件冒泡
                const historyModalContent = historyModal.querySelector('.bg-white');
                if (historyModalContent) {
                    historyModalContent.addEventListener('click', function(e) {
                        e.stopPropagation();
                    });
                }
                
                // 历史记录项点击事件
                const historyItems = historyModal.querySelectorAll('.bg-gray-50');
                historyItems.forEach(item => {
                    item.addEventListener('click', async function() {
                        // 获取对话内容
                        const dialogTitle = this.querySelector('.font-medium').textContent;
                        const dialogContent = this.querySelector('.text-gray-500.truncate').textContent;
                        
                        // 这里可以实现加载历史对话到当前会话的功能
                        console.log('加载历史对话:', dialogTitle, dialogContent);
                        
                        // 关闭弹窗
                        historyModal.classList.add('hidden');
                        
                        // 可以添加一个提示，告知用户已加载历史对话
                        await appAlert('已加载历史对话: ' + dialogTitle, '历史对话');
                    });
                });
            }
            
            // 全局悬浮播放器控制函数
            function updateFloatingPlayerDisplay(title, artist, isPlaying) {
                const titleElement = document.getElementById('floating-track-title');
                const artistElement = document.getElementById('floating-track-artist');
                const playPauseBtn = document.getElementById('floating-play-pause-btn');
                const floatingIcon = document.getElementById('floating-player-icon');
                const playingIndicator = document.getElementById('playing-indicator');
                
                if (title && titleElement) {
                    titleElement.textContent = title;
                }
                if (artist && artistElement) {
                    artistElement.textContent = artist;
                }
                
                if (playPauseBtn) {
                    const icon = playPauseBtn.querySelector('i');
                    if (isPlaying) {
                        icon.className = 'fas fa-pause';
                        playPauseBtn.setAttribute('data-playing', 'true');
                        floatingIcon.className = 'fas fa-pause text-white text-lg';
                        playingIndicator.style.display = 'block';
                    } else {
                        icon.className = 'fas fa-play';
                        playPauseBtn.setAttribute('data-playing', 'false');
                        floatingIcon.className = 'fas fa-play text-white text-lg';
                        playingIndicator.style.display = 'none';
                    }
                }
            }
            
            function updateFloatingVolumeDisplay(volume) {
                const volumeBar = document.getElementById('floating-volume-bar');
                const volumeText = volumeBar?.parentElement?.nextElementSibling;
                
                if (volumeBar) {
                    volumeBar.style.width = volume + '%';
                }
                if (volumeText) {
                    volumeText.textContent = volume + '%';
                }
            }
            
            // 全局悬浮播放器展开/折叠控制
            const playerCollapsed = document.getElementById('player-collapsed');
            const playerExpanded = document.getElementById('player-expanded');
            const playerMinimizeBtn = document.getElementById('player-minimize-btn');
            
            let isPlayerExpanded = false;
            
            // 点击悬浮球展开播放器
            if (playerCollapsed) {
                playerCollapsed.addEventListener('click', function() {
                    if (!isPlayerExpanded) {
                        playerCollapsed.classList.add('hidden');
                        playerExpanded.classList.remove('hidden');
                        isPlayerExpanded = true;
                    }
                });
            }
            
            // 点击最小化按钮折叠播放器
            if (playerMinimizeBtn) {
                playerMinimizeBtn.addEventListener('click', function() {
                    if (isPlayerExpanded) {
                        playerExpanded.classList.add('hidden');
                        playerCollapsed.classList.remove('hidden');
                        isPlayerExpanded = false;
                    }
                });
            }
            
            // 悬浮播放器控制按钮事件
            const floatingPlayPauseBtn = document.getElementById('floating-play-pause-btn');
            const floatingPrevBtn = document.getElementById('floating-prev-btn');
            const floatingNextBtn = document.getElementById('floating-next-btn');
            
            if (floatingPlayPauseBtn) {
                floatingPlayPauseBtn.addEventListener('click', function() {
                    const isPlaying = this.getAttribute('data-playing') === 'true';
                    updateFloatingPlayerDisplay(null, null, !isPlaying);
                });
            }
            
            if (floatingNextBtn) {
                floatingNextBtn.addEventListener('click', function() {
                    const tracks = [
                        { title: "轻松音乐频道", artist: "正在播放：舒缓钢琴曲" },
                        { title: "古典音乐厅", artist: "正在播放：贝多芬钢琴曲" },
                        { title: "轻松爵士", artist: "正在播放：咖啡厅音乐" },
                        { title: "新闻广播", artist: "正在播放：即时新闻" }
                    ];
                    const randomTrack = tracks[Math.floor(Math.random() * tracks.length)];
                    updateFloatingPlayerDisplay(randomTrack.title, randomTrack.artist, true);
                });
            }
            
            if (floatingPrevBtn) {
                floatingPrevBtn.addEventListener('click', function() {
                    const tracks = [
                        { title: "轻松音乐频道", artist: "正在播放：舒缓钢琴曲" },
                        { title: "古典音乐厅", artist: "正在播放：贝多芬钢琴曲" },
                        { title: "轻松爵士", artist: "正在播放：咖啡厅音乐" },
                        { title: "新闻广播", artist: "正在播放：即时新闻" }
                    ];
                    const randomTrack = tracks[Math.floor(Math.random() * tracks.length)];
                    updateFloatingPlayerDisplay(randomTrack.title, randomTrack.artist, true);
                });
            }
            
            // 音量控制
            const floatingVolumeBar = document.getElementById('floating-volume-bar');
            if (floatingVolumeBar && floatingVolumeBar.parentElement) {
                floatingVolumeBar.parentElement.addEventListener('click', function(e) {
                    const rect = this.getBoundingClientRect();
                    const clickX = e.clientX - rect.left;
                    const width = rect.width;
                    const volume = Math.round((clickX / width) * 100);
                    updateFloatingVolumeDisplay(Math.max(0, Math.min(100, volume)));
                });
            }
            
            // 进度条控制
            const floatingProgressBar = document.getElementById('floating-progress-bar');
            if (floatingProgressBar && floatingProgressBar.parentElement) {
                floatingProgressBar.parentElement.addEventListener('click', function(e) {
                    const rect = this.getBoundingClientRect();
                    const clickX = e.clientX - rect.left;
                    const width = rect.width;
                    const progress = (clickX / width) * 100;
                    floatingProgressBar.style.width = Math.max(0, Math.min(100, progress)) + '%';
                });
            }
            
            // 地图管理按钮事件处理
            const mapManagementBtn = document.getElementById('map-management-btn');
            if (mapManagementBtn) {
                mapManagementBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    showPage('map-management');
                });
            }
            
            // 设备位置地图相关功能（已集成到融合地图中）
            function initDeviceLocationMap() {
                // 此函数现在主要用于兼容性，实际功能已移至 initUnifiedMapSwitching()
                console.log('📍 设备位置地图功能已集成到融合地图中');
            }
            
            // 融合地图切换功能
            function initUnifiedMapSwitching() {
                const indoorMapBtn = document.getElementById('indoor-map-btn');
                const outdoorMapBtn = document.getElementById('outdoor-map-btn');
                const indoorMapView = document.getElementById('indoor-map-view');
                const outdoorMapView = document.getElementById('outdoor-map-view');
                const navigateBtn = document.getElementById('navigate-btn');
                const positionStatusText = document.getElementById('position-status-text');
                const mapTitle = document.getElementById('map-title');
                
                let currentMapType = 'indoor'; // 默认显示室内地图
                
                // 室外地图相关变量
                let currentLocationIndex = 0;
                let currentZoomLevel = 15;
                
                // 模拟位置数据
                const locationData = [
                    {
                        lat: 31.2304,
                        lng: 121.4737,
                        address: '上海市浦东新区张江高科技园区',
                        accuracy: '5米',
                        time: '10:23'
                    },
                    {
                        lat: 31.2354,
                        lng: 121.4857,
                        address: '上海市浦东新区世纪大道1号',
                        accuracy: '8米',
                        time: '10:45'
                    }
                ];
                
                // 切换到室内地图
                function switchToIndoorMap() {
                    if (currentMapType === 'indoor') return;
                    
                    currentMapType = 'indoor';
                    
                    // 更新按钮样式
                    if (indoorMapBtn && outdoorMapBtn) {
                        indoorMapBtn.className = 'px-3 py-1 rounded-md text-xs font-medium transition-all duration-200 bg-blue-600 text-white';
                        outdoorMapBtn.className = 'px-3 py-1 rounded-md text-xs font-medium transition-all duration-200 text-gray-400 hover:text-white';
                    }
                    
                    // 切换地图视图
                    if (indoorMapView && outdoorMapView) {
                        indoorMapView.classList.remove('hidden');
                        outdoorMapView.classList.add('hidden');
                    }
                    
                    // 隐藏导航按钮（室内地图不需要）
                    if (navigateBtn) {
                        navigateBtn.classList.add('hidden');
                    }
                    
                    // 更新状态文本
                    if (positionStatusText) {
                        positionStatusText.textContent = '定位正常';
                    }
                }
                
                // 切换到室外地图
                function switchToOutdoorMap() {
                    if (currentMapType === 'outdoor') return;
                    
                    currentMapType = 'outdoor';
                    
                    // 更新按钮样式
                    if (indoorMapBtn && outdoorMapBtn) {
                        indoorMapBtn.className = 'px-3 py-1 rounded-md text-xs font-medium transition-all duration-200 text-gray-400 hover:text-white';
                        outdoorMapBtn.className = 'px-3 py-1 rounded-md text-xs font-medium transition-all duration-200 bg-blue-600 text-white';
                    }
                    
                    // 切换地图视图
                    if (indoorMapView && outdoorMapView) {
                        indoorMapView.classList.add('hidden');
                        outdoorMapView.classList.remove('hidden');
                    }
                    
                    // 显示导航按钮
                    if (navigateBtn) {
                        navigateBtn.classList.remove('hidden');
                    }
                    
                    // 更新状态文本 - 只显示GPS定位
                    if (positionStatusText) {
                        positionStatusText.textContent = 'GPS定位';
                    }
                    
                    // 更新室外地图显示
                    updateOutdoorMapDisplay();
                }
                
                // 更新室外地图显示
                function updateOutdoorMapDisplay() {
                    const location = locationData[currentLocationIndex];
                    const mapBackground = document.getElementById('outdoor-map-background');
                    const deviceAddress = document.getElementById('device-address');
                    const locationUpdateTime = document.getElementById('location-update-time');
                    const gpsAccuracy = document.getElementById('gps-accuracy');
                    
                    // 更新地图背景
                    if (mapBackground) {
                        mapBackground.style.backgroundImage = `url('https://api.mapbox.com/styles/v1/mapbox/dark-v10/static/${location.lng},${location.lat},${currentZoomLevel},0/350x200?access_token=pk.eyJ1IjoiZXhhbXBsZXVzZXIiLCJhIjoiY2syMDVtbDZ1MG9hdjNvcGJ2YWUzcHNmcyJ9.f1Y4y9cTZxL-tsjNk3hUbA')`;
                    }
                    
                    // 更新底部详细地址信息（用户需要保留这些）
                    if (deviceAddress) deviceAddress.textContent = location.address;
                    if (locationUpdateTime) locationUpdateTime.textContent = location.time;
                    if (gpsAccuracy) gpsAccuracy.textContent = location.accuracy;
                }
                
                // 缩放功能
                function handleZoom(zoomIn) {
                    if (currentMapType === 'outdoor') {
                        if (zoomIn && currentZoomLevel < 19) {
                            currentZoomLevel += 1;
                            updateOutdoorMapDisplay();
                        } else if (!zoomIn && currentZoomLevel > 10) {
                            currentZoomLevel -= 1;
                            updateOutdoorMapDisplay();
                        }
                    }
                    // 室内地图缩放逻辑可以在这里添加
                }
                
                // 绑定事件监听器
                if (indoorMapBtn) {
                    indoorMapBtn.addEventListener('click', switchToIndoorMap);
                }
                
                if (outdoorMapBtn) {
                    outdoorMapBtn.addEventListener('click', switchToOutdoorMap);
                }
                
                // 绑定缩放按钮
                const zoomInBtn = document.getElementById('map-zoom-in');
                const zoomOutBtn = document.getElementById('map-zoom-out');
                
                if (zoomInBtn) {
                    zoomInBtn.addEventListener('click', () => handleZoom(true));
                }
                
                if (zoomOutBtn) {
                    zoomOutBtn.addEventListener('click', () => handleZoom(false));
                }
                
                // 导航按钮事件
                if (navigateBtn) {
                    navigateBtn.addEventListener('click', async () => {
                        if (currentMapType === 'outdoor') {
                            const location = locationData[currentLocationIndex];
                            await appAlert(`已打开导航至: ${location.address}`, '导航');
                        }
                    });
                }
                
                // 默认显示室内地图
                switchToIndoorMap();
                
                // 定时更新室外位置（仅在室外模式下有效）
                setInterval(() => {
                    if (currentMapType === 'outdoor') {
                        currentLocationIndex = (currentLocationIndex + 1) % locationData.length;
                        updateOutdoorMapDisplay();
                    }
                }, 30000);
            }
            
            // 在页面加载完成后初始化地图
            initDeviceLocationMap();
            
            // 初始化融合地图切换功能
            initUnifiedMapSwitching();
            
            // 建图功能相关事件处理
            initMappingFunctions();
        });
        
        // 建图功能初始化
        function initMappingFunctions() {
            // 地图管理入口
            const mapManagementBtn = document.getElementById('map-management-btn');
            if (mapManagementBtn) {
                mapManagementBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    showPage('map-management');
                });
            }
            
            // 地图管理页面返回按钮
            const mapManagementBackBtn = document.getElementById('map-management-back-btn');
            if (mapManagementBackBtn) {
                mapManagementBackBtn.addEventListener('click', function() {
                    showPage('profile');
                });
            }
            
            // 新建地图按钮
            const createNewMapBtn = document.getElementById('create-new-map-btn');
            if (createNewMapBtn) {
                createNewMapBtn.addEventListener('click', function() {
                    // 检查电量是否充足
                    const currentBattery = window.currentBatteryStatus ? window.currentBatteryStatus.level : 85;
                    
                    if (currentBattery < 50) {
                        // 电量不足，显示优雅的提示
                        showBatteryWarningModal(currentBattery);
                        return;
                    }
                    
                    // 电量充足，进入建图流程
                    showPage('create-map-check');
                    startConnectionCheck();
                });
            }
            
            // 连接检查页面
            const createMapCheckBackBtn = document.getElementById('create-map-check-back-btn');
            if (createMapCheckBackBtn) {
                createMapCheckBackBtn.addEventListener('click', function() {
                    showPage('map-management');
                });
            }
            
            // 地图命名页面
            const mapNamingBackBtn = document.getElementById('map-naming-back-btn');
            if (mapNamingBackBtn) {
                mapNamingBackBtn.addEventListener('click', function() {
                    showPage('create-map-check');
                });
            }
            
            // 地图命名输入验证
            const mapNameInput = document.getElementById('map-name-input');
            const namingNextBtn = document.getElementById('naming-next-btn');
            if (mapNameInput && namingNextBtn) {
                mapNameInput.addEventListener('input', function() {
                    if (this.value.trim().length > 0) {
                        namingNextBtn.disabled = false;
                        namingNextBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                        namingNextBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    } else {
                        namingNextBtn.disabled = true;
                        namingNextBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                        namingNextBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    }
                });
                
                namingNextBtn.addEventListener('click', function() {
                    if (!this.disabled) {
                        showPage('environment-check');
                        // 延迟执行环境检测，模拟检测过程
                        setTimeout(() => {
                            if (window.simulateEnvironmentDetection) {
                                window.simulateEnvironmentDetection();
                            }
                        }, 800);
                    }
                });
            }
            

            
            // 面积滑块
            const areaSlider = document.getElementById('area-slider');
            const areaValue = document.getElementById('area-value');
            if (areaSlider && areaValue) {
                areaSlider.addEventListener('input', function() {
                    areaValue.textContent = this.value + '㎡';
                });
            }
            
            // 环境检测页面
            const environmentCheckBackBtn = document.getElementById('environment-check-back-btn');
            const environmentNextBtn = document.getElementById('environment-next-btn');
            if (environmentCheckBackBtn) {
                environmentCheckBackBtn.addEventListener('click', function() {
                    showPage('map-naming');
                });
            }
            
            // 重置环境检测页面状态
            function resetEnvironmentDetection() {
                const indoorConfirm = document.getElementById('indoor-confirm');
                if (indoorConfirm) {
                    const label = indoorConfirm.closest('label');
                    if (label) {
                        // 重置样式
                        label.classList.remove('bg-yellow-50', 'border', 'border-yellow-300', 'rounded-lg', 'p-2');
                        const span = label.querySelector('span');
                        if (span) {
                            span.classList.remove('font-bold', 'text-blue-800');
                            span.textContent = '我确认当前处于室内环境';
                        }
                    }
                }
                
                // 默认隐藏整个检测部分
                const detectionSection = document.getElementById('environment-detection-section');
                if (detectionSection) {
                    detectionSection.classList.add('hidden');
                }
            }
            
            // 模拟环境检测 - 20%概率检测到非室内环境
            function simulateEnvironmentDetection() {
                // 先重置状态
                resetEnvironmentDetection();
                
                const isOutdoorDetected = Math.random() < 0.2; // 20%概率
                const detectionSection = document.getElementById('environment-detection-section');
                
                if (isOutdoorDetected && detectionSection) {
                    // 显示检测部分和警告
                    detectionSection.classList.remove('hidden');
                    
                    // 让第一个确认选项更加突出
                    const indoorConfirm = document.getElementById('indoor-confirm');
                    if (indoorConfirm) {
                        const label = indoorConfirm.closest('label');
                        if (label) {
                            label.classList.add('bg-yellow-50', 'border', 'border-yellow-300', 'rounded-lg', 'p-2');
                            const span = label.querySelector('span');
                            if (span) {
                                span.classList.add('font-bold', 'text-blue-800');
                                span.textContent = '⚠️ 我确认当前处于室内环境（重要确认）';
                            }
                        }
                    }
                } else {
                    // 正常情况下，检测部分保持隐藏
                    detectionSection.classList.add('hidden');
                }
            }
            
            // 保存模拟环境检测函数供页面切换时调用
            window.simulateEnvironmentDetection = simulateEnvironmentDetection;
            
            // 环境确认复选框
            const environmentCheckboxes = ['indoor-confirm', 'space-confirm', 'obstacle-confirm', 'safety-confirm'];
            environmentCheckboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.addEventListener('change', function() {
                        const allChecked = environmentCheckboxes.every(checkId => 
                            document.getElementById(checkId)?.checked
                        );
                        
                        if (environmentNextBtn) {
                            if (allChecked) {
                                environmentNextBtn.disabled = false;
                                environmentNextBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                                environmentNextBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                                environmentNextBtn.textContent = '环境检测通过，继续';
                            } else {
                                environmentNextBtn.disabled = true;
                                environmentNextBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                                environmentNextBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                                environmentNextBtn.textContent = '请确认所有环境条件';
                            }
                        }
                    });
                }
            });
            
            if (environmentNextBtn) {
                environmentNextBtn.addEventListener('click', function() {
                    if (!this.disabled) {
                        showPage('mapping-precautions');
                    }
                });
            }
            
            // 建图注意事项页面
            const precautionsBackBtn = document.getElementById('precautions-back-btn');
            const precautionsNextBtn = document.getElementById('precautions-next-btn');
            if (precautionsBackBtn) {
                precautionsBackBtn.addEventListener('click', function() {
                    showPage('environment-check');
                });
            }
            
            // 风险确认复选框
            const riskCheckboxes = ['safety-risk-confirm', 'responsibility-confirm'];
            riskCheckboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.addEventListener('change', function() {
                        const allChecked = riskCheckboxes.every(checkId => 
                            document.getElementById(checkId)?.checked
                        );
                        
                        if (precautionsNextBtn) {
                            if (allChecked) {
                                precautionsNextBtn.disabled = false;
                                precautionsNextBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                                precautionsNextBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                            } else {
                                precautionsNextBtn.disabled = true;
                                precautionsNextBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                                precautionsNextBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                            }
                        }
                    });
                }
            });
            
            if (precautionsNextBtn) {
                precautionsNextBtn.addEventListener('click', function() {
                    if (!this.disabled) {
                        showPage('real-time-mapping');
                        startRealTimeMapping();
                        // 启动新手引导
                        setTimeout(() => {
                            startMappingGuide();
                        }, 500);
                    }
                });
            }
            
            // 实时建图页面
            const emergencyStopBtn = document.getElementById('emergency-stop-btn');
            const saveAndContinueBtn = document.getElementById('save-and-continue-btn');
            
            if (emergencyStopBtn) {
                emergencyStopBtn.addEventListener('click', async function() {
                    const confirmed = await appConfirm('确定要停止建图吗？已扫描的数据将会保存。');
                    if (confirmed) {
                        stopMapping();
                        showPage('set-charging-station');
                    }
                });
            }
            
            if (saveAndContinueBtn) {
                saveAndContinueBtn.addEventListener('click', function() {
                    showPage('set-charging-station');
                });
            }
            
            // 建图速度控制
            const speedBtns = document.querySelectorAll('.speed-btn');
            speedBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    speedBtns.forEach(b => {
                        b.classList.remove('bg-blue-600', 'text-white');
                        b.classList.add('bg-gray-200');
                    });
                    this.classList.remove('bg-gray-200');
                    this.classList.add('bg-blue-600', 'text-white');
                });
            });
            
            // 设置充电桩页面
            initChargingStationPage();
            
            // 设置定位点页面
            initWaypointsPage();
            
            // 设置停靠点页面
            initParkingSpotsPage();
            
            // 设置安全区域页面
            initSafetyZonesPage();
            
            // 设置禁行区页面
            initRestrictedZonesPage();
            
            // 完成建图页面
            initMappingCompletePage();
        }
        
        // 新手引导系统
        function startMappingGuide() {
            const guideSteps = [
                {
                    title: "请坐在轮椅上操作",
                    content: "请坐在轮椅上使用摇杆控制方向和移动，可以将手机放在支架中并保持手机APP一直处于打开状态。",
                    icon: "fas fa-wheelchair",
                    color: "bg-green-500"
                },
                {
                    title: "控制建图时长",
                    content: "建图过程建议控制在30分钟以内。",
                    icon: "fas fa-battery-three-quarters",
                    color: "bg-blue-500"
                },
                {
                    title: "路径保持畅通",
                    content: "建图过程中请保持路径畅通，结束建图需先返回到充电桩前再点击完成建图。",
                    icon: "fas fa-route",
                    color: "bg-orange-500"
                }
            ];
            
            showGuideSteps(guideSteps, 0);
        }
        
        // 地点设置引导系统
        function showLocationGuide(type = 'waypoint') {
            const waypointGuideSteps = [
                {
                    title: "设置定位点",
                    content: "定位点帮助轮椅在室内准确定位和重定位。建议在房门口、客厅中央等开阔地点设置。",
                    icon: "fas fa-map-marker-alt",
                    color: "bg-blue-500"
                },
                {
                    title: "推荐位置",
                    content: "• 房门口、走廊入口等开阔地点\n• 客厅中央、餐厅中央等空旷区域\n• 各房间的连接通道处",
                    icon: "fas fa-lightbulb",
                    color: "bg-orange-500"
                },
                {
                    title: "设置建议",
                    content: "建议设置3-5个定位点，确保轮椅在各个区域都能准确定位。可在建图过程中随时添加。",
                    icon: "fas fa-info-circle",
                    color: "bg-purple-500"
                }
            ];
            
            const parkingGuideSteps = [
                {
                    title: "设置停靠点",
                    content: "停靠点是您经常上下轮椅的位置，设置后可以召唤轮椅导航到这些地点。",
                    icon: "fas fa-parking",
                    color: "bg-purple-500"
                },
                {
                    title: "选择合适位置",
                    content: "选择宽敞、安全的位置作为停靠点，确保轮椅能够安全停靠和离开。",
                    icon: "fas fa-check-circle",
                    color: "bg-green-500"
                },
                {
                    title: "安全考虑",
                    content: "停靠点应远离楼梯、台阶等危险区域，确保周围有足够的活动空间。",
                    icon: "fas fa-shield-alt",
                    color: "bg-red-500"
                }
            ];
            
            const steps = type === 'waypoint' ? waypointGuideSteps : parkingGuideSteps;
            showGuideSteps(steps, 0);
        }
        
        function showGuideSteps(steps, currentStep) {
            if (currentStep >= steps.length) {
                hideGuide();
                return;
            }
            
            const step = steps[currentStep];
            const guideContent = document.getElementById('guide-content');
            const guideOverlay = document.getElementById('guide-overlay');
            const guideNextBtn = document.getElementById('guide-next-btn');
            const guideSkipBtn = document.getElementById('guide-skip-btn');
            const guidePrevBtn = document.getElementById('guide-prev-btn');
            const guideNextArrowBtn = document.getElementById('guide-next-arrow-btn');
            
            guideContent.innerHTML = `
                <div class="text-center mb-6">
                    <div class="w-16 h-16 ${step.color} rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="${step.icon} text-white text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">${step.title}</h3>
                    <p class="text-sm text-gray-600 leading-relaxed">${step.content}</p>
                </div>
                <div class="flex justify-center space-x-2 mb-4">
                    ${steps.map((_, index) => 
                        `<div class="w-2 h-2 rounded-full ${index === currentStep ? 'bg-blue-500' : 'bg-gray-300'}"></div>`
                    ).join('')}
                </div>
            `;
            
            guideOverlay.classList.remove('hidden');
            
            // 更新左右箭头按钮状态
            if (guidePrevBtn) {
                if (currentStep === 0) {
                    guidePrevBtn.disabled = true;
                    guidePrevBtn.classList.add('opacity-30', 'cursor-not-allowed');
                    guidePrevBtn.classList.remove('hover:text-gray-600');
                } else {
                    guidePrevBtn.disabled = false;
                    guidePrevBtn.classList.remove('opacity-30', 'cursor-not-allowed');
                    guidePrevBtn.classList.add('hover:text-gray-600');
                }
            }
            
            if (guideNextArrowBtn) {
                if (currentStep === steps.length - 1) {
                    guideNextArrowBtn.disabled = true;
                    guideNextArrowBtn.classList.add('opacity-30', 'cursor-not-allowed');
                    guideNextArrowBtn.classList.remove('hover:text-gray-600');
                } else {
                    guideNextArrowBtn.disabled = false;
                    guideNextArrowBtn.classList.remove('opacity-30', 'cursor-not-allowed');
                    guideNextArrowBtn.classList.add('hover:text-gray-600');
                }
            }
            
            // 移除之前的事件监听器
            const newNextBtn = guideNextBtn.cloneNode(true);
            const newSkipBtn = guideSkipBtn.cloneNode(true);
            const newPrevBtn = guidePrevBtn.cloneNode(true);
            const newNextArrowBtn = guideNextArrowBtn.cloneNode(true);
            
            guideNextBtn.parentNode.replaceChild(newNextBtn, guideNextBtn);
            guideSkipBtn.parentNode.replaceChild(newSkipBtn, guideSkipBtn);
            guidePrevBtn.parentNode.replaceChild(newPrevBtn, guidePrevBtn);
            guideNextArrowBtn.parentNode.replaceChild(newNextArrowBtn, guideNextArrowBtn);
            
            // 添加新的事件监听器
            newNextBtn.addEventListener('click', () => {
                if (currentStep === steps.length - 1) {
                    hideGuide();
                } else {
                    showGuideSteps(steps, currentStep + 1);
                }
            });
            
            newSkipBtn.addEventListener('click', () => {
                hideGuide();
            });
            
            // 左箭头按钮事件
            newPrevBtn.addEventListener('click', () => {
                if (currentStep > 0) {
                    showGuideSteps(steps, currentStep - 1);
                }
            });
            
            // 右箭头按钮事件
            newNextArrowBtn.addEventListener('click', () => {
                if (currentStep < steps.length - 1) {
                    showGuideSteps(steps, currentStep + 1);
                }
            });
        }
        
        function hideGuide() {
            const guideOverlay = document.getElementById('guide-overlay');
            guideOverlay.classList.add('hidden');
        }
        
        // 停靠点设置引导（兼容性保持）
        function showParkingSpotGuide() {
            showLocationGuide('parking');
        }
        
        // 页面切换函数
        function showPage(pageId) {
            console.log('📄 切换到页面:', pageId);
            
            // 隐藏所有页面
            const pages = [
                'login', 'add-device', 'wifi-setup', 'device-success', 'control', 
                'device-status', 'profile', 'voice', 'voice-chat', 'navigation', 'map-management', 'create-map-check',
                'map-naming', 'environment-check', 'mapping-precautions', 'set-charging-home',
                'real-time-mapping', 'set-charging-station', 
                'set-waypoints', 'set-parking-spots', 'set-safety-zones', 'set-restricted-zones', 
                'mapping-complete', 'app-update', 'firmware-update',
                'outdoor-navigation-destination', 'outdoor-navigation-confirm', 'outdoor-navigation-route', 'outdoor-navigation-arrived'
            ];
            
            pages.forEach(page => {
                const element = document.getElementById(page);
                if (element) {
                    element.classList.add('hidden');
                }
            });
            
            // 底部导航栏显示/隐藏逻辑
            const bottomNav = document.getElementById('bottom-nav');
            if (bottomNav) {
                // 这些页面是二级页面，需要隐藏底部导航栏
                const hideNavPages = [
                    'voice-chat', 
                    'outdoor-navigation-destination', 
                    'outdoor-navigation-confirm', 
                    'outdoor-navigation-route', 
                    'outdoor-navigation-arrived'
                ];
                
                if (hideNavPages.includes(pageId)) {
                    bottomNav.style.display = 'none';
                } else {
                    bottomNav.style.display = 'block';
                }
            }
            
            // 悬浮播放器显示/隐藏逻辑
            const floatingPlayer = document.getElementById('floating-audio-player');
            if (floatingPlayer) {
                // 在导航页面隐藏悬浮播放器
                const hidePlayerPages = [
                    'outdoor-navigation-destination', 
                    'outdoor-navigation-confirm', 
                    'outdoor-navigation-route', 
                    'outdoor-navigation-arrived'
                ];
                
                if (hidePlayerPages.includes(pageId)) {
                    floatingPlayer.style.display = 'none';
                } else {
                    floatingPlayer.style.display = 'block';
                }
            }
            
            // 显示目标页面
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.remove('hidden');
                console.log('✅ 成功显示页面:', pageId);
            } else {
                console.error('❌ 页面不存在:', pageId);
            }
        }
        
        // 开始连接检查
        function startConnectionCheck() {
            const bluetoothStatus = document.getElementById('bluetooth-status');
            const wifiStatus = document.getElementById('wifi-status');
            const sensorStatus = document.getElementById('sensor-status');
            const connectionNextBtn = document.getElementById('connection-next-btn');
            
            // 模拟检查过程
            setTimeout(() => {
                // WiFi连接完成
                if (wifiStatus) {
                    wifiStatus.innerHTML = '<i class="fas fa-check text-white text-sm"></i>';
                    wifiStatus.classList.remove('bg-yellow-500');
                    wifiStatus.classList.add('bg-green-500');
                }
                
                setTimeout(() => {
                    // 传感器检查完成
                    if (sensorStatus) {
                        sensorStatus.innerHTML = '<i class="fas fa-check text-white text-sm"></i>';
                        sensorStatus.classList.remove('bg-gray-300');
                        sensorStatus.classList.add('bg-green-500');
                    }
                    
                    // 启用下一步按钮
                    if (connectionNextBtn) {
                        connectionNextBtn.disabled = false;
                        connectionNextBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                        connectionNextBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                        connectionNextBtn.textContent = '检查完成，下一步';
                        
                        connectionNextBtn.addEventListener('click', function() {
                            showPage('map-naming');
                        });
                    }
                }, 1500);
            }, 2000);
        }
        
        // 建图须知 -> 设置回充点
        function startRealTimeMapping() {
            showPage('set-charging-home');
            initChargingHomePage();
        }
        
        // 初始化设置回充点页面
        function initChargingHomePage() {
            const backBtn = document.getElementById('charging-home-back-btn');
            const detectBtn = document.getElementById('detect-charging-position-btn');
            const positionStatus = document.getElementById('position-status');
            const positionProgress = document.getElementById('position-progress');
            const detectionResult = document.getElementById('detection-result');
            
            if (backBtn) {
                backBtn.addEventListener('click', () => showPage('mapping-precautions'));
            }
            
            if (detectBtn) {
                detectBtn.addEventListener('click', function() {
                    detectChargingPosition();
                });
            }
            
            async function detectChargingPosition() {
                detectBtn.disabled = true;
                detectBtn.textContent = '设置中...';
                positionStatus.textContent = '正在设置充电桩...';
                
                // 模拟设置过程
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 20;
                    positionProgress.style.width = progress + '%';
                    
                    if (progress >= 100) {
                        clearInterval(interval);
                        
                        // 设置成功，显示弹窗
                        setTimeout(async () => {
                            await appAlert('充电桩设置成功！即将开始建图。', '设置成功');
                            
                            // 跳转到实时建图页面
                            showPage('real-time-mapping');
                            initRealTimeMappingPage();
                            // 启动建图引导
                            setTimeout(() => {
                                startMappingGuide();
                            }, 500);
                        }, 500);
                    }
                }, 200);
            }
        }
        

        
        // 初始化实时建图页面
        function initRealTimeMappingPage() {
            const progressBar = document.getElementById('mapping-progress-bar');
            const progressText = document.getElementById('mapping-progress-text');
            const elapsedTime = document.getElementById('elapsed-time');
            const remainingTime = document.getElementById('remaining-time');
            const scannedArea = document.getElementById('scanned-area');
            const detectedRooms = document.getElementById('detected-rooms');
            const obstaclesCount = document.getElementById('obstacles-count');
            const canvas = document.getElementById('mapping-canvas');
            const radarLine = document.getElementById('radar-line');
            const wheelchairPosition = document.getElementById('wheelchair-position');
            
            let progress = 15;
            let elapsed = 155; // 秒
            let radarAngle = 0;
            let wheelchairX = 30; // 轮椅位置百分比（从回充点开始）
            let wheelchairY = 30;
            let wheelchairAngle = 0;
            let pathPoints = []; // 轮椅路径点（永久保留用于导航）
            let isWaypointMode = false;
            let currentWaypointType = 'waypoint';
            let parkingSpots = []; // 停靠点列表
            let totalPathLength = 0; // 累计导航路径长度
            let buildingStartTime = Date.now(); // 建图开始时间
            let chargingHomePosition = { x: 30, y: 30 }; // 回充点位置
            let mappingDuration = 3 * 60 * 1000; // 3分钟建图时间
            let finishClickCount = 0; // 建图完成按钮点击次数
            let isReturningHome = false; // 是否正在返回回充点
            let previousWheelchairX = 30; // 记录上一次轮椅X位置，用于计算移动方向
            let previousWheelchairY = 30; // 记录上一次轮椅Y位置，用于计算移动方向
            
            // 将充电桩位置添加为路径起点
            pathPoints.push({x: chargingHomePosition.x, y: chargingHomePosition.y});
            
            // 初始化canvas
            if (canvas) {
                const ctx = canvas.getContext('2d');
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                
                // 开始绘制动画
                function drawMap() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // 绘制已扫描区域（激光雷达效果）
                    drawScannedAreas(ctx);
                    
                    // 绘制轮椅路径
                    drawWheelchairPath(ctx);
                    
                    // 绘制停靠点
                    drawParkingSpots(ctx);
                    
                    // 绘制回充点
                    drawChargingHome(ctx);
                    
                    requestAnimationFrame(drawMap);
                }
                drawMap();
                
                // 地图交互（预留）
                // canvas.addEventListener('click', function(e) {
                //     // 可用于地图交互功能
                // });
            }
            
            // 激光雷达旋转动画
            const radarInterval = setInterval(() => {
                radarAngle += 6; // 每次旋转6度
                if (radarAngle >= 360) radarAngle = 0;
                
                if (radarLine) {
                    radarLine.style.transform = `translate(-50%, -100%) rotate(${radarAngle}deg)`;
                }
            }, 50);
            
            // 轮椅移动模拟 - 扫地机器人风格
            let pathPhase = 0; // 路径阶段
            let pathStep = 0;  // 当前步骤
            let direction = 1; // 移动方向
            let currentRoom = 0; // 当前扫描房间
            
            // 定义房间扫描区域
            const rooms = [
                { minX: 15, maxX: 75, minY: 15, maxY: 75, name: "主房间" },
                { minX: 75, maxX: 95, minY: 25, maxY: 65, name: "次房间" }
            ];
            
            const wheelchairInterval = setInterval(() => {
                // 检查是否需要返回回充点
                const elapsedTime = Date.now() - buildingStartTime;
                
                if (elapsedTime > mappingDuration && !isReturningHome) {
                    isReturningHome = true;
                    // 显示返回提示
                    showSuccessMessage('建图时间已到，自动返回回充点');
                    // 更新状态提示
                    updateMappingStatus('返回回充点中...');
                }
                
                if (isReturningHome) {
                    // 返回回充点的逻辑
                    const dx = chargingHomePosition.x - wheelchairX;
                    const dy = chargingHomePosition.y - wheelchairY;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance > 2) {
                        // 计算朝向回充点的角度
                        wheelchairAngle = (Math.atan2(dy, dx) * 180 / Math.PI) % 360;
                        
                        // 向回充点移动
                        const moveSpeed = 0.8;
                        wheelchairX += (dx / distance) * moveSpeed;
                        wheelchairY += (dy / distance) * moveSpeed;
                    } else {
                        // 已到达回充点
                        wheelchairX = chargingHomePosition.x;
                        wheelchairY = chargingHomePosition.y;
                        wheelchairAngle = 180; // 面向充电桩
                        updateMappingStatus('已到达回充点', 'fas fa-home');
                    }
                } else {
                    // 正常建图移动逻辑（扫地机器人风格的弓字形扫描路径）
                    const room = rooms[currentRoom] || rooms[0];
                    const roomWidth = room.maxX - room.minX;
                    const roomHeight = room.maxY - room.minY;
                    
                    if (pathPhase === 0) {
                        // 水平扫描阶段
                        const rowHeight = 8; // 每行间距
                        const currentRow = Math.floor(pathStep / 50);
                        const stepInRow = pathStep % 50;
                        
                        wheelchairY = room.minY + (currentRow * rowHeight);
                        
                        if (currentRow % 2 === 0) {
                            // 偶数行：从左到右
                            wheelchairX = room.minX + (stepInRow / 50) * roomWidth;
                            wheelchairAngle = 90; // 向右
                        } else {
                            // 奇数行：从右到左
                            wheelchairX = room.maxX - (stepInRow / 50) * roomWidth;
                            wheelchairAngle = 270; // 向左
                        }
                        
                        // 检查是否完成当前房间扫描
                        if (wheelchairY > room.maxY - 5) {
                            pathPhase = 1; // 切换到边缘扫描
                            pathStep = 0;
                        }
                        
                    } else if (pathPhase === 1) {
                        // 边缘扫描阶段
                        const perimeter = (roomWidth + roomHeight) * 2;
                        const stepProgress = (pathStep % 200) / 200;
                        
                        if (stepProgress < 0.25) {
                            // 上边
                            wheelchairX = room.minX + (stepProgress * 4) * roomWidth;
                            wheelchairY = room.minY;
                            wheelchairAngle = 90;
                        } else if (stepProgress < 0.5) {
                            // 右边
                            wheelchairX = room.maxX;
                            wheelchairY = room.minY + ((stepProgress - 0.25) * 4) * roomHeight;
                            wheelchairAngle = 180;
                        } else if (stepProgress < 0.75) {
                            // 下边
                            wheelchairX = room.maxX - ((stepProgress - 0.5) * 4) * roomWidth;
                            wheelchairY = room.maxY;
                            wheelchairAngle = 270;
                        } else {
                            // 左边
                            wheelchairX = room.minX;
                            wheelchairY = room.maxY - ((stepProgress - 0.75) * 4) * roomHeight;
                            wheelchairAngle = 0;
                        }
                        
                        // 完成边缘扫描后切换到下个房间或螺旋扫描
                        if (pathStep > 200) {
                            if (currentRoom < rooms.length - 1) {
                                currentRoom++;
                                pathPhase = 0;
                                pathStep = 0;
                            } else {
                                pathPhase = 2; // 螺旋扫描
                                pathStep = 0;
                            }
                        }
                        
                    } else if (pathPhase === 2) {
                        // 螺旋扫描阶段（精细扫描）
                        const centerX = (room.minX + room.maxX) / 2;
                        const centerY = (room.minY + room.maxY) / 2;
                        const maxRadius = Math.min(roomWidth, roomHeight) / 3;
                        const spiralProgress = (pathStep % 300) / 300;
                        const radius = spiralProgress * maxRadius;
                        const angle = spiralProgress * Math.PI * 8; // 4圈螺旋
                        
                        wheelchairX = centerX + Math.cos(angle) * radius;
                        wheelchairY = centerY + Math.sin(angle) * radius;
                        wheelchairAngle = (angle * 180 / Math.PI) % 360;
                        
                        // 螺旋完成后重新开始
                        if (pathStep > 300) {
                            pathPhase = 0;
                            pathStep = 0;
                            currentRoom = 0;
                        }
                    }
                    
                    pathStep++;
                }
                
                // 添加一些随机性，模拟真实的路径调整
                wheelchairX += (Math.random() - 0.5) * 0.5;
                wheelchairY += (Math.random() - 0.5) * 0.5;
                
                // 确保轮椅不会超出边界
                wheelchairX = Math.max(10, Math.min(90, wheelchairX));
                wheelchairY = Math.max(10, Math.min(85, wheelchairY));
                
                // 记录建图路径点（永久保留，用于导航）
                pathPoints.push({x: wheelchairX, y: wheelchairY});
                // 不删除路径点，保留完整的建图路径供后续导航使用
                
                // 计算导航路径总长度
                if (pathPoints.length > 1) {
                    const lastPoint = pathPoints[pathPoints.length - 2];
                    const currentPoint = pathPoints[pathPoints.length - 1];
                    const distance = Math.sqrt(
                        Math.pow(currentPoint.x - lastPoint.x, 2) + 
                        Math.pow(currentPoint.y - lastPoint.y, 2)
                    );
                    totalPathLength += distance * 0.1; // 转换为实际距离（假设比例）
                    

                }
                
                if (wheelchairPosition) {
                    wheelchairPosition.style.left = wheelchairX + '%';
                    wheelchairPosition.style.top = wheelchairY + '%';
                    wheelchairPosition.style.transform = `translate(-50%, -50%) rotate(${wheelchairAngle}deg)`;
                }
            }, 150); // 稍微慢一点，看清楚路径
            
            // 建图进度更新
            const mappingInterval = setInterval(() => {
                progress += Math.random() * 2;
                elapsed += 5;
                
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(mappingInterval);
                    clearInterval(radarInterval);
                    clearInterval(wheelchairInterval);
                }
                
                // 更新进度条
                if (progressBar) progressBar.style.width = progress + '%';
                if (progressText) progressText.textContent = Math.round(progress) + '%';
                
                // 更新时间
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                if (elapsedTime) elapsedTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                const remaining = Math.max(0, 1200 - elapsed);
                const remainingMinutes = Math.floor(remaining / 60);
                const remainingSeconds = remaining % 60;
                if (remainingTime) remainingTime.textContent = `${remainingMinutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
                
                // 更新扫描数据
                if (scannedArea) scannedArea.textContent = Math.round(progress * 1.25) + '㎡';
                if (detectedRooms) detectedRooms.textContent = Math.min(5, Math.round(progress / 20));
                if (obstaclesCount) obstaclesCount.textContent = Math.round(progress / 12);
                

                
            }, 2500);
            
            // 绘制已扫描区域
            function drawScannedAreas(ctx) {
                // 绘制房间轮廓
                ctx.strokeStyle = '#9CA3AF';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.rect(50, 30, 200, 120);
                ctx.rect(270, 50, 80, 100);
                ctx.stroke();
                
                // 绘制已扫描的区域（渐变填充）
                const scanProgress = progress / 100;
                const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                gradient.addColorStop(0, `rgba(34, 197, 94, ${0.3 * scanProgress})`);
                gradient.addColorStop(1, `rgba(34, 197, 94, ${0.1 * scanProgress})`);
                
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.rect(50, 30, 200 * scanProgress, 120);
                if (scanProgress > 0.6) {
                    ctx.rect(270, 50, 80 * (scanProgress - 0.6) * 2.5, 100);
                }
                ctx.fill();
                
                // 绘制障碍物
                ctx.fillStyle = '#EF4444';
                ctx.fillRect(120, 80, 15, 15);
                ctx.fillRect(180, 60, 10, 30);
                ctx.fillRect(280, 120, 20, 10);
            }
            
            // 绘制轮椅路径
            function drawWheelchairPath(ctx) {
                if (pathPoints.length < 2) return;
                
                ctx.strokeStyle = '#FEF08A';
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                for (let i = 0; i < pathPoints.length; i++) {
                    const point = pathPoints[i];
                    const x = (point.x / 100) * canvas.width;
                    const y = (point.y / 100) * canvas.height;
                    
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();
                
                // 绘制路径点
                ctx.fillStyle = '#FEF08A';
                for (let i = 0; i < pathPoints.length; i += 5) {
                    const point = pathPoints[i];
                    const x = (point.x / 100) * canvas.width;
                    const y = (point.y / 100) * canvas.height;
                    ctx.beginPath();
                    ctx.arc(x, y, 1, 0, 2 * Math.PI);
                    ctx.fill();
                }
            }
            
            // 绘制停靠点
            function drawParkingSpots(ctx) {
                parkingSpots.forEach((spot, index) => {
                    const x = (spot.x / 100) * canvas.width;
                    const y = (spot.y / 100) * canvas.height;
                    
                    // 绘制停靠点
                    ctx.fillStyle = '#A855F7';
                    ctx.beginPath();
                    ctx.arc(x, y, 6, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    // 绘制停靠点编号
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText((index + 1).toString(), x, y + 3);
                    
                    // 绘制方向指示
                    if (spot.angle !== undefined) {
                        const angleRad = (spot.angle * Math.PI) / 180;
                        const lineLength = 12;
                        const endX = x + Math.cos(angleRad) * lineLength;
                        const endY = y + Math.sin(angleRad) * lineLength;
                        
                        ctx.strokeStyle = '#A855F7';
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.moveTo(x, y);
                        ctx.lineTo(endX, endY);
                        ctx.stroke();
                    }
                });
            }
            
            // 绘制回充点
            function drawChargingHome(ctx) {
                const x = (chargingHomePosition.x / 100) * canvas.width;
                const y = (chargingHomePosition.y / 100) * canvas.height;
                
                // 绘制回充点
                ctx.fillStyle = '#10B981';
                ctx.beginPath();
                ctx.arc(x, y, 8, 0, 2 * Math.PI);
                ctx.fill();
                
                // 绘制充电图标
                ctx.fillStyle = '#FFFFFF';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('⚡', x, y + 4);
            }
            
            // 添加停靠点
            async function addParkingSpot() {
                const spotName = await appPrompt('请输入停靠点名称：', '', '例如：沙发、床边、卫生间等', '添加停靠点');
                
                if (!spotName) return; // 用户取消了输入
                
                const isSafe = await appConfirm('请确认：停靠点附近环境安全，无尖锐物体或跌落风险？', '安全确认');
                
                if (!isSafe) {
                    await appAlert('请先确保停靠点附近环境安全后再设置', '安全提示');
                    return;
                }
                
                // 计算轮椅当前的移动方向
                let movementAngle = wheelchairAngle;
                if (pathPoints.length >= 2) {
                    const currentPoint = pathPoints[pathPoints.length - 1];
                    const previousPoint = pathPoints[pathPoints.length - 2];
                    const dx = currentPoint.x - previousPoint.x;
                    const dy = currentPoint.y - previousPoint.y;
                    
                    if (dx !== 0 || dy !== 0) {
                        // 根据移动方向计算角度
                        movementAngle = Math.atan2(dy, dx) * (180 / Math.PI);
                        // 确保角度在0-360度范围内
                        if (movementAngle < 0) movementAngle += 360;
                    }
                }
                
                const spot = {
                    id: Date.now(),
                    name: spotName,
                    x: wheelchairX,
                    y: wheelchairY,
                    angle: movementAngle, // 使用移动方向作为停靠点朝向
                    timestamp: new Date().toLocaleTimeString(),
                    isSafe: true
                };
                
                parkingSpots.push(spot);
                updateParkingSpotsList();
                
                // 显示成功提示
                showSuccessMessage(`停靠点"${spotName}"设置成功`);
            }
            
            // 更新停靠点列表
            function updateParkingSpotsList() {
                const spotsList = document.getElementById('parking-spots-list');
                const spotsCount = document.getElementById('parking-spots-count');
                const noSpotsTip = document.getElementById('no-parking-spots-tip');
                
                if (spotsCount) spotsCount.textContent = `${parkingSpots.length}个`;
                
                if (parkingSpots.length === 0) {
                    if (noSpotsTip) noSpotsTip.classList.remove('hidden');
                } else {
                    if (noSpotsTip) noSpotsTip.classList.add('hidden');
                    
                    if (spotsList) {
                        spotsList.innerHTML = parkingSpots.map((spot, index) => `
                            <div class="flex items-center justify-between p-3 bg-purple-50 rounded-lg border border-purple-200">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-purple-500 text-white rounded-full flex items-center justify-center text-sm font-semibold mr-3">
                                        ${index + 1}
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-purple-800">${spot.name}</p>
                                        <p class="text-xs text-purple-600">
                                            ${spot.timestamp} • 
                                            <span class="inline-flex items-center">
                                                <i class="fas fa-shield-check mr-1"></i>安全确认
                                            </span>
                                        </p>
                                    </div>
                                </div>
                                <button class="text-red-500 text-sm" onclick="removeParkingSpot(${spot.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `).join('');
                    }
                }
            }
            
            // 检查轮椅是否回到回充点
            function checkReturnToChargingHome() {
                const distance = Math.sqrt(
                    Math.pow(wheelchairX - chargingHomePosition.x, 2) + 
                    Math.pow(wheelchairY - chargingHomePosition.y, 2)
                );
                
                // 允许5%的误差范围
                return distance <= 5;
            }
            
            // 完成建图
            function finishMapping() {
                finishClickCount++;
                
                // 检查是否真的在回充点或已点击3次
                const isAtChargingHome = checkReturnToChargingHome();
                
                if (!isAtChargingHome && finishClickCount < 3) {
                    const remainingClicks = 3 - finishClickCount;
                    showSuccessMessage(`正在返回回充点... (${finishClickCount}/3)`);
                    
                    // 如果还没有开始返回，则开始返回
                    if (!isReturningHome) {
                        isReturningHome = true;
                        showSuccessMessage('开始返回回充点');
                        updateMappingStatus('返回回充点中...', 'fas fa-home');
                    }
                    
                    // 更新按钮文本
                    const finishBtn = document.getElementById('finish-mapping-btn');
                    if (finishBtn) {
                        finishBtn.innerHTML = `<i class="fas fa-home mr-2"></i>返回回充点 (${finishClickCount}/3)`;
                    }
                    
                    return;
                } else if (finishClickCount >= 3) {
                    // 点击3次后，模拟已回到回充点
                    wheelchairX = chargingHomePosition.x;
                    wheelchairY = chargingHomePosition.y;
                    wheelchairAngle = 180;
                    isReturningHome = true;
                    
                    showSuccessMessage('已模拟回到回充点，建图完成！');
                    updateMappingStatus('建图完成！', 'fas fa-check');
                } else if (isAtChargingHome) {
                    showSuccessMessage('已回到回充点，建图完成！');
                    updateMappingStatus('建图完成！', 'fas fa-check');
                }
                
                // 建图完成，跳转到安全区域设置
                setTimeout(() => {
                    showPage('set-safety-zones');
                    initSafetyZonesPage();
                }, 1500);
            }
            
            function showSuccessMessage(message) {
                const successDiv = document.createElement('div');
                successDiv.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                successDiv.textContent = message;
                document.body.appendChild(successDiv);
                
                setTimeout(() => {
                    document.body.removeChild(successDiv);
                }, 2000);
            }
            
            // 更新地图状态提示
            function updateMappingStatus(message, iconClass = 'fas fa-route') {
                const statusTip = document.getElementById('mapping-status-tip');
                if (statusTip) {
                    statusTip.innerHTML = `<i class="${iconClass} mr-1"></i>${message}`;
                    
                    // 根据状态设置不同颜色
                    statusTip.className = 'absolute top-2 left-2 text-white text-xs rounded-lg p-2';
                    if (message.includes('返回') || message.includes('回充')) {
                        statusTip.classList.add('bg-blue-500', 'bg-opacity-90');
                    } else if (message.includes('完成')) {
                        statusTip.classList.add('bg-green-600', 'bg-opacity-90');
                    } else {
                        statusTip.classList.add('bg-green-500', 'bg-opacity-90');
                    }
                }
            }
            
            // 地点管理系统
            let currentLocationType = 'waypoint'; // 当前选中的地点类型
            let allLocations = []; // 所有地点（包括定位点和停靠点）
            let isFirstLocationAdd = true;
            
            // 地点类型切换按钮
            const locationTypeWaypointBtn = document.getElementById('location-type-waypoint');
            const locationTypeParkingBtn = document.getElementById('location-type-parking');
            const addLocationBtn = document.getElementById('add-location-btn');
            
            if (locationTypeWaypointBtn) {
                locationTypeWaypointBtn.addEventListener('click', function() {
                    currentLocationType = 'waypoint';
                    updateLocationTypeButtons();
                });
            }
            
            if (locationTypeParkingBtn) {
                locationTypeParkingBtn.addEventListener('click', function() {
                    currentLocationType = 'parking';
                    updateLocationTypeButtons();
                });
            }
            
            // 添加地点按钮
            if (addLocationBtn) {
                addLocationBtn.addEventListener('click', function() {
                    // 第一次添加地点时显示引导
                    if (isFirstLocationAdd) {
                        showLocationGuide(currentLocationType);
                        isFirstLocationAdd = false;
                        
                        // 引导结束后再执行添加地点操作
                        const guideOverlay = document.getElementById('guide-overlay');
                        const originalHideGuide = window.hideGuide || hideGuide;
                        window.hideGuide = function() {
                            originalHideGuide();
                            setTimeout(() => {
                                addLocation();
                            }, 300);
                            window.hideGuide = originalHideGuide;
                        };
                    } else {
                        addLocation();
                    }
                });
            }
            
            // 更新地点类型按钮样式
            function updateLocationTypeButtons() {
                const waypointBtn = document.getElementById('location-type-waypoint');
                const parkingBtn = document.getElementById('location-type-parking');
                const addBtn = document.getElementById('add-location-btn');
                
                if (currentLocationType === 'waypoint') {
                    waypointBtn?.classList.add('bg-blue-100', 'text-blue-600', 'border-blue-200');
                    waypointBtn?.classList.remove('bg-gray-100', 'text-gray-600', 'border-gray-200');
                    parkingBtn?.classList.add('bg-gray-100', 'text-gray-600', 'border-gray-200');
                    parkingBtn?.classList.remove('bg-purple-100', 'text-purple-600', 'border-purple-200');
                    
                    if (addBtn) {
                        addBtn.innerHTML = '<i class="fas fa-plus mr-2"></i>添加定位点';
                        addBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                        addBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
                    }
                } else {
                    parkingBtn?.classList.add('bg-purple-100', 'text-purple-600', 'border-purple-200');
                    parkingBtn?.classList.remove('bg-gray-100', 'text-gray-600', 'border-gray-200');
                    waypointBtn?.classList.add('bg-gray-100', 'text-gray-600', 'border-gray-200');
                    waypointBtn?.classList.remove('bg-blue-100', 'text-blue-600', 'border-blue-200');
                    
                    if (addBtn) {
                        addBtn.innerHTML = '<i class="fas fa-plus mr-2"></i>添加停靠点';
                        addBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
                        addBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    }
                }
            }
            
            // 添加地点函数
            async function addLocation() {
                const isWaypoint = currentLocationType === 'waypoint';
                const promptText = isWaypoint ? 
                    '请输入定位点名称 (如：客厅入口、房门口等)：' : 
                    '请输入停靠点名称：';
                const placeholder = isWaypoint ? '例如：客厅入口、房门口等' : '例如：沙发、床边、卫生间等';
                const title = isWaypoint ? '添加定位点' : '添加停靠点';
                
                const name = await appPrompt(promptText, '', placeholder, title);
                
                if (!name) return; // 用户取消了输入
                
                // 如果是停靠点，需要进行安全确认
                if (!isWaypoint) {
                    const isSafe = await appConfirm('请确认：停靠点附近环境安全，无尖锐物体或跌落风险？', '安全确认');
                    
                    if (!isSafe) {
                        await appAlert('请先确保停靠点附近环境安全后再设置', '安全提示');
                        return;
                    }
                }
                
                const location = {
                    id: Date.now(),
                    name: name,
                    type: currentLocationType,
                    x: wheelchairX,
                    y: wheelchairY,
                    angle: wheelchairAngle,
                    position: `位置${allLocations.length + 1}`,
                    timestamp: new Date().toLocaleTimeString(),
                    isSafe: !isWaypoint ? true : undefined // 停靠点包含安全确认标识
                };
                
                allLocations.push(location);
                
                // 如果是停靠点，也添加到原来的停靠点列表中以保持兼容性
                if (currentLocationType === 'parking') {
                    parkingSpots.push(location);
                }
                
                updateLocationsList();
                
                // 显示成功提示
                const locationTypeText = isWaypoint ? '定位点' : '停靠点';
                showSuccessMessage(`${locationTypeText}"${name}"设置成功`);
            }
            
            // 更新地点列表
            function updateLocationsList() {
                const locationsList = document.getElementById('locations-list');
                const locationsCount = document.getElementById('locations-count');
                const noLocationsTip = document.getElementById('no-locations-tip');
                
                if (locationsCount) {
                    const waypointCount = allLocations.filter(loc => loc.type === 'waypoint').length;
                    const parkingCount = allLocations.filter(loc => loc.type === 'parking').length;
                    locationsCount.textContent = `${waypointCount}个定位点 • ${parkingCount}个停靠点`;
                }
                
                if (allLocations.length === 0) {
                    if (noLocationsTip) noLocationsTip.style.display = 'block';
                    if (locationsList) {
                        locationsList.innerHTML = '';
                        locationsList.appendChild(noLocationsTip);
                    }
                } else {
                    if (noLocationsTip) noLocationsTip.style.display = 'none';
                    if (locationsList) {
                        locationsList.innerHTML = allLocations.map((location, index) => {
                            const isWaypoint = location.type === 'waypoint';
                            const bgColor = isWaypoint ? 'bg-blue-50' : 'bg-purple-50';
                            const borderColor = isWaypoint ? 'border-blue-200' : 'border-purple-200';
                            const circleColor = isWaypoint ? 'bg-blue-500' : 'bg-purple-500';
                            const textColor = isWaypoint ? 'text-blue-800' : 'text-purple-800';
                            const subtextColor = isWaypoint ? 'text-blue-600' : 'text-purple-600';
                            const icon = isWaypoint ? 'fas fa-map-marker-alt' : 'fas fa-parking';
                            
                            return `
                                <div class="flex items-center justify-between p-3 ${bgColor} rounded-lg border ${borderColor}">
                                    <div class="flex items-center">
                                        <div class="w-8 h-8 ${circleColor} text-white rounded-full flex items-center justify-center text-sm font-semibold mr-3">
                                            ${index + 1}
                                        </div>
                                        <div>
                                            <p class="text-sm font-medium ${textColor}">${location.name}</p>
                                            <p class="text-xs ${subtextColor}">
                                                ${location.position} • ${location.timestamp}
                                                ${isWaypoint ? ' • 定位点' : ' • 停靠点'}
                                                ${!isWaypoint ? ' • <span class="inline-flex items-center"><i class="fas fa-shield-check mr-1"></i>安全确认</span>' : ''}
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <i class="${icon} ${isWaypoint ? 'text-blue-500' : 'text-purple-500'}"></i>
                                        <button class="text-red-500 text-sm" onclick="removeLocation(${location.id})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }
            }
            
            // 全局删除地点函数
            window.removeLocation = function(id) {
                allLocations = allLocations.filter(location => location.id !== id);
                // 同时从停靠点列表中删除（保持兼容性）
                parkingSpots = parkingSpots.filter(spot => spot.id !== id);
                updateLocationsList();
            };
            
            // 保持原有的停靠点函数兼容性
            window.addParkingSpot = function() {
                currentLocationType = 'parking';
                updateLocationTypeButtons();
                addLocation();
            };
            
            // 保持原有的删除停靠点函数兼容性
            window.removeParkingSpot = function(id) {
                removeLocation(id);
            };
            
            // 初始化地点管理
            updateLocationTypeButtons();
            
            // 建图完成按钮事件
            const finishMappingBtn = document.getElementById('finish-mapping-btn');
            if (finishMappingBtn) {
                finishMappingBtn.addEventListener('click', function() {
                    finishMapping();
                });
            }
            

            
            // 全局删除停靠点函数
            window.removeParkingSpot = function(id) {
                parkingSpots = parkingSpots.filter(spot => spot.id !== id);
                updateParkingSpotsList();
            };
        }
        
        // 停止建图
        function stopMapping() {
            // 这里可以添加停止建图的逻辑
            console.log('建图已停止');
        }
        
        // 初始化充电桩设置页面
        function initChargingStationPage() {
            const backBtn = document.getElementById('charging-station-back-btn');
            const nextBtn = document.getElementById('charging-station-next-btn');
            const canvas = document.getElementById('charging-map-canvas');
            const marker = document.getElementById('charging-station-marker');
            const preview = document.getElementById('charging-station-preview');
            const positionInfo = document.getElementById('charging-position-info');
            const scheduleCheckbox = document.getElementById('auto-charge-schedule');
            const scheduleTime = document.getElementById('schedule-time');
            
            if (backBtn) {
                backBtn.addEventListener('click', () => showPage('real-time-mapping'));
            }
            
            if (nextBtn) {
                nextBtn.addEventListener('click', () => showPage('set-waypoints'));
            }
            
            // 定时充电设置
            if (scheduleCheckbox && scheduleTime) {
                scheduleCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        scheduleTime.classList.remove('hidden');
                    } else {
                        scheduleTime.classList.add('hidden');
                    }
                });
            }
            
            // 模拟地图点击
            if (canvas) {
                canvas.addEventListener('click', function(e) {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    // 显示充电桩标记
                    if (marker) {
                        marker.style.left = x + 'px';
                        marker.style.top = y + 'px';
                        marker.classList.remove('hidden');
                    }
                    
                    // 显示预览信息
                    if (preview && positionInfo) {
                        preview.classList.remove('hidden');
                        positionInfo.textContent = `位置: (${Math.round(x)}, ${Math.round(y)})`;
                    }
                    
                    // 启用下一步按钮
                    if (nextBtn) {
                        nextBtn.disabled = false;
                        nextBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                        nextBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                        nextBtn.textContent = '设置定位点';
                    }
                });
            }
        }
        
        // 初始化定位点设置页面
        function initWaypointsPage() {
            const backBtn = document.getElementById('waypoints-back-btn');
            const nextBtn = document.getElementById('waypoints-next-btn');
            const canvas = document.getElementById('waypoints-map-canvas');
            const waypointsList = document.getElementById('waypoints-list');
            const waypointsCount = document.getElementById('waypoints-count');
            const quickBtns = document.querySelectorAll('.quick-waypoint-btn');
            
            let waypoints = [];
            
            if (backBtn) {
                backBtn.addEventListener('click', () => showPage('set-charging-station'));
            }
            
            if (nextBtn) {
                nextBtn.addEventListener('click', () => showPage('set-parking-spots'));
            }
            
            // 快速添加按钮
            quickBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const name = this.dataset.name;
                    addWaypoint(name, Math.random() * 200 + 25, Math.random() * 150 + 25);
                });
            });
            
            // 地图点击添加定位点
            if (canvas) {
                canvas.addEventListener('click', async function(e) {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    const name = await appPrompt('请输入定位点名称:', '', '例如：客厅入口、房门口等', '添加定位点');
                    if (name) {
                        addWaypoint(name, x, y);
                    }
                });
            }
            
            async function addWaypoint(name, x, y) {
                if (waypoints.length >= 8) {
                    await appAlert('最多只能设置8个定位点');
                    return;
                }
                
                waypoints.push({name, x, y});
                updateWaypointsList();
            }
            
            function updateWaypointsList() {
                if (waypointsList && waypointsCount) {
                    waypointsCount.textContent = `${waypoints.length}/8`;
                    
                    waypointsList.innerHTML = waypoints.map((wp, index) => `
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                            <div class="flex items-center">
                                <div class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs mr-2">
                                    ${index + 1}
                                </div>
                                <span class="text-sm">${wp.name}</span>
                            </div>
                            <button class="text-red-500 text-sm" onclick="removeWaypoint(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `).join('');
                }
            }
            
            // 全局删除函数
            window.removeWaypoint = function(index) {
                waypoints.splice(index, 1);
                updateWaypointsList();
            };
        }
        
        // 初始化停靠点设置页面
        function initParkingSpotsPage() {
            const backBtn = document.getElementById('parking-spots-back-btn');
            const nextBtn = document.getElementById('parking-spots-next-btn');
            
            if (backBtn) {
                backBtn.addEventListener('click', () => showPage('set-waypoints'));
            }
            
            if (nextBtn) {
                nextBtn.addEventListener('click', () => showPage('set-safety-zones'));
            }
            
            // 停靠点类型按钮
            const parkingTypeBtns = document.querySelectorAll('.parking-type-btn');
            parkingTypeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    parkingTypeBtns.forEach(b => b.classList.remove('border-purple-500', 'bg-purple-50'));
                    this.classList.add('border-purple-500', 'bg-purple-50');
                });
            });
        }
        
        // 初始化安全区域设置页面
        function initSafetyZonesPage() {
            const backBtn = document.getElementById('safety-zones-back-btn');
            const nextBtn = document.getElementById('safety-zones-next-btn');
            
            if (backBtn) {
                backBtn.addEventListener('click', () => showPage('set-parking-spots'));
            }
            
            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    showPage('mapping-complete');
                    completeMappingProcess();
                });
            }
            
            // 绘制工具
            const drawRectBtn = document.getElementById('draw-rectangle');
            const drawCircleBtn = document.getElementById('draw-circle');
            const clearZonesBtn = document.getElementById('clear-zones');
            
            if (drawRectBtn) {
                drawRectBtn.addEventListener('click', function() {
                    this.classList.add('bg-green-500');
                    drawCircleBtn?.classList.remove('bg-green-500');
                    drawCircleBtn?.classList.add('bg-gray-500');
                });
            }
            
            if (drawCircleBtn) {
                drawCircleBtn.addEventListener('click', function() {
                    this.classList.add('bg-green-500');
                    drawRectBtn?.classList.remove('bg-green-500');
                    drawRectBtn?.classList.add('bg-gray-500');
                });
            }
            
            if (clearZonesBtn) {
                clearZonesBtn.addEventListener('click', async function() {
                    const confirmed = await appConfirm('确定要清除所有安全区域吗？');
                    if (confirmed) {
                        // 清除安全区域逻辑
                        const zonesList = document.getElementById('safety-zones-list');
                        const zonesCount = document.getElementById('safety-zones-count');
                        if (zonesList) zonesList.innerHTML = '';
                        if (zonesCount) zonesCount.textContent = '0个';
                    }
                });
            }
        }
        
        // 初始化禁行区设置页面
        function initRestrictedZonesPage() {
            const backBtn = document.getElementById('restricted-zones-back-btn');
            const nextBtn = document.getElementById('restricted-zones-next-btn');
            
            if (backBtn) {
                backBtn.addEventListener('click', () => showPage('set-safety-zones'));
            }
            
            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    showPage('mapping-complete');
                    completeMappingProcess();
                });
            }
            
            // 快速添加禁行区按钮
            const restrictedZoneBtns = document.querySelectorAll('.restricted-zone-btn');
            restrictedZoneBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const type = this.dataset.type;
                    addRestrictedZone(type);
                });
            });
            
            function addRestrictedZone(type) {
                const zonesList = document.getElementById('restricted-zones-list');
                const zonesCount = document.getElementById('restricted-zones-count');
                
                if (zonesList) {
                    const zoneElement = document.createElement('div');
                    zoneElement.className = 'flex items-center justify-between p-2 bg-red-50 rounded-lg border border-red-200';
                    zoneElement.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas fa-ban text-red-600 mr-2"></i>
                            <span class="text-sm">${getZoneTypeName(type)}</span>
                        </div>
                        <button class="text-red-500 text-sm" onclick="this.parentElement.remove(); updateRestrictedZonesCount();">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    zonesList.appendChild(zoneElement);
                    updateRestrictedZonesCount();
                }
            }
            
            function getZoneTypeName(type) {
                const names = {
                    'stairs': '楼梯区域',
                    'kitchen': '厨房操作台',
                    'balcony': '阳台边缘',
                    'bathroom': '浴室淋浴区'
                };
                return names[type] || type;
            }
            
            window.updateRestrictedZonesCount = function() {
                const zonesList = document.getElementById('restricted-zones-list');
                const zonesCount = document.getElementById('restricted-zones-count');
                if (zonesList && zonesCount) {
                    const count = zonesList.children.length;
                    zonesCount.textContent = count + '个';
                }
            };
        }
        
        // 初始化建图完成页面
        function initMappingCompletePage() {
            const startNavigationBtn = document.getElementById('start-navigation-btn');
            const viewMapDetailsBtn = document.getElementById('view-map-details-btn');
            const backToManagementBtn = document.getElementById('back-to-management-btn');
            
            if (startNavigationBtn) {
                startNavigationBtn.addEventListener('click', () => {
                    showPage('control');
                    // 激活导航栏"控制"选项
                    updateNavigation('control');
                });
            }
            
            if (viewMapDetailsBtn) {
                viewMapDetailsBtn.addEventListener('click', async () => {
                    await appAlert('地图详情功能开发中...', '功能提示');
                });
            }
            
            if (backToManagementBtn) {
                backToManagementBtn.addEventListener('click', () => {
                    showPage('map-management');
                });
            }
        }
        
        // 完成建图过程
        function completeMappingProcess() {
            // 模拟云端同步过程
            setTimeout(() => {
                const syncStatus = document.querySelector('#mapping-complete .bg-blue-50');
                if (syncStatus) {
                    syncStatus.innerHTML = `
                        <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-check text-white text-sm"></i>
                        </div>
                        <div class="text-left">
                            <p class="font-medium text-green-800">同步完成</p>
                            <p class="text-sm text-green-600">地图数据已成功同步到云端</p>
                        </div>
                    `;
                    syncStatus.classList.remove('bg-blue-50');
                    syncStatus.classList.add('bg-green-50');
                }
            }, 3000);
        }
        
        // 初始化APP版本更新功能
        function initAppUpdate() {
            const appUpdateBtn = document.getElementById('app-update-btn');
            const appBackBtn = document.getElementById('app-update-back-btn');
            const appActionBtn = document.getElementById('app-update-action-btn');
            
            if (appUpdateBtn) {
                appUpdateBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage('app-update');
                    checkAppUpdate();
                });
            }
            
            if (appBackBtn) {
                appBackBtn.addEventListener('click', () => {
                    showPage('profile');
                });
            }
            
            async function checkAppUpdate() {
                const currentVersion = document.getElementById('current-app-version');
                const latestVersion = document.getElementById('latest-app-version');
                const updateStatus = document.getElementById('app-update-status');
                const updateContent = document.getElementById('app-update-content');
                const updateFeatures = document.getElementById('app-update-features');
                
                // 模拟检查更新过程
                setTimeout(() => {
                    latestVersion.textContent = 'v2.1.3';
                    updateStatus.innerHTML = '<p class="text-sm text-green-600"><i class="fas fa-check mr-2"></i>当前已是最新版本</p>';
                    
                    appActionBtn.textContent = '已是最新版本';
                    appActionBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    appActionBtn.classList.add('bg-green-600');
                    appActionBtn.disabled = false;
                    
                    // 模拟有新版本的情况（30%概率）
                    if (Math.random() < 0.3) {
                        latestVersion.textContent = 'v2.2.0';
                        latestVersion.classList.remove('text-green-600');
                        latestVersion.classList.add('text-orange-600');
                        
                        updateStatus.innerHTML = '<p class="text-sm text-orange-600"><i class="fas fa-download mr-2"></i>发现新版本可供更新</p>';
                        
                        updateContent.classList.remove('hidden');
                        updateFeatures.innerHTML = `
                            <li>• 新增智能语音助手，支持更多指令</li>
                            <li>• 优化建图算法，提升精度20%</li>
                            <li>• 增强电池管理，延长续航时间</li>
                            <li>• 修复若干已知问题，提升稳定性</li>
                        `;
                        
                        appActionBtn.textContent = '立即更新';
                        appActionBtn.classList.remove('bg-green-600');
                        appActionBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                        
                        appActionBtn.onclick = async function() {
                            const confirmed = await appConfirm('确定要更新到最新版本吗？更新过程约需1-2分钟。', '确认更新');
                            if (confirmed) {
                                startAppUpdate();
                            }
                        };
                        
                        // 更新个人资料页面的状态
                        const appVersionStatus = document.getElementById('app-version-status');
                        if (appVersionStatus) {
                            appVersionStatus.textContent = '有新版本';
                            appVersionStatus.classList.remove('text-green-500');
                            appVersionStatus.classList.add('text-orange-500');
                        }
                    }
                }, 1500);
            }
            
            async function startAppUpdate() {
                appActionBtn.disabled = true;
                appActionBtn.textContent = '正在更新...';
                
                // 模拟更新过程
                const updateStatus = document.getElementById('app-update-status');
                updateStatus.innerHTML = '<p class="text-sm text-blue-600"><i class="fas fa-download mr-2"></i>正在下载更新包...</p>';
                
                setTimeout(() => {
                    updateStatus.innerHTML = '<p class="text-sm text-blue-600"><i class="fas fa-cog fa-spin mr-2"></i>正在安装更新...</p>';
                    
                    setTimeout(async () => {
                        updateStatus.innerHTML = '<p class="text-sm text-green-600"><i class="fas fa-check mr-2"></i>更新完成！</p>';
                        await appAlert('APP更新完成！新功能已可使用。', '更新成功');
                        
                        // 更新版本显示
                        document.getElementById('current-app-version').textContent = 'v2.2.0';
                        document.getElementById('latest-app-version').textContent = 'v2.2.0';
                        document.getElementById('latest-app-version').classList.remove('text-orange-600');
                        document.getElementById('latest-app-version').classList.add('text-green-600');
                        
                        appActionBtn.textContent = '已是最新版本';
                        appActionBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                        appActionBtn.classList.add('bg-green-600');
                        
                        // 更新个人资料页面的状态
                        const appVersionStatus = document.getElementById('app-version-status');
                        if (appVersionStatus) {
                            appVersionStatus.textContent = 'v2.2.0';
                            appVersionStatus.classList.remove('text-orange-500');
                            appVersionStatus.classList.add('text-green-500');
                        }
                    }, 2000);
                }, 1500);
            }
        }
        
        // 初始化轮椅固件更新功能
        function initFirmwareUpdate() {
            const firmwareUpdateBtn = document.getElementById('firmware-update-btn');
            const firmwareBackBtn = document.getElementById('firmware-update-back-btn');
            const refreshDevicesBtn = document.getElementById('refresh-devices-btn');

            
            // 模拟轮椅设备数据
            let wheelchairDevices = [
                {
                    id: 'wheelchair-001',
                    name: '主轮椅',
                    model: 'CMG-Pro-2024',
                    currentVersion: 'v1.8.2',
                    latestVersion: 'v1.9.5',
                    batteryLevel: 85,
                    isConnected: true,
                    hasUpdate: true,
                    isUpdating: false,
                    lastConnected: '刚刚'
                },
                {
                    id: 'wheelchair-002',
                    name: '备用轮椅',
                    model: 'CMG-Lite-2024',
                    currentVersion: 'v1.9.5',
                    latestVersion: 'v1.9.5',
                    batteryLevel: 67,
                    isConnected: true,
                    hasUpdate: false,
                    isUpdating: false,
                    lastConnected: '2分钟前'
                },
                {
                    id: 'wheelchair-003',
                    name: '户外轮椅',
                    model: 'CMG-Sport-2024',
                    currentVersion: 'v1.7.8',
                    latestVersion: 'v1.9.5',
                    batteryLevel: 45,
                    isConnected: true,
                    hasUpdate: true,
                    isUpdating: false,
                    lastConnected: '5分钟前'
                }
            ];
            
            if (firmwareUpdateBtn) {
                firmwareUpdateBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage('firmware-update');
                    loadDevicesList();
                    updateDevicesSummary();
                });
            }
            
            if (firmwareBackBtn) {
                firmwareBackBtn.addEventListener('click', () => {
                    showPage('profile');
                });
            }
            
            if (refreshDevicesBtn) {
                refreshDevicesBtn.addEventListener('click', () => {
                    refreshDevicesList();
                });
            }
            

            
            // 加载设备列表
            function loadDevicesList() {
                const devicesList = document.getElementById('wheelchair-devices-list');
                if (!devicesList) return;
                
                devicesList.innerHTML = wheelchairDevices.map(device => createDeviceCard(device)).join('');
                
                // 为每个设备添加事件监听器
                wheelchairDevices.forEach(device => {
                    const updateBtn = document.getElementById(`update-${device.id}`);
                    const checkBtn = document.getElementById(`check-${device.id}`);
                    
                    if (updateBtn) {
                        updateBtn.addEventListener('click', () => updateSingleDevice(device.id));
                    }
                    
                    if (checkBtn) {
                        checkBtn.addEventListener('click', () => checkSingleDevice(device.id));
                    }
                });
            }
            
            // 创建设备卡片
            function createDeviceCard(device) {
                const connectionStatus = device.isConnected ? 
                    '<div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div><span class="text-sm text-green-600">在线</span>' :
                    '<div class="w-3 h-3 bg-red-500 rounded-full mr-2"></div><span class="text-sm text-red-600">离线</span>';
                
                const updateStatus = device.hasUpdate ? 
                    '<span class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded-full">有更新</span>' :
                    '<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">已是最新</span>';
                
                const batteryColor = device.batteryLevel > 50 ? 'text-green-600' : 
                                   device.batteryLevel > 20 ? 'text-yellow-600' : 'text-red-600';
                
                const updateBtnDisabled = !device.isConnected || !device.hasUpdate || device.isUpdating || device.batteryLevel < 50;
                const updateBtnClass = updateBtnDisabled ? 
                    'bg-gray-400 cursor-not-allowed' : 
                    'bg-purple-600 hover:bg-purple-700';
                
                return `
                    <div class="bg-white rounded-xl shadow-md p-4 border ${device.isUpdating ? 'border-purple-200' : 'border-gray-200'}">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-wheelchair text-purple-600 text-xl"></i>
                                </div>
                                <div>
                                    <h4 class="font-medium text-gray-800">${device.name}</h4>
                                    <p class="text-xs text-gray-500">${device.model}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                ${updateStatus}
                            </div>
                        </div>
                        
                        <div class="space-y-2 mb-4">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">当前版本</span>
                                <span class="text-sm font-medium">${device.currentVersion}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">最新版本</span>
                                <span class="text-sm font-medium">${device.latestVersion}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">电量</span>
                                <span class="text-sm font-medium ${batteryColor}">${device.batteryLevel}%</span>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                ${connectionStatus}
                            </div>
                            <div class="flex items-center space-x-2">
                                <button id="check-${device.id}" class="text-blue-600 hover:text-blue-700 text-sm">
                                    <i class="fas fa-search mr-1"></i>检查
                                </button>
                                <button id="update-${device.id}" class="text-white py-1 px-3 rounded-lg text-sm font-medium ${updateBtnClass}" ${updateBtnDisabled ? 'disabled' : ''}>
                                    ${device.isUpdating ? '更新中...' : '更新'}
                                </button>
                            </div>
                        </div>
                        
                        <!-- 更新进度条（更新时显示） -->
                        <div id="progress-${device.id}" class="mt-3 ${device.isUpdating ? '' : 'hidden'}">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <p class="text-xs text-gray-600 mt-1">正在更新固件...</p>
                        </div>
                    </div>
                `;
            }
            
            // 更新设备概览
            function updateDevicesSummary() {
                const connectedCount = wheelchairDevices.filter(d => d.isConnected).length;
                const pendingCount = wheelchairDevices.filter(d => d.hasUpdate).length;
                const totalCount = wheelchairDevices.length;
                
                const connectedElement = document.getElementById('connected-devices-count');
                const pendingElement = document.getElementById('pending-updates-count');
                const totalElement = document.getElementById('total-devices-count');
                
                if (connectedElement) connectedElement.textContent = connectedCount;
                if (pendingElement) pendingElement.textContent = pendingCount;
                if (totalElement) totalElement.textContent = totalCount;
                

            }
            
            // 刷新设备列表
            function refreshDevicesList() {
                const refreshBtn = document.getElementById('refresh-devices-btn');
                if (refreshBtn) {
                    refreshBtn.innerHTML = '<i class="fas fa-sync fa-spin text-sm"></i>';
                    
                    setTimeout(() => {
                                                 // 模拟刷新数据
                         wheelchairDevices.forEach(device => {
                             device.isConnected = Math.random() > 0.2; // 80%概率在线
                             device.lastConnected = device.isConnected ? '刚刚' : '离线';
                         });
                        
                        loadDevicesList();
                        updateDevicesSummary();
                        refreshBtn.innerHTML = '<i class="fas fa-sync text-sm"></i>';
                    }, 1500);
                }
            }
            
            // 检查单个设备
            function checkSingleDevice(deviceId) {
                const device = wheelchairDevices.find(d => d.id === deviceId);
                if (!device) return;
                
                const checkBtn = document.getElementById(`check-${deviceId}`);
                if (checkBtn) {
                    checkBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>检查中';
                    
                    setTimeout(() => {
                        // 模拟检查结果
                        device.hasUpdate = Math.random() > 0.5;
                        device.latestVersion = device.hasUpdate ? 'v1.9.5' : device.currentVersion;
                        
                        loadDevicesList();
                        updateDevicesSummary();
                        checkBtn.innerHTML = '<i class="fas fa-search mr-1"></i>检查';
                    }, 2000);
                }
            }
            

            
            // 更新单个设备
            async function updateSingleDevice(deviceId) {
                const device = wheelchairDevices.find(d => d.id === deviceId);
                if (!device) return;
                
                // 检查电量
                if (device.batteryLevel < 50) {
                    await appAlert(`${device.name}电量不足50%，无法进行固件更新。请先充电后再试。`, '电量不足');
                    return;
                }
                
                const confirmed = await appConfirm(`确定要更新${device.name}的固件吗？\n\n更新期间：\n• 轮椅将无法使用\n• 请勿断开电源\n• 更新约需5-10分钟`, '确认更新');
                if (!confirmed) return;
                
                startSingleDeviceUpdate(device);
            }
            

            
            // 开始单个设备更新
            async function startSingleDeviceUpdate(device) {
                device.isUpdating = true;
                loadDevicesList();
                updateDevicesSummary();
                
                const progressContainer = document.getElementById(`progress-${device.id}`);
                const progressBar = progressContainer?.querySelector('.bg-purple-600');
                const progressText = progressContainer?.querySelector('.text-xs');
                
                // 显示进度弹窗
                const progressModal = document.getElementById('firmware-update-progress-modal');
                const modalProgressBar = document.getElementById('firmware-progress-bar');
                const modalProgressText = document.getElementById('firmware-progress-text');
                const modalProgressPercentage = document.getElementById('firmware-progress-percentage');
                const modalCurrentStep = document.getElementById('firmware-current-step');
                const modalRemainingTime = document.getElementById('firmware-remaining-time');
                const modalProgressIcon = document.getElementById('firmware-progress-icon');
                
                // 更新弹窗标题
                const modalTitle = progressModal?.querySelector('h3');
                if (modalTitle) modalTitle.textContent = `${device.name} 固件更新中`;
                
                progressModal?.classList.remove('hidden');
                
                // 更新进度的函数
                function updateProgress(percent, text, step, time, icon = 'fas fa-microchip') {
                    // 更新设备卡片进度
                    if (progressBar) progressBar.style.width = percent + '%';
                    if (progressText) progressText.textContent = text;
                    
                    // 更新弹窗进度
                    if (modalProgressBar) modalProgressBar.style.width = percent + '%';
                    if (modalProgressText) modalProgressText.textContent = text;
                    if (modalProgressPercentage) modalProgressPercentage.textContent = percent + '%';
                    if (modalCurrentStep) modalCurrentStep.textContent = step;
                    if (modalRemainingTime) modalRemainingTime.textContent = time;
                    if (modalProgressIcon) modalProgressIcon.className = icon + ' text-purple-600 text-2xl';
                }
                
                // 模拟更新过程
                updateProgress(0, '准备中...', `正在准备${device.name}固件更新环境...`, '8-10分钟', 'fas fa-cog');
                
                setTimeout(() => {
                    updateProgress(15, '下载中...', '正在从服务器下载固件包...', '7-8分钟', 'fas fa-download');
                    
                    setTimeout(() => {
                        updateProgress(35, '验证中...', '正在验证固件包完整性...', '5-7分钟', 'fas fa-shield-check');
                        
                        setTimeout(() => {
                            updateProgress(50, '刷写中...', '正在刷写固件到轮椅系统（请勿断电）...', '3-5分钟', 'fas fa-microchip');
                            
                            setTimeout(() => {
                                updateProgress(75, '配置中...', '正在更新系统配置参数...', '2-3分钟', 'fas fa-wrench');
                                
                                setTimeout(() => {
                                    updateProgress(90, '重启中...', '正在重启轮椅系统...', '1-2分钟', 'fas fa-sync fa-spin');
                                    
                                    setTimeout(() => {
                                        updateProgress(100, '完成', '固件更新完成，正在进行最终检查...', '完成', 'fas fa-check');
                                        
                                        setTimeout(async () => {
                                            progressModal?.classList.add('hidden');
                                            
                                            // 更新设备状态
                                            device.isUpdating = false;
                                            device.currentVersion = device.latestVersion;
                                            device.hasUpdate = false;
                                            
                                            loadDevicesList();
                                            updateDevicesSummary();
                                            
                                            await appAlert(`${device.name}固件更新完成！系统性能已优化。`, '更新成功');
                                            
                                            // 更新个人资料页面的状态
                                            const firmwareVersionStatus = document.getElementById('firmware-version-status');
                                            if (firmwareVersionStatus) {
                                                const stillHasUpdates = wheelchairDevices.some(d => d.hasUpdate);
                                                if (!stillHasUpdates) {
                                                    firmwareVersionStatus.textContent = 'v1.9.5';
                                                    firmwareVersionStatus.classList.remove('text-red-500');
                                                    firmwareVersionStatus.classList.add('text-green-500');
                                                }
                                            }
                                        }, 1500);
                                    }, 1500);
                                }, 1500);
                            }, 2000);
                        }, 1500);
                    }, 1500);
                }, 1000);
            }
            

        }
        
        // 初始化更新功能
        initAppUpdate();
        initFirmwareUpdate();
        initNavigation();
        
        // 新导航功能
        function initNavigation() {
            // 导航状态变量
            let navigationTimer = null;
            let countdownTimer = null;
            let progressTimer = null;
            let currentNavigationType = null; // 'charging' 或 'summon'
            let currentDestination = null;
            let navigationSourcePage = null; // 记录导航来源页面
            
            // 辅助函数：获取定位状态
            function getPositioningStatus() {
                const statusElement = document.getElementById('indoor-position-status');
                if (statusElement) {
                    const statusText = statusElement.querySelector('span').textContent;
                    return statusText === '定位正常';
                }
                return true; // 默认正常
            }
            
            // 辅助函数：获取路径状态  
            function getPathStatus() {
                // 检查地图上的异常状态显示
                const mapContainer = document.querySelector('.indoor-map-container');
                if (mapContainer) {
                    const hasError = mapContainer.querySelector('.error-indicator');
                    return !hasError;
                }
                return true; // 默认正常
            }
            
            // 修改原有的去充电功能，使用新的导航页面
            const goChargingBtn = document.getElementById('go-charging-btn');
            if (goChargingBtn) {
                // 移除原有的事件监听器，添加新的
                const newGoChargingBtn = goChargingBtn.cloneNode(true);
                goChargingBtn.parentNode.replaceChild(newGoChargingBtn, goChargingBtn);
                
                newGoChargingBtn.addEventListener('click', function() {
                    // 获取当前状态
                    const positioningStatus = getPositioningStatus();
                    const pathStatus = getPathStatus();
                    
                    if (!positioningStatus || !pathStatus) {
                        let errorType;
                        if (!positioningStatus && pathStatus) {
                            errorType = 'positioning';
                        } else if (positioningStatus && !pathStatus) {
                            errorType = 'out_of_path';
                        } else {
                            errorType = 'positioning';
                        }
                        try {
                            console.log('🔋 尝试显示导航去充电错误:', errorType);
                            window.showPositioningError('去充电', errorType);
                        } catch (error) {
                            console.error('❌ 显示导航去充电错误失败:', error);
                        }
                        return;
                    }
                    
                    window.startNavigation('charging', '充电桩');
                });
            }
            
            // 目的地按钮的绑定现在在initSummonFunction中处理
            
            // 取消导航按钮
            const cancelNavigationBtn = document.getElementById('cancel-navigation-btn');
            if (cancelNavigationBtn) {
                cancelNavigationBtn.addEventListener('click', async function() {
                    const confirmed = await window.showMobileConfirm(
                        '导航将会停止，轮椅会停在当前位置',
                        '取消导航',
                        '确认取消',
                        '继续导航'
                    );
                    if (confirmed) {
                        window.stopNavigation();
                        const targetPage = navigationSourcePage || 'device-status';
                        showPage(targetPage);
                        console.log('🏠 返回来源页面:', targetPage);
                    }
                });
            }
            
            // 返回主页按钮
            const returnHomeBtn = document.getElementById('return-home-btn');
            if (returnHomeBtn) {
                returnHomeBtn.addEventListener('click', function() {
                    showPage('control');
                });
            }
            
            // 刷新位置按钮
            const refreshLocationBtn = document.getElementById('refresh-location-btn');
            if (refreshLocationBtn) {
                refreshLocationBtn.addEventListener('click', function() {
                    // 模拟刷新位置
                    this.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>刷新中';
                    setTimeout(() => {
                        this.innerHTML = '<i class="fas fa-sync mr-1"></i>刷新';
                        showToast('位置已更新', 'success');
                    }, 1000);
                });
            }
            
            // 开始导航主函数
            function startNavigation(type, destination) {
                console.log('🚀 开始导航:', type, destination);
                
                // 记录当前页面作为来源页面
                const currentPage = document.querySelector('div[id]:not(.hidden)');
                navigationSourcePage = currentPage ? currentPage.id : 'device-status';
                console.log('📍 导航来源页面:', navigationSourcePage);
                
                currentNavigationType = type;
                currentDestination = destination;
                
                // 显示导航页面
                showPage('navigation');
                
                // 显示倒计时页面
                showNavigationCountdown(destination);
                
                // 开始倒计时
                startCountdown();
            }
            
            // 显示导航倒计时
            function showNavigationCountdown(destination) {
                const countdownDiv = document.getElementById('navigation-countdown');
                const progressDiv = document.getElementById('navigation-progress');
                const completeDiv = document.getElementById('navigation-complete');
                
                // 隐藏其他状态，显示倒计时
                if (progressDiv) progressDiv.classList.add('hidden');
                if (completeDiv) completeDiv.classList.add('hidden');
                if (countdownDiv) countdownDiv.classList.remove('hidden');
                
                // 更新倒计时内容
                const countdownTitle = document.getElementById('countdown-title');
                const countdownMessage = document.getElementById('countdown-message');
                
                if (countdownTitle) {
                    countdownTitle.textContent = currentNavigationType === 'charging' ? '准备去充电' : '准备召唤';
                }
                if (countdownMessage) {
                    countdownMessage.textContent = `即将开始前往${destination}...`;
                }
            }
            
            // 开始倒计时
            function startCountdown() {
                let countdown = 5;
                const countdownNumber = document.getElementById('countdown-number');
                
                if (countdownNumber) countdownNumber.textContent = countdown;
                
                countdownTimer = setInterval(() => {
                    countdown--;
                    if (countdownNumber) countdownNumber.textContent = countdown;
                    
                    if (countdown <= 0) {
                        clearInterval(countdownTimer);
                        startNavigationProgress();
                    }
                }, 1000);
            }
            
            // 开始导航进度
            function startNavigationProgress() {
                console.log('开始导航进度');
                
                // 隐藏倒计时页面
                const countdownDiv = document.getElementById('navigation-countdown');
                if (countdownDiv) {
                    countdownDiv.style.display = 'none';
                }
                
                // 隐藏完成页面
                const completeDiv = document.getElementById('navigation-complete');
                if (completeDiv) {
                    completeDiv.style.display = 'none';
                }
                
                // 直接创建导航进度界面
                createNavigationProgressUI();
            }
            
            // 模拟导航进度
            function simulateNavigationProgress() {
                let progress = 0;
                let distance = 8.5; // 初始距离
                let timeRemaining = 150; // 2分30秒
                
                progressTimer = setInterval(() => {
                    progress += Math.random() * 3 + 1; // 随机增加1-4%
                    distance = Math.max(0, distance - (Math.random() * 0.3 + 0.1)); // 减少距离
                    timeRemaining = Math.max(0, timeRemaining - Math.random() * 4 - 2); // 减少时间
                    
                    // 限制进度最大值
                    progress = Math.min(progress, 100);
                    
                    // 更新UI - 使用动态创建的元素ID
                    const progressBar = document.getElementById('dynamic-navigation-progress-bar');
                    const progressPercentage = document.getElementById('dynamic-navigation-percentage');
                    const remainingDistance = document.getElementById('dynamic-remaining-distance');
                    const estimatedTime = document.getElementById('dynamic-estimated-time');
                    const currentSpeed = document.getElementById('dynamic-current-speed');
                    const wheelchairPosition = document.getElementById('dynamic-wheelchair-position');
                    
                    if (progressBar) progressBar.style.width = progress + '%';
                    if (progressPercentage) progressPercentage.textContent = Math.round(progress) + '%';
                    if (remainingDistance) remainingDistance.textContent = distance.toFixed(1) + 'm';
                    if (estimatedTime) {
                        const minutes = Math.floor(timeRemaining / 60);
                        const seconds = Math.round(timeRemaining % 60);
                        estimatedTime.textContent = `${minutes}分${seconds}秒`;
                    }
                    if (currentSpeed) {
                        const speed = (Math.random() * 0.4 + 0.6).toFixed(1); // 0.6-1.0 m/s
                        currentSpeed.textContent = speed + 'm/s';
                    }
                    
                    // 更新轮椅位置（模拟移动）
                    if (wheelchairPosition) {
                        const currentLeft = parseInt(wheelchairPosition.style.left) || 80;
                        const targetLeft = 250; // 目标位置
                        const newLeft = currentLeft + (targetLeft - currentLeft) * (progress / 100) * 0.05;
                        wheelchairPosition.style.left = Math.min(newLeft, targetLeft - 10) + 'px';
                    }
                    
                    // 导航完成
                    if (progress >= 100) {
                        clearInterval(progressTimer);
                        setTimeout(() => {
                            showNavigationComplete();
                        }, 1000);
                    }
                }, 1000);
            }
            
            // 显示导航完成
            function showNavigationComplete() {
                // 移除进度界面
                const progressDiv = document.getElementById('navigation-progress');
                if (progressDiv) {
                    progressDiv.remove();
                }
                
                // 创建完成页面
                const completeContainer = document.createElement('div');
                completeContainer.id = 'navigation-complete';
                completeContainer.style.cssText = `
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    right: 0 !important;
                    bottom: 0 !important;
                    background: #f9fafb !important;
                    z-index: 10000 !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    padding: 20px !important;
                `;
                
                const message = currentNavigationType === 'charging' ? 
                    '轮椅已成功到达充电桩' : 
                    `轮椅已成功到达${currentDestination}`;
                
                completeContainer.innerHTML = `
                    <div style="background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 40px; text-align: center; max-width: 320px; width: 100%;">
                        <div style="width: 64px; height: 64px; background: #dcfce7; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px;">
                            <i class="fas fa-check" style="color: #16a34a; font-size: 32px;"></i>
                        </div>
                        <h2 style="font-size: 24px; font-weight: 600; margin: 0 0 12px 0; color: #166534;">导航完成</h2>
                        <p style="color: #6b7280; margin: 0 0 32px 0; font-size: 16px;">${message}</p>
                        
                        <button id="dynamic-return-home-btn" style="width: 100%; background: #8b5cf6; color: white; padding: 12px; border-radius: 8px; font-size: 16px; font-weight: 500; border: none; cursor: pointer;">
                            返回主页
                        </button>
                    </div>
                `;
                
                // 添加到导航页面
                const navigationPage = document.getElementById('navigation');
                if (navigationPage) {
                    navigationPage.appendChild(completeContainer);
                    
                    // 绑定返回按钮事件
                    const returnBtn = document.getElementById('dynamic-return-home-btn');
                    if (returnBtn) {
                        returnBtn.addEventListener('click', () => {
                            stopNavigation();
                            const targetPage = navigationSourcePage || 'device-status';
                            showPage(targetPage);
                            console.log('🏠 返回来源页面:', targetPage);
                        });
                    }
                }
                
                // 播放成功提示音
                showToast('导航完成！', 'success');
            }
            
            // 创建导航进度界面
            function createNavigationProgressUI() {
                // 移除现有的进度页面
                const existingProgress = document.getElementById('navigation-progress');
                if (existingProgress) {
                    existingProgress.remove();
                }
                
                // 创建新的导航进度界面
                const progressContainer = document.createElement('div');
                progressContainer.id = 'navigation-progress';
                progressContainer.style.cssText = `
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    right: 0 !important;
                    bottom: 0 !important;
                    background: #f9fafb !important;
                    z-index: 10000 !important;
                    overflow-y: auto !important;
                    padding: 20px !important;
                `;
                
                progressContainer.innerHTML = `
                    <!-- 导航状态栏 -->
                    <div style="background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 16px; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                            <h2 style="font-size: 18px; font-weight: 600; margin: 0;" id="dynamic-navigation-title">
                                ${currentNavigationType === 'charging' ? '正在前往充电桩' : `正在前往${currentDestination}`}
                            </h2>
                            <div style="display: flex; align-items: center; color: #10b981;">
                                <div style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; margin-right: 8px; animation: pulse 2s infinite;"></div>
                                <span style="font-size: 14px;">导航中</span>
                            </div>
                        </div>
                        
                        <!-- 导航信息 -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; text-align: center;">
                            <div>
                                <p style="font-size: 12px; color: #6b7280; margin: 0 0 4px 0;">剩余距离</p>
                                <p style="font-size: 18px; font-weight: 600; color: #8b5cf6; margin: 0;" id="dynamic-remaining-distance">8.5m</p>
                            </div>
                            <div>
                                <p style="font-size: 12px; color: #6b7280; margin: 0 0 4px 0;">预计时间</p>
                                <p style="font-size: 18px; font-weight: 600; color: #3b82f6; margin: 0;" id="dynamic-estimated-time">2分30秒</p>
                            </div>
                            <div>
                                <p style="font-size: 12px; color: #6b7280; margin: 0 0 4px 0;">当前速度</p>
                                <p style="font-size: 18px; font-weight: 600; color: #10b981; margin: 0;" id="dynamic-current-speed">0.8m/s</p>
                            </div>
                        </div>
                    </div>

                    <!-- 地图区域 -->
                    <div style="background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 16px; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                            <h3 style="font-weight: 500; margin: 0;">实时位置</h3>
                            <button id="dynamic-refresh-location-btn" style="color: #3b82f6; font-size: 14px; background: none; border: none; cursor: pointer;">
                                <i class="fas fa-sync" style="margin-right: 4px;"></i>刷新
                            </button>
                        </div>
                        
                        <!-- 简化地图视图 -->
                        <div style="position: relative; background: #f3f4f6; border-radius: 8px; height: 192px; overflow: hidden;">
                            <!-- 轮椅位置 -->
                            <div id="dynamic-wheelchair-position" style="position: absolute; left: 80px; top: 80px; transition: all 1s ease;">
                                <div style="width: 24px; height: 24px; background: #8b5cf6; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-wheelchair" style="color: white; font-size: 12px;"></i>
                                </div>
                                <div style="position: absolute; top: -32px; left: 50%; transform: translateX(-50%); background: #8b5cf6; color: white; font-size: 12px; padding: 4px 8px; border-radius: 4px;">
                                    轮椅
                                </div>
                            </div>
                            
                            <!-- 目标位置 -->
                            <div style="position: absolute; left: 250px; top: 75px;">
                                <div style="width: 24px; height: 24px; background: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; animation: pulse 2s infinite;">
                                    <i class="fas fa-flag" style="color: white; font-size: 12px;"></i>
                                </div>
                            </div>
                            
                            <!-- 路径指示 -->
                            <div style="position: absolute; left: 100px; top: 85px; right: 50px; height: 4px; background: linear-gradient(90deg, #8b5cf6, #10b981); border-radius: 2px; opacity: 0.8;">
                            </div>
                        </div>
                    </div>

                    <!-- 导航进度 -->
                    <div style="background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 16px; margin-bottom: 100px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 14px; font-weight: 500;">导航进度</span>
                            <span style="font-size: 14px; color: #8b5cf6;" id="dynamic-navigation-percentage">15%</span>
                        </div>
                        <div style="width: 100%; background: #e5e7eb; border-radius: 9999px; height: 8px;">
                            <div id="dynamic-navigation-progress-bar" style="background: #8b5cf6; height: 8px; border-radius: 9999px; transition: width 0.5s ease; width: 15%;"></div>
                        </div>
                    </div>

                    <!-- 圆形取消按钮 -->
                    <div style="position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%);">
                        <button id="dynamic-cancel-navigation-btn" style="
                            width: 120px; 
                            height: 120px; 
                            background: linear-gradient(135deg, #ef4444, #dc2626); 
                            color: white; 
                            border-radius: 50%; 
                            border: 4px solid white;
                            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4), 0 4px 12px rgba(0, 0, 0, 0.1); 
                            cursor: pointer;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            font-size: 16px;
                            font-weight: 700;
                            transition: all 0.2s ease;
                            outline: none;
                            -webkit-tap-highlight-color: transparent;
                        " 
                        onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 12px 32px rgba(239, 68, 68, 0.5), 0 6px 16px rgba(0, 0, 0, 0.15)'" 
                        onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 8px 24px rgba(239, 68, 68, 0.4), 0 4px 12px rgba(0, 0, 0, 0.1)'" 
                        onmousedown="this.style.transform='scale(0.95)'"
                        onmouseup="this.style.transform='scale(1.05)'">
                            <i class="fas fa-stop" style="font-size: 24px; margin-bottom: 8px;"></i>
                            <span>取消导航</span>
                        </button>
                    </div>
                `;
                
                // 添加到导航页面
                const navigationPage = document.getElementById('navigation');
                if (navigationPage) {
                    navigationPage.appendChild(progressContainer);
                    
                    // 绑定取消按钮事件
                    setTimeout(() => {
                        const cancelBtn = document.getElementById('dynamic-cancel-navigation-btn');
                        console.log('寻找取消按钮:', cancelBtn);
                        
                        if (cancelBtn) {
                            // 绑定移动端确认对话框
                            cancelBtn.onclick = async function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                console.log('🛑 取消按钮被点击！');
                                
                                const confirmed = await window.showMobileConfirm(
                                    '导航将会停止，轮椅会停在当前位置',
                                    '取消导航',
                                    '确认取消',
                                    '继续导航'
                                );
                                
                                if (confirmed) {
                                    console.log('✅ 用户确认取消导航');
                                    window.stopNavigation();
                                    const targetPage = navigationSourcePage || 'device-status';
                                    showPage(targetPage);
                                    console.log('🏠 返回来源页面:', targetPage);
                                } else {
                                    console.log('❌ 用户取消了取消操作');
                                }
                            };
                            
                            // 添加触摸事件支持
                            cancelBtn.ontouchstart = function(e) {
                                console.log('👆 触摸开始');
                                this.style.transform = 'scale(0.95)';
                            };
                            
                            cancelBtn.ontouchend = function(e) {
                                console.log('👆 触摸结束');
                                this.style.transform = 'scale(1)';
                            };
                            
                            console.log('✅ 取消按钮事件绑定完成');
                        } else {
                            console.error('❌ 未找到取消按钮');
                        }
                    }, 200);
                    
                    // 绑定刷新按钮事件
                    const refreshBtn = document.getElementById('dynamic-refresh-location-btn');
                    if (refreshBtn) {
                        refreshBtn.addEventListener('click', function() {
                            this.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 4px;"></i>刷新中';
                            setTimeout(() => {
                                this.innerHTML = '<i class="fas fa-sync" style="margin-right: 4px;"></i>刷新';
                                showToast('位置已更新', 'success');
                            }, 1000);
                        });
                    }
                    
                    // 开始模拟导航进度
                    simulateNavigationProgress();
                } else {
                    console.error('❌ 导航页面未找到！');
                }
            }
            
            // 停止导航
            function stopNavigation() {
                if (countdownTimer) {
                    clearInterval(countdownTimer);
                    countdownTimer = null;
                }
                if (progressTimer) {
                    clearInterval(progressTimer);
                    progressTimer = null;
                }
                
                // 重置状态
                currentNavigationType = null;
                currentDestination = null;
                navigationSourcePage = null;
                
                // 移除动态创建的进度界面
                const dynamicProgress = document.getElementById('navigation-progress');
                if (dynamicProgress) {
                    dynamicProgress.remove();
                }
            }
            
            // 发现广场和语音对话页面切换
            const startChatBtn = document.getElementById('start-chat-btn');
            const voiceChatBackBtn = document.getElementById('voice-chat-back-btn');
            
            // 开始对话按钮
            if (startChatBtn) {
                startChatBtn.addEventListener('click', function() {
                    console.log('🎤 点击开始对话');
                    showPage('voice-chat');
                    
                    // 隐藏底部导航栏（因为这是二级页面）
                    const bottomNav = document.getElementById('bottom-nav');
                    if (bottomNav) {
                        bottomNav.style.display = 'none';
                    }
                    
                    // 为语音对话页面添加一个简单的向上滑动动画效果
                    const voiceChatPage = document.getElementById('voice-chat');
                    if (voiceChatPage) {
                        voiceChatPage.style.transform = 'translateY(100%)';
                        voiceChatPage.style.transition = 'transform 0.3s ease-out';
                        setTimeout(() => {
                            voiceChatPage.style.transform = 'translateY(0)';
                        }, 10);
                    }
                });
            }
            
            // 语音对话返回按钮
            if (voiceChatBackBtn) {
                voiceChatBackBtn.addEventListener('click', function() {
                    console.log('🔙 返回发现广场');
                    
                    // 显示底部导航栏
                    const bottomNav = document.getElementById('bottom-nav');
                    if (bottomNav) {
                        bottomNav.style.display = 'block';
                    }
                    
                    showPage('voice');
                    
                    // 添加向下滑动的退出动画
                    const voiceChatPage = document.getElementById('voice-chat');
                    if (voiceChatPage) {
                        voiceChatPage.style.transform = 'translateY(100%)';
                        voiceChatPage.style.transition = 'transform 0.3s ease-in';
                    }
                });
            }
            
            // 户外导航功能实现
            function initOutdoorNavigation() {
                // 全局导航状态
                let currentDestination = '';
                let routeData = null;
                let isNavigating = false;
                
                // 路线导航按钮点击
                const routeNavigationBtn = document.getElementById('route-navigation-btn');
                if (routeNavigationBtn) {
                    console.log('✅ 路线导航按钮事件绑定成功');
                    routeNavigationBtn.addEventListener('click', function(e) {
                        console.log('🧭 路线导航按钮被点击');
                        e.preventDefault();
                        e.stopPropagation();
                        showPage('outdoor-navigation-destination');
                    });
                } else {
                    console.error('❌ 路线导航按钮未找到');
                }
                
                // 目的地输入页面逻辑
                initDestinationPage();
                
                // 导航确认页面逻辑
                initConfirmPage();
                
                // 导航页面逻辑
                initRoutePage();
                
                // 到达页面逻辑
                initArrivedPage();
                
                function hideBottomNav() {
                    const bottomNav = document.getElementById('bottom-nav');
                    if (bottomNav) {
                        bottomNav.style.display = 'none';
                    }
                }
                
                function showBottomNav() {
                    const bottomNav = document.getElementById('bottom-nav');
                    if (bottomNav) {
                        bottomNav.style.display = 'block';
                    }
                }
                
                // 目的地输入页面初始化
                function initDestinationPage() {
                    const destinationBackBtn = document.getElementById('destination-back-btn');
                    const voiceInputTab = document.getElementById('voice-input-tab');
                    const textInputTab = document.getElementById('text-input-tab');
                    const voiceInputArea = document.getElementById('voice-input-area');
                    const textInputArea = document.getElementById('text-input-area');
                    const startVoiceInputBtn = document.getElementById('start-voice-input-btn');
                    const destinationInput = document.getElementById('destination-input');
                    const clearInputBtn = document.getElementById('clear-input-btn');
                    const confirmDestinationBtn = document.getElementById('confirm-destination-btn');
                    const commonDestinationBtns = document.querySelectorAll('.common-destination-btn');
                    
                    // 返回按钮
                    if (destinationBackBtn) {
                        destinationBackBtn.addEventListener('click', function() {
                            showPage('voice');
                        });
                    }
                    
                    // 输入方式切换
                    if (voiceInputTab && textInputTab) {
                        voiceInputTab.addEventListener('click', function() {
                            switchToVoiceInput();
                        });
                        
                        textInputTab.addEventListener('click', function() {
                            switchToTextInput();
                        });
                    }
                    
                    function switchToVoiceInput() {
                        voiceInputTab.className = 'flex-1 py-2 px-4 rounded-lg bg-blue-500 text-white text-sm font-medium';
                        textInputTab.className = 'flex-1 py-2 px-4 rounded-lg bg-gray-100 text-gray-700 text-sm font-medium';
                        voiceInputArea.classList.remove('hidden');
                        textInputArea.classList.add('hidden');
                    }
                    
                    function switchToTextInput() {
                        textInputTab.className = 'flex-1 py-2 px-4 rounded-lg bg-blue-500 text-white text-sm font-medium';
                        voiceInputTab.className = 'flex-1 py-2 px-4 rounded-lg bg-gray-100 text-gray-700 text-sm font-medium';
                        textInputArea.classList.remove('hidden');
                        voiceInputArea.classList.add('hidden');
                    }
                    
                    // 语音输入
                    if (startVoiceInputBtn) {
                        startVoiceInputBtn.addEventListener('click', function() {
                            simulateVoiceInput();
                        });
                    }
                    
                    function simulateVoiceInput() {
                        const voiceInputResult = document.getElementById('voice-input-result');
                        const voiceInputText = document.getElementById('voice-input-text');
                        
                        // 模拟语音识别过程
                        startVoiceInputBtn.classList.add('animate-pulse');
                        startVoiceInputBtn.innerHTML = '<i class="fas fa-microphone text-2xl animate-bounce"></i>';
                        
                        setTimeout(() => {
                            // 模拟NLP解析结果
                            const destinations = ['朝阳公园', '北京站', '协和医院', '三里屯', '天安门广场', '故宫博物院'];
                            const randomDestination = destinations[Math.floor(Math.random() * destinations.length)];
                            
                            voiceInputText.textContent = `我想去${randomDestination}`;
                            voiceInputResult.classList.remove('hidden');
                            currentDestination = randomDestination;
                            
                            startVoiceInputBtn.classList.remove('animate-pulse');
                            startVoiceInputBtn.innerHTML = '<i class="fas fa-microphone text-2xl"></i>';
                            
                            updateConfirmButton();
                        }, 2000);
                    }
                    
                    // 文本输入
                    if (destinationInput) {
                        destinationInput.addEventListener('input', function() {
                            currentDestination = this.value;
                            updateConfirmButton();
                        });
                    }
                    
                    // 清除输入
                    if (clearInputBtn) {
                        clearInputBtn.addEventListener('click', function() {
                            destinationInput.value = '';
                            currentDestination = '';
                            updateConfirmButton();
                        });
                    }
                    
                    // 常用目的地按钮
                    commonDestinationBtns.forEach(btn => {
                        btn.addEventListener('click', function() {
                            const destination = this.getAttribute('data-destination');
                            currentDestination = destination;
                            
                            // 更新输入框显示
                            if (textInputArea.classList.contains('hidden')) {
                                // 语音输入模式
                                const voiceInputText = document.getElementById('voice-input-text');
                                const voiceInputResult = document.getElementById('voice-input-result');
                                voiceInputText.textContent = destination;
                                voiceInputResult.classList.remove('hidden');
                            } else {
                                // 文本输入模式
                                destinationInput.value = destination;
                            }
                            
                            updateConfirmButton();
                        });
                    });
                    
                    // 确认目的地
                    if (confirmDestinationBtn) {
                        confirmDestinationBtn.addEventListener('click', function() {
                            if (currentDestination) {
                                proceedToConfirmPage();
                            }
                        });
                    }
                    
                    function updateConfirmButton() {
                        if (currentDestination && currentDestination.trim()) {
                            confirmDestinationBtn.disabled = false;
                            confirmDestinationBtn.classList.remove('disabled:bg-gray-300', 'disabled:cursor-not-allowed');
                        } else {
                            confirmDestinationBtn.disabled = true;
                            confirmDestinationBtn.classList.add('disabled:bg-gray-300', 'disabled:cursor-not-allowed');
                        }
                    }
                    
                    function proceedToConfirmPage() {
                        // 生成路线数据
                        generateRouteData();
                        // 更新确认页面信息
                        updateConfirmPageData();
                        // 跳转到确认页面
                        showPage('outdoor-navigation-confirm');
                    }
                }
                
                // 导航确认页面初始化
                function initConfirmPage() {
                    const confirmBackBtn = document.getElementById('confirm-back-btn');
                    const startNavigationBtn = document.getElementById('start-outdoor-navigation-btn');
                    
                    if (confirmBackBtn) {
                        confirmBackBtn.addEventListener('click', function() {
                            showPage('outdoor-navigation-destination');
                        });
                    }
                    
                    if (startNavigationBtn) {
                        startNavigationBtn.addEventListener('click', function() {
                            console.log('✅ 户外导航确认按钮被点击');
                            startOutdoorNavigation();
                        });
                    } else {
                        console.error('❌ 户外导航确认按钮未找到');
                    }
                }
                
                // 导航页面初始化
                function initRoutePage() {
                    const endNavigationBtn = document.getElementById('end-navigation-btn');
                    const voiceGuidanceBtn = document.getElementById('voice-guidance-btn');
                    const mapCenterBtn = document.getElementById('map-center-btn');
                    
                    // 结束导航按钮
                    if (endNavigationBtn) {
                        endNavigationBtn.addEventListener('click', function() {
                            showNavigationCancelConfirm();
                        });
                    }
                    
                    // 语音播报开关
                    if (voiceGuidanceBtn) {
                        voiceGuidanceBtn.addEventListener('click', function() {
                            toggleVoiceGuidance();
                        });
                    }
                    
                    // 地图控制按钮
                    if (mapCenterBtn) {
                        mapCenterBtn.addEventListener('click', function() {
                            if (window.navigationMap && window.startMarker && window.endMarker) {
                                try {
                                    const group = new L.featureGroup([window.startMarker, window.endMarker]);
                                    window.navigationMap.fitBounds(group.getBounds(), { padding: [50, 50] });
                                    showToast('地图已居中', 'success');
                                } catch (error) {
                                    console.error('地图居中失败:', error);
                                    showToast('地图居中失败', 'error');
                                }
                            } else {
                                showToast('地图尚未完全加载', 'warning');
                            }
                        });
                    }
                    
                    // 路线菜单弹窗处理
                    initRouteMenuModal();
                }
                
                // 到达页面初始化
                function initArrivedPage() {
                    const backToDiscoveryBtn = document.getElementById('back-to-discovery-btn');
                    
                    if (backToDiscoveryBtn) {
                        backToDiscoveryBtn.addEventListener('click', function() {
                            showPage('voice');
                            resetNavigationState();
                        });
                    }
                }
                
                // 生成路线数据
                function generateRouteData() {
                    const distances = [2.8, 5.2, 8.1, 12.5, 15.3];
                    const randomDistance = distances[Math.floor(Math.random() * distances.length)];
                    const estimatedTime = Math.ceil(randomDistance * 4.5); // 假设平均速度4.5km/h
                    
                    routeData = {
                        destination: currentDestination,
                        distance: randomDistance,
                        estimatedTime: estimatedTime,
                        batteryConsumption: Math.ceil(randomDistance * 1.5), // 假设每公里消耗1.5%电量
                        weather: generateWeatherData(),
                        schedule: generateScheduleCheck()
                    };
                }
                
                // 生成天气数据
                function generateWeatherData() {
                    const weathers = [
                        { icon: 'fas fa-sun', desc: '晴朗，适宜出行', temp: 22, feelsLike: 24, wind: '3级', precipitation: '0%', advice: '天气条件良好，适合外出', adviceType: 'success' },
                        { icon: 'fas fa-cloud', desc: '多云，天气良好', temp: 18, feelsLike: 20, wind: '2级', precipitation: '10%', advice: '天气较好，注意保暖', adviceType: 'info' },
                        { icon: 'fas fa-cloud-rain', desc: '小雨，建议带伞', temp: 15, feelsLike: 13, wind: '4级', precipitation: '80%', advice: '预计15分钟后有小雨，建议带伞', adviceType: 'warning' }
                    ];
                    return weathers[Math.floor(Math.random() * weathers.length)];
                }
                
                // 生成日程检查
                function generateScheduleCheck() {
                    const hasConflict = Math.random() < 0.2; // 20%概率有冲突
                    return {
                        hasConflict: hasConflict,
                        status: hasConflict ? '存在冲突' : '无冲突',
                        details: hasConflict ? '16:00有医院预约，请注意时间安排' : '未发现与现有安排冲突，可以开始导航',
                        type: hasConflict ? 'warning' : 'success'
                    };
                }
                
                // 更新确认页面数据
                function updateConfirmPageData() {
                    if (!routeData) return;
                    
                    // 更新目的地信息
                    const destinationName = document.getElementById('destination-name');
                    const estimatedDistance = document.getElementById('estimated-distance');
                    const estimatedTime = document.getElementById('estimated-time');
                    
                    if (destinationName) destinationName.textContent = routeData.destination;
                    if (estimatedDistance) estimatedDistance.textContent = `${routeData.distance} km`;
                    if (estimatedTime) estimatedTime.textContent = `${routeData.estimatedTime} 分钟`;
                    
                    // 更新电量评估
                    const currentBattery = 65; // 模拟当前电量
                    const batteryAssessment = document.getElementById('battery-assessment');
                    const currentBatteryDisplay = document.getElementById('current-battery');
                    const batteryDetails = document.getElementById('battery-details');
                    
                    const remainingBattery = currentBattery - routeData.batteryConsumption * 2; // 往返
                    const canReturn = remainingBattery > 20;
                    
                    if (batteryAssessment) {
                        batteryAssessment.textContent = canReturn ? '电量充足，支持往返' : '电量可能不足往返，建议充电';
                        batteryAssessment.className = canReturn ? 'text-sm text-green-600' : 'text-sm text-orange-600';
                    }
                    if (currentBatteryDisplay) currentBatteryDisplay.textContent = `${currentBattery}%`;
                    if (batteryDetails) {
                        const maxRange = Math.floor(currentBattery / 1.5);
                        batteryDetails.textContent = `当前电量预计可支持 ${maxRange} 公里行程`;
                    }
                    
                    // 更新天气信息
                    const weather = routeData.weather;
                    const weatherIcon = document.getElementById('weather-icon');
                    const weatherDescription = document.getElementById('weather-description');
                    const currentTemperature = document.getElementById('current-temperature');
                    const feelsLike = document.getElementById('feels-like');
                    const windSpeed = document.getElementById('wind-speed');
                    const precipitation = document.getElementById('precipitation');
                    const weatherAdvice = document.getElementById('weather-advice');
                    
                    if (weatherIcon) weatherIcon.className = weather.icon + ' text-yellow-500';
                    if (weatherDescription) weatherDescription.textContent = weather.desc;
                    if (currentTemperature) currentTemperature.textContent = `${weather.temp}°C`;
                    if (feelsLike) feelsLike.textContent = `${weather.feelsLike}°C`;
                    if (windSpeed) windSpeed.textContent = weather.wind;
                    if (precipitation) precipitation.textContent = weather.precipitation;
                    if (weatherAdvice) {
                        const adviceColors = {
                            success: 'bg-green-50 text-green-700',
                            warning: 'bg-orange-50 text-orange-700',
                            info: 'bg-blue-50 text-blue-700'
                        };
                        weatherAdvice.className = `mt-3 p-2 rounded-lg ${adviceColors[weather.adviceType]}`;
                        weatherAdvice.innerHTML = `<p class="text-xs"><i class="fas fa-${weather.adviceType === 'success' ? 'check-circle' : weather.adviceType === 'warning' ? 'exclamation-triangle' : 'info-circle'} mr-1"></i>${weather.advice}</p>`;
                    }
                    
                    // 更新日程检查
                    const schedule = routeData.schedule;
                    const scheduleStatus = document.getElementById('schedule-status');
                    const scheduleDetails = document.getElementById('schedule-details');
                    
                    if (scheduleStatus) {
                        scheduleStatus.textContent = schedule.status;
                        scheduleStatus.className = schedule.hasConflict ? 'text-sm text-orange-600' : 'text-sm text-green-600';
                    }
                    if (scheduleDetails) {
                        const detailColors = {
                            warning: 'bg-orange-50 text-orange-700',
                            success: 'bg-green-50 text-green-700'
                        };
                        scheduleDetails.className = `rounded-lg p-3 ${detailColors[schedule.type]}`;
                        scheduleDetails.innerHTML = `<p class="text-xs"><i class="fas fa-${schedule.hasConflict ? 'exclamation-triangle' : 'check-circle'} mr-1"></i>${schedule.details}</p>`;
                    }
                }
                
                // 开始户外导航
                function startOutdoorNavigation() {
                    console.log('🚀 开始户外导航');
                    isNavigating = true;
                    updateRoutePageData();
                    showPage('outdoor-navigation-route');
                    
                    // 初始化真实地图
                    setTimeout(() => {
                        initNavigationMap();
                    }, 100); // 等待页面显示后再初始化地图
                    
                    // 模拟导航过程
                    simulateNavigation();
                }
                
                // 更新导航页面数据 (优化版本)
                function updateRoutePageData() {
                    if (!routeData) return;
                    
                    // 计算ETA时间
                    const now = new Date();
                    const etaTime = new Date(now.getTime() + routeData.estimatedTime * 60000);
                    const etaTimeStr = `${etaTime.getHours()}:${etaTime.getMinutes().toString().padStart(2, '0')}`;
                    
                    // 更新顶部蓝色卡片中的信息栏
                    const remainingTime = document.getElementById('remaining-time');
                    const remainingDistance = document.getElementById('remaining-distance');
                    const routeBattery = document.getElementById('route-battery');
                    
                    if (remainingTime) remainingTime.textContent = `${routeData.estimatedTime}分钟`;
                    if (remainingDistance) remainingDistance.textContent = `${routeData.distance}公里`;
                    if (routeBattery) routeBattery.textContent = '60%';
                    
                    // 更新底部操作栏的数据 (高德地图样式)
                    const bottomDistance = document.getElementById('bottom-distance');
                    const bottomTime = document.getElementById('bottom-time');
                    const bottomEta = document.getElementById('bottom-eta');
                    
                    if (bottomDistance) bottomDistance.textContent = `${routeData.distance}公里`;
                    if (bottomTime) bottomTime.textContent = `${routeData.estimatedTime}分钟`;
                    if (bottomEta) bottomEta.textContent = `${etaTimeStr}到达`;
                }
                
                // 模拟导航过程 (Google Maps风格)
                function simulateNavigation() {
                    let remainingTime = routeData.estimatedTime;
                    let remainingDistance = routeData.distance;
                    
                    const instructions = [
                        { icon: 'fa-arrow-right', text: '前方右转', road: '朝阳北路', distance: 200 },
                        { icon: 'fa-arrow-left', text: '前方左转', road: '建国门外大街', distance: 500 },
                        { icon: 'fa-arrow-up', text: '直行', road: '建国门外大街', distance: 800 },
                        { icon: 'fa-arrow-right', text: '前方右转', road: '朝阳公园南路', distance: 300 },
                        { icon: 'fa-map-marker-alt', text: '即将到达目的地', road: routeData.destination, distance: 50 }
                    ];
                    
                    let currentInstruction = 0;
                    let currentInstructionDistance = instructions[0]?.distance || 200;
                    
                    const navigationInterval = setInterval(() => {
                        remainingTime -= 2;
                        remainingDistance -= 0.15;
                        currentInstructionDistance -= 50;
                        
                        // 计算新的ETA
                        const now = new Date();
                        const etaTime = new Date(now.getTime() + remainingTime * 60000);
                        const etaTimeStr = `${etaTime.getHours()}:${etaTime.getMinutes().toString().padStart(2, '0')}`;
                        
                        // 更新顶部蓝色卡片信息栏
                        const remainingTimeTop = document.getElementById('remaining-time');
                        const remainingDistanceTop = document.getElementById('remaining-distance');
                        
                        if (remainingTimeTop) remainingTimeTop.textContent = `${Math.max(0, remainingTime)}分钟`;
                        if (remainingDistanceTop) remainingDistanceTop.textContent = `${Math.max(0, remainingDistance.toFixed(1))}公里`;
                        
                        // 更新底部操作栏的实时数据
                        const bottomDistance = document.getElementById('bottom-distance');
                        const bottomTime = document.getElementById('bottom-time');
                        const bottomEta = document.getElementById('bottom-eta');
                        
                        if (bottomDistance) bottomDistance.textContent = `${Math.max(0, remainingDistance.toFixed(1))}公里`;
                        if (bottomTime) bottomTime.textContent = `${Math.max(0, remainingTime)}分钟`;
                        if (bottomEta) bottomEta.textContent = `${etaTimeStr}到达`;
                        
                        // 更新导航指令
                        if (currentInstruction < instructions.length) {
                            const instruction = instructions[currentInstruction];
                            const directionIcon = document.getElementById('direction-icon');
                            const nextInstruction = document.getElementById('next-instruction');
                            const nextRoad = document.getElementById('next-road');
                            const distanceToTurn = document.getElementById('distance-to-turn');
                            
                            if (directionIcon) directionIcon.className = `fas ${instruction.icon} text-white text-2xl`;
                            if (nextInstruction) nextInstruction.textContent = instruction.text;
                            if (nextRoad) nextRoad.textContent = instruction.road;
                            if (distanceToTurn) distanceToTurn.textContent = Math.max(0, currentInstructionDistance).toString();
                            
                            // 如果当前指令距离用完，切换到下一个指令
                            if (currentInstructionDistance <= 0 && currentInstruction < instructions.length - 1) {
                                currentInstruction++;
                                currentInstructionDistance = instructions[currentInstruction]?.distance || 100;
                            }
                        }
                        
                        // 检查是否到达
                        if (remainingTime <= 0 || remainingDistance <= 0) {
                            clearInterval(navigationInterval);
                            arriveAtDestination();
                        }
                    }, 3000); // 每3秒更新一次
                }
                
                // 到达目的地
                function arriveAtDestination() {
                    updateArrivedPageData();
                    showPage('outdoor-navigation-arrived');
                    
                    // 3秒后自动显示返回按钮提示
                    setTimeout(() => {
                        const backBtn = document.getElementById('back-to-discovery-btn');
                        if (backBtn) {
                            backBtn.classList.add('animate-pulse');
                        }
                    }, 3000);
                }
                
                // 更新到达页面数据
                function updateArrivedPageData() {
                    if (!routeData) return;
                    
                    const arrivedDestination = document.getElementById('arrived-destination');
                    const arrivalTime = document.getElementById('arrival-time');
                    const tripDistance = document.getElementById('trip-distance');
                    const tripTime = document.getElementById('trip-time');
                    const tripBattery = document.getElementById('trip-battery');
                    
                    const now = new Date();
                    const timeStr = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
                    
                    if (arrivedDestination) arrivedDestination.textContent = routeData.destination;
                    if (arrivalTime) arrivalTime.textContent = `${timeStr} 到达`;
                    if (tripDistance) tripDistance.textContent = routeData.distance.toString();
                    if (tripTime) tripTime.textContent = routeData.estimatedTime.toString();
                    if (tripBattery) tripBattery.textContent = `${routeData.batteryConsumption}%`;
                }
                
                // 显示取消导航确认 (移动端友好)
                function showNavigationCancelConfirm() {
                    // 创建确认对话框
                    const confirmModal = document.createElement('div');
                    confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-[70] flex items-center justify-center p-4';
                    confirmModal.innerHTML = `
                        <div class="bg-white rounded-2xl p-6 max-w-sm w-full">
                            <h3 class="text-lg font-semibold text-center mb-3">结束导航</h3>
                            <p class="text-gray-600 text-center mb-6">确定要结束当前导航吗？</p>
                            <div class="flex space-x-3">
                                <button id="cancel-confirm-no" class="flex-1 py-3 px-4 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                                    继续导航
                                </button>
                                <button id="cancel-confirm-yes" class="flex-1 py-3 px-4 bg-red-500 text-white rounded-lg font-medium hover:bg-red-600 transition-colors">
                                    结束导航
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(confirmModal);
                    
                    // 绑定事件
                    const noBtn = confirmModal.querySelector('#cancel-confirm-no');
                    const yesBtn = confirmModal.querySelector('#cancel-confirm-yes');
                    
                    const removeModal = () => {
                        document.body.removeChild(confirmModal);
                    };
                    
                    noBtn.addEventListener('click', removeModal);
                    yesBtn.addEventListener('click', () => {
                        removeModal();
                        showPage('voice');
                        resetNavigationState();
                    });
                    
                    // 点击背景关闭
                    confirmModal.addEventListener('click', (e) => {
                        if (e.target === confirmModal) {
                            removeModal();
                        }
                    });
                }
                

                
                // 切换语音引导 (Google Maps风格)
                function toggleVoiceGuidance() {
                    const voiceBtn = document.getElementById('voice-guidance-btn');
                    if (voiceBtn) {
                        const currentIcon = voiceBtn.querySelector('i');
                        const isMuted = currentIcon.classList.contains('fa-volume-mute');
                        
                        if (isMuted) {
                            currentIcon.className = 'fas fa-volume-up text-gray-700';
                            showToast('语音引导已开启', 'success');
                        } else {
                            currentIcon.className = 'fas fa-volume-mute text-gray-700';
                            showToast('语音引导已关闭', 'info');
                        }
                    }
                }
                
                // 显示路线菜单
                function showRouteMenu() {
                    const routeMenuModal = document.getElementById('route-menu-modal');
                    const routeMenuContent = document.getElementById('route-menu-content');
                    
                    if (routeMenuModal && routeMenuContent) {
                        routeMenuModal.classList.remove('hidden');
                        setTimeout(() => {
                            routeMenuContent.style.transform = 'translateY(0)';
                        }, 10);
                    }
                }
                
                // 隐藏路线菜单
                function hideRouteMenu() {
                    const routeMenuModal = document.getElementById('route-menu-modal');
                    const routeMenuContent = document.getElementById('route-menu-content');
                    
                    if (routeMenuModal && routeMenuContent) {
                        routeMenuContent.style.transform = 'translateY(100%)';
                        setTimeout(() => {
                            routeMenuModal.classList.add('hidden');
                        }, 300);
                    }
                }
                
                // 初始化路线菜单弹窗
                function initRouteMenuModal() {
                    const closeRouteMenuBtn = document.getElementById('close-route-menu');
                    const routeMenuModal = document.getElementById('route-menu-modal');
                    
                    if (closeRouteMenuBtn) {
                        closeRouteMenuBtn.addEventListener('click', hideRouteMenu);
                    }
                    
                    if (routeMenuModal) {
                        routeMenuModal.addEventListener('click', function(e) {
                            if (e.target === routeMenuModal) {
                                hideRouteMenu();
                            }
                        });
                    }
                }
                
                // 初始化导航地图
                function initNavigationMap() {
                    console.log('🗺️ 初始化导航地图');
                    
                    const mapContainer = document.getElementById('route-map-container');
                    if (!mapContainer) {
                        console.error('❌ 地图容器未找到');
                        return;
                    }
                    
                    try {
                        // 清除现有地图
                        mapContainer.innerHTML = '';
                        
                        // 创建地图实例，尝试获取用户位置
                        let initialCenter = [39.9042, 116.4074]; // 北京默认位置
                        
                        // 简化的位置获取
                        if (navigator.geolocation) {
                            navigator.geolocation.getCurrentPosition(
                                (position) => {
                                    console.log('✅ 获取位置成功:', position.coords.latitude, position.coords.longitude);
                                    const newCenter = [position.coords.latitude, position.coords.longitude];
                                    if (window.navigationMap && window.startMarker) {
                                        window.navigationMap.setView(newCenter, 15);
                                        window.startMarker.setLatLng(newCenter);
                                    }
                                },
                                (error) => {
                                    console.warn('位置获取失败，使用默认位置');
                                },
                                { timeout: 5000, enableHighAccuracy: false }
                            );
                        }
                        
                        const map = L.map('route-map-container').setView(initialCenter, 15);
                        
                        // 使用国内可访问的地图源
                        try {
                            // 使用高德地图瓦片（国内访问稳定）
                            L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
                                subdomains: ['1', '2', '3', '4'],
                                attribution: '© 高德地图',
                                maxZoom: 18
                            }).addTo(map);
                            console.log('✅ 使用高德地图瓦片');
                        } catch (error) {
                            console.warn('高德地图加载失败，尝试备用方案');
                            try {
                                // 备用方案：天地图
                                L.tileLayer('https://t{s}.tianditu.gov.cn/vec_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=vec&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=您的天地图key', {
                                    subdomains: ['0', '1', '2', '3', '4', '5', '6', '7'],
                                    attribution: '© 天地图',
                                    maxZoom: 18
                                }).addTo(map);
                                console.log('✅ 使用天地图瓦片');
                            } catch (error2) {
                                console.warn('所有地图服务无法加载，使用纯色背景');
                                map.getContainer().style.backgroundColor = '#f3f4f6';
                                // 添加简单的网格线效果
                                map.getContainer().style.backgroundImage = `
                                    linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px),
                                    linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px)
                                `;
                                map.getContainer().style.backgroundSize = '50px 50px';
                            }
                        }
                        
                        // 起点标记（当前位置）
                        const startIcon = L.divIcon({
                            html: '<div class="w-6 h-6 bg-blue-600 rounded-full border-2 border-white shadow-lg flex items-center justify-center"><i class="fas fa-location-arrow text-white text-xs"></i></div>',
                            className: 'custom-div-icon',
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        });
                        
                        const startMarker = L.marker(initialCenter, { icon: startIcon }).addTo(map)
                            .bindPopup('当前位置');
                        
                        // 目的地标记
                        const endIcon = L.divIcon({
                            html: '<div class="w-8 h-8 bg-red-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center"><i class="fas fa-map-marker-alt text-white text-sm"></i></div>',
                            className: 'custom-div-icon',
                            iconSize: [32, 32],
                            iconAnchor: [16, 32]
                        });
                        
                        // 根据目的地设置终点坐标
                        let endCoords = [39.9142, 116.4174]; // 默认坐标
                        if (routeData && routeData.destination) {
                            // 根据目的地名称设置坐标（这里简化处理）
                            const destinationCoords = {
                                '朝阳公园': [39.9289, 116.4486],
                                '北京站': [39.9042, 116.4278],
                                '协和医院': [39.9127, 116.4108],
                                '三里屯': [39.9365, 116.4478],
                                '天安门广场': [39.9042, 116.3975],
                                '故宫博物院': [39.9163, 116.3972]
                            };
                            endCoords = destinationCoords[routeData.destination] || endCoords;
                        }
                        
                        const endMarker = L.marker(endCoords, { icon: endIcon }).addTo(map)
                            .bindPopup(routeData ? routeData.destination : '目的地');
                        
                        // 绘制路线
                        const routeCoords = [
                            initialCenter, // 起点
                            [initialCenter[0] + 0.004, initialCenter[1] + 0.005], // 中间点1
                            [initialCenter[0] + 0.008, initialCenter[1] + 0.008], // 中间点2
                            endCoords // 终点
                        ];
                        
                        const routeLine = L.polyline(routeCoords, {
                            color: '#4285F4',
                            weight: 6,
                            opacity: 0.8
                        }).addTo(map);
                        
                        // 已行驶路线（绿色）
                        const traveledLine = L.polyline([
                            initialCenter,
                            [initialCenter[0] + 0.004, initialCenter[1] + 0.005]
                        ], {
                            color: '#1a73e8',
                            weight: 6,
                            opacity: 0.9
                        }).addTo(map);
                        
                        // 调整地图视野以包含所有标记
                        const group = new L.featureGroup([startMarker, endMarker, routeLine]);
                        map.fitBounds(group.getBounds(), { padding: [50, 50] });
                        
                        // 禁用地图交互（保持导航专注性）
                        map.dragging.disable();
                        map.touchZoom.disable();
                        map.doubleClickZoom.disable();
                        map.scrollWheelZoom.disable();
                        map.boxZoom.disable();
                        map.keyboard.disable();
                        if (map.tap) map.tap.disable();
                        
                        console.log('✅ 导航地图初始化成功');
                        
                        // 存储地图实例以便后续更新
                        window.navigationMap = map;
                        window.startMarker = startMarker;
                        window.endMarker = endMarker;
                        window.traveledLine = traveledLine;
                        window.routeLine = routeLine;
                        
                    } catch (error) {
                        console.error('❌ 地图初始化失败:', error);
                        mapContainer.innerHTML = `
                            <div class="absolute inset-0 bg-gray-800 flex items-center justify-center">
                                <div class="text-center text-white">
                                    <i class="fas fa-map text-4xl mb-4 opacity-50"></i>
                                    <p class="text-lg mb-2">地图加载失败</p>
                                    <p class="text-sm opacity-75">请检查网络连接</p>
                                </div>
                            </div>
                        `;
                    }
                }
                
                // 更新位置后重新绘制路线
                function updateRouteWithNewLocation(newStartCoords) {
                    if (!window.navigationMap || !window.endMarker) return;
                    
                    try {
                        // 获取目的地坐标
                        const endCoords = window.endMarker.getLatLng();
                        
                        // 重新计算路线
                        const newRouteCoords = [
                            newStartCoords,
                            [newStartCoords[0] + (endCoords.lat - newStartCoords[0]) * 0.3, newStartCoords[1] + (endCoords.lng - newStartCoords[1]) * 0.3],
                            [newStartCoords[0] + (endCoords.lat - newStartCoords[0]) * 0.7, newStartCoords[1] + (endCoords.lng - newStartCoords[1]) * 0.7],
                            [endCoords.lat, endCoords.lng]
                        ];
                        
                        // 更新路线
                        if (window.routeLine) {
                            window.routeLine.setLatLngs(newRouteCoords);
                        }
                        
                        // 更新已行驶路线（重置为起点）
                        if (window.traveledLine) {
                            window.traveledLine.setLatLngs([newStartCoords, newStartCoords]);
                        }
                        
                        console.log('✅ 路线已更新到新位置');
                        
                    } catch (error) {
                        console.error('❌ 路线更新失败:', error);
                    }
                }
                

                
                // 重置导航状态
                function resetNavigationState() {
                    currentDestination = '';
                    routeData = null;
                    isNavigating = false;
                    
                    // 清理地图实例
                    if (window.navigationMap) {
                        window.navigationMap.remove();
                        window.navigationMap = null;
                        window.startMarker = null;
                        window.endMarker = null;
                        window.traveledLine = null;
                        window.routeLine = null;
                    }
                    
                    // 重置输入框
                    const destinationInput = document.getElementById('destination-input');
                    const voiceInputResult = document.getElementById('voice-input-result');
                    const confirmDestinationBtn = document.getElementById('confirm-destination-btn');
                    
                    if (destinationInput) destinationInput.value = '';
                    if (voiceInputResult) voiceInputResult.classList.add('hidden');
                    if (confirmDestinationBtn) {
                        confirmDestinationBtn.disabled = true;
                        confirmDestinationBtn.classList.add('disabled:bg-gray-300', 'disabled:cursor-not-allowed');
                    }
                }
            }
            
            // 户外导航功能初始化
            initOutdoorNavigation();
            
            // 功能入口卡片点击事件
            const featureCards = document.querySelectorAll('#voice .grid > div');
            featureCards.forEach(card => {
                card.addEventListener('click', function(e) {
                    const featureName = this.querySelector('h4').textContent;
                    if (featureName === '路线导航') {
                        // 路线导航功能已由专门的事件处理器处理，阻止这里的处理
                        e.stopPropagation();
                        return;
                    }
                    showToast(`${featureName}功能开发中，敬请期待`, 'info');
                });
            });
        }
        
        // 更新导航栏状态
        function updateNavigation(activeTab) {
            const navLinks = document.querySelectorAll('nav a');
            navLinks.forEach(link => {
                link.classList.remove('text-blue-500');
                link.classList.add('text-gray-400');
            });
            
            const activeLink = document.querySelector(`nav a[href="#${activeTab}"]`);
            if (activeLink) {
                activeLink.classList.remove('text-gray-400');
                activeLink.classList.add('text-blue-500');
            }
        }
    </script>
</body>
</html> 